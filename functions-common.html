<!DOCTYPE html>
<html>
<head>
    <meta http-eqiv='content-type' content='text/html;charset=utf-8'>
    <title>functions-common</title>
    <link rel=stylesheet href="http://jashkenas.github.com/docco/resources/docco.css">
</head>
<body>
<div id=container>
    <div id=background></div>
    <table cellspacing=0 cellpadding=0>
    <thead>
      <tr>
        <th class=docs><h1>functions-common</h1></th>
        <th class=code></th>
      </tr>
    </thead>
    <tbody>
        <tr><td class='docs'><?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.12: http://docutils.sourceforge.net/" />
<title></title>
<style type="text/css">

/*
:Author: David Goodger (goodger@python.org)
:Id: $Id: html4css1.css 7614 2013-02-21 15:55:51Z milde $
:Copyright: This stylesheet has been placed in the public domain.

Default cascading style sheet for the HTML output of Docutils.

See http://docutils.sf.net/docs/howto/html-stylesheets.html for how to
customize this style sheet.
*/

/* used to remove borders from tables and images */
.borderless, table.borderless td, table.borderless th {
  border: 0 }

table.borderless td, table.borderless th {
  /* Override padding for "table.docutils td" with "! important".
     The right padding separates the table cells. */
  padding: 0 0.5em 0 0 ! important }

.first {
  /* Override more specific margin styles with "! important". */
  margin-top: 0 ! important }

.last, .with-subtitle {
  margin-bottom: 0 ! important }

.hidden {
  display: none }

a.toc-backref {
  text-decoration: none ;
  color: black }

blockquote.epigraph {
  margin: 2em 5em ; }

dl.docutils dd {
  margin-bottom: 0.5em }

object[type="image/svg+xml"], object[type="application/x-shockwave-flash"] {
  overflow: hidden;
}

/* Uncomment (and remove this text!) to get bold-faced definition list terms
dl.docutils dt {
  font-weight: bold }
*/

div.abstract {
  margin: 2em 5em }

div.abstract p.topic-title {
  font-weight: bold ;
  text-align: center }

div.admonition, div.attention, div.caution, div.danger, div.error,
div.hint, div.important, div.note, div.tip, div.warning {
  margin: 2em ;
  border: medium outset ;
  padding: 1em }

div.admonition p.admonition-title, div.hint p.admonition-title,
div.important p.admonition-title, div.note p.admonition-title,
div.tip p.admonition-title {
  font-weight: bold ;
  font-family: sans-serif }

div.attention p.admonition-title, div.caution p.admonition-title,
div.danger p.admonition-title, div.error p.admonition-title,
div.warning p.admonition-title, .code .error {
  color: red ;
  font-weight: bold ;
  font-family: sans-serif }

/* Uncomment (and remove this text!) to get reduced vertical space in
   compound paragraphs.
div.compound .compound-first, div.compound .compound-middle {
  margin-bottom: 0.5em }

div.compound .compound-last, div.compound .compound-middle {
  margin-top: 0.5em }
*/

div.dedication {
  margin: 2em 5em ;
  text-align: center ;
  font-style: italic }

div.dedication p.topic-title {
  font-weight: bold ;
  font-style: normal }

div.figure {
  margin-left: 2em ;
  margin-right: 2em }

div.footer, div.header {
  clear: both;
  font-size: smaller }

div.line-block {
  display: block ;
  margin-top: 1em ;
  margin-bottom: 1em }

div.line-block div.line-block {
  margin-top: 0 ;
  margin-bottom: 0 ;
  margin-left: 1.5em }

div.sidebar {
  margin: 0 0 0.5em 1em ;
  border: medium outset ;
  padding: 1em ;
  background-color: #ffffee ;
  width: 40% ;
  float: right ;
  clear: right }

div.sidebar p.rubric {
  font-family: sans-serif ;
  font-size: medium }

div.system-messages {
  margin: 5em }

div.system-messages h1 {
  color: red }

div.system-message {
  border: medium outset ;
  padding: 1em }

div.system-message p.system-message-title {
  color: red ;
  font-weight: bold }

div.topic {
  margin: 2em }

h1.section-subtitle, h2.section-subtitle, h3.section-subtitle,
h4.section-subtitle, h5.section-subtitle, h6.section-subtitle {
  margin-top: 0.4em }

h1.title {
  text-align: center }

h2.subtitle {
  text-align: center }

hr.docutils {
  width: 75% }

img.align-left, .figure.align-left, object.align-left {
  clear: left ;
  float: left ;
  margin-right: 1em }

img.align-right, .figure.align-right, object.align-right {
  clear: right ;
  float: right ;
  margin-left: 1em }

img.align-center, .figure.align-center, object.align-center {
  display: block;
  margin-left: auto;
  margin-right: auto;
}

.align-left {
  text-align: left }

.align-center {
  clear: both ;
  text-align: center }

.align-right {
  text-align: right }

/* reset inner alignment in figures */
div.align-right {
  text-align: inherit }

/* div.align-center * { */
/*   text-align: left } */

ol.simple, ul.simple {
  margin-bottom: 1em }

ol.arabic {
  list-style: decimal }

ol.loweralpha {
  list-style: lower-alpha }

ol.upperalpha {
  list-style: upper-alpha }

ol.lowerroman {
  list-style: lower-roman }

ol.upperroman {
  list-style: upper-roman }

p.attribution {
  text-align: right ;
  margin-left: 50% }

p.caption {
  font-style: italic }

p.credits {
  font-style: italic ;
  font-size: smaller }

p.label {
  white-space: nowrap }

p.rubric {
  font-weight: bold ;
  font-size: larger ;
  color: maroon ;
  text-align: center }

p.sidebar-title {
  font-family: sans-serif ;
  font-weight: bold ;
  font-size: larger }

p.sidebar-subtitle {
  font-family: sans-serif ;
  font-weight: bold }

p.topic-title {
  font-weight: bold }

pre.address {
  margin-bottom: 0 ;
  margin-top: 0 ;
  font: inherit }

pre.literal-block, pre.doctest-block, pre.math, pre.code {
  margin-left: 2em ;
  margin-right: 2em }

pre.code .ln { color: grey; } /* line numbers */
pre.code, code { background-color: #eeeeee }
pre.code .comment, code .comment { color: #5C6576 }
pre.code .keyword, code .keyword { color: #3B0D06; font-weight: bold }
pre.code .literal.string, code .literal.string { color: #0C5404 }
pre.code .name.builtin, code .name.builtin { color: #352B84 }
pre.code .deleted, code .deleted { background-color: #DEB0A1}
pre.code .inserted, code .inserted { background-color: #A3D289}

span.classifier {
  font-family: sans-serif ;
  font-style: oblique }

span.classifier-delimiter {
  font-family: sans-serif ;
  font-weight: bold }

span.interpreted {
  font-family: sans-serif }

span.option {
  white-space: nowrap }

span.pre {
  white-space: pre }

span.problematic {
  color: red }

span.section-subtitle {
  /* font-size relative to parent (h1..h6 element) */
  font-size: 80% }

table.citation {
  border-left: solid 1px gray;
  margin-left: 1px }

table.docinfo {
  margin: 2em 4em }

table.docutils {
  margin-top: 0.5em ;
  margin-bottom: 0.5em }

table.footnote {
  border-left: solid 1px black;
  margin-left: 1px }

table.docutils td, table.docutils th,
table.docinfo td, table.docinfo th {
  padding-left: 0.5em ;
  padding-right: 0.5em ;
  vertical-align: top }

table.docutils th.field-name, table.docinfo th.docinfo-name {
  font-weight: bold ;
  text-align: left ;
  white-space: nowrap ;
  padding-left: 0 }

/* "booktabs" style (no vertical lines) */
table.docutils.booktabs {
  border: 0px;
  border-top: 2px solid;
  border-bottom: 2px solid;
  border-collapse: collapse;
}
table.docutils.booktabs * {
  border: 0px;
}
table.docutils.booktabs th {
  border-bottom: thin solid;
  text-align: left;
}

h1 tt.docutils, h2 tt.docutils, h3 tt.docutils,
h4 tt.docutils, h5 tt.docutils, h6 tt.docutils {
  font-size: 100% }

ul.auto-toc {
  list-style-type: none }

</style>
</head>
<body>
<div class="document">


<p>functions-common - Common functions used by DevStack components</p>
<p>The canonical copy of this file is maintained in the DevStack repo.
All modifications should be made there and then sync'ed to other repos
as required.</p>
<p>This file is sorted alphabetically within the function groups.</p>
<ul class="simple">
<li>Config Functions</li>
<li>Control Functions</li>
<li>Distro Functions</li>
<li>Git Functions</li>
<li>OpenStack Functions</li>
<li>Package Functions</li>
<li>Process Functions</li>
<li>Python Functions</li>
<li>Service Functions</li>
<li>System Functions</li>
</ul>
<p>The following variables are assumed to be defined by certain functions:</p>
<ul class="simple">
<li><tt class="docutils literal">ENABLED_SERVICES</tt></li>
<li><tt class="docutils literal">ERROR_ON_CLONE</tt></li>
<li><tt class="docutils literal">FILES</tt></li>
<li><tt class="docutils literal">OFFLINE</tt></li>
<li><tt class="docutils literal">PIP_DOWNLOAD_CACHE</tt></li>
<li><tt class="docutils literal">PIP_USE_MIRRORS</tt></li>
<li><tt class="docutils literal">RECLONE</tt></li>
<li><tt class="docutils literal">REQUIREMENTS_DIR</tt></li>
<li><tt class="docutils literal">STACK_USER</tt></li>
<li><tt class="docutils literal">TRACK_DEPENDS</tt></li>
<li><tt class="docutils literal">UNDO_REQUIREMENTS</tt></li>
<li><tt class="docutils literal">http_proxy</tt>, <tt class="docutils literal">https_proxy</tt>, <tt class="docutils literal">no_proxy</tt></li>
</ul>
<div class="system-message">
<p class="system-message-title">System Message: WARNING/2 (<tt class="docutils">&lt;stdin&gt;</tt>, line 34)</p>
Bullet list ends without a blank line; unexpected unindent.</div>
<p>Save trace setting</p>
</td><td class=code><div class=highlight><pre>

<span class="nv">XTRACE</span><span class="o">=</span><span class="k">$(</span><span class="nb">set</span> +o | grep xtrace<span class="k">)</span>
<span class="nb">set</span> +o xtrace

</pre></div></td></tr><tr><td class=docs>
<p>Global Config Variables</p>
</td><td class=code><div class=highlight><pre>
<span class="nb">declare</span> -A GITREPO
<span class="nb">declare</span> -A GITBRANCH
<span class="nb">declare</span> -A GITDIR


</pre></div></td></tr><tr><td class=docs>
<div class="section" id="config-functions">
<h1>Config Functions</h1>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Append a new option in an ini file without replacing the old value
iniadd config-file section option value1 value2 value3 ...</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>iniadd <span class="o">{</span>
    <span class="nb">local </span><span class="nv">xtrace</span><span class="o">=</span><span class="k">$(</span><span class="nb">set</span> +o | grep xtrace<span class="k">)</span>
    <span class="nb">set</span> +o xtrace
    <span class="nb">local </span><span class="nv">file</span><span class="o">=</span><span class="nv">$1</span>
    <span class="nb">local </span><span class="nv">section</span><span class="o">=</span><span class="nv">$2</span>
    <span class="nb">local </span><span class="nv">option</span><span class="o">=</span><span class="nv">$3</span>
    <span class="nb">shift </span>3

    <span class="nb">local </span><span class="nv">values</span><span class="o">=</span><span class="s2">&quot;$(iniget_multiline $file $section $option) $@&quot;</span>
    iniset_multiline <span class="nv">$file</span> <span class="nv">$section</span> <span class="nv">$option</span> <span class="nv">$values</span>
    <span class="nv">$xtrace</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Comment an option in an INI file
inicomment config-file section option</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>inicomment <span class="o">{</span>
    <span class="nb">local </span><span class="nv">xtrace</span><span class="o">=</span><span class="k">$(</span><span class="nb">set</span> +o | grep xtrace<span class="k">)</span>
    <span class="nb">set</span> +o xtrace
    <span class="nb">local </span><span class="nv">file</span><span class="o">=</span><span class="nv">$1</span>
    <span class="nb">local </span><span class="nv">section</span><span class="o">=</span><span class="nv">$2</span>
    <span class="nb">local </span><span class="nv">option</span><span class="o">=</span><span class="nv">$3</span>

    sed -i -e <span class="s2">&quot;/^\[$section\]/,/^\[.*\]/ s|^\($option[ \t]*=.*$\)|#\1|&quot;</span> <span class="s2">&quot;$file&quot;</span>
    <span class="nv">$xtrace</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Get an option from an INI file
iniget config-file section option</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>iniget <span class="o">{</span>
    <span class="nb">local </span><span class="nv">xtrace</span><span class="o">=</span><span class="k">$(</span><span class="nb">set</span> +o | grep xtrace<span class="k">)</span>
    <span class="nb">set</span> +o xtrace
    <span class="nb">local </span><span class="nv">file</span><span class="o">=</span><span class="nv">$1</span>
    <span class="nb">local </span><span class="nv">section</span><span class="o">=</span><span class="nv">$2</span>
    <span class="nb">local </span><span class="nv">option</span><span class="o">=</span><span class="nv">$3</span>
    <span class="nb">local </span>line

    <span class="nv">line</span><span class="o">=</span><span class="k">$(</span>sed -ne <span class="s2">&quot;/^\[$section\]/,/^\[.*\]/ { /^$option[ \t]*=/ p; }&quot;</span> <span class="s2">&quot;$file&quot;</span><span class="k">)</span>
    <span class="nb">echo</span> <span class="k">${</span><span class="nv">line</span><span class="p">#*=</span><span class="k">}</span>
    <span class="nv">$xtrace</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Get a multiple line option from an INI file
iniget_multiline config-file section option</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>iniget_multiline <span class="o">{</span>
    <span class="nb">local </span><span class="nv">xtrace</span><span class="o">=</span><span class="k">$(</span><span class="nb">set</span> +o | grep xtrace<span class="k">)</span>
    <span class="nb">set</span> +o xtrace
    <span class="nb">local </span><span class="nv">file</span><span class="o">=</span><span class="nv">$1</span>
    <span class="nb">local </span><span class="nv">section</span><span class="o">=</span><span class="nv">$2</span>
    <span class="nb">local </span><span class="nv">option</span><span class="o">=</span><span class="nv">$3</span>
    <span class="nb">local </span>values

    <span class="nv">values</span><span class="o">=</span><span class="k">$(</span>sed -ne <span class="s2">&quot;/^\[$section\]/,/^\[.*\]/ { s/^$option[ \t]*=[ \t]*//gp; }&quot;</span> <span class="s2">&quot;$file&quot;</span><span class="k">)</span>
    <span class="nb">echo</span> <span class="k">${</span><span class="nv">values</span><span class="k">}</span>
    <span class="nv">$xtrace</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Determinate is the given option present in the INI file
ini_has_option config-file section option</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>ini_has_option <span class="o">{</span>
    <span class="nb">local </span><span class="nv">xtrace</span><span class="o">=</span><span class="k">$(</span><span class="nb">set</span> +o | grep xtrace<span class="k">)</span>
    <span class="nb">set</span> +o xtrace
    <span class="nb">local </span><span class="nv">file</span><span class="o">=</span><span class="nv">$1</span>
    <span class="nb">local </span><span class="nv">section</span><span class="o">=</span><span class="nv">$2</span>
    <span class="nb">local </span><span class="nv">option</span><span class="o">=</span><span class="nv">$3</span>
    <span class="nb">local </span>line

    <span class="nv">line</span><span class="o">=</span><span class="k">$(</span>sed -ne <span class="s2">&quot;/^\[$section\]/,/^\[.*\]/ { /^$option[ \t]*=/ p; }&quot;</span> <span class="s2">&quot;$file&quot;</span><span class="k">)</span>
    <span class="nv">$xtrace</span>
    <span class="o">[</span> -n <span class="s2">&quot;$line&quot;</span> <span class="o">]</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Set an option in an INI file
iniset config-file section option value</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>iniset <span class="o">{</span>
    <span class="nb">local </span><span class="nv">xtrace</span><span class="o">=</span><span class="k">$(</span><span class="nb">set</span> +o | grep xtrace<span class="k">)</span>
    <span class="nb">set</span> +o xtrace
    <span class="nb">local </span><span class="nv">file</span><span class="o">=</span><span class="nv">$1</span>
    <span class="nb">local </span><span class="nv">section</span><span class="o">=</span><span class="nv">$2</span>
    <span class="nb">local </span><span class="nv">option</span><span class="o">=</span><span class="nv">$3</span>
    <span class="nb">local </span><span class="nv">value</span><span class="o">=</span><span class="nv">$4</span>

    <span class="o">[[</span> -z <span class="nv">$section</span> <span class="o">||</span> -z <span class="nv">$option</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="k">return</span>

<span class="k">    if</span> ! grep -q <span class="s2">&quot;^\[$section\]&quot;</span> <span class="s2">&quot;$file&quot;</span> 2&gt;/dev/null; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>Add section at the end</p>
</td><td class=code><div class=highlight><pre>
        <span class="nb">echo</span> -e <span class="s2">&quot;\n[$section]&quot;</span> &gt;&gt;<span class="s2">&quot;$file&quot;</span>
    <span class="k">fi</span>
<span class="k">    if</span> ! ini_has_option <span class="s2">&quot;$file&quot;</span> <span class="s2">&quot;$section&quot;</span> <span class="s2">&quot;$option&quot;</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>Add it</p>
</td><td class=code><div class=highlight><pre>
        sed -i -e <span class="s2">&quot;/^\[$section\]/ a\\</span>
<span class="s2">$option = $value</span>
<span class="s2">&quot;</span> <span class="s2">&quot;$file&quot;</span>
    <span class="k">else</span>
<span class="k">        </span><span class="nb">local </span><span class="nv">sep</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> -ne <span class="s2">&quot;\x01&quot;</span><span class="k">)</span>
</pre></div></td></tr><tr><td class=docs>
<p>Replace it</p>
</td><td class=code><div class=highlight><pre>
        sed -i -e <span class="s1">&#39;/^\[&#39;</span><span class="k">${</span><span class="nv">section</span><span class="k">}</span><span class="s1">&#39;\]/,/^\[.*\]/ s&#39;</span><span class="k">${</span><span class="nv">sep</span><span class="k">}</span><span class="s1">&#39;^\(&#39;</span><span class="k">${</span><span class="nv">option</span><span class="k">}</span><span class="s1">&#39;[ \t]*=[ \t]*\).*$&#39;</span><span class="k">${</span><span class="nv">sep</span><span class="k">}</span><span class="s1">&#39;\1&#39;</span><span class="s2">&quot;${value}&quot;</span><span class="k">${</span><span class="nv">sep</span><span class="k">}</span> <span class="s2">&quot;$file&quot;</span>
    <span class="k">fi</span>
    <span class="nv">$xtrace</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Set a multiple line option in an INI file
iniset_multiline config-file section option value1 value2 valu3 ...</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>iniset_multiline <span class="o">{</span>
    <span class="nb">local </span><span class="nv">xtrace</span><span class="o">=</span><span class="k">$(</span><span class="nb">set</span> +o | grep xtrace<span class="k">)</span>
    <span class="nb">set</span> +o xtrace
    <span class="nb">local </span><span class="nv">file</span><span class="o">=</span><span class="nv">$1</span>
    <span class="nb">local </span><span class="nv">section</span><span class="o">=</span><span class="nv">$2</span>
    <span class="nb">local </span><span class="nv">option</span><span class="o">=</span><span class="nv">$3</span>

    <span class="nb">shift </span>3
    <span class="nb">local </span>values
    <span class="k">for </span>v in <span class="nv">$@</span>; <span class="k">do</span>
</pre></div></td></tr><tr><td class=docs>
<p>The later sed command inserts each new value in the line next to
the section identifier, which causes the values to be inserted in
the reverse order. Do a reverse here to keep the original order.</p>
</td><td class=code><div class=highlight><pre>
        <span class="nv">values</span><span class="o">=</span><span class="s2">&quot;$v ${values}&quot;</span>
    <span class="k">done</span>
<span class="k">    if</span> ! grep -q <span class="s2">&quot;^\[$section\]&quot;</span> <span class="s2">&quot;$file&quot;</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>Add section at the end</p>
</td><td class=code><div class=highlight><pre>
        <span class="nb">echo</span> -e <span class="s2">&quot;\n[$section]&quot;</span> &gt;&gt;<span class="s2">&quot;$file&quot;</span>
    <span class="k">else</span>
</pre></div></td></tr><tr><td class=docs>
<p>Remove old values</p>
</td><td class=code><div class=highlight><pre>
        sed -i -e <span class="s2">&quot;/^\[$section\]/,/^\[.*\]/ { /^$option[ \t]*=/ d; }&quot;</span> <span class="s2">&quot;$file&quot;</span>
    <span class="k">fi</span>
</pre></div></td></tr><tr><td class=docs>
<p>Add new ones</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">for </span>v in <span class="nv">$values</span>; <span class="k">do</span>
<span class="k">        </span>sed -i -e <span class="s2">&quot;/^\[$section\]/ a\\</span>
<span class="s2">$option = $v</span>
<span class="s2">&quot;</span> <span class="s2">&quot;$file&quot;</span>
    <span class="k">done</span>
    <span class="nv">$xtrace</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Uncomment an option in an INI file
iniuncomment config-file section option</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>iniuncomment <span class="o">{</span>
    <span class="nb">local </span><span class="nv">xtrace</span><span class="o">=</span><span class="k">$(</span><span class="nb">set</span> +o | grep xtrace<span class="k">)</span>
    <span class="nb">set</span> +o xtrace
    <span class="nb">local </span><span class="nv">file</span><span class="o">=</span><span class="nv">$1</span>
    <span class="nb">local </span><span class="nv">section</span><span class="o">=</span><span class="nv">$2</span>
    <span class="nb">local </span><span class="nv">option</span><span class="o">=</span><span class="nv">$3</span>
    sed -i -e <span class="s2">&quot;/^\[$section\]/,/^\[.*\]/ s|[^ \t]*#[ \t]*\($option[ \t]*=.*$\)|\1|&quot;</span> <span class="s2">&quot;$file&quot;</span>
    <span class="nv">$xtrace</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Normalize config values to True or False
Accepts as False: 0 no No NO false False FALSE
Accepts as True: 1 yes Yes YES true True TRUE
VAR=$(trueorfalse default-value test-value)</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>trueorfalse <span class="o">{</span>
    <span class="nb">local </span><span class="nv">xtrace</span><span class="o">=</span><span class="k">$(</span><span class="nb">set</span> +o | grep xtrace<span class="k">)</span>
    <span class="nb">set</span> +o xtrace
    <span class="nb">local </span><span class="nv">default</span><span class="o">=</span><span class="nv">$1</span>
    <span class="nb">local </span><span class="nv">testval</span><span class="o">=</span><span class="nv">$2</span>

    <span class="o">[[</span> -z <span class="s2">&quot;$testval&quot;</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="o">{</span> <span class="nb">echo</span> <span class="s2">&quot;$default&quot;</span>; <span class="k">return</span>; <span class="o">}</span>
    <span class="o">[[</span> <span class="s2">&quot;0 no No NO false False FALSE&quot;</span> <span class="o">=</span>~ <span class="s2">&quot;$testval&quot;</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="o">{</span> <span class="nb">echo</span> <span class="s2">&quot;False&quot;</span>; <span class="k">return</span>; <span class="o">}</span>
    <span class="o">[[</span> <span class="s2">&quot;1 yes Yes YES true True TRUE&quot;</span> <span class="o">=</span>~ <span class="s2">&quot;$testval&quot;</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="o">{</span> <span class="nb">echo</span> <span class="s2">&quot;True&quot;</span>; <span class="k">return</span>; <span class="o">}</span>
    <span class="nb">echo</span> <span class="s2">&quot;$default&quot;</span>
    <span class="nv">$xtrace</span>
<span class="o">}</span>


</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="control-functions">
<h1>Control Functions</h1>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Prints backtrace info
filename:lineno:function
backtrace level</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>backtrace <span class="o">{</span>
    <span class="nb">local </span><span class="nv">level</span><span class="o">=</span><span class="nv">$1</span>
    <span class="nb">local </span><span class="nv">deep</span><span class="o">=</span><span class="k">$((${#</span><span class="nv">BASH_SOURCE</span><span class="p">[@]</span><span class="k">}</span> <span class="o">-</span> <span class="m">1</span><span class="k">))</span>
    <span class="nb">echo</span> <span class="s2">&quot;[Call Trace]&quot;</span>
    <span class="k">while</span> <span class="o">[</span> <span class="nv">$level</span> -le <span class="nv">$deep</span> <span class="o">]</span>; <span class="k">do</span>
<span class="k">        </span><span class="nb">echo</span> <span class="s2">&quot;${BASH_SOURCE[$deep]}:${BASH_LINENO[$deep-1]}:${FUNCNAME[$deep-1]}&quot;</span>
        <span class="nv">deep</span><span class="o">=</span><span class="k">$((</span>deep <span class="o">-</span> <span class="m">1</span><span class="k">))</span>
    <span class="k">done</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Prints line number and &quot;message&quot; then exits
die $LINENO &quot;message&quot;</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>die <span class="o">{</span>
    <span class="nb">local </span><span class="nv">exitcode</span><span class="o">=</span><span class="nv">$?</span>
    <span class="nb">set</span> +o xtrace
    <span class="nb">local </span><span class="nv">line</span><span class="o">=</span><span class="nv">$1</span>; <span class="nb">shift</span>
<span class="nb">    </span><span class="k">if</span> <span class="o">[</span> <span class="nv">$exitcode</span> <span class="o">==</span> 0 <span class="o">]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nv">exitcode</span><span class="o">=</span>1
    <span class="k">fi</span>
<span class="k">    </span>backtrace 2
    err <span class="nv">$line</span> <span class="s2">&quot;$*&quot;</span>
</pre></div></td></tr><tr><td class=docs>
<p>Give buffers a second to flush</p>
</td><td class=code><div class=highlight><pre>
    sleep 1
    <span class="nb">exit</span> <span class="nv">$exitcode</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Checks an environment variable is not set or has length 0 OR if the
exit code is non-zero and prints &quot;message&quot; and exits
NOTE: env-var is the variable name without a '$'
die_if_not_set $LINENO env-var &quot;message&quot;</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>die_if_not_set <span class="o">{</span>
    <span class="nb">local </span><span class="nv">exitcode</span><span class="o">=</span><span class="nv">$?</span>
    <span class="nb">local </span><span class="nv">xtrace</span><span class="o">=</span><span class="k">$(</span><span class="nb">set</span> +o | grep xtrace<span class="k">)</span>
    <span class="nb">set</span> +o xtrace
    <span class="nb">local </span><span class="nv">line</span><span class="o">=</span><span class="nv">$1</span>; <span class="nb">shift</span>
<span class="nb">    local </span><span class="nv">evar</span><span class="o">=</span><span class="nv">$1</span>; <span class="nb">shift</span>
<span class="nb">    </span><span class="k">if</span> ! is_set <span class="nv">$evar</span> <span class="o">||</span> <span class="o">[</span> <span class="nv">$exitcode</span> !<span class="o">=</span> 0 <span class="o">]</span>; <span class="k">then</span>
<span class="k">        </span>die <span class="nv">$line</span> <span class="s2">&quot;$*&quot;</span>
    <span class="k">fi</span>
    <span class="nv">$xtrace</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Prints line number and &quot;message&quot; in error format
err $LINENO &quot;message&quot;</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>err <span class="o">{</span>
    <span class="nb">local </span><span class="nv">exitcode</span><span class="o">=</span><span class="nv">$?</span>
    <span class="nb">local </span><span class="nv">xtrace</span><span class="o">=</span><span class="k">$(</span><span class="nb">set</span> +o | grep xtrace<span class="k">)</span>
    <span class="nb">set</span> +o xtrace
    <span class="nb">local </span><span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;[ERROR] ${BASH_SOURCE[2]}:$1 $2&quot;</span>
    <span class="nb">echo</span> <span class="nv">$msg</span> 1&gt;&amp;2;
    <span class="k">if</span> <span class="o">[[</span> -n <span class="k">${</span><span class="nv">SCREEN_LOGDIR</span><span class="k">}</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nb">echo</span> <span class="nv">$msg</span> &gt;&gt; <span class="s2">&quot;${SCREEN_LOGDIR}/error.log&quot;</span>
    <span class="k">fi</span>
    <span class="nv">$xtrace</span>
    <span class="k">return</span> <span class="nv">$exitcode</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Checks an environment variable is not set or has length 0 OR if the
exit code is non-zero and prints &quot;message&quot;
NOTE: env-var is the variable name without a '$'
err_if_not_set $LINENO env-var &quot;message&quot;</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>err_if_not_set <span class="o">{</span>
    <span class="nb">local </span><span class="nv">exitcode</span><span class="o">=</span><span class="nv">$?</span>
    <span class="nb">local </span><span class="nv">xtrace</span><span class="o">=</span><span class="k">$(</span><span class="nb">set</span> +o | grep xtrace<span class="k">)</span>
    <span class="nb">set</span> +o xtrace
    <span class="nb">local </span><span class="nv">line</span><span class="o">=</span><span class="nv">$1</span>; <span class="nb">shift</span>
<span class="nb">    local </span><span class="nv">evar</span><span class="o">=</span><span class="nv">$1</span>; <span class="nb">shift</span>
<span class="nb">    </span><span class="k">if</span> ! is_set <span class="nv">$evar</span> <span class="o">||</span> <span class="o">[</span> <span class="nv">$exitcode</span> !<span class="o">=</span> 0 <span class="o">]</span>; <span class="k">then</span>
<span class="k">        </span>err <span class="nv">$line</span> <span class="s2">&quot;$*&quot;</span>
    <span class="k">fi</span>
    <span class="nv">$xtrace</span>
    <span class="k">return</span> <span class="nv">$exitcode</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Exit after outputting a message about the distribution not being supported.
exit_distro_not_supported [optional-string-telling-what-is-missing]</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>exit_distro_not_supported <span class="o">{</span>
    <span class="k">if</span> <span class="o">[[</span> -z <span class="s2">&quot;$DISTRO&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span>GetDistro
    <span class="k">fi</span>

<span class="k">    if</span> <span class="o">[</span> <span class="nv">$# </span>-gt 0 <span class="o">]</span>; <span class="k">then</span>
<span class="k">        </span>die <span class="nv">$LINENO</span> <span class="s2">&quot;Support for $DISTRO is incomplete: no support for $@&quot;</span>
    <span class="k">else</span>
<span class="k">        </span>die <span class="nv">$LINENO</span> <span class="s2">&quot;Support for $DISTRO is incomplete.&quot;</span>
    <span class="k">fi</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Test if the named environment variable is set and not zero length
is_set env-var</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>is_set <span class="o">{</span>
    <span class="nb">local </span><span class="nv">var</span><span class="o">=</span><span class="se">\$</span><span class="s2">&quot;$1&quot;</span>
    <span class="nb">eval</span> <span class="s2">&quot;[ -n \&quot;$var\&quot; ]&quot;</span> <span class="c"># For ex.: sh -c &quot;[ -n \&quot;$var\&quot; ]&quot; would be better, but several exercises depends on this</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Prints line number and &quot;message&quot; in warning format
warn $LINENO &quot;message&quot;</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>warn <span class="o">{</span>
    <span class="nb">local </span><span class="nv">exitcode</span><span class="o">=</span><span class="nv">$?</span>
    <span class="nb">local </span><span class="nv">xtrace</span><span class="o">=</span><span class="k">$(</span><span class="nb">set</span> +o | grep xtrace<span class="k">)</span>
    <span class="nb">set</span> +o xtrace
    <span class="nb">local </span><span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;[WARNING] ${BASH_SOURCE[2]}:$1 $2&quot;</span>
    <span class="nb">echo</span> <span class="nv">$msg</span> 1&gt;&amp;2;
    <span class="k">if</span> <span class="o">[[</span> -n <span class="k">${</span><span class="nv">SCREEN_LOGDIR</span><span class="k">}</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nb">echo</span> <span class="nv">$msg</span> &gt;&gt; <span class="s2">&quot;${SCREEN_LOGDIR}/error.log&quot;</span>
    <span class="k">fi</span>
    <span class="nv">$xtrace</span>
    <span class="k">return</span> <span class="nv">$exitcode</span>
<span class="o">}</span>


</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="distro-functions">
<h1>Distro Functions</h1>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Determine OS Vendor, Release and Update
Tested with OS/X, Ubuntu, RedHat, CentOS, Fedora
Returns results in global variables:
<tt class="docutils literal">os_VENDOR</tt> - vendor name: <tt class="docutils literal">Ubuntu</tt>, <tt class="docutils literal">Fedora</tt>, etc
<tt class="docutils literal">os_RELEASE</tt> - major release: <tt class="docutils literal">14.04</tt> (Ubuntu), <tt class="docutils literal">20</tt> (Fedora)
<tt class="docutils literal">os_UPDATE</tt> - update: ex. the <tt class="docutils literal">5</tt> in <tt class="docutils literal">RHEL6.5</tt>
<tt class="docutils literal">os_PACKAGE</tt> - package type: <tt class="docutils literal">deb</tt> or <tt class="docutils literal">rpm</tt>
<tt class="docutils literal">os_CODENAME</tt> - vendor's codename for release: <tt class="docutils literal">snow leopard</tt>, <tt class="docutils literal">trusty</tt></p>
</td><td class=code><div class=highlight><pre>
<span class="nb">declare </span>os_VENDOR os_RELEASE os_UPDATE os_PACKAGE os_CODENAME

</pre></div></td></tr><tr><td class=docs>
<p>GetOSVersion</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>GetOSVersion <span class="o">{</span>

</pre></div></td></tr><tr><td class=docs>
<p>Figure out which vendor we are</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">if</span> <span class="o">[[</span> -x <span class="s2">&quot;`which sw_vers 2&gt;/dev/null`&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>OS/X</p>
</td><td class=code><div class=highlight><pre>
        <span class="nv">os_VENDOR</span><span class="o">=</span><span class="sb">`</span>sw_vers -productName<span class="sb">`</span>
        <span class="nv">os_RELEASE</span><span class="o">=</span><span class="sb">`</span>sw_vers -productVersion<span class="sb">`</span>
        <span class="nv">os_UPDATE</span><span class="o">=</span><span class="k">${</span><span class="nv">os_RELEASE</span><span class="p">##*.</span><span class="k">}</span>
        <span class="nv">os_RELEASE</span><span class="o">=</span><span class="k">${</span><span class="nv">os_RELEASE</span><span class="p">%.*</span><span class="k">}</span>
        <span class="nv">os_PACKAGE</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$os_RELEASE&quot;</span> <span class="o">=</span>~ <span class="s2">&quot;10.7&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            </span><span class="nv">os_CODENAME</span><span class="o">=</span><span class="s2">&quot;lion&quot;</span>
        <span class="k">elif</span> <span class="o">[[</span> <span class="s2">&quot;$os_RELEASE&quot;</span> <span class="o">=</span>~ <span class="s2">&quot;10.6&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            </span><span class="nv">os_CODENAME</span><span class="o">=</span><span class="s2">&quot;snow leopard&quot;</span>
        <span class="k">elif</span> <span class="o">[[</span> <span class="s2">&quot;$os_RELEASE&quot;</span> <span class="o">=</span>~ <span class="s2">&quot;10.5&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            </span><span class="nv">os_CODENAME</span><span class="o">=</span><span class="s2">&quot;leopard&quot;</span>
        <span class="k">elif</span> <span class="o">[[</span> <span class="s2">&quot;$os_RELEASE&quot;</span> <span class="o">=</span>~ <span class="s2">&quot;10.4&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            </span><span class="nv">os_CODENAME</span><span class="o">=</span><span class="s2">&quot;tiger&quot;</span>
        <span class="k">elif</span> <span class="o">[[</span> <span class="s2">&quot;$os_RELEASE&quot;</span> <span class="o">=</span>~ <span class="s2">&quot;10.3&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            </span><span class="nv">os_CODENAME</span><span class="o">=</span><span class="s2">&quot;panther&quot;</span>
        <span class="k">else</span>
<span class="k">            </span><span class="nv">os_CODENAME</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
        <span class="k">fi</span>
<span class="k">    elif</span> <span class="o">[[</span> -x <span class="k">$(</span>which lsb_release 2&gt;/dev/null<span class="k">)</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nv">os_VENDOR</span><span class="o">=</span><span class="k">$(</span>lsb_release -i -s<span class="k">)</span>
        <span class="nv">os_RELEASE</span><span class="o">=</span><span class="k">$(</span>lsb_release -r -s<span class="k">)</span>
        <span class="nv">os_UPDATE</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
        <span class="nv">os_PACKAGE</span><span class="o">=</span><span class="s2">&quot;rpm&quot;</span>
        <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;Debian,Ubuntu,LinuxMint&quot;</span> <span class="o">=</span>~ <span class="nv">$os_VENDOR</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            </span><span class="nv">os_PACKAGE</span><span class="o">=</span><span class="s2">&quot;deb&quot;</span>
        <span class="k">elif</span> <span class="o">[[</span> <span class="s2">&quot;SUSE LINUX&quot;</span> <span class="o">=</span>~ <span class="nv">$os_VENDOR</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            </span>lsb_release -d -s | grep -q openSUSE
            <span class="k">if</span> <span class="o">[[</span> <span class="nv">$?</span> -eq 0 <span class="o">]]</span>; <span class="k">then</span>
<span class="k">                </span><span class="nv">os_VENDOR</span><span class="o">=</span><span class="s2">&quot;openSUSE&quot;</span>
            <span class="k">fi</span>
<span class="k">        elif</span> <span class="o">[[</span> <span class="nv">$os_VENDOR</span> <span class="o">==</span> <span class="s2">&quot;openSUSE project&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            </span><span class="nv">os_VENDOR</span><span class="o">=</span><span class="s2">&quot;openSUSE&quot;</span>
        <span class="k">elif</span> <span class="o">[[</span> <span class="nv">$os_VENDOR</span> <span class="o">=</span>~ Red.*Hat <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            </span><span class="nv">os_VENDOR</span><span class="o">=</span><span class="s2">&quot;Red Hat&quot;</span>
        <span class="k">fi</span>
<span class="k">        </span><span class="nv">os_CODENAME</span><span class="o">=</span><span class="k">$(</span>lsb_release -c -s<span class="k">)</span>
    <span class="k">elif</span> <span class="o">[[</span> -r /etc/redhat-release <span class="o">]]</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>Red Hat Enterprise Linux Server release 5.5 (Tikanga)
Red Hat Enterprise Linux Server release 7.0 Beta (Maipo)
CentOS release 5.5 (Final)
CentOS Linux release 6.0 (Final)
Fedora release 16 (Verne)
XenServer release 6.2.0-70446c (xenenterprise)</p>
</td><td class=code><div class=highlight><pre>
        <span class="nv">os_CODENAME</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
        <span class="k">for </span>r in <span class="s2">&quot;Red Hat&quot;</span> CentOS Fedora XenServer; <span class="k">do</span>
<span class="k">            </span><span class="nv">os_VENDOR</span><span class="o">=</span><span class="nv">$r</span>
            <span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&quot;`grep \&quot;$r\&quot; /etc/redhat-release`&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">                </span><span class="nv">ver</span><span class="o">=</span><span class="sb">`</span>sed -e <span class="s1">&#39;s/^.* \([0-9].*\) (\(.*\)).*$/\1\|\2/&#39;</span> /etc/redhat-release<span class="sb">`</span>
                <span class="nv">os_CODENAME</span><span class="o">=</span><span class="k">${</span><span class="nv">ver</span><span class="p">#*|</span><span class="k">}</span>
                <span class="nv">os_RELEASE</span><span class="o">=</span><span class="k">${</span><span class="nv">ver</span><span class="p">%|*</span><span class="k">}</span>
                <span class="nv">os_UPDATE</span><span class="o">=</span><span class="k">${</span><span class="nv">os_RELEASE</span><span class="p">##*.</span><span class="k">}</span>
                <span class="nv">os_RELEASE</span><span class="o">=</span><span class="k">${</span><span class="nv">os_RELEASE</span><span class="p">%.*</span><span class="k">}</span>
                <span class="nb">break</span>
<span class="nb">            </span><span class="k">fi</span>
<span class="k">            </span><span class="nv">os_VENDOR</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
        <span class="k">done</span>
<span class="k">        </span><span class="nv">os_PACKAGE</span><span class="o">=</span><span class="s2">&quot;rpm&quot;</span>
    <span class="k">elif</span> <span class="o">[[</span> -r /etc/SuSE-release <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        for </span>r in openSUSE <span class="s2">&quot;SUSE Linux&quot;</span>; <span class="k">do</span>
<span class="k">            if</span> <span class="o">[[</span> <span class="s2">&quot;$r&quot;</span> <span class="o">=</span> <span class="s2">&quot;SUSE Linux&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">                </span><span class="nv">os_VENDOR</span><span class="o">=</span><span class="s2">&quot;SUSE LINUX&quot;</span>
            <span class="k">else</span>
<span class="k">                </span><span class="nv">os_VENDOR</span><span class="o">=</span><span class="nv">$r</span>
            <span class="k">fi</span>

<span class="k">            if</span> <span class="o">[[</span> -n <span class="s2">&quot;`grep \&quot;$r\&quot; /etc/SuSE-release`&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">                </span><span class="nv">os_CODENAME</span><span class="o">=</span><span class="sb">`</span>grep <span class="s2">&quot;CODENAME = &quot;</span> /etc/SuSE-release | sed <span class="s1">&#39;s:.* = ::g&#39;</span><span class="sb">`</span>
                <span class="nv">os_RELEASE</span><span class="o">=</span><span class="sb">`</span>grep <span class="s2">&quot;VERSION = &quot;</span> /etc/SuSE-release | sed <span class="s1">&#39;s:.* = ::g&#39;</span><span class="sb">`</span>
                <span class="nv">os_UPDATE</span><span class="o">=</span><span class="sb">`</span>grep <span class="s2">&quot;PATCHLEVEL = &quot;</span> /etc/SuSE-release | sed <span class="s1">&#39;s:.* = ::g&#39;</span><span class="sb">`</span>
                <span class="nb">break</span>
<span class="nb">            </span><span class="k">fi</span>
<span class="k">            </span><span class="nv">os_VENDOR</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
        <span class="k">done</span>
<span class="k">        </span><span class="nv">os_PACKAGE</span><span class="o">=</span><span class="s2">&quot;rpm&quot;</span>
</pre></div></td></tr><tr><td class=docs>
<p>If lsb_release is not installed, we should be able to detect Debian OS</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">elif</span> <span class="o">[[</span> -f /etc/debian_version <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="o">[[</span> <span class="k">$(</span>cat /proc/version<span class="k">)</span> <span class="o">=</span>~ <span class="s2">&quot;Debian&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nv">os_VENDOR</span><span class="o">=</span><span class="s2">&quot;Debian&quot;</span>
        <span class="nv">os_PACKAGE</span><span class="o">=</span><span class="s2">&quot;deb&quot;</span>
        <span class="nv">os_CODENAME</span><span class="o">=</span><span class="k">$(</span>awk <span class="s1">&#39;/VERSION=/&#39;</span> /etc/os-release | sed <span class="s1">&#39;s/VERSION=//&#39;</span> | sed -r <span class="s1">&#39;s/\&quot;|\(|\)//g&#39;</span> | awk <span class="s1">&#39;{print $2}&#39;</span><span class="k">)</span>
        <span class="nv">os_RELEASE</span><span class="o">=</span><span class="k">$(</span>awk <span class="s1">&#39;/VERSION_ID=/&#39;</span> /etc/os-release | sed <span class="s1">&#39;s/VERSION_ID=//&#39;</span> | sed <span class="s1">&#39;s/\&quot;//g&#39;</span><span class="k">)</span>
    <span class="k">fi</span>
<span class="k">    </span><span class="nb">export </span>os_VENDOR os_RELEASE os_UPDATE os_PACKAGE os_CODENAME
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Translate the OS version values into common nomenclature
Sets global <tt class="docutils literal">DISTRO</tt> from the <tt class="docutils literal">os_*</tt> values</p>
</td><td class=code><div class=highlight><pre>
<span class="nb">declare </span>DISTRO

<span class="k">function </span>GetDistro <span class="o">{</span>
    GetOSVersion
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$os_VENDOR&quot;</span> <span class="o">=</span>~ <span class="o">(</span>Ubuntu<span class="o">)</span> <span class="o">||</span> <span class="s2">&quot;$os_VENDOR&quot;</span> <span class="o">=</span>~ <span class="o">(</span>Debian<span class="o">)</span> <span class="o">]]</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>'Everyone' refers to Ubuntu / Debian releases by the code name adjective</p>
</td><td class=code><div class=highlight><pre>
        <span class="nv">DISTRO</span><span class="o">=</span><span class="nv">$os_CODENAME</span>
    <span class="k">elif</span> <span class="o">[[</span> <span class="s2">&quot;$os_VENDOR&quot;</span> <span class="o">=</span>~ <span class="o">(</span>Fedora<span class="o">)</span> <span class="o">]]</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>For Fedora, just use 'f' and the release</p>
</td><td class=code><div class=highlight><pre>
        <span class="nv">DISTRO</span><span class="o">=</span><span class="s2">&quot;f$os_RELEASE&quot;</span>
    <span class="k">elif</span> <span class="o">[[</span> <span class="s2">&quot;$os_VENDOR&quot;</span> <span class="o">=</span>~ <span class="o">(</span>openSUSE<span class="o">)</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nv">DISTRO</span><span class="o">=</span><span class="s2">&quot;opensuse-$os_RELEASE&quot;</span>
    <span class="k">elif</span> <span class="o">[[</span> <span class="s2">&quot;$os_VENDOR&quot;</span> <span class="o">=</span>~ <span class="o">(</span>SUSE LINUX<span class="o">)</span> <span class="o">]]</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>For SLE, also use the service pack</p>
</td><td class=code><div class=highlight><pre>
        <span class="k">if</span> <span class="o">[[</span> -z <span class="s2">&quot;$os_UPDATE&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            </span><span class="nv">DISTRO</span><span class="o">=</span><span class="s2">&quot;sle${os_RELEASE}&quot;</span>
        <span class="k">else</span>
<span class="k">            </span><span class="nv">DISTRO</span><span class="o">=</span><span class="s2">&quot;sle${os_RELEASE}sp${os_UPDATE}&quot;</span>
        <span class="k">fi</span>
<span class="k">    elif</span> <span class="o">[[</span> <span class="s2">&quot;$os_VENDOR&quot;</span> <span class="o">=</span>~ <span class="o">(</span>Red Hat<span class="o">)</span> <span class="o">||</span> <span class="se">\</span>
        <span class="s2">&quot;$os_VENDOR&quot;</span> <span class="o">=</span>~ <span class="o">(</span>CentOS<span class="o">)</span> <span class="o">||</span> <span class="se">\</span>
        <span class="s2">&quot;$os_VENDOR&quot;</span> <span class="o">=</span>~ <span class="o">(</span>OracleServer<span class="o">)</span> <span class="o">]]</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>Drop the . release as we assume it's compatible</p>
</td><td class=code><div class=highlight><pre>
        <span class="nv">DISTRO</span><span class="o">=</span><span class="s2">&quot;rhel${os_RELEASE::1}&quot;</span>
    <span class="k">elif</span> <span class="o">[[</span> <span class="s2">&quot;$os_VENDOR&quot;</span> <span class="o">=</span>~ <span class="o">(</span>XenServer<span class="o">)</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nv">DISTRO</span><span class="o">=</span><span class="s2">&quot;xs$os_RELEASE&quot;</span>
    <span class="k">else</span>
</pre></div></td></tr><tr><td class=docs>
<p>Catch-all for now is Vendor + Release + Update</p>
</td><td class=code><div class=highlight><pre>
        <span class="nv">DISTRO</span><span class="o">=</span><span class="s2">&quot;$os_VENDOR-$os_RELEASE.$os_UPDATE&quot;</span>
    <span class="k">fi</span>
<span class="k">    </span><span class="nb">export </span>DISTRO
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Utility function for checking machine architecture
is_arch arch-type</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>is_arch <span class="o">{</span>
    <span class="o">[[</span> <span class="s2">&quot;$(uname -m)&quot;</span> <span class="o">==</span> <span class="s2">&quot;$1&quot;</span> <span class="o">]]</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Quick check for a rackspace host; n.b. rackspace provided images
have these Xen tools installed but a custom image may not.</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>is_rackspace <span class="o">{</span>
    <span class="o">[</span> -f /usr/bin/xenstore-ls <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="se">\</span>
        sudo /usr/bin/xenstore-ls vm-data | grep -q <span class="s2">&quot;Rackspace&quot;</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Determine if current distribution is a Fedora-based distribution
(Fedora, RHEL, CentOS, etc).
is_fedora</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>is_fedora <span class="o">{</span>
    <span class="k">if</span> <span class="o">[[</span> -z <span class="s2">&quot;$os_VENDOR&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span>GetOSVersion
    <span class="k">fi</span>

    <span class="o">[</span> <span class="s2">&quot;$os_VENDOR&quot;</span> <span class="o">=</span> <span class="s2">&quot;Fedora&quot;</span> <span class="o">]</span> <span class="o">||</span> <span class="o">[</span> <span class="s2">&quot;$os_VENDOR&quot;</span> <span class="o">=</span> <span class="s2">&quot;Red Hat&quot;</span> <span class="o">]</span> <span class="o">||</span> <span class="se">\</span>
        <span class="o">[</span> <span class="s2">&quot;$os_VENDOR&quot;</span> <span class="o">=</span> <span class="s2">&quot;CentOS&quot;</span> <span class="o">]</span> <span class="o">||</span> <span class="o">[</span> <span class="s2">&quot;$os_VENDOR&quot;</span> <span class="o">=</span> <span class="s2">&quot;OracleServer&quot;</span> <span class="o">]</span>
<span class="o">}</span>


</pre></div></td></tr><tr><td class=docs>
<p>Determine if current distribution is a SUSE-based distribution
(openSUSE, SLE).
is_suse</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>is_suse <span class="o">{</span>
    <span class="k">if</span> <span class="o">[[</span> -z <span class="s2">&quot;$os_VENDOR&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span>GetOSVersion
    <span class="k">fi</span>

    <span class="o">[</span> <span class="s2">&quot;$os_VENDOR&quot;</span> <span class="o">=</span> <span class="s2">&quot;openSUSE&quot;</span> <span class="o">]</span> <span class="o">||</span> <span class="o">[</span> <span class="s2">&quot;$os_VENDOR&quot;</span> <span class="o">=</span> <span class="s2">&quot;SUSE LINUX&quot;</span> <span class="o">]</span>
<span class="o">}</span>


</pre></div></td></tr><tr><td class=docs>
<p>Determine if current distribution is an Ubuntu-based distribution
It will also detect non-Ubuntu but Debian-based distros
is_ubuntu</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>is_ubuntu <span class="o">{</span>
    <span class="k">if</span> <span class="o">[[</span> -z <span class="s2">&quot;$os_PACKAGE&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span>GetOSVersion
    <span class="k">fi</span>
    <span class="o">[</span> <span class="s2">&quot;$os_PACKAGE&quot;</span> <span class="o">=</span> <span class="s2">&quot;deb&quot;</span> <span class="o">]</span>
<span class="o">}</span>


</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="git-functions">
<h1>Git Functions</h1>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Returns openstack release name for a given branch name
<tt class="docutils literal">get_release_name_from_branch <span class="pre">branch-name</span></tt></p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>get_release_name_from_branch <span class="o">{</span>
    <span class="nb">local </span><span class="nv">branch</span><span class="o">=</span><span class="nv">$1</span>

    <span class="k">if</span> <span class="o">[[</span> <span class="nv">$branch</span> <span class="o">=</span>~ <span class="s2">&quot;stable/&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nb">echo</span> <span class="k">${</span><span class="nv">branch</span><span class="p">#*/</span><span class="k">}</span>
    <span class="k">else</span>
<span class="k">        </span><span class="nb">echo</span> <span class="s2">&quot;master&quot;</span>
    <span class="k">fi</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>git clone only if directory doesn't exist already.  Since <tt class="docutils literal">DEST</tt> might not
be owned by the installation user, we create the directory and change the
ownership to the proper user.
Set global <tt class="docutils literal">RECLONE=yes</tt> to simulate a clone when dest-dir exists
Set global <tt class="docutils literal">ERROR_ON_CLONE=True</tt> to abort execution with an error if the git repo
does not exist (default is False, meaning the repo will be cloned).
Uses globals <tt class="docutils literal">ERROR_ON_CLONE</tt>, <tt class="docutils literal">OFFLINE</tt>, <tt class="docutils literal">RECLONE</tt>
git_clone remote dest-dir branch</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>git_clone <span class="o">{</span>
    <span class="nb">local </span><span class="nv">git_remote</span><span class="o">=</span><span class="nv">$1</span>
    <span class="nb">local </span><span class="nv">git_dest</span><span class="o">=</span><span class="nv">$2</span>
    <span class="nb">local </span><span class="nv">git_ref</span><span class="o">=</span><span class="nv">$3</span>
    <span class="nb">local </span><span class="nv">orig_dir</span><span class="o">=</span><span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span>

    <span class="nv">RECLONE</span><span class="o">=</span><span class="k">$(</span>trueorfalse False <span class="nv">$RECLONE</span><span class="k">)</span>

    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$OFFLINE&quot;</span> <span class="o">=</span> <span class="s2">&quot;True&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nb">echo</span> <span class="s2">&quot;Running in offline mode, clones already exist&quot;</span>
</pre></div></td></tr><tr><td class=docs>
<p>print out the results so we know what change was used in the logs</p>
</td><td class=code><div class=highlight><pre>
        <span class="nb">cd</span> <span class="nv">$git_dest</span>
        git show --oneline | head -1
        <span class="nb">cd</span> <span class="nv">$orig_dir</span>
        <span class="k">return</span>
<span class="k">    fi</span>

<span class="k">    if </span><span class="nb">echo</span> <span class="nv">$git_ref</span> | egrep -q <span class="s2">&quot;^refs&quot;</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>If our branch name is a gerrit style refs/changes/...</p>
</td><td class=code><div class=highlight><pre>
        <span class="k">if</span> <span class="o">[[</span> ! -d <span class="nv">$git_dest</span> <span class="o">]]</span>; <span class="k">then</span>
            <span class="o">[[</span> <span class="s2">&quot;$ERROR_ON_CLONE&quot;</span> <span class="o">=</span> <span class="s2">&quot;True&quot;</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="se">\</span>
                die <span class="nv">$LINENO</span> <span class="s2">&quot;Cloning not allowed in this configuration&quot;</span>
            git_timed clone <span class="nv">$git_remote</span> <span class="nv">$git_dest</span>
        <span class="k">fi</span>
<span class="k">        </span><span class="nb">cd</span> <span class="nv">$git_dest</span>
        git_timed fetch <span class="nv">$git_remote</span> <span class="nv">$git_ref</span> <span class="o">&amp;&amp;</span> git checkout FETCH_HEAD
    <span class="k">else</span>
</pre></div></td></tr><tr><td class=docs>
<p>do a full clone only if the directory doesn't exist</p>
</td><td class=code><div class=highlight><pre>
        <span class="k">if</span> <span class="o">[[</span> ! -d <span class="nv">$git_dest</span> <span class="o">]]</span>; <span class="k">then</span>
            <span class="o">[[</span> <span class="s2">&quot;$ERROR_ON_CLONE&quot;</span> <span class="o">=</span> <span class="s2">&quot;True&quot;</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="se">\</span>
                die <span class="nv">$LINENO</span> <span class="s2">&quot;Cloning not allowed in this configuration&quot;</span>
            git_timed clone <span class="nv">$git_remote</span> <span class="nv">$git_dest</span>
            <span class="nb">cd</span> <span class="nv">$git_dest</span>
</pre></div></td></tr><tr><td class=docs>
<p>This checkout syntax works for both branches and tags</p>
</td><td class=code><div class=highlight><pre>
            git checkout <span class="nv">$git_ref</span>
        <span class="k">elif</span> <span class="o">[[</span> <span class="s2">&quot;$RECLONE&quot;</span> <span class="o">=</span> <span class="s2">&quot;True&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>if it does exist then simulate what clone does if asked to RECLONE</p>
</td><td class=code><div class=highlight><pre>
            <span class="nb">cd</span> <span class="nv">$git_dest</span>
</pre></div></td></tr><tr><td class=docs>
<p>set the url to pull from and fetch</p>
</td><td class=code><div class=highlight><pre>
            git remote <span class="nb">set</span>-url origin <span class="nv">$git_remote</span>
            git_timed fetch origin
</pre></div></td></tr><tr><td class=docs>
<p>remove the existing ignored files (like pyc) as they cause breakage
(due to the py files having older timestamps than our pyc, so python
thinks the pyc files are correct using them)</p>
</td><td class=code><div class=highlight><pre>
            find <span class="nv">$git_dest</span> -name <span class="s1">&#39;*.pyc&#39;</span> -delete

</pre></div></td></tr><tr><td class=docs>
<p>handle git_ref accordingly to type (tag, branch)</p>
</td><td class=code><div class=highlight><pre>
            <span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&quot;`git show-ref refs/tags/$git_ref`&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">                </span>git_update_tag <span class="nv">$git_ref</span>
            <span class="k">elif</span> <span class="o">[[</span> -n <span class="s2">&quot;`git show-ref refs/heads/$git_ref`&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">                </span>git_update_branch <span class="nv">$git_ref</span>
            <span class="k">elif</span> <span class="o">[[</span> -n <span class="s2">&quot;`git show-ref refs/remotes/origin/$git_ref`&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">                </span>git_update_remote_branch <span class="nv">$git_ref</span>
            <span class="k">else</span>
<span class="k">                </span>die <span class="nv">$LINENO</span> <span class="s2">&quot;$git_ref is neither branch nor tag&quot;</span>
            <span class="k">fi</span>

<span class="k">        fi</span>
<span class="k">    fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>print out the results so we know what change was used in the logs</p>
</td><td class=code><div class=highlight><pre>
    <span class="nb">cd</span> <span class="nv">$git_dest</span>
    git show --oneline | head -1
    <span class="nb">cd</span> <span class="nv">$orig_dir</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>A variation on git clone that lets us specify a project by it's
actual name, like oslo.config. This is exceptionally useful in the
library installation case</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>git_clone_by_name <span class="o">{</span>
    <span class="nb">local </span><span class="nv">name</span><span class="o">=</span><span class="nv">$1</span>
    <span class="nb">local </span><span class="nv">repo</span><span class="o">=</span><span class="k">${</span><span class="nv">GITREPO</span><span class="p">[</span><span class="nv">$name</span><span class="p">]</span><span class="k">}</span>
    <span class="nb">local </span><span class="nv">dir</span><span class="o">=</span><span class="k">${</span><span class="nv">GITDIR</span><span class="p">[</span><span class="nv">$name</span><span class="p">]</span><span class="k">}</span>
    <span class="nb">local </span><span class="nv">branch</span><span class="o">=</span><span class="k">${</span><span class="nv">GITBRANCH</span><span class="p">[</span><span class="nv">$name</span><span class="p">]</span><span class="k">}</span>
    git_clone <span class="nv">$repo</span> <span class="nv">$dir</span> <span class="nv">$branch</span>
<span class="o">}</span>


</pre></div></td></tr><tr><td class=docs>
<p>git can sometimes get itself infinitely stuck with transient network
errors or other issues with the remote end.  This wraps git in a
timeout/retry loop and is intended to watch over non-local git
processes that might hang.  GIT_TIMEOUT, if set, is passed directly
to timeout(1); otherwise the default value of 0 maintains the status
quo of waiting forever.
usage: git_timed &lt;git-command&gt;</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>git_timed <span class="o">{</span>
    <span class="nb">local </span><span class="nv">count</span><span class="o">=</span>0
    <span class="nb">local </span><span class="nv">timeout</span><span class="o">=</span>0

    <span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&quot;${GIT_TIMEOUT}&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nv">timeout</span><span class="o">=</span><span class="k">${</span><span class="nv">GIT_TIMEOUT</span><span class="k">}</span>
    <span class="k">fi</span>

<span class="k">    until </span>timeout -s SIGINT <span class="k">${</span><span class="nv">timeout</span><span class="k">}</span> git <span class="s2">&quot;$@&quot;</span>; <span class="k">do</span>
</pre></div></td></tr><tr><td class=docs>
<p>124 is timeout(1)'s special return code when it reached the
timeout; otherwise assume fatal failure</p>
</td><td class=code><div class=highlight><pre>
        <span class="k">if</span> <span class="o">[[</span> <span class="nv">$?</span> -ne 124 <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            </span>die <span class="nv">$LINENO</span> <span class="s2">&quot;git call failed: [git $@]&quot;</span>
        <span class="k">fi</span>

<span class="k">        </span><span class="nv">count</span><span class="o">=</span><span class="k">$((</span><span class="nv">$count</span> <span class="o">+</span> <span class="m">1</span><span class="k">))</span>
        warn <span class="s2">&quot;timeout ${count} for git call: [git $@]&quot;</span>
        <span class="k">if</span> <span class="o">[</span> <span class="nv">$count</span> -eq 3 <span class="o">]</span>; <span class="k">then</span>
<span class="k">            </span>die <span class="nv">$LINENO</span> <span class="s2">&quot;Maximum of 3 git retries reached&quot;</span>
        <span class="k">fi</span>
<span class="k">        </span>sleep 5
    <span class="k">done</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>git update using reference as a branch.
git_update_branch ref</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>git_update_branch <span class="o">{</span>
    <span class="nb">local </span><span class="nv">git_branch</span><span class="o">=</span><span class="nv">$1</span>

    git checkout -f origin/<span class="nv">$git_branch</span>
</pre></div></td></tr><tr><td class=docs>
<p>a local branch might not exist</p>
</td><td class=code><div class=highlight><pre>
    git branch -D <span class="nv">$git_branch</span> <span class="o">||</span> <span class="nb">true</span>
<span class="nb">    </span>git checkout -b <span class="nv">$git_branch</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>git update using reference as a branch.
git_update_remote_branch ref</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>git_update_remote_branch <span class="o">{</span>
    <span class="nb">local </span><span class="nv">git_branch</span><span class="o">=</span><span class="nv">$1</span>

    git checkout -b <span class="nv">$git_branch</span> -t origin/<span class="nv">$git_branch</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>git update using reference as a tag. Be careful editing source at that repo
as working copy will be in a detached mode
git_update_tag ref</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>git_update_tag <span class="o">{</span>
    <span class="nb">local </span><span class="nv">git_tag</span><span class="o">=</span><span class="nv">$1</span>

    git tag -d <span class="nv">$git_tag</span>
</pre></div></td></tr><tr><td class=docs>
<p>fetching given tag only</p>
</td><td class=code><div class=highlight><pre>
    git_timed fetch origin tag <span class="nv">$git_tag</span>
    git checkout -f <span class="nv">$git_tag</span>
<span class="o">}</span>


</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="openstack-functions">
<h1>OpenStack Functions</h1>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Get the default value for HOST_IP
get_default_host_ip fixed_range floating_range host_ip_iface host_ip</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>get_default_host_ip <span class="o">{</span>
    <span class="nb">local </span><span class="nv">fixed_range</span><span class="o">=</span><span class="nv">$1</span>
    <span class="nb">local </span><span class="nv">floating_range</span><span class="o">=</span><span class="nv">$2</span>
    <span class="nb">local </span><span class="nv">host_ip_iface</span><span class="o">=</span><span class="nv">$3</span>
    <span class="nb">local </span><span class="nv">host_ip</span><span class="o">=</span><span class="nv">$4</span>

</pre></div></td></tr><tr><td class=docs>
<p>Find the interface used for the default route</p>
</td><td class=code><div class=highlight><pre>
    <span class="nv">host_ip_iface</span><span class="o">=</span><span class="k">${</span><span class="nv">host_ip_iface</span><span class="k">:-$(</span>ip route | sed -n <span class="s1">&#39;/^default/{ s/.*dev \(\w\+\)\s\+.*/\1/; p; }&#39;</span> | head -1<span class="k">)}</span>
</pre></div></td></tr><tr><td class=docs>
<p>Search for an IP unless an explicit is set by <tt class="docutils literal">HOST_IP</tt> environment variable</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;$host_ip&quot;</span> -o <span class="s2">&quot;$host_ip&quot;</span> <span class="o">==</span> <span class="s2">&quot;dhcp&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nv">host_ip</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
        <span class="nb">local </span><span class="nv">host_ips</span><span class="o">=</span><span class="k">$(</span><span class="nv">LC_ALL</span><span class="o">=</span>C ip -f inet addr show <span class="k">${</span><span class="nv">host_ip_iface</span><span class="k">}</span> | awk <span class="s1">&#39;/inet/ {split($2,parts,&quot;/&quot;);  print parts[1]}&#39;</span><span class="k">)</span>
        <span class="nb">local </span>ip
        <span class="k">for </span>ip in <span class="nv">$host_ips</span>; <span class="k">do</span>
</pre></div></td></tr><tr><td class=docs>
<p>Attempt to filter out IP addresses that are part of the fixed and
floating range. Note that this method only works if the <tt class="docutils literal">netaddr</tt>
python library is installed. If it is not installed, an error
will be printed and the first IP from the interface will be used.
If that is not correct set <tt class="docutils literal">HOST_IP</tt> in <tt class="docutils literal">localrc</tt> to the correct
address.</p>
</td><td class=code><div class=highlight><pre>
            <span class="k">if</span> ! <span class="o">(</span>address_in_net <span class="nv">$ip</span> <span class="nv">$fixed_range</span> <span class="o">||</span> address_in_net <span class="nv">$ip</span> <span class="nv">$floating_range</span><span class="o">)</span>; <span class="k">then</span>
<span class="k">                </span><span class="nv">host_ip</span><span class="o">=</span><span class="nv">$ip</span>
                <span class="nb">break</span>;
            <span class="k">fi</span>
<span class="k">        done</span>
<span class="k">    fi</span>
<span class="k">    </span><span class="nb">echo</span> <span class="nv">$host_ip</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Generates hex string from <tt class="docutils literal">size</tt> byte of pseudo random data
generate_hex_string size</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>generate_hex_string <span class="o">{</span>
    <span class="nb">local </span><span class="nv">size</span><span class="o">=</span><span class="nv">$1</span>
    hexdump -n <span class="s2">&quot;$size&quot;</span> -v -e <span class="s1">&#39;/1 &quot;%02x&quot;&#39;</span> /dev/urandom
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Grab a numbered field from python prettytable output
Fields are numbered starting with 1
Reverse syntax is supported: -1 is the last field, -2 is second to last, etc.
get_field field-number</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>get_field <span class="o">{</span>
    <span class="nb">local </span>data field
    <span class="k">while </span><span class="nb">read </span>data; <span class="k">do</span>
<span class="k">        if</span> <span class="o">[</span> <span class="s2">&quot;$1&quot;</span> -lt 0 <span class="o">]</span>; <span class="k">then</span>
<span class="k">            </span><span class="nv">field</span><span class="o">=</span><span class="s2">&quot;(\$(NF$1))&quot;</span>
        <span class="k">else</span>
<span class="k">            </span><span class="nv">field</span><span class="o">=</span><span class="s2">&quot;\$$(($1 + 1))&quot;</span>
        <span class="k">fi</span>
<span class="k">        </span><span class="nb">echo</span> <span class="s2">&quot;$data&quot;</span> | awk -F<span class="s1">&#39;[ \t]*\\|[ \t]*&#39;</span> <span class="s2">&quot;{print $field}&quot;</span>
    <span class="k">done</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Add a policy to a policy.json file
Do nothing if the policy already exists
<tt class="docutils literal">policy_add policy_file policy_name policy_permissions</tt></p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>policy_add <span class="o">{</span>
    <span class="nb">local </span><span class="nv">policy_file</span><span class="o">=</span><span class="nv">$1</span>
    <span class="nb">local </span><span class="nv">policy_name</span><span class="o">=</span><span class="nv">$2</span>
    <span class="nb">local </span><span class="nv">policy_perm</span><span class="o">=</span><span class="nv">$3</span>

    <span class="k">if </span>grep -q <span class="k">${</span><span class="nv">policy_name</span><span class="k">}</span> <span class="k">${</span><span class="nv">policy_file</span><span class="k">}</span>; <span class="k">then</span>
<span class="k">        </span><span class="nb">echo</span> <span class="s2">&quot;Policy ${policy_name} already exists in ${policy_file}&quot;</span>
        <span class="k">return</span>
<span class="k">    fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Add a terminating comma to policy lines without one
Remove the closing '}' and all lines following to the end-of-file</p>
</td><td class=code><div class=highlight><pre>
    <span class="nb">local </span><span class="nv">tmpfile</span><span class="o">=</span><span class="k">$(</span>mktemp<span class="k">)</span>
    uniq <span class="k">${</span><span class="nv">policy_file</span><span class="k">}</span> | sed -e <span class="s1">&#39;</span>
<span class="s1">        s/]$/],/</span>
<span class="s1">        /^[}]/,$d</span>
<span class="s1">    &#39;</span> &gt; <span class="k">${</span><span class="nv">tmpfile</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Append policy and closing brace</p>
</td><td class=code><div class=highlight><pre>
    <span class="nb">echo</span> <span class="s2">&quot;    \&quot;${policy_name}\&quot;: ${policy_perm}&quot;</span> &gt;&gt;<span class="k">${</span><span class="nv">tmpfile</span><span class="k">}</span>
    <span class="nb">echo</span> <span class="s2">&quot;}&quot;</span> &gt;&gt;<span class="k">${</span><span class="nv">tmpfile</span><span class="k">}</span>

    mv <span class="k">${</span><span class="nv">tmpfile</span><span class="k">}</span> <span class="k">${</span><span class="nv">policy_file</span><span class="k">}</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Gets or creates user
Usage: get_or_create_user &lt;username&gt; &lt;password&gt; &lt;project&gt; [&lt;email&gt;]</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>get_or_create_user <span class="o">{</span>
    <span class="k">if</span> <span class="o">[[</span> ! -z <span class="s2">&quot;$4&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nb">local </span><span class="nv">email</span><span class="o">=</span><span class="s2">&quot;--email=$4&quot;</span>
    <span class="k">else</span>
<span class="k">        </span><span class="nb">local </span><span class="nv">email</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
    <span class="k">fi</span>
</pre></div></td></tr><tr><td class=docs>
<p>Gets user id</p>
</td><td class=code><div class=highlight><pre>
    <span class="nb">local </span><span class="nv">user_id</span><span class="o">=</span><span class="k">$(</span>
</pre></div></td></tr><tr><td class=docs>
<p>Gets user id</p>
</td><td class=code><div class=highlight><pre>
        openstack user show <span class="nv">$1</span> -f value -c id 2&gt;/dev/null <span class="o">||</span>
</pre></div></td></tr><tr><td class=docs>
<p>Creates new user</p>
</td><td class=code><div class=highlight><pre>
        openstack user create <span class="se">\</span>
            <span class="nv">$1</span> <span class="se">\</span>
            --password <span class="s2">&quot;$2&quot;</span> <span class="se">\</span>
            --project <span class="nv">$3</span> <span class="se">\</span>
            <span class="nv">$email</span> <span class="se">\</span>
            -f value -c id
    <span class="k">)</span>
    <span class="nb">echo</span> <span class="nv">$user_id</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Gets or creates project
Usage: get_or_create_project &lt;name&gt;</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>get_or_create_project <span class="o">{</span>
</pre></div></td></tr><tr><td class=docs>
<p>Gets project id</p>
</td><td class=code><div class=highlight><pre>
    <span class="nb">local </span><span class="nv">project_id</span><span class="o">=</span><span class="k">$(</span>
</pre></div></td></tr><tr><td class=docs>
<p>Gets project id</p>
</td><td class=code><div class=highlight><pre>
        openstack project show <span class="nv">$1</span> -f value -c id 2&gt;/dev/null <span class="o">||</span>
</pre></div></td></tr><tr><td class=docs>
<p>Creates new project if not exists</p>
</td><td class=code><div class=highlight><pre>
        openstack project create <span class="nv">$1</span> -f value -c id
    <span class="k">)</span>
    <span class="nb">echo</span> <span class="nv">$project_id</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Gets or creates role
Usage: get_or_create_role &lt;name&gt;</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>get_or_create_role <span class="o">{</span>
    <span class="nb">local </span><span class="nv">role_id</span><span class="o">=</span><span class="k">$(</span>
</pre></div></td></tr><tr><td class=docs>
<p>Gets role id</p>
</td><td class=code><div class=highlight><pre>
        openstack role show <span class="nv">$1</span> -f value -c id 2&gt;/dev/null <span class="o">||</span>
</pre></div></td></tr><tr><td class=docs>
<p>Creates role if not exists</p>
</td><td class=code><div class=highlight><pre>
        openstack role create <span class="nv">$1</span> -f value -c id
    <span class="k">)</span>
    <span class="nb">echo</span> <span class="nv">$role_id</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Gets or adds user role
Usage: get_or_add_user_role &lt;role&gt; &lt;user&gt; &lt;project&gt;</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>get_or_add_user_role <span class="o">{</span>
</pre></div></td></tr><tr><td class=docs>
<p>Gets user role id</p>
</td><td class=code><div class=highlight><pre>
    <span class="nb">local </span><span class="nv">user_role_id</span><span class="o">=</span><span class="k">$(</span>openstack user role list <span class="se">\</span>
        <span class="nv">$2</span> <span class="se">\</span>
        --project <span class="nv">$3</span> <span class="se">\</span>
        --column <span class="s2">&quot;ID&quot;</span> <span class="se">\</span>
        --column <span class="s2">&quot;Name&quot;</span> <span class="se">\</span>
        | grep <span class="s2">&quot; $1 &quot;</span> | get_field 1<span class="k">)</span>
    <span class="k">if</span> <span class="o">[[</span> -z <span class="s2">&quot;$user_role_id&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>Adds role to user</p>
</td><td class=code><div class=highlight><pre>
        <span class="nv">user_role_id</span><span class="o">=</span><span class="k">$(</span>openstack role add <span class="se">\</span>
            <span class="nv">$1</span> <span class="se">\</span>
            --user <span class="nv">$2</span> <span class="se">\</span>
            --project <span class="nv">$3</span> <span class="se">\</span>
            | grep <span class="s2">&quot; id &quot;</span> | get_field 2<span class="k">)</span>
    <span class="k">fi</span>
<span class="k">    </span><span class="nb">echo</span> <span class="nv">$user_role_id</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Gets or creates service
Usage: get_or_create_service &lt;name&gt; &lt;type&gt; &lt;description&gt;</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>get_or_create_service <span class="o">{</span>
</pre></div></td></tr><tr><td class=docs>
<p>Gets service id</p>
</td><td class=code><div class=highlight><pre>
    <span class="nb">local </span><span class="nv">service_id</span><span class="o">=</span><span class="k">$(</span>
</pre></div></td></tr><tr><td class=docs>
<p>Gets service id</p>
</td><td class=code><div class=highlight><pre>
        openstack service show <span class="nv">$1</span> -f value -c id 2&gt;/dev/null <span class="o">||</span>
</pre></div></td></tr><tr><td class=docs>
<p>Creates new service if not exists</p>
</td><td class=code><div class=highlight><pre>
        openstack service create <span class="se">\</span>
            <span class="nv">$1</span> <span class="se">\</span>
            --type<span class="o">=</span><span class="nv">$2</span> <span class="se">\</span>
            --description<span class="o">=</span><span class="s2">&quot;$3&quot;</span> <span class="se">\</span>
            -f value -c id
    <span class="k">)</span>
    <span class="nb">echo</span> <span class="nv">$service_id</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Gets or creates endpoint
Usage: get_or_create_endpoint &lt;service&gt; &lt;region&gt; &lt;publicurl&gt; &lt;adminurl&gt; &lt;internalurl&gt;</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>get_or_create_endpoint <span class="o">{</span>
</pre></div></td></tr><tr><td class=docs>
<p>Gets endpoint id</p>
</td><td class=code><div class=highlight><pre>
    <span class="nb">local </span><span class="nv">endpoint_id</span><span class="o">=</span><span class="k">$(</span>openstack endpoint list <span class="se">\</span>
        --column <span class="s2">&quot;ID&quot;</span> <span class="se">\</span>
        --column <span class="s2">&quot;Region&quot;</span> <span class="se">\</span>
        --column <span class="s2">&quot;Service Name&quot;</span> <span class="se">\</span>
        | grep <span class="s2">&quot; $2 &quot;</span> <span class="se">\</span>
        | grep <span class="s2">&quot; $1 &quot;</span> | get_field 1<span class="k">)</span>
    <span class="k">if</span> <span class="o">[[</span> -z <span class="s2">&quot;$endpoint_id&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>Creates new endpoint</p>
</td><td class=code><div class=highlight><pre>
        <span class="nv">endpoint_id</span><span class="o">=</span><span class="k">$(</span>openstack endpoint create <span class="se">\</span>
            <span class="nv">$1</span> <span class="se">\</span>
            --region <span class="nv">$2</span> <span class="se">\</span>
            --publicurl <span class="nv">$3</span> <span class="se">\</span>
            --adminurl <span class="nv">$4</span> <span class="se">\</span>
            --internalurl <span class="nv">$5</span> <span class="se">\</span>
            | grep <span class="s2">&quot; id &quot;</span> | get_field 2<span class="k">)</span>
    <span class="k">fi</span>
<span class="k">    </span><span class="nb">echo</span> <span class="nv">$endpoint_id</span>
<span class="o">}</span>


</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="package-functions">
<h1>Package Functions</h1>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>_get_package_dir</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>_get_package_dir <span class="o">{</span>
    <span class="nb">local </span>pkg_dir
    <span class="k">if </span>is_ubuntu; <span class="k">then</span>
<span class="k">        </span><span class="nv">pkg_dir</span><span class="o">=</span><span class="nv">$FILES</span>/apts
    <span class="k">elif </span>is_fedora; <span class="k">then</span>
<span class="k">        </span><span class="nv">pkg_dir</span><span class="o">=</span><span class="nv">$FILES</span>/rpms
    <span class="k">elif </span>is_suse; <span class="k">then</span>
<span class="k">        </span><span class="nv">pkg_dir</span><span class="o">=</span><span class="nv">$FILES</span>/rpms-suse
    <span class="k">else</span>
<span class="k">        </span>exit_distro_not_supported <span class="s2">&quot;list of packages&quot;</span>
    <span class="k">fi</span>
<span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;$pkg_dir&quot;</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Wrapper for <tt class="docutils literal"><span class="pre">apt-get</span></tt> to set cache and proxy environment variables
Uses globals <tt class="docutils literal">OFFLINE</tt>, <tt class="docutils literal">*_proxy</tt>
apt_get operation package [package ...]</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>apt_get <span class="o">{</span>
    <span class="nb">local </span><span class="nv">xtrace</span><span class="o">=</span><span class="k">$(</span><span class="nb">set</span> +o | grep xtrace<span class="k">)</span>
    <span class="nb">set</span> +o xtrace

    <span class="o">[[</span> <span class="s2">&quot;$OFFLINE&quot;</span> <span class="o">=</span> <span class="s2">&quot;True&quot;</span> <span class="o">||</span> -z <span class="s2">&quot;$@&quot;</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="k">return</span>
<span class="k">    </span><span class="nb">local </span><span class="nv">sudo</span><span class="o">=</span><span class="s2">&quot;sudo&quot;</span>
    <span class="o">[[</span> <span class="s2">&quot;$(id -u)&quot;</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nv">sudo</span><span class="o">=</span><span class="s2">&quot;env&quot;</span>

    <span class="nv">$xtrace</span>
    <span class="nv">$sudo</span> <span class="nv">DEBIAN_FRONTEND</span><span class="o">=</span>noninteractive <span class="se">\</span>
        <span class="nv">http_proxy</span><span class="o">=</span><span class="nv">$http_proxy</span> <span class="nv">https_proxy</span><span class="o">=</span><span class="nv">$https_proxy</span> <span class="se">\</span>
        <span class="nv">no_proxy</span><span class="o">=</span><span class="nv">$no_proxy</span> <span class="se">\</span>
        apt-get --option <span class="s2">&quot;Dpkg::Options::=--force-confold&quot;</span> --assume-yes <span class="s2">&quot;$@&quot;</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>get_packages() collects a list of package names of any type from the
prerequisite files in <tt class="docutils literal"><span class="pre">files/{apts|rpms}</span></tt>.  The list is intended
to be passed to a package installer such as apt or yum.</p>
<p>Only packages required for the services in 1st argument will be
included.  Two bits of metadata are recognized in the prerequisite files:</p>
<ul class="simple">
<li><tt class="docutils literal"># NOPRIME</tt> defers installation to be performed later in <cite>stack.sh</cite></li>
<li><tt class="docutils literal"># dist:DISTRO</tt> or <tt class="docutils literal">dist:DISTRO1,DISTRO2</tt> limits the selection
of the package to the distros listed.  The distro names are case insensitive.</li>
</ul>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>get_packages <span class="o">{</span>
    <span class="nb">local </span><span class="nv">xtrace</span><span class="o">=</span><span class="k">$(</span><span class="nb">set</span> +o | grep xtrace<span class="k">)</span>
    <span class="nb">set</span> +o xtrace
    <span class="nb">local </span><span class="nv">services</span><span class="o">=</span><span class="nv">$@</span>
    <span class="nb">local </span><span class="nv">package_dir</span><span class="o">=</span><span class="k">$(</span>_get_package_dir<span class="k">)</span>
    <span class="nb">local </span>file_to_parse
    <span class="nb">local </span>service

    <span class="k">if</span> <span class="o">[[</span> -z <span class="s2">&quot;$package_dir&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nb">echo</span> <span class="s2">&quot;No package directory supplied&quot;</span>
        <span class="k">return </span>1
    <span class="k">fi</span>
<span class="k">    if</span> <span class="o">[[</span> -z <span class="s2">&quot;$DISTRO&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span>GetDistro
        <span class="nb">echo</span> <span class="s2">&quot;Found Distro $DISTRO&quot;</span>
    <span class="k">fi</span>
<span class="k">    for </span>service in <span class="k">${</span><span class="nv">services</span><span class="p">//,/ </span><span class="k">}</span>; <span class="k">do</span>
</pre></div></td></tr><tr><td class=docs>
<p>Allow individual services to specify dependencies</p>
</td><td class=code><div class=highlight><pre>
        <span class="k">if</span> <span class="o">[[</span> -e <span class="k">${</span><span class="nv">package_dir</span><span class="k">}</span>/<span class="k">${</span><span class="nv">service</span><span class="k">}</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            </span><span class="nv">file_to_parse</span><span class="o">=</span><span class="s2">&quot;${file_to_parse} $service&quot;</span>
        <span class="k">fi</span>
</pre></div></td></tr><tr><td class=docs>
<p>NOTE(sdague) n-api needs glance for now because that's where
glance client is</p>
</td><td class=code><div class=highlight><pre>
        <span class="k">if</span> <span class="o">[[</span> <span class="nv">$service</span> <span class="o">==</span> n-api <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            if</span> <span class="o">[[</span> ! <span class="nv">$file_to_parse</span> <span class="o">=</span>~ nova <span class="o">]]</span>; <span class="k">then</span>
<span class="k">                </span><span class="nv">file_to_parse</span><span class="o">=</span><span class="s2">&quot;${file_to_parse} nova&quot;</span>
            <span class="k">fi</span>
<span class="k">            if</span> <span class="o">[[</span> ! <span class="nv">$file_to_parse</span> <span class="o">=</span>~ glance <span class="o">]]</span>; <span class="k">then</span>
<span class="k">                </span><span class="nv">file_to_parse</span><span class="o">=</span><span class="s2">&quot;${file_to_parse} glance&quot;</span>
            <span class="k">fi</span>
<span class="k">        elif</span> <span class="o">[[</span> <span class="nv">$service</span> <span class="o">==</span> c-* <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            if</span> <span class="o">[[</span> ! <span class="nv">$file_to_parse</span> <span class="o">=</span>~ cinder <span class="o">]]</span>; <span class="k">then</span>
<span class="k">                </span><span class="nv">file_to_parse</span><span class="o">=</span><span class="s2">&quot;${file_to_parse} cinder&quot;</span>
            <span class="k">fi</span>
<span class="k">        elif</span> <span class="o">[[</span> <span class="nv">$service</span> <span class="o">==</span> ceilometer-* <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            if</span> <span class="o">[[</span> ! <span class="nv">$file_to_parse</span> <span class="o">=</span>~ ceilometer <span class="o">]]</span>; <span class="k">then</span>
<span class="k">                </span><span class="nv">file_to_parse</span><span class="o">=</span><span class="s2">&quot;${file_to_parse} ceilometer&quot;</span>
            <span class="k">fi</span>
<span class="k">        elif</span> <span class="o">[[</span> <span class="nv">$service</span> <span class="o">==</span> s-* <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            if</span> <span class="o">[[</span> ! <span class="nv">$file_to_parse</span> <span class="o">=</span>~ swift <span class="o">]]</span>; <span class="k">then</span>
<span class="k">                </span><span class="nv">file_to_parse</span><span class="o">=</span><span class="s2">&quot;${file_to_parse} swift&quot;</span>
            <span class="k">fi</span>
<span class="k">        elif</span> <span class="o">[[</span> <span class="nv">$service</span> <span class="o">==</span> n-* <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            if</span> <span class="o">[[</span> ! <span class="nv">$file_to_parse</span> <span class="o">=</span>~ nova <span class="o">]]</span>; <span class="k">then</span>
<span class="k">                </span><span class="nv">file_to_parse</span><span class="o">=</span><span class="s2">&quot;${file_to_parse} nova&quot;</span>
            <span class="k">fi</span>
<span class="k">        elif</span> <span class="o">[[</span> <span class="nv">$service</span> <span class="o">==</span> g-* <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            if</span> <span class="o">[[</span> ! <span class="nv">$file_to_parse</span> <span class="o">=</span>~ glance <span class="o">]]</span>; <span class="k">then</span>
<span class="k">                </span><span class="nv">file_to_parse</span><span class="o">=</span><span class="s2">&quot;${file_to_parse} glance&quot;</span>
            <span class="k">fi</span>
<span class="k">        elif</span> <span class="o">[[</span> <span class="nv">$service</span> <span class="o">==</span> key* <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            if</span> <span class="o">[[</span> ! <span class="nv">$file_to_parse</span> <span class="o">=</span>~ keystone <span class="o">]]</span>; <span class="k">then</span>
<span class="k">                </span><span class="nv">file_to_parse</span><span class="o">=</span><span class="s2">&quot;${file_to_parse} keystone&quot;</span>
            <span class="k">fi</span>
<span class="k">        elif</span> <span class="o">[[</span> <span class="nv">$service</span> <span class="o">==</span> q-* <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            if</span> <span class="o">[[</span> ! <span class="nv">$file_to_parse</span> <span class="o">=</span>~ neutron <span class="o">]]</span>; <span class="k">then</span>
<span class="k">                </span><span class="nv">file_to_parse</span><span class="o">=</span><span class="s2">&quot;${file_to_parse} neutron&quot;</span>
            <span class="k">fi</span>
<span class="k">        elif</span> <span class="o">[[</span> <span class="nv">$service</span> <span class="o">==</span> ir-* <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            if</span> <span class="o">[[</span> ! <span class="nv">$file_to_parse</span> <span class="o">=</span>~ ironic <span class="o">]]</span>; <span class="k">then</span>
<span class="k">                </span><span class="nv">file_to_parse</span><span class="o">=</span><span class="s2">&quot;${file_to_parse} ironic&quot;</span>
            <span class="k">fi</span>
<span class="k">        fi</span>
<span class="k">    done</span>

<span class="k">    for </span>file in <span class="k">${</span><span class="nv">file_to_parse</span><span class="k">}</span>; <span class="k">do</span>
<span class="k">        </span><span class="nb">local </span><span class="nv">fname</span><span class="o">=</span><span class="k">${</span><span class="nv">package_dir</span><span class="k">}</span>/<span class="k">${</span><span class="nv">file</span><span class="k">}</span>
        <span class="nb">local </span>OIFS line package distros distro
        <span class="o">[[</span> -e <span class="nv">$fname</span> <span class="o">]]</span> <span class="o">||</span> <span class="k">continue</span>

<span class="k">        </span><span class="nv">OIFS</span><span class="o">=</span><span class="nv">$IFS</span>
        <span class="nv">IFS</span><span class="o">=</span><span class="s1">$&#39;\n&#39;</span>
        <span class="k">for </span>line in <span class="k">$(</span>&lt;<span class="k">${</span><span class="nv">fname</span><span class="k">})</span>; <span class="k">do</span>
<span class="k">            if</span> <span class="o">[[</span> <span class="nv">$line</span> <span class="o">=</span>~ <span class="s2">&quot;NOPRIME&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">                continue</span>
<span class="k">            fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Assume we want this package</p>
</td><td class=code><div class=highlight><pre>
            <span class="nv">package</span><span class="o">=</span><span class="k">${</span><span class="nv">line</span><span class="p">%#*</span><span class="k">}</span>
            <span class="nv">inst_pkg</span><span class="o">=</span>1

</pre></div></td></tr><tr><td class=docs>
<p>Look for # dist:xxx in comment</p>
</td><td class=code><div class=highlight><pre>
            <span class="k">if</span> <span class="o">[[</span> <span class="nv">$line</span> <span class="o">=</span>~ <span class="o">(</span>.*<span class="o">)</span><span class="c">#.*dist:([^ ]*) ]]; then</span>
</pre></div></td></tr><tr><td class=docs>
<p>We are using BASH regexp matching feature.</p>
</td><td class=code><div class=highlight><pre>
                <span class="nv">package</span><span class="o">=</span><span class="k">${</span><span class="nv">BASH_REMATCH</span><span class="p">[1]</span><span class="k">}</span>
                <span class="nv">distros</span><span class="o">=</span><span class="k">${</span><span class="nv">BASH_REMATCH</span><span class="p">[2]</span><span class="k">}</span>
</pre></div></td></tr><tr><td class=docs>
<p>In bash ${VAR,,} will lowecase VAR
Look for a match in the distro list</p>
</td><td class=code><div class=highlight><pre>
                <span class="k">if</span> <span class="o">[[</span> ! <span class="k">${</span><span class="nv">distros</span><span class="p">,,</span><span class="k">}</span> <span class="o">=</span>~ <span class="k">${</span><span class="nv">DISTRO</span><span class="p">,,</span><span class="k">}</span> <span class="o">]]</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>If no match then skip this package</p>
</td><td class=code><div class=highlight><pre>
                    <span class="nv">inst_pkg</span><span class="o">=</span>0
                <span class="k">fi</span>
<span class="k">            fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Look for # testonly in comment</p>
</td><td class=code><div class=highlight><pre>
            <span class="k">if</span> <span class="o">[[</span> <span class="nv">$line</span> <span class="o">=</span>~ <span class="o">(</span>.*<span class="o">)</span><span class="c">#.*testonly.* ]]; then</span>
                <span class="nv">package</span><span class="o">=</span><span class="k">${</span><span class="nv">BASH_REMATCH</span><span class="p">[1]</span><span class="k">}</span>
</pre></div></td></tr><tr><td class=docs>
<p>Are we installing test packages? (test for the default value)</p>
</td><td class=code><div class=highlight><pre>
                <span class="k">if</span> <span class="o">[[</span> <span class="nv">$INSTALL_TESTONLY_PACKAGES</span> <span class="o">=</span> <span class="s2">&quot;False&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>If not installing test packages the skip this package</p>
</td><td class=code><div class=highlight><pre>
                    <span class="nv">inst_pkg</span><span class="o">=</span>0
                <span class="k">fi</span>
<span class="k">            fi</span>

<span class="k">            if</span> <span class="o">[[</span> <span class="nv">$inst_pkg</span> <span class="o">=</span> 1 <span class="o">]]</span>; <span class="k">then</span>
<span class="k">                </span><span class="nb">echo</span> <span class="nv">$package</span>
            <span class="k">fi</span>
<span class="k">        done</span>
<span class="k">        </span><span class="nv">IFS</span><span class="o">=</span><span class="nv">$OIFS</span>
    <span class="k">done</span>
    <span class="nv">$xtrace</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Distro-agnostic package installer
Uses globals <tt class="docutils literal">NO_UPDATE_REPOS</tt>, <tt class="docutils literal">REPOS_UPDATED</tt>, <tt class="docutils literal">RETRY_UPDATE</tt>
install_package package [package ...]</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>update_package_repo <span class="o">{</span>
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$NO_UPDATE_REPOS&quot;</span> <span class="o">=</span> <span class="s2">&quot;True&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        return </span>0
    <span class="k">fi</span>

<span class="k">    if </span>is_ubuntu; <span class="k">then</span>
<span class="k">        </span><span class="nb">local </span><span class="nv">xtrace</span><span class="o">=</span><span class="k">$(</span><span class="nb">set</span> +o | grep xtrace<span class="k">)</span>
        <span class="nb">set</span> +o xtrace
        <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$REPOS_UPDATED&quot;</span> !<span class="o">=</span> <span class="s2">&quot;True&quot;</span> <span class="o">||</span> <span class="s2">&quot;$RETRY_UPDATE&quot;</span> <span class="o">=</span> <span class="s2">&quot;True&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>if there are transient errors pulling the updates, that's fine.
It may be secondary repositories that we don't really care about.</p>
</td><td class=code><div class=highlight><pre>
            apt_get update  <span class="o">||</span> /bin/true
            <span class="nv">REPOS_UPDATED</span><span class="o">=</span>True
        <span class="k">fi</span>
        <span class="nv">$xtrace</span>
    <span class="k">fi</span>
<span class="o">}</span>

<span class="k">function </span>real_install_package <span class="o">{</span>
    <span class="k">if </span>is_ubuntu; <span class="k">then</span>
<span class="k">        </span>apt_get install <span class="s2">&quot;$@&quot;</span>
    <span class="k">elif </span>is_fedora; <span class="k">then</span>
<span class="k">        </span>yum_install <span class="s2">&quot;$@&quot;</span>
    <span class="k">elif </span>is_suse; <span class="k">then</span>
<span class="k">        </span>zypper_install <span class="s2">&quot;$@&quot;</span>
    <span class="k">else</span>
<span class="k">        </span>exit_distro_not_supported <span class="s2">&quot;installing packages&quot;</span>
    <span class="k">fi</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Distro-agnostic package installer
install_package package [package ...]</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>install_package <span class="o">{</span>
    update_package_repo
    real_install_package <span class="nv">$@</span> <span class="o">||</span> <span class="nv">RETRY_UPDATE</span><span class="o">=</span>True update_package_repo <span class="o">&amp;&amp;</span> real_install_package <span class="nv">$@</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Distro-agnostic function to tell if a package is installed
is_package_installed package [package ...]</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>is_package_installed <span class="o">{</span>
    <span class="k">if</span> <span class="o">[[</span> -z <span class="s2">&quot;$@&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        return </span>1
    <span class="k">fi</span>

<span class="k">    if</span> <span class="o">[[</span> -z <span class="s2">&quot;$os_PACKAGE&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span>GetOSVersion
    <span class="k">fi</span>

<span class="k">    if</span> <span class="o">[[</span> <span class="s2">&quot;$os_PACKAGE&quot;</span> <span class="o">=</span> <span class="s2">&quot;deb&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span>dpkg -s <span class="s2">&quot;$@&quot;</span> &gt; /dev/null 2&gt; /dev/null
    <span class="k">elif</span> <span class="o">[[</span> <span class="s2">&quot;$os_PACKAGE&quot;</span> <span class="o">=</span> <span class="s2">&quot;rpm&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span>rpm --quiet -q <span class="s2">&quot;$@&quot;</span>
    <span class="k">else</span>
<span class="k">        </span>exit_distro_not_supported <span class="s2">&quot;finding if a package is installed&quot;</span>
    <span class="k">fi</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Distro-agnostic package uninstaller
uninstall_package package [package ...]</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>uninstall_package <span class="o">{</span>
    <span class="k">if </span>is_ubuntu; <span class="k">then</span>
<span class="k">        </span>apt_get purge <span class="s2">&quot;$@&quot;</span>
    <span class="k">elif </span>is_fedora; <span class="k">then</span>
<span class="k">        </span>sudo yum remove -y <span class="s2">&quot;$@&quot;</span>
    <span class="k">elif </span>is_suse; <span class="k">then</span>
<span class="k">        </span>sudo zypper rm <span class="s2">&quot;$@&quot;</span>
    <span class="k">else</span>
<span class="k">        </span>exit_distro_not_supported <span class="s2">&quot;uninstalling packages&quot;</span>
    <span class="k">fi</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Wrapper for <tt class="docutils literal">yum</tt> to set proxy environment variables
Uses globals <tt class="docutils literal">OFFLINE</tt>, <tt class="docutils literal">*_proxy</tt>
yum_install package [package ...]</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>yum_install <span class="o">{</span>
    <span class="o">[[</span> <span class="s2">&quot;$OFFLINE&quot;</span> <span class="o">=</span> <span class="s2">&quot;True&quot;</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="k">return</span>
<span class="k">    </span><span class="nb">local </span><span class="nv">sudo</span><span class="o">=</span><span class="s2">&quot;sudo&quot;</span>
    <span class="o">[[</span> <span class="s2">&quot;$(id -u)&quot;</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nv">sudo</span><span class="o">=</span><span class="s2">&quot;env&quot;</span>

</pre></div></td></tr><tr><td class=docs>
<p>The manual check for missing packages is because yum -y assumes
missing packages are OK.  See
<a class="reference external" href="https://bugzilla.redhat.com/show_bug.cgi?id=965567">https://bugzilla.redhat.com/show_bug.cgi?id=965567</a></p>
</td><td class=code><div class=highlight><pre>
    <span class="nv">$sudo</span> <span class="nv">http_proxy</span><span class="o">=</span><span class="nv">$http_proxy</span> <span class="nv">https_proxy</span><span class="o">=</span><span class="nv">$https_proxy</span> <span class="se">\</span>
        <span class="nv">no_proxy</span><span class="o">=</span><span class="nv">$no_proxy</span> <span class="se">\</span>
        yum install -y <span class="s2">&quot;$@&quot;</span> 2&gt;&amp;1 | <span class="se">\</span>
        awk <span class="s1">&#39;</span>
<span class="s1">            BEGIN { fail=0 }</span>
<span class="s1">            /No package/ { fail=1 }</span>
<span class="s1">            { print }</span>
<span class="s1">            END { exit fail }&#39;</span> <span class="o">||</span> <span class="se">\</span>
                die <span class="nv">$LINENO</span> <span class="s2">&quot;Missing packages detected&quot;</span>

</pre></div></td></tr><tr><td class=docs>
<p>also ensure we catch a yum failure</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">if</span> <span class="o">[[</span> <span class="k">${</span><span class="nv">PIPESTATUS</span><span class="p">[0]</span><span class="k">}</span> !<span class="o">=</span> 0 <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span>die <span class="nv">$LINENO</span> <span class="s2">&quot;Yum install failure&quot;</span>
    <span class="k">fi</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>zypper wrapper to set arguments correctly
Uses globals <tt class="docutils literal">OFFLINE</tt>, <tt class="docutils literal">*_proxy</tt>
zypper_install package [package ...]</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>zypper_install <span class="o">{</span>
    <span class="o">[[</span> <span class="s2">&quot;$OFFLINE&quot;</span> <span class="o">=</span> <span class="s2">&quot;True&quot;</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="k">return</span>
<span class="k">    </span><span class="nb">local </span><span class="nv">sudo</span><span class="o">=</span><span class="s2">&quot;sudo&quot;</span>
    <span class="o">[[</span> <span class="s2">&quot;$(id -u)&quot;</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nv">sudo</span><span class="o">=</span><span class="s2">&quot;env&quot;</span>
    <span class="nv">$sudo</span> <span class="nv">http_proxy</span><span class="o">=</span><span class="nv">$http_proxy</span> <span class="nv">https_proxy</span><span class="o">=</span><span class="nv">$https_proxy</span> <span class="se">\</span>
        zypper --non-interactive install --auto-agree-with-licenses <span class="s2">&quot;$@&quot;</span>
<span class="o">}</span>


</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="process-functions">
<h1>Process Functions</h1>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>_run_process() is designed to be backgrounded by run_process() to simulate a
fork.  It includes the dirty work of closing extra filehandles and preparing log
files to produce the same logs as screen_it().  The log filename is derived
from the service name and global-and-now-misnamed <tt class="docutils literal">SCREEN_LOGDIR</tt>
Uses globals <tt class="docutils literal">CURRENT_LOG_TIME</tt>, <tt class="docutils literal">SCREEN_LOGDIR</tt>, <tt class="docutils literal">SCREEN_NAME</tt>, <tt class="docutils literal">SERVICE_DIR</tt>
If an optional group is provided sg will be used to set the group of
the command.
_run_process service &quot;command-line&quot; [group]</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>_run_process <span class="o">{</span>
    <span class="nb">local </span><span class="nv">service</span><span class="o">=</span><span class="nv">$1</span>
    <span class="nb">local command</span><span class="o">=</span><span class="s2">&quot;$2&quot;</span>
    <span class="nb">local </span><span class="nv">group</span><span class="o">=</span><span class="nv">$3</span>

</pre></div></td></tr><tr><td class=docs>
<p>Undo logging redirections and close the extra descriptors</p>
</td><td class=code><div class=highlight><pre>
    <span class="nb">exec </span>1&gt;&amp;3
    <span class="nb">exec </span>2&gt;&amp;3
    <span class="nb">exec </span>3&gt;&amp;-
    <span class="nb">exec </span>6&gt;&amp;-

    <span class="k">if</span> <span class="o">[[</span> -n <span class="k">${</span><span class="nv">SCREEN_LOGDIR</span><span class="k">}</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nb">exec </span>1&gt;&amp;<span class="k">${</span><span class="nv">SCREEN_LOGDIR</span><span class="k">}</span>/screen-<span class="k">${</span><span class="nv">service</span><span class="k">}</span>.<span class="k">${</span><span class="nv">CURRENT_LOG_TIME</span><span class="k">}</span>.log 2&gt;&amp;1
        ln -sf <span class="k">${</span><span class="nv">SCREEN_LOGDIR</span><span class="k">}</span>/screen-<span class="k">${</span><span class="nv">service</span><span class="k">}</span>.<span class="k">${</span><span class="nv">CURRENT_LOG_TIME</span><span class="k">}</span>.log <span class="k">${</span><span class="nv">SCREEN_LOGDIR</span><span class="k">}</span>/screen-<span class="k">${</span><span class="nv">service</span><span class="k">}</span>.log

</pre></div></td></tr><tr><td class=docs>
<p>TODO(dtroyer): Hack to get stdout from the Python interpreter for the logs.</p>
</td><td class=code><div class=highlight><pre>
        <span class="nb">export </span><span class="nv">PYTHONUNBUFFERED</span><span class="o">=</span>1
    <span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Run under <tt class="docutils literal">setsid</tt> to force the process to become a session and group leader.
The pid saved can be used with pkill -g to get the entire process group.</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&quot;$group&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span>setsid sg <span class="nv">$group</span> <span class="s2">&quot;$command&quot;</span> &amp; <span class="nb">echo</span> <span class="nv">$!</span> &gt;<span class="nv">$SERVICE_DIR</span>/<span class="nv">$SCREEN_NAME</span>/<span class="nv">$service</span>.pid
    <span class="k">else</span>
<span class="k">        </span>setsid <span class="nv">$command</span> &amp; <span class="nb">echo</span> <span class="nv">$!</span> &gt;<span class="nv">$SERVICE_DIR</span>/<span class="nv">$SCREEN_NAME</span>/<span class="nv">$service</span>.pid
    <span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Just silently exit this process</p>
</td><td class=code><div class=highlight><pre>
    <span class="nb">exit </span>0
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Helper to remove the <tt class="docutils literal">*.failure</tt> files under <tt class="docutils literal"><span class="pre">$SERVICE_DIR/$SCREEN_NAME</span></tt>.
This is used for <tt class="docutils literal">service_check</tt> when all the <tt class="docutils literal">screen_it</tt> are called finished
Uses globals <tt class="docutils literal">SCREEN_NAME</tt>, <tt class="docutils literal">SERVICE_DIR</tt>
init_service_check</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>init_service_check <span class="o">{</span>
    <span class="nv">SCREEN_NAME</span><span class="o">=</span><span class="k">${</span><span class="nv">SCREEN_NAME</span><span class="k">:-</span><span class="nv">stack</span><span class="k">}</span>
    <span class="nv">SERVICE_DIR</span><span class="o">=</span><span class="k">${</span><span class="nv">SERVICE_DIR</span><span class="k">:-${</span><span class="nv">DEST</span><span class="k">}</span><span class="p">/status</span><span class="k">}</span>

    <span class="k">if</span> <span class="o">[[</span> ! -d <span class="s2">&quot;$SERVICE_DIR/$SCREEN_NAME&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span>mkdir -p <span class="s2">&quot;$SERVICE_DIR/$SCREEN_NAME&quot;</span>
    <span class="k">fi</span>

<span class="k">    </span>rm -f <span class="s2">&quot;$SERVICE_DIR/$SCREEN_NAME&quot;</span>/*.failure
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Find out if a process exists by partial name.
is_running name</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>is_running <span class="o">{</span>
    <span class="nb">local </span><span class="nv">name</span><span class="o">=</span><span class="nv">$1</span>
    ps auxw | grep -v grep | grep <span class="k">${</span><span class="nv">name</span><span class="k">}</span> &gt; /dev/null
    <span class="nb">local </span><span class="nv">exitcode</span><span class="o">=</span><span class="nv">$?</span>
</pre></div></td></tr><tr><td class=docs>
<p>some times I really hate bash reverse binary logic</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">return</span> <span class="nv">$exitcode</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Run a single service under screen or directly
If the command includes shell metachatacters (;&lt;&gt;*) it must be run using a shell
If an optional group is provided sg will be used to run the
command as that group.
run_process service &quot;command-line&quot; [group]</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>run_process <span class="o">{</span>
    <span class="nb">local </span><span class="nv">service</span><span class="o">=</span><span class="nv">$1</span>
    <span class="nb">local command</span><span class="o">=</span><span class="s2">&quot;$2&quot;</span>
    <span class="nb">local </span><span class="nv">group</span><span class="o">=</span><span class="nv">$3</span>

    <span class="k">if </span>is_service_enabled <span class="nv">$service</span>; <span class="k">then</span>
<span class="k">        if</span> <span class="o">[[</span> <span class="s2">&quot;$USE_SCREEN&quot;</span> <span class="o">=</span> <span class="s2">&quot;True&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            </span>screen_service <span class="s2">&quot;$service&quot;</span> <span class="s2">&quot;$command&quot;</span> <span class="s2">&quot;$group&quot;</span>
        <span class="k">else</span>
</pre></div></td></tr><tr><td class=docs>
<p>Spawn directly without screen</p>
</td><td class=code><div class=highlight><pre>
            _run_process <span class="s2">&quot;$service&quot;</span> <span class="s2">&quot;$command&quot;</span> <span class="s2">&quot;$group&quot;</span> &amp;
        <span class="k">fi</span>
<span class="k">    fi</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Helper to launch a service in a named screen
Uses globals <tt class="docutils literal">CURRENT_LOG_TIME</tt>, <tt class="docutils literal">SCREEN_NAME</tt>, <tt class="docutils literal">SCREEN_LOGDIR</tt>,
<tt class="docutils literal">SERVICE_DIR</tt>, <tt class="docutils literal">USE_SCREEN</tt>
screen_service service &quot;command-line&quot; [group]
Run a command in a shell in a screen window, if an optional group
is provided, use sg to set the group of the command.</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>screen_service <span class="o">{</span>
    <span class="nb">local </span><span class="nv">service</span><span class="o">=</span><span class="nv">$1</span>
    <span class="nb">local command</span><span class="o">=</span><span class="s2">&quot;$2&quot;</span>
    <span class="nb">local </span><span class="nv">group</span><span class="o">=</span><span class="nv">$3</span>

    <span class="nv">SCREEN_NAME</span><span class="o">=</span><span class="k">${</span><span class="nv">SCREEN_NAME</span><span class="k">:-</span><span class="nv">stack</span><span class="k">}</span>
    <span class="nv">SERVICE_DIR</span><span class="o">=</span><span class="k">${</span><span class="nv">SERVICE_DIR</span><span class="k">:-${</span><span class="nv">DEST</span><span class="k">}</span><span class="p">/status</span><span class="k">}</span>
    <span class="nv">USE_SCREEN</span><span class="o">=</span><span class="k">$(</span>trueorfalse True <span class="nv">$USE_SCREEN</span><span class="k">)</span>

    <span class="k">if </span>is_service_enabled <span class="nv">$service</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>Append the service to the screen rc file</p>
</td><td class=code><div class=highlight><pre>
        screen_rc <span class="s2">&quot;$service&quot;</span> <span class="s2">&quot;$command&quot;</span>

        screen -S <span class="nv">$SCREEN_NAME</span> -X screen -t <span class="nv">$service</span>

        <span class="k">if</span> <span class="o">[[</span> -n <span class="k">${</span><span class="nv">SCREEN_LOGDIR</span><span class="k">}</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            </span>screen -S <span class="nv">$SCREEN_NAME</span> -p <span class="nv">$service</span> -X logfile <span class="k">${</span><span class="nv">SCREEN_LOGDIR</span><span class="k">}</span>/screen-<span class="k">${</span><span class="nv">service</span><span class="k">}</span>.<span class="k">${</span><span class="nv">CURRENT_LOG_TIME</span><span class="k">}</span>.log
            screen -S <span class="nv">$SCREEN_NAME</span> -p <span class="nv">$service</span> -X log on
            ln -sf <span class="k">${</span><span class="nv">SCREEN_LOGDIR</span><span class="k">}</span>/screen-<span class="k">${</span><span class="nv">service</span><span class="k">}</span>.<span class="k">${</span><span class="nv">CURRENT_LOG_TIME</span><span class="k">}</span>.log <span class="k">${</span><span class="nv">SCREEN_LOGDIR</span><span class="k">}</span>/screen-<span class="k">${</span><span class="nv">service</span><span class="k">}</span>.log
        <span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>sleep to allow bash to be ready to be send the command - we are
creating a new window in screen and then sends characters, so if
bash isn't running by the time we send the command, nothing happens</p>
</td><td class=code><div class=highlight><pre>
        sleep 3

        <span class="nv">NL</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> -ne <span class="s1">&#39;\015&#39;</span><span class="sb">`</span>
</pre></div></td></tr><tr><td class=docs>
<p>This fun command does the following:
- the passed server command is backgrounded
- the pid of the background process is saved in the usual place
- the server process is brought back to the foreground
- if the server process exits prematurely the fg command errors</p>
<div class="system-message">
<p class="system-message-title">System Message: ERROR/3 (<tt class="docutils">&lt;stdin&gt;</tt>, line 723)</p>
Unexpected indentation.</div>
<blockquote>
and a message is written to stdout and the service failure file</blockquote>
<div class="system-message">
<p class="system-message-title">System Message: WARNING/2 (<tt class="docutils">&lt;stdin&gt;</tt>, line 724)</p>
Block quote ends without a blank line; unexpected unindent.</div>
<p>The pid saved can be used in stop_process() as a process group
id to kill off all child processes</p>
</td><td class=code><div class=highlight><pre>
        <span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&quot;$group&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            </span><span class="nb">command</span><span class="o">=</span><span class="s2">&quot;sg $group &#39;$command&#39;&quot;</span>
        <span class="k">fi</span>
<span class="k">        </span>screen -S <span class="nv">$SCREEN_NAME</span> -p <span class="nv">$service</span> -X stuff <span class="s2">&quot;$command &amp; echo \$! &gt;$SERVICE_DIR/$SCREEN_NAME/${service}.pid; fg || echo \&quot;$service failed to start\&quot; | tee \&quot;$SERVICE_DIR/$SCREEN_NAME/${service}.failure\&quot;$NL&quot;</span>
    <span class="k">fi</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Screen rc file builder
Uses globals <tt class="docutils literal">SCREEN_NAME</tt>, <tt class="docutils literal">SCREENRC</tt>
screen_rc service &quot;command-line&quot;</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>screen_rc <span class="o">{</span>
    <span class="nv">SCREEN_NAME</span><span class="o">=</span><span class="k">${</span><span class="nv">SCREEN_NAME</span><span class="k">:-</span><span class="nv">stack</span><span class="k">}</span>
    <span class="nv">SCREENRC</span><span class="o">=</span><span class="nv">$TOP_DIR</span>/<span class="nv">$SCREEN_NAME</span>-screenrc
    <span class="k">if</span> <span class="o">[[</span> ! -e <span class="nv">$SCREENRC</span> <span class="o">]]</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>Name the screen session</p>
</td><td class=code><div class=highlight><pre>
        <span class="nb">echo</span> <span class="s2">&quot;sessionname $SCREEN_NAME&quot;</span> &gt; <span class="nv">$SCREENRC</span>
</pre></div></td></tr><tr><td class=docs>
<p>Set a reasonable statusbar</p>
</td><td class=code><div class=highlight><pre>
        <span class="nb">echo</span> <span class="s2">&quot;hardstatus alwayslastline &#39;$SCREEN_HARDSTATUS&#39;&quot;</span> &gt;&gt; <span class="nv">$SCREENRC</span>
</pre></div></td></tr><tr><td class=docs>
<p>Some distributions override PROMPT_COMMAND for the screen terminal type - turn that off</p>
</td><td class=code><div class=highlight><pre>
        <span class="nb">echo</span> <span class="s2">&quot;setenv PROMPT_COMMAND /bin/true&quot;</span> &gt;&gt; <span class="nv">$SCREENRC</span>
        <span class="nb">echo</span> <span class="s2">&quot;screen -t shell bash&quot;</span> &gt;&gt; <span class="nv">$SCREENRC</span>
    <span class="k">fi</span>
</pre></div></td></tr><tr><td class=docs>
<p>If this service doesn't already exist in the screenrc file</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">if</span> ! grep <span class="nv">$1</span> <span class="nv">$SCREENRC</span> 2&gt;&amp;1 &gt; /dev/null; <span class="k">then</span>
<span class="k">        </span><span class="nv">NL</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> -ne <span class="s1">&#39;\015&#39;</span><span class="sb">`</span>
        <span class="nb">echo</span> <span class="s2">&quot;screen -t $1 bash&quot;</span> &gt;&gt; <span class="nv">$SCREENRC</span>
        <span class="nb">echo</span> <span class="s2">&quot;stuff \&quot;$2$NL\&quot;&quot;</span> &gt;&gt; <span class="nv">$SCREENRC</span>

        <span class="k">if</span> <span class="o">[[</span> -n <span class="k">${</span><span class="nv">SCREEN_LOGDIR</span><span class="k">}</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            </span><span class="nb">echo</span> <span class="s2">&quot;logfile ${SCREEN_LOGDIR}/screen-${1}.${CURRENT_LOG_TIME}.log&quot;</span> &gt;&gt;<span class="nv">$SCREENRC</span>
            <span class="nb">echo</span> <span class="s2">&quot;log on&quot;</span> &gt;&gt;<span class="nv">$SCREENRC</span>
        <span class="k">fi</span>
<span class="k">    fi</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Stop a service in screen
If a PID is available use it, kill the whole process group via TERM
If screen is being used kill the screen window; this will catch processes
that did not leave a PID behind
Uses globals <tt class="docutils literal">SCREEN_NAME</tt>, <tt class="docutils literal">SERVICE_DIR</tt>, <tt class="docutils literal">USE_SCREEN</tt>
screen_stop_service service</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>screen_stop_service <span class="o">{</span>
    <span class="nb">local </span><span class="nv">service</span><span class="o">=</span><span class="nv">$1</span>

    <span class="nv">SCREEN_NAME</span><span class="o">=</span><span class="k">${</span><span class="nv">SCREEN_NAME</span><span class="k">:-</span><span class="nv">stack</span><span class="k">}</span>
    <span class="nv">SERVICE_DIR</span><span class="o">=</span><span class="k">${</span><span class="nv">SERVICE_DIR</span><span class="k">:-${</span><span class="nv">DEST</span><span class="k">}</span><span class="p">/status</span><span class="k">}</span>
    <span class="nv">USE_SCREEN</span><span class="o">=</span><span class="k">$(</span>trueorfalse True <span class="nv">$USE_SCREEN</span><span class="k">)</span>

    <span class="k">if </span>is_service_enabled <span class="nv">$service</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>Clean up the screen window</p>
</td><td class=code><div class=highlight><pre>
        screen -S <span class="nv">$SCREEN_NAME</span> -p <span class="nv">$service</span> -X <span class="nb">kill</span>
<span class="nb">    </span><span class="k">fi</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Stop a service process
If a PID is available use it, kill the whole process group via TERM
If screen is being used kill the screen window; this will catch processes
that did not leave a PID behind
Uses globals <tt class="docutils literal">SERVICE_DIR</tt>, <tt class="docutils literal">USE_SCREEN</tt>
stop_process service</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>stop_process <span class="o">{</span>
    <span class="nb">local </span><span class="nv">service</span><span class="o">=</span><span class="nv">$1</span>

    <span class="nv">SERVICE_DIR</span><span class="o">=</span><span class="k">${</span><span class="nv">SERVICE_DIR</span><span class="k">:-${</span><span class="nv">DEST</span><span class="k">}</span><span class="p">/status</span><span class="k">}</span>
    <span class="nv">USE_SCREEN</span><span class="o">=</span><span class="k">$(</span>trueorfalse True <span class="nv">$USE_SCREEN</span><span class="k">)</span>

    <span class="k">if </span>is_service_enabled <span class="nv">$service</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>Kill via pid if we have one available</p>
</td><td class=code><div class=highlight><pre>
        <span class="k">if</span> <span class="o">[[</span> -r <span class="nv">$SERVICE_DIR</span>/<span class="nv">$SCREEN_NAME</span>/<span class="nv">$service</span>.pid <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            </span>pkill -g <span class="k">$(</span>cat <span class="nv">$SERVICE_DIR</span>/<span class="nv">$SCREEN_NAME</span>/<span class="nv">$service</span>.pid<span class="k">)</span>
            rm <span class="nv">$SERVICE_DIR</span>/<span class="nv">$SCREEN_NAME</span>/<span class="nv">$service</span>.pid
        <span class="k">fi</span>
<span class="k">        if</span> <span class="o">[[</span> <span class="s2">&quot;$USE_SCREEN&quot;</span> <span class="o">=</span> <span class="s2">&quot;True&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>Clean up the screen window</p>
</td><td class=code><div class=highlight><pre>
            screen_stop_service <span class="nv">$service</span>
        <span class="k">fi</span>
<span class="k">    fi</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Helper to get the status of each running service
Uses globals <tt class="docutils literal">SCREEN_NAME</tt>, <tt class="docutils literal">SERVICE_DIR</tt>
service_check</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>service_check <span class="o">{</span>
    <span class="nb">local </span>service
    <span class="nb">local </span>failures
    <span class="nv">SCREEN_NAME</span><span class="o">=</span><span class="k">${</span><span class="nv">SCREEN_NAME</span><span class="k">:-</span><span class="nv">stack</span><span class="k">}</span>
    <span class="nv">SERVICE_DIR</span><span class="o">=</span><span class="k">${</span><span class="nv">SERVICE_DIR</span><span class="k">:-${</span><span class="nv">DEST</span><span class="k">}</span><span class="p">/status</span><span class="k">}</span>


    <span class="k">if</span> <span class="o">[[</span> ! -d <span class="s2">&quot;$SERVICE_DIR/$SCREEN_NAME&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nb">echo</span> <span class="s2">&quot;No service status directory found&quot;</span>
        <span class="k">return</span>
<span class="k">    fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Check if there is any falure flag file under $SERVICE_DIR/$SCREEN_NAME
make this -o errexit safe</p>
</td><td class=code><div class=highlight><pre>
    <span class="nv">failures</span><span class="o">=</span><span class="sb">`</span>ls <span class="s2">&quot;$SERVICE_DIR/$SCREEN_NAME&quot;</span>/*.failure 2&gt;/dev/null <span class="o">||</span> /bin/true<span class="sb">`</span>

    <span class="k">for </span>service in <span class="nv">$failures</span>; <span class="k">do</span>
<span class="k">        </span><span class="nv">service</span><span class="o">=</span><span class="sb">`</span>basename <span class="nv">$service</span><span class="sb">`</span>
        <span class="nv">service</span><span class="o">=</span><span class="k">${</span><span class="nv">service</span><span class="p">%.failure</span><span class="k">}</span>
        <span class="nb">echo</span> <span class="s2">&quot;Error: Service $service is not running&quot;</span>
    <span class="k">done</span>

<span class="k">    if</span> <span class="o">[</span> -n <span class="s2">&quot;$failures&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">        </span>die <span class="nv">$LINENO</span> <span class="s2">&quot;More details about the above errors can be found with screen, with ./rejoin-stack.sh&quot;</span>
    <span class="k">fi</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Tail a log file in a screen if USE_SCREEN is true.</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>tail_log <span class="o">{</span>
    <span class="nb">local </span><span class="nv">service</span><span class="o">=</span><span class="nv">$1</span>
    <span class="nb">local </span><span class="nv">logfile</span><span class="o">=</span><span class="nv">$2</span>

    <span class="nv">USE_SCREEN</span><span class="o">=</span><span class="k">$(</span>trueorfalse True <span class="nv">$USE_SCREEN</span><span class="k">)</span>
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$USE_SCREEN&quot;</span> <span class="o">=</span> <span class="s2">&quot;True&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span>screen_service <span class="s2">&quot;$service&quot;</span> <span class="s2">&quot;sudo tail -f $logfile&quot;</span>
    <span class="k">fi</span>
<span class="o">}</span>


</pre></div></td></tr><tr><td class=docs>
<div class="section" id="deprecated-functions">
<h2>Deprecated Functions</h2>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>_old_run_process() is designed to be backgrounded by old_run_process() to simulate a
fork.  It includes the dirty work of closing extra filehandles and preparing log
files to produce the same logs as screen_it().  The log filename is derived
from the service name and global-and-now-misnamed <tt class="docutils literal">SCREEN_LOGDIR</tt>
Uses globals <tt class="docutils literal">CURRENT_LOG_TIME</tt>, <tt class="docutils literal">SCREEN_LOGDIR</tt>, <tt class="docutils literal">SCREEN_NAME</tt>, <tt class="docutils literal">SERVICE_DIR</tt>
_old_run_process service &quot;command-line&quot;</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>_old_run_process <span class="o">{</span>
    <span class="nb">local </span><span class="nv">service</span><span class="o">=</span><span class="nv">$1</span>
    <span class="nb">local command</span><span class="o">=</span><span class="s2">&quot;$2&quot;</span>

</pre></div></td></tr><tr><td class=docs>
<p>Undo logging redirections and close the extra descriptors</p>
</td><td class=code><div class=highlight><pre>
    <span class="nb">exec </span>1&gt;&amp;3
    <span class="nb">exec </span>2&gt;&amp;3
    <span class="nb">exec </span>3&gt;&amp;-
    <span class="nb">exec </span>6&gt;&amp;-

    <span class="k">if</span> <span class="o">[[</span> -n <span class="k">${</span><span class="nv">SCREEN_LOGDIR</span><span class="k">}</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nb">exec </span>1&gt;&amp;<span class="k">${</span><span class="nv">SCREEN_LOGDIR</span><span class="k">}</span>/screen-<span class="k">${</span><span class="nv">1</span><span class="k">}</span>.<span class="k">${</span><span class="nv">CURRENT_LOG_TIME</span><span class="k">}</span>.log 2&gt;&amp;1
        ln -sf <span class="k">${</span><span class="nv">SCREEN_LOGDIR</span><span class="k">}</span>/screen-<span class="k">${</span><span class="nv">1</span><span class="k">}</span>.<span class="k">${</span><span class="nv">CURRENT_LOG_TIME</span><span class="k">}</span>.log <span class="k">${</span><span class="nv">SCREEN_LOGDIR</span><span class="k">}</span>/screen-<span class="k">${</span><span class="nv">1</span><span class="k">}</span>.log

</pre></div></td></tr><tr><td class=docs>
<p>TODO(dtroyer): Hack to get stdout from the Python interpreter for the logs.</p>
</td><td class=code><div class=highlight><pre>
        <span class="nb">export </span><span class="nv">PYTHONUNBUFFERED</span><span class="o">=</span>1
    <span class="k">fi</span>

<span class="k">    </span><span class="nb">exec</span> /bin/bash -c <span class="s2">&quot;$command&quot;</span>
    die <span class="s2">&quot;$service exec failure: $command&quot;</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>old_run_process() launches a child process that closes all file descriptors and
then exec's the passed in command.  This is meant to duplicate the semantics
of screen_it() without screen.  PIDs are written to
<tt class="docutils literal"><span class="pre">$SERVICE_DIR/$SCREEN_NAME/$service.pid</span></tt> by the spawned child process.
old_run_process service &quot;command-line&quot;</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>old_run_process <span class="o">{</span>
    <span class="nb">local </span><span class="nv">service</span><span class="o">=</span><span class="nv">$1</span>
    <span class="nb">local command</span><span class="o">=</span><span class="s2">&quot;$2&quot;</span>

</pre></div></td></tr><tr><td class=docs>
<p>Spawn the child process</p>
</td><td class=code><div class=highlight><pre>
    _old_run_process <span class="s2">&quot;$service&quot;</span> <span class="s2">&quot;$command&quot;</span> &amp;
    <span class="nb">echo</span> <span class="nv">$!</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Compatibility for existing start_XXXX() functions
Uses global <tt class="docutils literal">USE_SCREEN</tt>
screen_it service &quot;command-line&quot;</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>screen_it <span class="o">{</span>
    <span class="k">if </span>is_service_enabled <span class="nv">$1</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>Append the service to the screen rc file</p>
</td><td class=code><div class=highlight><pre>
        screen_rc <span class="s2">&quot;$1&quot;</span> <span class="s2">&quot;$2&quot;</span>

        <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$USE_SCREEN&quot;</span> <span class="o">=</span> <span class="s2">&quot;True&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            </span>screen_service <span class="s2">&quot;$1&quot;</span> <span class="s2">&quot;$2&quot;</span>
        <span class="k">else</span>
</pre></div></td></tr><tr><td class=docs>
<p>Spawn directly without screen</p>
</td><td class=code><div class=highlight><pre>
            old_run_process <span class="s2">&quot;$1&quot;</span> <span class="s2">&quot;$2&quot;</span> &gt;<span class="nv">$SERVICE_DIR</span>/<span class="nv">$SCREEN_NAME</span>/<span class="nv">$1</span>.pid
        <span class="k">fi</span>
<span class="k">    fi</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Compatibility for existing stop_XXXX() functions
Stop a service in screen
If a PID is available use it, kill the whole process group via TERM
If screen is being used kill the screen window; this will catch processes
that did not leave a PID behind
screen_stop service</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>screen_stop <span class="o">{</span>
</pre></div></td></tr><tr><td class=docs>
<p>Clean up the screen window</p>
</td><td class=code><div class=highlight><pre>
    stop_process <span class="nv">$1</span>
<span class="o">}</span>


</pre></div></td></tr><tr><td class=docs>
</div>
</div>
<div class="section" id="python-functions">
<h1>Python Functions</h1>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Get the path to the pip command.
get_pip_command</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>get_pip_command <span class="o">{</span>
    which pip <span class="o">||</span> which pip-python

    <span class="k">if</span> <span class="o">[</span> <span class="nv">$?</span> -ne 0 <span class="o">]</span>; <span class="k">then</span>
<span class="k">        </span>die <span class="nv">$LINENO</span> <span class="s2">&quot;Unable to find pip; cannot continue&quot;</span>
    <span class="k">fi</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Get the path to the direcotry where python executables are installed.
get_python_exec_prefix</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>get_python_exec_prefix <span class="o">{</span>
    <span class="k">if </span>is_fedora <span class="o">||</span> is_suse; <span class="k">then</span>
<span class="k">        </span><span class="nb">echo</span> <span class="s2">&quot;/usr/bin&quot;</span>
    <span class="k">else</span>
<span class="k">        </span><span class="nb">echo</span> <span class="s2">&quot;/usr/local/bin&quot;</span>
    <span class="k">fi</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Wrapper for <tt class="docutils literal">pip install</tt> to set cache and proxy environment variables
Uses globals <tt class="docutils literal">OFFLINE</tt>, <tt class="docutils literal">PIP_DOWNLOAD_CACHE</tt>, <tt class="docutils literal">PIP_USE_MIRRORS</tt>,
<tt class="docutils literal">TRACK_DEPENDS</tt>, <tt class="docutils literal">*_proxy</tt>
pip_install package [package ...]</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>pip_install <span class="o">{</span>
    <span class="nb">local </span><span class="nv">xtrace</span><span class="o">=</span><span class="k">$(</span><span class="nb">set</span> +o | grep xtrace<span class="k">)</span>
    <span class="nb">set</span> +o xtrace
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$OFFLINE&quot;</span> <span class="o">=</span> <span class="s2">&quot;True&quot;</span> <span class="o">||</span> -z <span class="s2">&quot;$@&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
        <span class="nv">$xtrace</span>
        <span class="k">return</span>
<span class="k">    fi</span>

<span class="k">    if</span> <span class="o">[[</span> -z <span class="s2">&quot;$os_PACKAGE&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span>GetOSVersion
    <span class="k">fi</span>
<span class="k">    if</span> <span class="o">[[</span> <span class="nv">$TRACK_DEPENDS</span> <span class="o">=</span> True <span class="o">&amp;&amp;</span> ! <span class="s2">&quot;$@&quot;</span> <span class="o">=</span>~ virtualenv <span class="o">]]</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>TRACK_DEPENDS=True installation creates a circular dependency when
we attempt to install virtualenv into a virualenv, so we must global
that installation.</p>
</td><td class=code><div class=highlight><pre>
        <span class="nb">source</span> <span class="nv">$DEST</span>/.venv/bin/activate
        <span class="nb">local </span><span class="nv">cmd_pip</span><span class="o">=</span><span class="nv">$DEST</span>/.venv/bin/pip
        <span class="nb">local </span><span class="nv">sudo_pip</span><span class="o">=</span><span class="s2">&quot;env&quot;</span>
    <span class="k">else</span>
<span class="k">        </span><span class="nb">local </span><span class="nv">cmd_pip</span><span class="o">=</span><span class="k">$(</span>get_pip_command<span class="k">)</span>
        <span class="nb">local </span><span class="nv">sudo_pip</span><span class="o">=</span><span class="s2">&quot;sudo&quot;</span>
    <span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Mirror option not needed anymore because pypi has CDN available,
but it's useful in certain circumstances</p>
</td><td class=code><div class=highlight><pre>
    <span class="nv">PIP_USE_MIRRORS</span><span class="o">=</span><span class="k">${</span><span class="nv">PIP_USE_MIRRORS</span><span class="k">:-</span><span class="nv">False</span><span class="k">}</span>
    <span class="nb">local </span><span class="nv">pip_mirror_opt</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$PIP_USE_MIRRORS&quot;</span> !<span class="o">=</span> <span class="s2">&quot;False&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nv">pip_mirror_opt</span><span class="o">=</span><span class="s2">&quot;--use-mirrors&quot;</span>
    <span class="k">fi</span>

    <span class="nv">$xtrace</span>
    <span class="nv">$sudo_pip</span> <span class="nv">PIP_DOWNLOAD_CACHE</span><span class="o">=</span><span class="k">${</span><span class="nv">PIP_DOWNLOAD_CACHE</span><span class="k">:-</span><span class="p">/var/cache/pip</span><span class="k">}</span> <span class="se">\</span>
        <span class="nv">http_proxy</span><span class="o">=</span><span class="nv">$http_proxy</span> <span class="se">\</span>
        <span class="nv">https_proxy</span><span class="o">=</span><span class="nv">$https_proxy</span> <span class="se">\</span>
        <span class="nv">no_proxy</span><span class="o">=</span><span class="nv">$no_proxy</span> <span class="se">\</span>
        <span class="nv">$cmd_pip</span> install <span class="se">\</span>
        <span class="nv">$pip_mirror_opt</span> <span class="nv">$@</span>

    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$INSTALL_TESTONLY_PACKAGES&quot;</span> <span class="o">==</span> <span class="s2">&quot;True&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nb">local </span><span class="nv">test_req</span><span class="o">=</span><span class="s2">&quot;$@/test-requirements.txt&quot;</span>
        <span class="k">if</span> <span class="o">[[</span> -e <span class="s2">&quot;$test_req&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
            <span class="nv">$sudo_pip</span> <span class="nv">PIP_DOWNLOAD_CACHE</span><span class="o">=</span><span class="k">${</span><span class="nv">PIP_DOWNLOAD_CACHE</span><span class="k">:-</span><span class="p">/var/cache/pip</span><span class="k">}</span> <span class="se">\</span>
                <span class="nv">http_proxy</span><span class="o">=</span><span class="nv">$http_proxy</span> <span class="se">\</span>
                <span class="nv">https_proxy</span><span class="o">=</span><span class="nv">$https_proxy</span> <span class="se">\</span>
                <span class="nv">no_proxy</span><span class="o">=</span><span class="nv">$no_proxy</span> <span class="se">\</span>
                <span class="nv">$cmd_pip</span> install <span class="se">\</span>
                <span class="nv">$pip_mirror_opt</span> -r <span class="nv">$test_req</span>
        <span class="k">fi</span>
<span class="k">    fi</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>should we use this library from their git repo, or should we let it
get pulled in via pip dependencies.</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>use_library_from_git <span class="o">{</span>
    <span class="nb">local </span><span class="nv">name</span><span class="o">=</span><span class="nv">$1</span>
    <span class="nb">local </span><span class="nv">enabled</span><span class="o">=</span>1
    <span class="o">[[</span> ,<span class="k">${</span><span class="nv">LIBS_FROM_GIT</span><span class="k">}</span>, <span class="o">=</span>~ ,<span class="k">${</span><span class="nv">name</span><span class="k">}</span>, <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nv">enabled</span><span class="o">=</span>0
    <span class="k">return</span> <span class="nv">$enabled</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>setup a library by name. If we are trying to use the library from
git, we'll do a git based install, otherwise we'll punt and the
library should be installed by a requirements pull from another
project.</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>setup_lib <span class="o">{</span>
    <span class="nb">local </span><span class="nv">name</span><span class="o">=</span><span class="nv">$1</span>
    <span class="nb">local </span><span class="nv">dir</span><span class="o">=</span><span class="k">${</span><span class="nv">GITDIR</span><span class="p">[</span><span class="nv">$name</span><span class="p">]</span><span class="k">}</span>
    setup_install <span class="nv">$dir</span>
<span class="o">}</span>


</pre></div></td></tr><tr><td class=docs>
<p>this should be used if you want to install globally, all libraries should
use this, especially <em>oslo</em> ones</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>setup_install <span class="o">{</span>
    <span class="nb">local </span><span class="nv">project_dir</span><span class="o">=</span><span class="nv">$1</span>
    setup_package_with_req_sync <span class="nv">$project_dir</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>this should be used for projects which run services, like all services</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>setup_develop <span class="o">{</span>
    <span class="nb">local </span><span class="nv">project_dir</span><span class="o">=</span><span class="nv">$1</span>
    setup_package_with_req_sync <span class="nv">$project_dir</span> -e
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p><tt class="docutils literal">pip install <span class="pre">-e</span></tt> the package, which processes the dependencies
using pip before running <cite>setup.py develop</cite></p>
<p>Updates the dependencies in project_dir from the
openstack/requirements global list before installing anything.</p>
<p>Uses globals <tt class="docutils literal">TRACK_DEPENDS</tt>, <tt class="docutils literal">REQUIREMENTS_DIR</tt>, <tt class="docutils literal">UNDO_REQUIREMENTS</tt>
setup_develop directory</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>setup_package_with_req_sync <span class="o">{</span>
    <span class="nb">local </span><span class="nv">project_dir</span><span class="o">=</span><span class="nv">$1</span>
    <span class="nb">local </span><span class="nv">flags</span><span class="o">=</span><span class="nv">$2</span>

</pre></div></td></tr><tr><td class=docs>
<p>Don't update repo if local changes exist
Don't use buggy &quot;git diff --quiet&quot;
<tt class="docutils literal">errexit</tt> requires us to trap the exit code when the repo is changed</p>
</td><td class=code><div class=highlight><pre>
    <span class="nb">local </span><span class="nv">update_requirements</span><span class="o">=</span><span class="k">$(</span><span class="nb">cd</span> <span class="nv">$project_dir</span> <span class="o">&amp;&amp;</span> git diff --exit-code &gt;/dev/null <span class="o">||</span> <span class="nb">echo</span> <span class="s2">&quot;changed&quot;</span><span class="k">)</span>

    <span class="k">if</span> <span class="o">[[</span> <span class="nv">$update_requirements</span> !<span class="o">=</span> <span class="s2">&quot;changed&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
        <span class="o">(</span><span class="nb">cd</span> <span class="nv">$REQUIREMENTS_DIR</span>; <span class="se">\</span>
            python update.py <span class="nv">$project_dir</span><span class="o">)</span>
    <span class="k">fi</span>

<span class="k">    </span>setup_package <span class="nv">$project_dir</span> <span class="nv">$flags</span>

</pre></div></td></tr><tr><td class=docs>
<p>We've just gone and possibly modified the user's source tree in an
automated way, which is considered bad form if it's a development
tree because we've screwed up their next git checkin. So undo it.</p>
<p>However... there are some circumstances, like running in the gate
where we really really want the overridden version to stick. So provide
a variable that tells us whether or not we should UNDO the requirements
changes (this will be set to False in the OpenStack ci gate)</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">if</span> <span class="o">[</span> <span class="nv">$UNDO_REQUIREMENTS</span> <span class="o">=</span> <span class="s2">&quot;True&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">        if</span> <span class="o">[[</span> <span class="nv">$update_requirements</span> !<span class="o">=</span> <span class="s2">&quot;changed&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
            <span class="o">(</span><span class="nb">cd</span> <span class="nv">$project_dir</span> <span class="o">&amp;&amp;</span> git reset --hard<span class="o">)</span>
        <span class="k">fi</span>
<span class="k">    fi</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p><tt class="docutils literal">pip install <span class="pre">-e</span></tt> the package, which processes the dependencies
using pip before running <cite>setup.py develop</cite>
Uses globals <tt class="docutils literal">STACK_USER</tt>
setup_develop_no_requirements_update directory</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>setup_package <span class="o">{</span>
    <span class="nb">local </span><span class="nv">project_dir</span><span class="o">=</span><span class="nv">$1</span>
    <span class="nb">local </span><span class="nv">flags</span><span class="o">=</span><span class="nv">$2</span>

    pip_install <span class="nv">$flags</span> <span class="nv">$project_dir</span>
</pre></div></td></tr><tr><td class=docs>
<p>ensure that further actions can do things like setup.py sdist</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$flags&quot;</span> <span class="o">==</span> <span class="s2">&quot;-e&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span>safe_chown -R <span class="nv">$STACK_USER</span> <span class="nv">$1</span>/*.egg-info
    <span class="k">fi</span>
<span class="o">}</span>


</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="service-functions">
<h1>Service Functions</h1>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>remove extra commas from the input string (i.e. <tt class="docutils literal">ENABLED_SERVICES</tt>)
_cleanup_service_list service-list</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>_cleanup_service_list <span class="o">{</span>
    <span class="nb">echo</span> <span class="s2">&quot;$1&quot;</span> | sed -e <span class="s1">&#39;</span>
<span class="s1">        s/,,/,/g;</span>
<span class="s1">        s/^,//;</span>
<span class="s1">        s/,$//</span>
<span class="s1">    &#39;</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>disable_all_services() removes all current services
from <tt class="docutils literal">ENABLED_SERVICES</tt> to reset the configuration
before a minimal installation
Uses global <tt class="docutils literal">ENABLED_SERVICES</tt>
disable_all_services</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>disable_all_services <span class="o">{</span>
    <span class="nv">ENABLED_SERVICES</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Remove all services starting with '-'.  For example, to install all default
services except rabbit (rabbit) set in <tt class="docutils literal">localrc</tt>:
ENABLED_SERVICES+=&quot;,-rabbit&quot;
Uses global <tt class="docutils literal">ENABLED_SERVICES</tt>
disable_negated_services</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>disable_negated_services <span class="o">{</span>
    <span class="nb">local </span><span class="nv">tmpsvcs</span><span class="o">=</span><span class="s2">&quot;${ENABLED_SERVICES}&quot;</span>
    <span class="nb">local </span>service
    <span class="k">for </span>service in <span class="k">${</span><span class="nv">tmpsvcs</span><span class="p">//,/ </span><span class="k">}</span>; <span class="k">do</span>
<span class="k">        if</span> <span class="o">[[</span> <span class="k">${</span><span class="nv">service</span><span class="k">}</span> <span class="o">==</span> -* <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            </span><span class="nv">tmpsvcs</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="k">${</span><span class="nv">tmpsvcs</span><span class="k">}</span>|sed -r <span class="s2">&quot;s/(,)?(-)?${service#-}(,)?/,/g&quot;</span><span class="k">)</span>
        <span class="k">fi</span>
<span class="k">    done</span>
<span class="k">    </span><span class="nv">ENABLED_SERVICES</span><span class="o">=</span><span class="k">$(</span>_cleanup_service_list <span class="s2">&quot;$tmpsvcs&quot;</span><span class="k">)</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>disable_service() removes the services passed as argument to the
<tt class="docutils literal">ENABLED_SERVICES</tt> list, if they are present.</p>
<dl class="docutils">
<dt>For example:</dt>
<dd>disable_service rabbit</dd>
</dl>
<p>This function does not know about the special cases
for nova, glance, and neutron built into is_service_enabled().
Uses global <tt class="docutils literal">ENABLED_SERVICES</tt>
disable_service service [service ...]</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>disable_service <span class="o">{</span>
    <span class="nb">local </span><span class="nv">tmpsvcs</span><span class="o">=</span><span class="s2">&quot;,${ENABLED_SERVICES},&quot;</span>
    <span class="nb">local </span>service
    <span class="k">for </span>service in <span class="nv">$@</span>; <span class="k">do</span>
<span class="k">        if </span>is_service_enabled <span class="nv">$service</span>; <span class="k">then</span>
<span class="k">            </span><span class="nv">tmpsvcs</span><span class="o">=</span><span class="k">${</span><span class="nv">tmpsvcs</span><span class="p">//,</span><span class="nv">$service</span><span class="p">,/,</span><span class="k">}</span>
        <span class="k">fi</span>
<span class="k">    done</span>
<span class="k">    </span><span class="nv">ENABLED_SERVICES</span><span class="o">=</span><span class="k">$(</span>_cleanup_service_list <span class="s2">&quot;$tmpsvcs&quot;</span><span class="k">)</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>enable_service() adds the services passed as argument to the
<tt class="docutils literal">ENABLED_SERVICES</tt> list, if they are not already present.</p>
<dl class="docutils">
<dt>For example:</dt>
<dd>enable_service qpid</dd>
</dl>
<p>This function does not know about the special cases
for nova, glance, and neutron built into is_service_enabled().
Uses global <tt class="docutils literal">ENABLED_SERVICES</tt>
enable_service service [service ...]</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>enable_service <span class="o">{</span>
    <span class="nb">local </span><span class="nv">tmpsvcs</span><span class="o">=</span><span class="s2">&quot;${ENABLED_SERVICES}&quot;</span>
    <span class="nb">local </span>service
    <span class="k">for </span>service in <span class="nv">$@</span>; <span class="k">do</span>
<span class="k">        if</span> ! is_service_enabled <span class="nv">$service</span>; <span class="k">then</span>
<span class="k">            </span>tmpsvcs+<span class="o">=</span><span class="s2">&quot;,$service&quot;</span>
        <span class="k">fi</span>
<span class="k">    done</span>
<span class="k">    </span><span class="nv">ENABLED_SERVICES</span><span class="o">=</span><span class="k">$(</span>_cleanup_service_list <span class="s2">&quot;$tmpsvcs&quot;</span><span class="k">)</span>
    disable_negated_services
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>is_service_enabled() checks if the service(s) specified as arguments are
enabled by the user in <tt class="docutils literal">ENABLED_SERVICES</tt>.</p>
<p>Multiple services specified as arguments are <tt class="docutils literal">OR</tt>'ed together; the test
is a short-circuit boolean, i.e it returns on the first match.</p>
<dl class="docutils">
<dt>There are special cases for some 'catch-all' services::</dt>
<dd><strong>nova</strong> returns true if any service enabled start with <strong>n-</strong>
<strong>cinder</strong> returns true if any service enabled start with <strong>c-</strong>
<strong>ceilometer</strong> returns true if any service enabled start with <strong>ceilometer</strong>
<strong>glance</strong> returns true if any service enabled start with <strong>g-</strong>
<strong>neutron</strong> returns true if any service enabled start with <strong>q-</strong>
<strong>swift</strong> returns true if any service enabled start with <strong>s-</strong>
<strong>trove</strong> returns true if any service enabled start with <strong>tr-</strong>
For backward compatibility if we have <strong>swift</strong> in ENABLED_SERVICES all the
<strong>s-</strong> services will be enabled. This will be deprecated in the future.</dd>
</dl>
<p>Cells within nova is enabled if <strong>n-cell</strong> is in <tt class="docutils literal">ENABLED_SERVICES</tt>.
We also need to make sure to treat <strong>n-cell-region</strong> and <strong>n-cell-child</strong>
as enabled in this case.</p>
<p>Uses global <tt class="docutils literal">ENABLED_SERVICES</tt>
is_service_enabled service [service ...]</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>is_service_enabled <span class="o">{</span>
    <span class="nb">local </span><span class="nv">xtrace</span><span class="o">=</span><span class="k">$(</span><span class="nb">set</span> +o | grep xtrace<span class="k">)</span>
    <span class="nb">set</span> +o xtrace
    <span class="nb">local </span><span class="nv">enabled</span><span class="o">=</span>1
    <span class="nb">local </span><span class="nv">services</span><span class="o">=</span><span class="nv">$@</span>
    <span class="nb">local </span>service
    <span class="k">for </span>service in <span class="k">${</span><span class="nv">services</span><span class="k">}</span>; <span class="k">do</span>
        <span class="o">[[</span> ,<span class="k">${</span><span class="nv">ENABLED_SERVICES</span><span class="k">}</span>, <span class="o">=</span>~ ,<span class="k">${</span><span class="nv">service</span><span class="k">}</span>, <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nv">enabled</span><span class="o">=</span>0

</pre></div></td></tr><tr><td class=docs>
<p>Look for top-level 'enabled' function for this service</p>
</td><td class=code><div class=highlight><pre>
        <span class="k">if </span><span class="nb">type </span>is_<span class="k">${</span><span class="nv">service</span><span class="k">}</span>_enabled &gt;/dev/null 2&gt;&amp;1; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>A function exists for this service, use it</p>
</td><td class=code><div class=highlight><pre>
            is_<span class="k">${</span><span class="nv">service</span><span class="k">}</span>_enabled
            <span class="nv">enabled</span><span class="o">=</span><span class="nv">$?</span>
        <span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<dl class="docutils">
<dt>TODO(dtroyer): Remove these legacy special-cases after the is_XXX_enabled()</dt>
<dd>are implemented</dd>
</dl>
</td><td class=code><div class=highlight><pre>

        <span class="o">[[</span> <span class="k">${</span><span class="nv">service</span><span class="k">}</span> <span class="o">==</span> n-cell-* <span class="o">&amp;&amp;</span> <span class="k">${</span><span class="nv">ENABLED_SERVICES</span><span class="k">}</span> <span class="o">=</span>~ <span class="s2">&quot;n-cell&quot;</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nv">enabled</span><span class="o">=</span>0
        <span class="o">[[</span> <span class="k">${</span><span class="nv">service</span><span class="k">}</span> <span class="o">==</span> n-cpu-* <span class="o">&amp;&amp;</span> <span class="k">${</span><span class="nv">ENABLED_SERVICES</span><span class="k">}</span> <span class="o">=</span>~ <span class="s2">&quot;n-cpu&quot;</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nv">enabled</span><span class="o">=</span>0
        <span class="o">[[</span> <span class="k">${</span><span class="nv">service</span><span class="k">}</span> <span class="o">==</span> <span class="s2">&quot;nova&quot;</span> <span class="o">&amp;&amp;</span> <span class="k">${</span><span class="nv">ENABLED_SERVICES</span><span class="k">}</span> <span class="o">=</span>~ <span class="s2">&quot;n-&quot;</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nv">enabled</span><span class="o">=</span>0
        <span class="o">[[</span> <span class="k">${</span><span class="nv">service</span><span class="k">}</span> <span class="o">==</span> <span class="s2">&quot;cinder&quot;</span> <span class="o">&amp;&amp;</span> <span class="k">${</span><span class="nv">ENABLED_SERVICES</span><span class="k">}</span> <span class="o">=</span>~ <span class="s2">&quot;c-&quot;</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nv">enabled</span><span class="o">=</span>0
        <span class="o">[[</span> <span class="k">${</span><span class="nv">service</span><span class="k">}</span> <span class="o">==</span> <span class="s2">&quot;ceilometer&quot;</span> <span class="o">&amp;&amp;</span> <span class="k">${</span><span class="nv">ENABLED_SERVICES</span><span class="k">}</span> <span class="o">=</span>~ <span class="s2">&quot;ceilometer-&quot;</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nv">enabled</span><span class="o">=</span>0
        <span class="o">[[</span> <span class="k">${</span><span class="nv">service</span><span class="k">}</span> <span class="o">==</span> <span class="s2">&quot;glance&quot;</span> <span class="o">&amp;&amp;</span> <span class="k">${</span><span class="nv">ENABLED_SERVICES</span><span class="k">}</span> <span class="o">=</span>~ <span class="s2">&quot;g-&quot;</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nv">enabled</span><span class="o">=</span>0
        <span class="o">[[</span> <span class="k">${</span><span class="nv">service</span><span class="k">}</span> <span class="o">==</span> <span class="s2">&quot;ironic&quot;</span> <span class="o">&amp;&amp;</span> <span class="k">${</span><span class="nv">ENABLED_SERVICES</span><span class="k">}</span> <span class="o">=</span>~ <span class="s2">&quot;ir-&quot;</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nv">enabled</span><span class="o">=</span>0
        <span class="o">[[</span> <span class="k">${</span><span class="nv">service</span><span class="k">}</span> <span class="o">==</span> <span class="s2">&quot;neutron&quot;</span> <span class="o">&amp;&amp;</span> <span class="k">${</span><span class="nv">ENABLED_SERVICES</span><span class="k">}</span> <span class="o">=</span>~ <span class="s2">&quot;q-&quot;</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nv">enabled</span><span class="o">=</span>0
        <span class="o">[[</span> <span class="k">${</span><span class="nv">service</span><span class="k">}</span> <span class="o">==</span> <span class="s2">&quot;trove&quot;</span> <span class="o">&amp;&amp;</span> <span class="k">${</span><span class="nv">ENABLED_SERVICES</span><span class="k">}</span> <span class="o">=</span>~ <span class="s2">&quot;tr-&quot;</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nv">enabled</span><span class="o">=</span>0
        <span class="o">[[</span> <span class="k">${</span><span class="nv">service</span><span class="k">}</span> <span class="o">==</span> <span class="s2">&quot;swift&quot;</span> <span class="o">&amp;&amp;</span> <span class="k">${</span><span class="nv">ENABLED_SERVICES</span><span class="k">}</span> <span class="o">=</span>~ <span class="s2">&quot;s-&quot;</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nv">enabled</span><span class="o">=</span>0
        <span class="o">[[</span> <span class="k">${</span><span class="nv">service</span><span class="k">}</span> <span class="o">==</span> s-* <span class="o">&amp;&amp;</span> <span class="k">${</span><span class="nv">ENABLED_SERVICES</span><span class="k">}</span> <span class="o">=</span>~ <span class="s2">&quot;swift&quot;</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nv">enabled</span><span class="o">=</span>0
        <span class="o">[[</span> <span class="k">${</span><span class="nv">service</span><span class="k">}</span> <span class="o">==</span> key-* <span class="o">&amp;&amp;</span> <span class="k">${</span><span class="nv">ENABLED_SERVICES</span><span class="k">}</span> <span class="o">=</span>~ <span class="s2">&quot;key&quot;</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nv">enabled</span><span class="o">=</span>0
    <span class="k">done</span>
    <span class="nv">$xtrace</span>
    <span class="k">return</span> <span class="nv">$enabled</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<dl class="docutils">
<dt>Toggle enable/disable_service for services that must run exclusive of each other</dt>
<dd>$1 The name of a variable containing a space-separated list of services
$2 The name of a variable in which to store the enabled service's name
$3 The name of the service to enable</dd>
</dl>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>use_exclusive_service <span class="o">{</span>
    <span class="nb">local </span><span class="nv">options</span><span class="o">=</span><span class="k">${</span><span class="p">!1</span><span class="k">}</span>
    <span class="nb">local </span><span class="nv">selection</span><span class="o">=</span><span class="nv">$3</span>
    <span class="nb">local </span><span class="nv">out</span><span class="o">=</span><span class="nv">$2</span>
    <span class="o">[</span> -z <span class="nv">$selection</span> <span class="o">]</span> <span class="o">||</span> <span class="o">[[</span> ! <span class="s2">&quot;$options&quot;</span> <span class="o">=</span>~ <span class="s2">&quot;$selection&quot;</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="k">return </span>1
    <span class="nb">local </span>opt
    <span class="k">for </span>opt in <span class="nv">$options</span>;<span class="k">do</span>
        <span class="o">[[</span> <span class="s2">&quot;$opt&quot;</span> <span class="o">=</span> <span class="s2">&quot;$selection&quot;</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> enable_service <span class="nv">$opt</span> <span class="o">||</span> disable_service <span class="nv">$opt</span>
    <span class="k">done</span>
<span class="k">    </span><span class="nb">eval</span> <span class="s2">&quot;$out=$selection&quot;</span>
    <span class="k">return </span>0
<span class="o">}</span>


</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="system-functions">
<h1>System Functions</h1>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Only run the command if the target file (the last arg) is not on an
NFS filesystem.</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>_safe_permission_operation <span class="o">{</span>
    <span class="nb">local </span><span class="nv">xtrace</span><span class="o">=</span><span class="k">$(</span><span class="nb">set</span> +o | grep xtrace<span class="k">)</span>
    <span class="nb">set</span> +o xtrace
    <span class="nb">local </span><span class="nv">args</span><span class="o">=(</span> <span class="nv">$@</span> <span class="o">)</span>
    <span class="nb">local </span>last
    <span class="nb">local </span>sudo_cmd
    <span class="nb">local </span>dir_to_check

    <span class="nb">let </span><span class="nv">last</span><span class="o">=</span><span class="s2">&quot;${#args[*]} - 1&quot;</span>

    <span class="nb">local </span><span class="nv">dir_to_check</span><span class="o">=</span><span class="k">${</span><span class="nv">args</span><span class="p">[</span><span class="nv">$last</span><span class="p">]</span><span class="k">}</span>
    <span class="k">if</span> <span class="o">[</span> ! -d <span class="s2">&quot;$dir_to_check&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nv">dir_to_check</span><span class="o">=</span><span class="sb">`</span>dirname <span class="s2">&quot;$dir_to_check&quot;</span><span class="sb">`</span>
    <span class="k">fi</span>

<span class="k">    if </span>is_nfs_directory <span class="s2">&quot;$dir_to_check&quot;</span> ; <span class="k">then</span>
        <span class="nv">$xtrace</span>
        <span class="k">return </span>0
    <span class="k">fi</span>

<span class="k">    if</span> <span class="o">[[</span> <span class="nv">$TRACK_DEPENDS</span> <span class="o">=</span> True <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nv">sudo_cmd</span><span class="o">=</span><span class="s2">&quot;env&quot;</span>
    <span class="k">else</span>
<span class="k">        </span><span class="nv">sudo_cmd</span><span class="o">=</span><span class="s2">&quot;sudo&quot;</span>
    <span class="k">fi</span>

    <span class="nv">$xtrace</span>
    <span class="nv">$sudo_cmd</span> <span class="nv">$@</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Exit 0 if address is in network or 1 if address is not in network
ip-range is in CIDR notation: 1.2.3.4/20
address_in_net ip-address ip-range</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>address_in_net <span class="o">{</span>
    <span class="nb">local </span><span class="nv">ip</span><span class="o">=</span><span class="nv">$1</span>
    <span class="nb">local </span><span class="nv">range</span><span class="o">=</span><span class="nv">$2</span>
    <span class="nb">local </span><span class="nv">masklen</span><span class="o">=</span><span class="k">${</span><span class="nv">range</span><span class="p">#*/</span><span class="k">}</span>
    <span class="nb">local </span><span class="nv">network</span><span class="o">=</span><span class="k">$(</span>maskip <span class="k">${</span><span class="nv">range</span><span class="p">%/*</span><span class="k">}</span> <span class="k">$(</span>cidr2netmask <span class="nv">$masklen</span><span class="k">))</span>
    <span class="nb">local </span><span class="nv">subnet</span><span class="o">=</span><span class="k">$(</span>maskip <span class="nv">$ip</span> <span class="k">$(</span>cidr2netmask <span class="nv">$masklen</span><span class="k">))</span>
    <span class="o">[[</span> <span class="nv">$network</span> <span class="o">==</span> <span class="nv">$subnet</span> <span class="o">]]</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Add a user to a group.
add_user_to_group user group</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>add_user_to_group <span class="o">{</span>
    <span class="nb">local </span><span class="nv">user</span><span class="o">=</span><span class="nv">$1</span>
    <span class="nb">local </span><span class="nv">group</span><span class="o">=</span><span class="nv">$2</span>

    <span class="k">if</span> <span class="o">[[</span> -z <span class="s2">&quot;$os_VENDOR&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span>GetOSVersion
    <span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>SLE11 and openSUSE 12.2 don't have the usual usermod</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">if</span> ! is_suse <span class="o">||</span> <span class="o">[[</span> <span class="s2">&quot;$os_VENDOR&quot;</span> <span class="o">=</span> <span class="s2">&quot;openSUSE&quot;</span> <span class="o">&amp;&amp;</span> <span class="s2">&quot;$os_RELEASE&quot;</span> !<span class="o">=</span> <span class="s2">&quot;12.2&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span>sudo usermod -a -G <span class="s2">&quot;$group&quot;</span> <span class="s2">&quot;$user&quot;</span>
    <span class="k">else</span>
<span class="k">        </span>sudo usermod -A <span class="s2">&quot;$group&quot;</span> <span class="s2">&quot;$user&quot;</span>
    <span class="k">fi</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Convert CIDR notation to a IPv4 netmask
cidr2netmask cidr-bits</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>cidr2netmask <span class="o">{</span>
    <span class="nb">local </span><span class="nv">maskpat</span><span class="o">=</span><span class="s2">&quot;255 255 255 255&quot;</span>
    <span class="nb">local </span><span class="nv">maskdgt</span><span class="o">=</span><span class="s2">&quot;254 252 248 240 224 192 128&quot;</span>
    <span class="nb">set</span> -- <span class="k">${</span><span class="nv">maskpat</span><span class="p">:</span><span class="nv">0</span><span class="p">:</span><span class="k">$((</span> <span class="o">(</span><span class="nv">$1</span> <span class="o">/</span> <span class="m">8</span><span class="o">)</span> <span class="o">*</span> <span class="m">4</span> <span class="k">))}${</span><span class="nv">maskdgt</span><span class="p">:</span><span class="k">$((</span> <span class="o">(</span><span class="m">7</span> <span class="o">-</span> <span class="o">(</span><span class="nv">$1</span> <span class="o">%</span> <span class="m">8</span><span class="k">))</span><span class="p"> * 4 )):</span><span class="nv">3</span><span class="k">}</span>
    <span class="nb">echo</span> <span class="k">${</span><span class="nv">1</span><span class="p">-0</span><span class="k">}</span>.<span class="k">${</span><span class="nv">2</span><span class="p">-0</span><span class="k">}</span>.<span class="k">${</span><span class="nv">3</span><span class="p">-0</span><span class="k">}</span>.<span class="k">${</span><span class="nv">4</span><span class="p">-0</span><span class="k">}</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Gracefully cp only if source file/dir exists
cp_it source destination</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>cp_it <span class="o">{</span>
    <span class="k">if</span> <span class="o">[</span> -e <span class="nv">$1</span> <span class="o">]</span> <span class="o">||</span> <span class="o">[</span> -d <span class="nv">$1</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">        </span>cp -pRL <span class="nv">$1</span> <span class="nv">$2</span>
    <span class="k">fi</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>HTTP and HTTPS proxy servers are supported via the usual environment variables [1]
<tt class="docutils literal">http_proxy</tt>, <tt class="docutils literal">https_proxy</tt> and <tt class="docutils literal">no_proxy</tt>. They can be set in
<tt class="docutils literal">localrc</tt> or on the command line if necessary:</p>
<pre class="literal-block">
[1] http://www.w3.org/Daemon/User/Proxies/ProxyClients.html
</pre>
<blockquote>
http_proxy=http://proxy.example.com:3128/ no_proxy=repo.example.net ./stack.sh</blockquote>
</td><td class=code><div class=highlight><pre>

<span class="k">function </span>export_proxy_variables <span class="o">{</span>
    <span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&quot;$http_proxy&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nb">export </span><span class="nv">http_proxy</span><span class="o">=</span><span class="nv">$http_proxy</span>
    <span class="k">fi</span>
<span class="k">    if</span> <span class="o">[[</span> -n <span class="s2">&quot;$https_proxy&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nb">export </span><span class="nv">https_proxy</span><span class="o">=</span><span class="nv">$https_proxy</span>
    <span class="k">fi</span>
<span class="k">    if</span> <span class="o">[[</span> -n <span class="s2">&quot;$no_proxy&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nb">export </span><span class="nv">no_proxy</span><span class="o">=</span><span class="nv">$no_proxy</span>
    <span class="k">fi</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Returns true if the directory is on a filesystem mounted via NFS.</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>is_nfs_directory <span class="o">{</span>
    <span class="nb">local </span><span class="nv">mount_type</span><span class="o">=</span><span class="sb">`</span>stat -f -L -c %T <span class="nv">$1</span><span class="sb">`</span>
    <span class="nb">test</span> <span class="s2">&quot;$mount_type&quot;</span> <span class="o">==</span> <span class="s2">&quot;nfs&quot;</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Return the network portion of the given IP address using netmask
netmask is in the traditional dotted-quad format
maskip ip-address netmask</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>maskip <span class="o">{</span>
    <span class="nb">local </span><span class="nv">ip</span><span class="o">=</span><span class="nv">$1</span>
    <span class="nb">local </span><span class="nv">mask</span><span class="o">=</span><span class="nv">$2</span>
    <span class="nb">local </span><span class="nv">l</span><span class="o">=</span><span class="s2">&quot;${ip%.*}&quot;</span>; <span class="nb">local </span><span class="nv">r</span><span class="o">=</span><span class="s2">&quot;${ip#*.}&quot;</span>; <span class="nb">local </span><span class="nv">n</span><span class="o">=</span><span class="s2">&quot;${mask%.*}&quot;</span>; <span class="nb">local </span><span class="nv">m</span><span class="o">=</span><span class="s2">&quot;${mask#*.}&quot;</span>
    <span class="nb">local </span><span class="nv">subnet</span><span class="o">=</span><span class="k">$((${</span><span class="nv">ip</span><span class="p">%%.*</span><span class="k">}</span><span class="o">&amp;</span><span class="k">${</span><span class="nv">mask</span><span class="p">%%.*</span><span class="k">}))</span>.<span class="k">$((${</span><span class="nv">r</span><span class="p">%%.*</span><span class="k">}</span><span class="o">&amp;</span><span class="k">${</span><span class="nv">m</span><span class="p">%%.*</span><span class="k">}))</span>.<span class="k">$((${</span><span class="nv">l</span><span class="p">##*.</span><span class="k">}</span><span class="o">&amp;</span><span class="k">${</span><span class="nv">n</span><span class="p">##*.</span><span class="k">}))</span>.<span class="k">$((${</span><span class="nv">ip</span><span class="p">##*.</span><span class="k">}</span><span class="o">&amp;</span><span class="k">${</span><span class="nv">mask</span><span class="p">##*.</span><span class="k">}))</span>
    <span class="nb">echo</span> <span class="nv">$subnet</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Service wrapper to restart services
restart_service service-name</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>restart_service <span class="o">{</span>
    <span class="k">if </span>is_ubuntu; <span class="k">then</span>
<span class="k">        </span>sudo /usr/sbin/service <span class="nv">$1</span> restart
    <span class="k">else</span>
<span class="k">        </span>sudo /sbin/service <span class="nv">$1</span> restart
    <span class="k">fi</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Only change permissions of a file or directory if it is not on an
NFS filesystem.</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>safe_chmod <span class="o">{</span>
    _safe_permission_operation chmod <span class="nv">$@</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Only change ownership of a file or directory if it is not on an NFS
filesystem.</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>safe_chown <span class="o">{</span>
    _safe_permission_operation chown <span class="nv">$@</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Service wrapper to start services
start_service service-name</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>start_service <span class="o">{</span>
    <span class="k">if </span>is_ubuntu; <span class="k">then</span>
<span class="k">        </span>sudo /usr/sbin/service <span class="nv">$1</span> start
    <span class="k">else</span>
<span class="k">        </span>sudo /sbin/service <span class="nv">$1</span> start
    <span class="k">fi</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Service wrapper to stop services
stop_service service-name</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>stop_service <span class="o">{</span>
    <span class="k">if </span>is_ubuntu; <span class="k">then</span>
<span class="k">        </span>sudo /usr/sbin/service <span class="nv">$1</span> stop
    <span class="k">else</span>
<span class="k">        </span>sudo /sbin/service <span class="nv">$1</span> stop
    <span class="k">fi</span>
<span class="o">}</span>


</pre></div></td></tr><tr><td class=docs>
<p>Restore xtrace</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">$XTRACE</span>

</pre></div></td></tr><tr><td class=docs>
<p>Local variables:
mode: shell-script
End:</p>
</td><td class=code><div class=highlight><pre>


</td><td class=code><div class=highlight><pre>
</pre></div></td></tr><tr><td class=docs>
</pre></div></td></tr><tr><td class=docs>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
</div>
</div>
</body>
</html></td><td class='code'></td></tr>
    </tbody>
    </table>
</div>
</body>
</html>
