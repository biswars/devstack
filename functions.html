<!DOCTYPE html>
<html>
<head>
    <meta http-eqiv='content-type' content='text/html;charset=utf-8'>
    <title>functions</title>
    <link rel=stylesheet href="http://jashkenas.github.com/docco/resources/docco.css">
</head>
<body>
<div id=container>
    <div id=background></div>
    <table cellspacing=0 cellpadding=0>
    <thead>
      <tr>
        <th class=docs><h1>functions</h1></th>
        <th class=code></th>
      </tr>
    </thead>
    <tbody>
        <tr><td class='docs'><?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.12: http://docutils.sourceforge.net/" />
<title></title>
<style type="text/css">

/*
:Author: David Goodger (goodger@python.org)
:Id: $Id: html4css1.css 7614 2013-02-21 15:55:51Z milde $
:Copyright: This stylesheet has been placed in the public domain.

Default cascading style sheet for the HTML output of Docutils.

See http://docutils.sf.net/docs/howto/html-stylesheets.html for how to
customize this style sheet.
*/

/* used to remove borders from tables and images */
.borderless, table.borderless td, table.borderless th {
  border: 0 }

table.borderless td, table.borderless th {
  /* Override padding for "table.docutils td" with "! important".
     The right padding separates the table cells. */
  padding: 0 0.5em 0 0 ! important }

.first {
  /* Override more specific margin styles with "! important". */
  margin-top: 0 ! important }

.last, .with-subtitle {
  margin-bottom: 0 ! important }

.hidden {
  display: none }

a.toc-backref {
  text-decoration: none ;
  color: black }

blockquote.epigraph {
  margin: 2em 5em ; }

dl.docutils dd {
  margin-bottom: 0.5em }

object[type="image/svg+xml"], object[type="application/x-shockwave-flash"] {
  overflow: hidden;
}

/* Uncomment (and remove this text!) to get bold-faced definition list terms
dl.docutils dt {
  font-weight: bold }
*/

div.abstract {
  margin: 2em 5em }

div.abstract p.topic-title {
  font-weight: bold ;
  text-align: center }

div.admonition, div.attention, div.caution, div.danger, div.error,
div.hint, div.important, div.note, div.tip, div.warning {
  margin: 2em ;
  border: medium outset ;
  padding: 1em }

div.admonition p.admonition-title, div.hint p.admonition-title,
div.important p.admonition-title, div.note p.admonition-title,
div.tip p.admonition-title {
  font-weight: bold ;
  font-family: sans-serif }

div.attention p.admonition-title, div.caution p.admonition-title,
div.danger p.admonition-title, div.error p.admonition-title,
div.warning p.admonition-title, .code .error {
  color: red ;
  font-weight: bold ;
  font-family: sans-serif }

/* Uncomment (and remove this text!) to get reduced vertical space in
   compound paragraphs.
div.compound .compound-first, div.compound .compound-middle {
  margin-bottom: 0.5em }

div.compound .compound-last, div.compound .compound-middle {
  margin-top: 0.5em }
*/

div.dedication {
  margin: 2em 5em ;
  text-align: center ;
  font-style: italic }

div.dedication p.topic-title {
  font-weight: bold ;
  font-style: normal }

div.figure {
  margin-left: 2em ;
  margin-right: 2em }

div.footer, div.header {
  clear: both;
  font-size: smaller }

div.line-block {
  display: block ;
  margin-top: 1em ;
  margin-bottom: 1em }

div.line-block div.line-block {
  margin-top: 0 ;
  margin-bottom: 0 ;
  margin-left: 1.5em }

div.sidebar {
  margin: 0 0 0.5em 1em ;
  border: medium outset ;
  padding: 1em ;
  background-color: #ffffee ;
  width: 40% ;
  float: right ;
  clear: right }

div.sidebar p.rubric {
  font-family: sans-serif ;
  font-size: medium }

div.system-messages {
  margin: 5em }

div.system-messages h1 {
  color: red }

div.system-message {
  border: medium outset ;
  padding: 1em }

div.system-message p.system-message-title {
  color: red ;
  font-weight: bold }

div.topic {
  margin: 2em }

h1.section-subtitle, h2.section-subtitle, h3.section-subtitle,
h4.section-subtitle, h5.section-subtitle, h6.section-subtitle {
  margin-top: 0.4em }

h1.title {
  text-align: center }

h2.subtitle {
  text-align: center }

hr.docutils {
  width: 75% }

img.align-left, .figure.align-left, object.align-left {
  clear: left ;
  float: left ;
  margin-right: 1em }

img.align-right, .figure.align-right, object.align-right {
  clear: right ;
  float: right ;
  margin-left: 1em }

img.align-center, .figure.align-center, object.align-center {
  display: block;
  margin-left: auto;
  margin-right: auto;
}

.align-left {
  text-align: left }

.align-center {
  clear: both ;
  text-align: center }

.align-right {
  text-align: right }

/* reset inner alignment in figures */
div.align-right {
  text-align: inherit }

/* div.align-center * { */
/*   text-align: left } */

ol.simple, ul.simple {
  margin-bottom: 1em }

ol.arabic {
  list-style: decimal }

ol.loweralpha {
  list-style: lower-alpha }

ol.upperalpha {
  list-style: upper-alpha }

ol.lowerroman {
  list-style: lower-roman }

ol.upperroman {
  list-style: upper-roman }

p.attribution {
  text-align: right ;
  margin-left: 50% }

p.caption {
  font-style: italic }

p.credits {
  font-style: italic ;
  font-size: smaller }

p.label {
  white-space: nowrap }

p.rubric {
  font-weight: bold ;
  font-size: larger ;
  color: maroon ;
  text-align: center }

p.sidebar-title {
  font-family: sans-serif ;
  font-weight: bold ;
  font-size: larger }

p.sidebar-subtitle {
  font-family: sans-serif ;
  font-weight: bold }

p.topic-title {
  font-weight: bold }

pre.address {
  margin-bottom: 0 ;
  margin-top: 0 ;
  font: inherit }

pre.literal-block, pre.doctest-block, pre.math, pre.code {
  margin-left: 2em ;
  margin-right: 2em }

pre.code .ln { color: grey; } /* line numbers */
pre.code, code { background-color: #eeeeee }
pre.code .comment, code .comment { color: #5C6576 }
pre.code .keyword, code .keyword { color: #3B0D06; font-weight: bold }
pre.code .literal.string, code .literal.string { color: #0C5404 }
pre.code .name.builtin, code .name.builtin { color: #352B84 }
pre.code .deleted, code .deleted { background-color: #DEB0A1}
pre.code .inserted, code .inserted { background-color: #A3D289}

span.classifier {
  font-family: sans-serif ;
  font-style: oblique }

span.classifier-delimiter {
  font-family: sans-serif ;
  font-weight: bold }

span.interpreted {
  font-family: sans-serif }

span.option {
  white-space: nowrap }

span.pre {
  white-space: pre }

span.problematic {
  color: red }

span.section-subtitle {
  /* font-size relative to parent (h1..h6 element) */
  font-size: 80% }

table.citation {
  border-left: solid 1px gray;
  margin-left: 1px }

table.docinfo {
  margin: 2em 4em }

table.docutils {
  margin-top: 0.5em ;
  margin-bottom: 0.5em }

table.footnote {
  border-left: solid 1px black;
  margin-left: 1px }

table.docutils td, table.docutils th,
table.docinfo td, table.docinfo th {
  padding-left: 0.5em ;
  padding-right: 0.5em ;
  vertical-align: top }

table.docutils th.field-name, table.docinfo th.docinfo-name {
  font-weight: bold ;
  text-align: left ;
  white-space: nowrap ;
  padding-left: 0 }

/* "booktabs" style (no vertical lines) */
table.docutils.booktabs {
  border: 0px;
  border-top: 2px solid;
  border-bottom: 2px solid;
  border-collapse: collapse;
}
table.docutils.booktabs * {
  border: 0px;
}
table.docutils.booktabs th {
  border-bottom: thin solid;
  text-align: left;
}

h1 tt.docutils, h2 tt.docutils, h3 tt.docutils,
h4 tt.docutils, h5 tt.docutils, h6 tt.docutils {
  font-size: 100% }

ul.auto-toc {
  list-style-type: none }

</style>
</head>
<body>
<div class="document">


<p>functions - DevStack-specific functions</p>
<p>The following variables are assumed to be defined by certain functions:</p>
<ul class="simple">
<li><tt class="docutils literal">DATABASE_BACKENDS</tt></li>
<li><tt class="docutils literal">ENABLED_SERVICES</tt></li>
<li><tt class="docutils literal">FILES</tt></li>
<li><tt class="docutils literal">GLANCE_HOSTPORT</tt></li>
</ul>
<p>Include the common functions</p>
</td><td class=code><div class=highlight><pre>

<span class="nv">FUNC_DIR</span><span class="o">=</span><span class="k">$(</span><span class="nb">cd</span> <span class="k">$(</span>dirname <span class="s2">&quot;${BASH_SOURCE:-$0}&quot;</span><span class="k">)</span> <span class="o">&amp;&amp;</span> <span class="nb">pwd</span><span class="k">)</span>
<span class="nb">source</span> <span class="k">${</span><span class="nv">FUNC_DIR</span><span class="k">}</span>/functions-common

</pre></div></td></tr><tr><td class=docs>
<p>Save trace setting</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">XTRACE</span><span class="o">=</span><span class="k">$(</span><span class="nb">set</span> +o | grep xtrace<span class="k">)</span>
<span class="nb">set</span> +o xtrace

</pre></div></td></tr><tr><td class=docs>
<p>Check if a function already exists</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>function_exists <span class="o">{</span>
    <span class="nb">declare</span> -f -F <span class="nv">$1</span> &gt; /dev/null
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Retrieve an image from a URL and upload into Glance.
Uses the following variables:</p>
<ul class="simple">
<li><tt class="docutils literal">FILES</tt> must be set to the cache dir</li>
<li><tt class="docutils literal">GLANCE_HOSTPORT</tt></li>
</ul>
<p>upload_image image-url glance-token</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>upload_image <span class="o">{</span>
    <span class="nb">local </span><span class="nv">image_url</span><span class="o">=</span><span class="nv">$1</span>
    <span class="nb">local </span><span class="nv">token</span><span class="o">=</span><span class="nv">$2</span>

    <span class="nb">local </span>image image_fname image_name

</pre></div></td></tr><tr><td class=docs>
<p>Create a directory for the downloaded image tarballs.</p>
</td><td class=code><div class=highlight><pre>
    mkdir -p <span class="nv">$FILES</span>/images
    <span class="nv">image_fname</span><span class="o">=</span><span class="sb">`</span>basename <span class="s2">&quot;$image_url&quot;</span><span class="sb">`</span>
    <span class="k">if</span> <span class="o">[[</span> <span class="nv">$image_url</span> !<span class="o">=</span> file* <span class="o">]]</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>Downloads the image (uec ami+akistyle), then extracts it.</p>
</td><td class=code><div class=highlight><pre>
        <span class="k">if</span> <span class="o">[[</span> ! -f <span class="nv">$FILES</span>/<span class="nv">$image_fname</span> <span class="o">||</span> <span class="s2">&quot;$(stat -c &quot;</span>%s<span class="s2">&quot; $FILES/$image_fname)&quot;</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            </span>wget -c <span class="nv">$image_url</span> -O <span class="nv">$FILES</span>/<span class="nv">$image_fname</span>
            <span class="k">if</span> <span class="o">[[</span> <span class="nv">$?</span> -ne 0 <span class="o">]]</span>; <span class="k">then</span>
<span class="k">                </span><span class="nb">echo</span> <span class="s2">&quot;Not found: $image_url&quot;</span>
                <span class="k">return</span>
<span class="k">            fi</span>
<span class="k">        fi</span>
<span class="k">        </span><span class="nv">image</span><span class="o">=</span><span class="s2">&quot;$FILES/${image_fname}&quot;</span>
    <span class="k">else</span>
</pre></div></td></tr><tr><td class=docs>
<p>File based URL (RFC 1738): <a class="reference external" href="file://host/path">file://host/path</a>
Remote files are not considered here.
<a href="#id1"><span class="problematic" id="id2">*</span></a>nix: <a class="reference external" href="file:///home/user/path/file">file:///home/user/path/file</a>
windows: <a class="reference external" href="file:///C:/Documents%20and%20Settings/user/path/file">file:///C:/Documents%20and%20Settings/user/path/file</a></p>
<div class="system-message" id="id1">
<p class="system-message-title">System Message: WARNING/2 (<tt class="docutils">&lt;stdin&gt;</tt>, line 40); <em><a href="#id2">backlink</a></em></p>
Inline emphasis start-string without end-string.</div>
</td><td class=code><div class=highlight><pre>
        <span class="nv">image</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$image_url</span> | sed <span class="s2">&quot;s/^file:\/\///g&quot;</span><span class="k">)</span>
        <span class="k">if</span> <span class="o">[[</span> ! -f <span class="nv">$image</span> <span class="o">||</span> <span class="s2">&quot;$(stat -c &quot;</span>%s<span class="s2">&quot; $image)&quot;</span> <span class="o">==</span> <span class="s2">&quot;0&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            </span><span class="nb">echo</span> <span class="s2">&quot;Not found: $image_url&quot;</span>
            <span class="k">return</span>
<span class="k">        fi</span>
<span class="k">    fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>OpenVZ-format images are provided as .tar.gz, but not decompressed prior to loading</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$image_url&quot;</span> <span class="o">=</span>~ <span class="s1">&#39;openvz&#39;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nv">image_name</span><span class="o">=</span><span class="s2">&quot;${image_fname%.tar.gz}&quot;</span>
        openstack --os-token <span class="nv">$token</span> --os-url <span class="nv">$GLANCE_SERVICE_PROTOCOL</span>://<span class="nv">$GLANCE_HOSTPORT</span> image create <span class="s2">&quot;$image_name&quot;</span> --public --container-format ami --disk-format ami &lt; <span class="s2">&quot;${image}&quot;</span>
        <span class="k">return</span>
<span class="k">    fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>vmdk format images</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$image_url&quot;</span> <span class="o">=</span>~ <span class="s1">&#39;.vmdk&#39;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nv">image_name</span><span class="o">=</span><span class="s2">&quot;${image_fname%.vmdk}&quot;</span>

</pre></div></td></tr><tr><td class=docs>
<p>Before we can upload vmdk type images to glance, we need to know it's
disk type, storage adapter, and networking adapter. These values are
passed to glance as custom properties.
We take these values from the vmdk file if populated. Otherwise, we use
vmdk filename, which is expected in the following format:</p>
<blockquote>
&lt;name&gt;-&lt;disk type&gt;;&lt;storage adapter&gt;;&lt;network adapter&gt;</blockquote>
<p>If the filename does not follow the above format then the vsphere
driver will supply default values.</p>
</td><td class=code><div class=highlight><pre>

        <span class="nb">local </span><span class="nv">vmdk_disktype</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
        <span class="nb">local </span><span class="nv">vmdk_net_adapter</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
        <span class="nb">local </span>path_len

</pre></div></td></tr><tr><td class=docs>
<p>vmdk adapter type</p>
</td><td class=code><div class=highlight><pre>
        <span class="nb">local </span><span class="nv">vmdk_adapter_type</span><span class="o">=</span><span class="s2">&quot;$(head -25 $image | { grep -a -F -m 1 &#39;ddb.adapterType =&#39; $image || true; })&quot;</span>
        <span class="nv">vmdk_adapter_type</span><span class="o">=</span><span class="s2">&quot;${vmdk_adapter_type#*\&quot;}&quot;</span>
        <span class="nv">vmdk_adapter_type</span><span class="o">=</span><span class="s2">&quot;${vmdk_adapter_type%?}&quot;</span>

</pre></div></td></tr><tr><td class=docs>
<p>vmdk disk type</p>
</td><td class=code><div class=highlight><pre>
        <span class="nb">local </span><span class="nv">vmdk_create_type</span><span class="o">=</span><span class="s2">&quot;$(head -25 $image | { grep -a -F -m 1 &#39;createType=&#39; $image || true; })&quot;</span>
        <span class="nv">vmdk_create_type</span><span class="o">=</span><span class="s2">&quot;${vmdk_create_type#*\&quot;}&quot;</span>
        <span class="nv">vmdk_create_type</span><span class="o">=</span><span class="s2">&quot;${vmdk_create_type%\&quot;*}&quot;</span>

        <span class="nv">descriptor_data_pair_msg</span><span class="o">=</span><span class="s2">&quot;Monolithic flat and VMFS disks &quot;</span><span class="sb">`</span>
                                    <span class="sb">`</span><span class="s2">&quot;should use a descriptor-data pair.&quot;</span>
        <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$vmdk_create_type&quot;</span> <span class="o">=</span> <span class="s2">&quot;monolithicSparse&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            </span><span class="nv">vmdk_disktype</span><span class="o">=</span><span class="s2">&quot;sparse&quot;</span>
        <span class="k">elif</span> <span class="o">[[</span> <span class="s2">&quot;$vmdk_create_type&quot;</span> <span class="o">=</span> <span class="s2">&quot;monolithicFlat&quot;</span> <span class="o">||</span> <span class="s2">&quot;$vmdk_create_type&quot;</span> <span class="o">=</span> <span class="s2">&quot;vmfs&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>Attempt to retrieve the <a href="#id3"><span class="problematic" id="id4">*</span></a>-flat.vmdk</p>
<div class="system-message" id="id3">
<p class="system-message-title">System Message: WARNING/2 (<tt class="docutils">&lt;stdin&gt;</tt>, line 76); <em><a href="#id4">backlink</a></em></p>
Inline emphasis start-string without end-string.</div>
</td><td class=code><div class=highlight><pre>
            <span class="nb">local </span><span class="nv">flat_fname</span><span class="o">=</span><span class="s2">&quot;$(head -25 $image | { grep -G &#39;RW\|RDONLY [0-9]+ FLAT\|VMFS&#39; $image || true; })&quot;</span>
            <span class="nv">flat_fname</span><span class="o">=</span><span class="s2">&quot;${flat_fname#*\&quot;}&quot;</span>
            <span class="nv">flat_fname</span><span class="o">=</span><span class="s2">&quot;${flat_fname%?}&quot;</span>
            <span class="k">if</span> <span class="o">[[</span> -z <span class="s2">&quot;$flat_fname&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">                </span><span class="nv">flat_fname</span><span class="o">=</span><span class="s2">&quot;$image_name-flat.vmdk&quot;</span>
            <span class="k">fi</span>
<span class="k">            </span><span class="nv">path_len</span><span class="o">=</span><span class="sb">`</span>expr <span class="k">${#</span><span class="nv">image_url</span><span class="k">}</span> - <span class="k">${#</span><span class="nv">image_fname</span><span class="k">}</span><span class="sb">`</span>
            <span class="nb">local </span><span class="nv">flat_url</span><span class="o">=</span><span class="s2">&quot;${image_url:0:$path_len}$flat_fname&quot;</span>
            warn <span class="nv">$LINENO</span> <span class="s2">&quot;$descriptor_data_pair_msg&quot;</span><span class="sb">`</span>
                            <span class="sb">`</span><span class="s2">&quot; Attempt to retrieve the *-flat.vmdk: $flat_url&quot;</span>
            <span class="k">if</span> <span class="o">[[</span> <span class="nv">$flat_url</span> !<span class="o">=</span> file* <span class="o">]]</span>; <span class="k">then</span>
<span class="k">                if</span> <span class="o">[[</span> ! -f <span class="nv">$FILES</span>/<span class="nv">$flat_fname</span> <span class="o">||</span> <span class="se">\</span>
                <span class="s2">&quot;$(stat -c &quot;</span>%s<span class="s2">&quot; $FILES/$flat_fname)&quot;</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">                    </span>wget -c <span class="nv">$flat_url</span> -O <span class="nv">$FILES</span>/<span class="nv">$flat_fname</span>
                <span class="k">fi</span>
<span class="k">                </span><span class="nv">image</span><span class="o">=</span><span class="s2">&quot;$FILES/${flat_fname}&quot;</span>
            <span class="k">else</span>
<span class="k">                </span><span class="nv">image</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$flat_url</span> | sed <span class="s2">&quot;s/^file:\/\///g&quot;</span><span class="k">)</span>
                <span class="k">if</span> <span class="o">[[</span> ! -f <span class="nv">$image</span> <span class="o">||</span> <span class="s2">&quot;$(stat -c &quot;</span>%s<span class="s2">&quot; $image)&quot;</span> <span class="o">==</span> <span class="s2">&quot;0&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">                    </span><span class="nb">echo</span> <span class="s2">&quot;Flat disk not found: $flat_url&quot;</span>
                    <span class="k">return </span>1
                <span class="k">fi</span>
<span class="k">            fi</span>
<span class="k">            </span><span class="nv">image_name</span><span class="o">=</span><span class="s2">&quot;${flat_fname}&quot;</span>
            <span class="nv">vmdk_disktype</span><span class="o">=</span><span class="s2">&quot;preallocated&quot;</span>
        <span class="k">elif</span> <span class="o">[[</span> <span class="s2">&quot;$vmdk_create_type&quot;</span> <span class="o">=</span> <span class="s2">&quot;streamOptimized&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            </span><span class="nv">vmdk_disktype</span><span class="o">=</span><span class="s2">&quot;streamOptimized&quot;</span>
        <span class="k">elif</span> <span class="o">[[</span> -z <span class="s2">&quot;$vmdk_create_type&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p><em>-flat.vmdk provided: attempt to retrieve the descriptor (</em>.vmdk)
to retrieve appropriate metadata</p>
</td><td class=code><div class=highlight><pre>
            <span class="k">if</span> <span class="o">[[</span> <span class="k">${</span><span class="nv">image_name</span><span class="p">: -5</span><span class="k">}</span> !<span class="o">=</span> <span class="s2">&quot;-flat&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">                </span>warn <span class="nv">$LINENO</span> <span class="s2">&quot;Expected filename suffix: &#39;-flat&#39;.&quot;</span><span class="sb">`</span>
                            <span class="sb">`</span><span class="s2">&quot; Filename provided: ${image_name}&quot;</span>
            <span class="k">else</span>
<span class="k">                </span><span class="nv">descriptor_fname</span><span class="o">=</span><span class="s2">&quot;${image_name:0:${#image_name} - 5}.vmdk&quot;</span>
                <span class="nv">path_len</span><span class="o">=</span><span class="sb">`</span>expr <span class="k">${#</span><span class="nv">image_url</span><span class="k">}</span> - <span class="k">${#</span><span class="nv">image_fname</span><span class="k">}</span><span class="sb">`</span>
                <span class="nb">local </span><span class="nv">flat_path</span><span class="o">=</span><span class="s2">&quot;${image_url:0:$path_len}&quot;</span>
                <span class="nb">local </span><span class="nv">descriptor_url</span><span class="o">=</span><span class="nv">$flat_path$descriptor_fname</span>
                warn <span class="nv">$LINENO</span> <span class="s2">&quot;$descriptor_data_pair_msg&quot;</span><span class="sb">`</span>
                                <span class="sb">`</span><span class="s2">&quot; Attempt to retrieve the descriptor *.vmdk: $descriptor_url&quot;</span>
                <span class="k">if</span> <span class="o">[[</span> <span class="nv">$flat_path</span> !<span class="o">=</span> file* <span class="o">]]</span>; <span class="k">then</span>
<span class="k">                    if</span> <span class="o">[[</span> ! -f <span class="nv">$FILES</span>/<span class="nv">$descriptor_fname</span> <span class="o">||</span> <span class="se">\</span>
                    <span class="s2">&quot;$(stat -c &quot;</span>%s<span class="s2">&quot; $FILES/$descriptor_fname)&quot;</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">                        </span>wget -c <span class="nv">$descriptor_url</span> -O <span class="nv">$FILES</span>/<span class="nv">$descriptor_fname</span>
                    <span class="k">fi</span>
<span class="k">                    </span><span class="nv">descriptor_url</span><span class="o">=</span><span class="s2">&quot;$FILES/$descriptor_fname&quot;</span>
                <span class="k">else</span>
<span class="k">                    </span><span class="nv">descriptor_url</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$descriptor_url</span> | sed <span class="s2">&quot;s/^file:\/\///g&quot;</span><span class="k">)</span>
                    <span class="k">if</span> <span class="o">[[</span> ! -f <span class="nv">$descriptor_url</span> <span class="o">||</span> <span class="se">\</span>
                    <span class="s2">&quot;$(stat -c &quot;</span>%s<span class="s2">&quot; $descriptor_url)&quot;</span> <span class="o">==</span> <span class="s2">&quot;0&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">                        </span><span class="nb">echo</span> <span class="s2">&quot;Descriptor not found: $descriptor_url&quot;</span>
                        <span class="k">return </span>1
                    <span class="k">fi</span>
<span class="k">                fi</span>
<span class="k">                </span><span class="nv">vmdk_adapter_type</span><span class="o">=</span><span class="s2">&quot;$(head -25 $descriptor_url | { grep -a -F -m 1 &#39;ddb.adapterType =&#39; $descriptor_url || true; })&quot;</span>
                <span class="nv">vmdk_adapter_type</span><span class="o">=</span><span class="s2">&quot;${vmdk_adapter_type#*\&quot;}&quot;</span>
                <span class="nv">vmdk_adapter_type</span><span class="o">=</span><span class="s2">&quot;${vmdk_adapter_type%?}&quot;</span>
            <span class="k">fi</span>
<span class="k">            </span><span class="nv">vmdk_disktype</span><span class="o">=</span><span class="s2">&quot;preallocated&quot;</span>
        <span class="k">else</span>
<span class="k">            </span><span class="nv">vmdk_disktype</span><span class="o">=</span><span class="s2">&quot;preallocated&quot;</span>
        <span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>NOTE: For backwards compatibility reasons, colons may be used in place
of semi-colons for property delimiters but they are not permitted
characters in NTFS filesystems.</p>
</td><td class=code><div class=highlight><pre>
        <span class="nv">property_string</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="s2">&quot;$image_name&quot;</span> | <span class="o">{</span> grep -oP <span class="s1">&#39;(?&lt;=-)(?!.*-).*[:;].*[:;].*$&#39;</span> <span class="o">||</span> <span class="nb">true</span>; <span class="o">}</span><span class="sb">`</span>
        <span class="nv">IFS</span><span class="o">=</span><span class="s1">&#39;:;&#39;</span> <span class="nb">read</span> -a props <span class="o">&lt;&lt;&lt;</span> <span class="s2">&quot;$property_string&quot;</span>
        <span class="nv">vmdk_disktype</span><span class="o">=</span><span class="s2">&quot;${props[0]:-$vmdk_disktype}&quot;</span>
        <span class="nv">vmdk_adapter_type</span><span class="o">=</span><span class="s2">&quot;${props[1]:-$vmdk_adapter_type}&quot;</span>
        <span class="nv">vmdk_net_adapter</span><span class="o">=</span><span class="s2">&quot;${props[2]:-$vmdk_net_adapter}&quot;</span>

        openstack --os-token <span class="nv">$token</span> --os-url <span class="nv">$GLANCE_SERVICE_PROTOCOL</span>://<span class="nv">$GLANCE_HOSTPORT</span> image create <span class="s2">&quot;$image_name&quot;</span> --public --container-format bare --disk-format vmdk --property <span class="nv">vmware_disktype</span><span class="o">=</span><span class="s2">&quot;$vmdk_disktype&quot;</span> --property <span class="nv">vmware_adaptertype</span><span class="o">=</span><span class="s2">&quot;$vmdk_adapter_type&quot;</span> --property <span class="nv">hw_vif_model</span><span class="o">=</span><span class="s2">&quot;$vmdk_net_adapter&quot;</span> &lt; <span class="s2">&quot;${image}&quot;</span>
        <span class="k">return</span>
<span class="k">    fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>XenServer-vhd-ovf-format images are provided as .vhd.tgz
and should not be decompressed prior to loading</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$image_url&quot;</span> <span class="o">=</span>~ <span class="s1">&#39;.vhd.tgz&#39;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nv">image_name</span><span class="o">=</span><span class="s2">&quot;${image_fname%.vhd.tgz}&quot;</span>
        <span class="nb">local </span><span class="nv">force_vm_mode</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$image_name&quot;</span> <span class="o">=</span>~ <span class="s1">&#39;cirros&#39;</span> <span class="o">]]</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>Cirros VHD image currently only boots in PV mode.
Nova defaults to PV for all VHD images, but
the glance setting is needed for booting
directly from volume.</p>
</td><td class=code><div class=highlight><pre>
            <span class="nv">force_vm_mode</span><span class="o">=</span><span class="s2">&quot;--property vm_mode=xen&quot;</span>
        <span class="k">fi</span>
<span class="k">        </span>openstack <span class="se">\</span>
            --os-token <span class="nv">$token</span> <span class="se">\</span>
            --os-url <span class="nv">$GLANCE_SERVICE_PROTOCOL</span>://<span class="nv">$GLANCE_HOSTPORT</span> <span class="se">\</span>
            image create <span class="se">\</span>
            <span class="s2">&quot;$image_name&quot;</span> --public <span class="se">\</span>
            --container-format<span class="o">=</span>ovf --disk-format<span class="o">=</span>vhd <span class="se">\</span>
            <span class="nv">$force_vm_mode</span> &lt; <span class="s2">&quot;${image}&quot;</span>
        <span class="k">return</span>
<span class="k">    fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>.xen-raw.tgz suggests a Xen capable raw image inside a tgz.
and should not be decompressed prior to loading.
Setting metadata, so PV mode is used.</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$image_url&quot;</span> <span class="o">=</span>~ <span class="s1">&#39;.xen-raw.tgz&#39;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nv">image_name</span><span class="o">=</span><span class="s2">&quot;${image_fname%.xen-raw.tgz}&quot;</span>
        openstack <span class="se">\</span>
            --os-token <span class="nv">$token</span> <span class="se">\</span>
            --os-url <span class="nv">$GLANCE_SERVICE_PROTOCOL</span>://<span class="nv">$GLANCE_HOSTPORT</span> <span class="se">\</span>
            image create <span class="se">\</span>
            <span class="s2">&quot;$image_name&quot;</span> --public <span class="se">\</span>
            --container-format<span class="o">=</span>tgz --disk-format<span class="o">=</span>raw <span class="se">\</span>
            --property <span class="nv">vm_mode</span><span class="o">=</span>xen &lt; <span class="s2">&quot;${image}&quot;</span>
        <span class="k">return</span>
<span class="k">    fi</span>

<span class="k">    </span><span class="nb">local </span><span class="nv">kernel</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
    <span class="nb">local </span><span class="nv">ramdisk</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
    <span class="nb">local </span><span class="nv">disk_format</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
    <span class="nb">local </span><span class="nv">container_format</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
    <span class="nb">local </span><span class="nv">unpack</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
    <span class="nb">local </span><span class="nv">img_property</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
    <span class="k">case</span> <span class="s2">&quot;$image_fname&quot;</span> in
        *.tar.gz|*.tgz<span class="o">)</span>
</pre></div></td></tr><tr><td class=docs>
<p>Extract ami and aki files</p>
</td><td class=code><div class=highlight><pre>
            <span class="o">[</span> <span class="s2">&quot;${image_fname%.tar.gz}&quot;</span> !<span class="o">=</span> <span class="s2">&quot;$image_fname&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span>
                <span class="nv">image_name</span><span class="o">=</span><span class="s2">&quot;${image_fname%.tar.gz}&quot;</span> <span class="o">||</span>
                <span class="nv">image_name</span><span class="o">=</span><span class="s2">&quot;${image_fname%.tgz}&quot;</span>
            <span class="nb">local </span><span class="nv">xdir</span><span class="o">=</span><span class="s2">&quot;$FILES/images/$image_name&quot;</span>
            rm -Rf <span class="s2">&quot;$xdir&quot;</span>;
            mkdir <span class="s2">&quot;$xdir&quot;</span>
            tar -zxf <span class="nv">$image</span> -C <span class="s2">&quot;$xdir&quot;</span>
            <span class="nv">kernel</span><span class="o">=</span><span class="k">$(for </span>f in <span class="s2">&quot;$xdir/&quot;</span>*-vmlinuz* <span class="s2">&quot;$xdir/&quot;</span>aki-*/image; <span class="k">do</span>
                <span class="o">[</span> -f <span class="s2">&quot;$f&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">&quot;$f&quot;</span> <span class="o">&amp;&amp;</span> <span class="nb">break</span>; <span class="k">done</span>; <span class="nb">true</span><span class="k">)</span>
            <span class="nv">ramdisk</span><span class="o">=</span><span class="k">$(for </span>f in <span class="s2">&quot;$xdir/&quot;</span>*-initrd* <span class="s2">&quot;$xdir/&quot;</span>ari-*/image; <span class="k">do</span>
                <span class="o">[</span> -f <span class="s2">&quot;$f&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">&quot;$f&quot;</span> <span class="o">&amp;&amp;</span> <span class="nb">break</span>; <span class="k">done</span>; <span class="nb">true</span><span class="k">)</span>
            <span class="nv">image</span><span class="o">=</span><span class="k">$(for </span>f in <span class="s2">&quot;$xdir/&quot;</span>*.img <span class="s2">&quot;$xdir/&quot;</span>ami-*/image; <span class="k">do</span>
                <span class="o">[</span> -f <span class="s2">&quot;$f&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">&quot;$f&quot;</span> <span class="o">&amp;&amp;</span> <span class="nb">break</span>; <span class="k">done</span>; <span class="nb">true</span><span class="k">)</span>
            <span class="k">if</span> <span class="o">[[</span> -z <span class="s2">&quot;$image_name&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">                </span><span class="nv">image_name</span><span class="o">=</span><span class="k">$(</span>basename <span class="s2">&quot;$image&quot;</span> <span class="s2">&quot;.img&quot;</span><span class="k">)</span>
            <span class="k">fi</span>
            ;;
        *.img<span class="o">)</span>
            <span class="nv">image_name</span><span class="o">=</span><span class="k">$(</span>basename <span class="s2">&quot;$image&quot;</span> <span class="s2">&quot;.img&quot;</span><span class="k">)</span>
            <span class="nb">local </span><span class="nv">format</span><span class="o">=</span><span class="k">$(</span>qemu-img info <span class="k">${</span><span class="nv">image</span><span class="k">}</span> | awk <span class="s1">&#39;/^file format/ { print $3; exit }&#39;</span><span class="k">)</span>
            <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;,qcow2,raw,vdi,vmdk,vpc,&quot;</span> <span class="o">=</span>~ <span class="s2">&quot;,$format,&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">                </span><span class="nv">disk_format</span><span class="o">=</span><span class="nv">$format</span>
            <span class="k">else</span>
<span class="k">                </span><span class="nv">disk_format</span><span class="o">=</span>raw
            <span class="k">fi</span>
<span class="k">            </span><span class="nv">container_format</span><span class="o">=</span>bare
            ;;
        *.img.gz<span class="o">)</span>
            <span class="nv">image_name</span><span class="o">=</span><span class="k">$(</span>basename <span class="s2">&quot;$image&quot;</span> <span class="s2">&quot;.img.gz&quot;</span><span class="k">)</span>
            <span class="nv">disk_format</span><span class="o">=</span>raw
            <span class="nv">container_format</span><span class="o">=</span>bare
            <span class="nv">unpack</span><span class="o">=</span>zcat
            ;;
        *.qcow2<span class="o">)</span>
            <span class="nv">image_name</span><span class="o">=</span><span class="k">$(</span>basename <span class="s2">&quot;$image&quot;</span> <span class="s2">&quot;.qcow2&quot;</span><span class="k">)</span>
            <span class="nv">disk_format</span><span class="o">=</span>qcow2
            <span class="nv">container_format</span><span class="o">=</span>bare
            ;;
        *.iso<span class="o">)</span>
            <span class="nv">image_name</span><span class="o">=</span><span class="k">$(</span>basename <span class="s2">&quot;$image&quot;</span> <span class="s2">&quot;.iso&quot;</span><span class="k">)</span>
            <span class="nv">disk_format</span><span class="o">=</span>iso
            <span class="nv">container_format</span><span class="o">=</span>bare
            ;;
        *.vhd|*.vhdx|*.vhd.gz|*.vhdx.gz<span class="o">)</span>
            <span class="nb">local </span><span class="nv">extension</span><span class="o">=</span><span class="s2">&quot;${image_fname#*.}&quot;</span>
            <span class="nv">image_name</span><span class="o">=</span><span class="k">$(</span>basename <span class="s2">&quot;$image&quot;</span> <span class="s2">&quot;.$extension&quot;</span><span class="k">)</span>
            <span class="nv">disk_format</span><span class="o">=</span>vhd
            <span class="nv">container_format</span><span class="o">=</span>bare
            <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;${image_fname##*.}&quot;</span> <span class="o">==</span> <span class="s2">&quot;gz&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">                </span><span class="nv">unpack</span><span class="o">=</span>zcat
            <span class="k">fi</span>
            ;;
        *<span class="o">)</span> <span class="nb">echo</span> <span class="s2">&quot;Do not know what to do with $image_fname&quot;</span>; <span class="nb">false</span>;;
    <span class="k">esac</span>

<span class="k">    if </span>is_arch <span class="s2">&quot;ppc64&quot;</span>; <span class="k">then</span>
<span class="k">        </span><span class="nv">img_property</span><span class="o">=</span><span class="s2">&quot;--property hw_cdrom_bus=scsi&quot;</span>
    <span class="k">fi</span>

<span class="k">    if</span> <span class="o">[</span> <span class="s2">&quot;$container_format&quot;</span> <span class="o">=</span> <span class="s2">&quot;bare&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">        if</span> <span class="o">[</span> <span class="s2">&quot;$unpack&quot;</span> <span class="o">=</span> <span class="s2">&quot;zcat&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">            </span>openstack --os-token <span class="nv">$token</span> --os-url <span class="nv">$GLANCE_SERVICE_PROTOCOL</span>://<span class="nv">$GLANCE_HOSTPORT</span> image create <span class="s2">&quot;$image_name&quot;</span> <span class="nv">$img_property</span> --public --container-format<span class="o">=</span><span class="nv">$container_format</span> --disk-format <span class="nv">$disk_format</span> &lt; &lt;<span class="o">(</span>zcat --force <span class="s2">&quot;${image}&quot;</span><span class="o">)</span>
        <span class="k">else</span>
<span class="k">            </span>openstack --os-token <span class="nv">$token</span> --os-url <span class="nv">$GLANCE_SERVICE_PROTOCOL</span>://<span class="nv">$GLANCE_HOSTPORT</span> image create <span class="s2">&quot;$image_name&quot;</span> <span class="nv">$img_property</span> --public --container-format<span class="o">=</span><span class="nv">$container_format</span> --disk-format <span class="nv">$disk_format</span> &lt; <span class="s2">&quot;${image}&quot;</span>
        <span class="k">fi</span>
<span class="k">    else</span>
</pre></div></td></tr><tr><td class=docs>
<p>Use glance client to add the kernel the root filesystem.
We parse the results of the first upload to get the glance ID of the
kernel for use when uploading the root filesystem.</p>
</td><td class=code><div class=highlight><pre>
        <span class="nb">local </span><span class="nv">kernel_id</span><span class="o">=</span><span class="s2">&quot;&quot;</span> <span class="nv">ramdisk_id</span><span class="o">=</span><span class="s2">&quot;&quot;</span>;
        <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;$kernel&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">            </span><span class="nv">kernel_id</span><span class="o">=</span><span class="k">$(</span>openstack --os-token <span class="nv">$token</span> --os-url <span class="nv">$GLANCE_SERVICE_PROTOCOL</span>://<span class="nv">$GLANCE_HOSTPORT</span> image create <span class="s2">&quot;$image_name-kernel&quot;</span> <span class="nv">$img_property</span> --public --container-format aki --disk-format aki &lt; <span class="s2">&quot;$kernel&quot;</span> | grep <span class="s1">&#39; id &#39;</span> | get_field 2<span class="k">)</span>
        <span class="k">fi</span>
<span class="k">        if</span> <span class="o">[</span> -n <span class="s2">&quot;$ramdisk&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">            </span><span class="nv">ramdisk_id</span><span class="o">=</span><span class="k">$(</span>openstack --os-token <span class="nv">$token</span> --os-url <span class="nv">$GLANCE_SERVICE_PROTOCOL</span>://<span class="nv">$GLANCE_HOSTPORT</span> image create <span class="s2">&quot;$image_name-ramdisk&quot;</span> <span class="nv">$img_property</span> --public --container-format ari --disk-format ari &lt; <span class="s2">&quot;$ramdisk&quot;</span> | grep <span class="s1">&#39; id &#39;</span> | get_field 2<span class="k">)</span>
        <span class="k">fi</span>
<span class="k">        </span>openstack --os-token <span class="nv">$token</span> --os-url <span class="nv">$GLANCE_SERVICE_PROTOCOL</span>://<span class="nv">$GLANCE_HOSTPORT</span> image create <span class="s2">&quot;${image_name%.img}&quot;</span> <span class="nv">$img_property</span> --public --container-format ami --disk-format ami <span class="k">${</span><span class="nv">kernel_id</span><span class="p">:+--property kernel_id=</span><span class="nv">$kernel_id</span><span class="k">}</span> <span class="k">${</span><span class="nv">ramdisk_id</span><span class="p">:+--property ramdisk_id=</span><span class="nv">$ramdisk_id</span><span class="k">}</span> &lt; <span class="s2">&quot;${image}&quot;</span>
    <span class="k">fi</span>
<span class="o">}</span>


</pre></div></td></tr><tr><td class=docs>
<p>Set the database backend to use
When called from stackrc/localrc DATABASE_BACKENDS has not been
initialized yet, just save the configuration selection and call back later
to validate it.</p>
<p><tt class="docutils literal">$1</tt> - the name of the database backend to use (mysql, postgresql, ...)</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>use_database <span class="o">{</span>
    <span class="k">if</span> <span class="o">[[</span> -z <span class="s2">&quot;$DATABASE_BACKENDS&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>No backends registered means this is likely called from <tt class="docutils literal">localrc</tt>
This is now deprecated usage</p>
</td><td class=code><div class=highlight><pre>
        <span class="nv">DATABASE_TYPE</span><span class="o">=</span><span class="nv">$1</span>
        <span class="nv">DEPRECATED_TEXT</span><span class="o">=</span><span class="s2">&quot;$DEPRECATED_TEXT\nThe database backend needs to be properly set in ENABLED_SERVICES; use_database is deprecated localrc\n&quot;</span>
    <span class="k">else</span>
</pre></div></td></tr><tr><td class=docs>
<p>This should no longer get called...here for posterity</p>
</td><td class=code><div class=highlight><pre>
        use_exclusive_service DATABASE_BACKENDS DATABASE_TYPE <span class="nv">$1</span>
    <span class="k">fi</span>
<span class="o">}</span>


</pre></div></td></tr><tr><td class=docs>
<p>Wait for an HTTP server to start answering requests
wait_for_service timeout url</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>wait_for_service <span class="o">{</span>
    <span class="nb">local </span><span class="nv">timeout</span><span class="o">=</span><span class="nv">$1</span>
    <span class="nb">local </span><span class="nv">url</span><span class="o">=</span><span class="nv">$2</span>
    timeout <span class="nv">$timeout</span> sh -c <span class="s2">&quot;while ! curl -k --noproxy &#39;*&#39; -s $url &gt;/dev/null; do sleep 1; done&quot;</span>
<span class="o">}</span>


</pre></div></td></tr><tr><td class=docs>
<p>ping check
Uses globals <tt class="docutils literal">ENABLED_SERVICES</tt>
ping_check from-net ip boot-timeout expected</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>ping_check <span class="o">{</span>
    <span class="k">if </span>is_service_enabled neutron; <span class="k">then</span>
<span class="k">        </span>_ping_check_neutron  <span class="s2">&quot;$1&quot;</span> <span class="nv">$2</span> <span class="nv">$3</span> <span class="nv">$4</span>
        <span class="k">return</span>
<span class="k">    fi</span>
<span class="k">    </span>_ping_check_novanet <span class="s2">&quot;$1&quot;</span> <span class="nv">$2</span> <span class="nv">$3</span> <span class="nv">$4</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>ping check for nova
Uses globals <tt class="docutils literal">MULTI_HOST</tt>, <tt class="docutils literal">PRIVATE_NETWORK</tt></p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>_ping_check_novanet <span class="o">{</span>
    <span class="nb">local </span><span class="nv">from_net</span><span class="o">=</span><span class="nv">$1</span>
    <span class="nb">local </span><span class="nv">ip</span><span class="o">=</span><span class="nv">$2</span>
    <span class="nb">local </span><span class="nv">boot_timeout</span><span class="o">=</span><span class="nv">$3</span>
    <span class="nb">local </span><span class="nv">expected</span><span class="o">=</span><span class="k">${</span><span class="nv">4</span><span class="k">:-</span><span class="s2">&quot;True&quot;</span><span class="k">}</span>
    <span class="nb">local </span><span class="nv">check_command</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
    <span class="nv">MULTI_HOST</span><span class="o">=</span><span class="sb">`</span>trueorfalse False <span class="nv">$MULTI_HOST</span><span class="sb">`</span>
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$MULTI_HOST&quot;</span> <span class="o">=</span> <span class="s2">&quot;True&quot;</span> <span class="o">&amp;&amp;</span> <span class="s2">&quot;$from_net&quot;</span> <span class="o">=</span> <span class="s2">&quot;$PRIVATE_NETWORK_NAME&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        return</span>
<span class="k">    fi</span>
<span class="k">    if</span> <span class="o">[[</span> <span class="s2">&quot;$expected&quot;</span> <span class="o">=</span> <span class="s2">&quot;True&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nv">check_command</span><span class="o">=</span><span class="s2">&quot;while ! ping -c1 -w1 $ip; do sleep 1; done&quot;</span>
    <span class="k">else</span>
<span class="k">        </span><span class="nv">check_command</span><span class="o">=</span><span class="s2">&quot;while ping -c1 -w1 $ip; do sleep 1; done&quot;</span>
    <span class="k">fi</span>
<span class="k">    if</span> ! timeout <span class="nv">$boot_timeout</span> sh -c <span class="s2">&quot;$check_command&quot;</span>; <span class="k">then</span>
<span class="k">        if</span> <span class="o">[[</span> <span class="s2">&quot;$expected&quot;</span> <span class="o">=</span> <span class="s2">&quot;True&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            </span>die <span class="nv">$LINENO</span> <span class="s2">&quot;[Fail] Couldn&#39;t ping server&quot;</span>
        <span class="k">else</span>
<span class="k">            </span>die <span class="nv">$LINENO</span> <span class="s2">&quot;[Fail] Could ping server&quot;</span>
        <span class="k">fi</span>
<span class="k">    fi</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Get ip of instance</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>get_instance_ip <span class="o">{</span>
    <span class="nb">local </span><span class="nv">vm_id</span><span class="o">=</span><span class="nv">$1</span>
    <span class="nb">local </span><span class="nv">network_name</span><span class="o">=</span><span class="nv">$2</span>
    <span class="nb">local </span><span class="nv">nova_result</span><span class="o">=</span><span class="s2">&quot;$(nova show $vm_id)&quot;</span>
    <span class="nb">local </span><span class="nv">ip</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">&quot;$nova_result&quot;</span> | grep <span class="s2">&quot;$network_name&quot;</span> | get_field 2<span class="k">)</span>
    <span class="k">if</span> <span class="o">[[</span> <span class="nv">$ip</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="o">]]</span>;<span class="k">then</span>
<span class="k">        </span><span class="nb">echo</span> <span class="s2">&quot;$nova_result&quot;</span>
        die <span class="nv">$LINENO</span> <span class="s2">&quot;[Fail] Coudn&#39;t get ipaddress of VM&quot;</span>
    <span class="k">fi</span>
<span class="k">    </span><span class="nb">echo</span> <span class="nv">$ip</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>ssh check</p>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>ssh_check net-name key-file floating-ip default-user active-timeout</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>ssh_check <span class="o">{</span>
    <span class="k">if </span>is_service_enabled neutron; <span class="k">then</span>
<span class="k">        </span>_ssh_check_neutron  <span class="s2">&quot;$1&quot;</span> <span class="nv">$2</span> <span class="nv">$3</span> <span class="nv">$4</span> <span class="nv">$5</span>
        <span class="k">return</span>
<span class="k">    fi</span>
<span class="k">    </span>_ssh_check_novanet <span class="s2">&quot;$1&quot;</span> <span class="nv">$2</span> <span class="nv">$3</span> <span class="nv">$4</span> <span class="nv">$5</span>
<span class="o">}</span>

<span class="k">function </span>_ssh_check_novanet <span class="o">{</span>
    <span class="nb">local </span><span class="nv">NET_NAME</span><span class="o">=</span><span class="nv">$1</span>
    <span class="nb">local </span><span class="nv">KEY_FILE</span><span class="o">=</span><span class="nv">$2</span>
    <span class="nb">local </span><span class="nv">FLOATING_IP</span><span class="o">=</span><span class="nv">$3</span>
    <span class="nb">local </span><span class="nv">DEFAULT_INSTANCE_USER</span><span class="o">=</span><span class="nv">$4</span>
    <span class="nb">local </span><span class="nv">ACTIVE_TIMEOUT</span><span class="o">=</span><span class="nv">$5</span>
    <span class="nb">local </span><span class="nv">probe_cmd</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
    <span class="k">if</span> ! timeout <span class="nv">$ACTIVE_TIMEOUT</span> sh -c <span class="s2">&quot;while ! ssh -o StrictHostKeyChecking=no -i $KEY_FILE ${DEFAULT_INSTANCE_USER}@$FLOATING_IP echo success; do sleep 1; done&quot;</span>; <span class="k">then</span>
<span class="k">        </span>die <span class="nv">$LINENO</span> <span class="s2">&quot;server didn&#39;t become ssh-able!&quot;</span>
    <span class="k">fi</span>
<span class="o">}</span>


</pre></div></td></tr><tr><td class=docs>
<p>Get the location of the $module-rootwrap executables, where module is cinder
or nova.
get_rootwrap_location module</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>get_rootwrap_location <span class="o">{</span>
    <span class="nb">local </span><span class="nv">module</span><span class="o">=</span><span class="nv">$1</span>

    <span class="nb">echo</span> <span class="s2">&quot;$(get_python_exec_prefix)/$module-rootwrap&quot;</span>
<span class="o">}</span>


</pre></div></td></tr><tr><td class=docs>
<p>Path permissions sanity check
check_path_perm_sanity path</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>check_path_perm_sanity <span class="o">{</span>
</pre></div></td></tr><tr><td class=docs>
<p>Ensure no element of the path has 0700 permissions, which is very
likely to cause issues for daemons.  Inspired by default 0700
homedir permissions on RHEL and common practice of making DEST in
the stack user's homedir.</p>
</td><td class=code><div class=highlight><pre>

    <span class="nb">local </span><span class="nv">real_path</span><span class="o">=</span><span class="k">$(</span>readlink -f <span class="nv">$1</span><span class="k">)</span>
    <span class="nb">local </span><span class="nv">rebuilt_path</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
    <span class="k">for </span>i in <span class="k">$(</span><span class="nb">echo</span> <span class="k">${</span><span class="nv">real_path</span><span class="k">}</span> | tr <span class="s2">&quot;/&quot;</span> <span class="s2">&quot; &quot;</span><span class="k">)</span>; <span class="k">do</span>
<span class="k">        </span><span class="nv">rebuilt_path</span><span class="o">=</span><span class="nv">$rebuilt_path</span><span class="s2">&quot;/&quot;</span><span class="nv">$i</span>

        <span class="k">if</span> <span class="o">[[</span> <span class="k">$(</span>stat -c <span class="s1">&#39;%a&#39;</span> <span class="k">${</span><span class="nv">rebuilt_path</span><span class="k">})</span> <span class="o">=</span> 700 <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            </span><span class="nb">echo</span> <span class="s2">&quot;*** DEST path element&quot;</span>
            <span class="nb">echo</span> <span class="s2">&quot;***    ${rebuilt_path}&quot;</span>
            <span class="nb">echo</span> <span class="s2">&quot;*** appears to have 0700 permissions.&quot;</span>
            <span class="nb">echo</span> <span class="s2">&quot;*** This is very likely to cause fatal issues for devstack daemons.&quot;</span>

            <span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&quot;$SKIP_PATH_SANITY&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">                return</span>
<span class="k">            else</span>
<span class="k">                </span><span class="nb">echo</span> <span class="s2">&quot;*** Set SKIP_PATH_SANITY to skip this check&quot;</span>
                die <span class="nv">$LINENO</span> <span class="s2">&quot;Invalid path permissions&quot;</span>
            <span class="k">fi</span>
<span class="k">        fi</span>
<span class="k">    done</span>
<span class="o">}</span>


</pre></div></td></tr><tr><td class=docs>
<p>This function recursively compares versions, and is not meant to be
called by anything other than vercmp_numbers below. This function does
not work with alphabetic versions.</p>
<p>_vercmp_r sep ver1 ver2</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>_vercmp_r <span class="o">{</span>
    <span class="nb">typeset </span>sep
    <span class="nb">typeset</span> -a <span class="nv">ver1</span><span class="o">=()</span> <span class="nv">ver2</span><span class="o">=()</span>
    <span class="nv">sep</span><span class="o">=</span><span class="nv">$1</span>; <span class="nb">shift</span>
<span class="nb">    </span><span class="nv">ver1</span><span class="o">=(</span><span class="s2">&quot;${@:1:sep}&quot;</span><span class="o">)</span>
    <span class="nv">ver2</span><span class="o">=(</span><span class="s2">&quot;${@:sep+1}&quot;</span><span class="o">)</span>

    <span class="k">if</span> <span class="o">((</span>ver1 &gt; ver2<span class="o">))</span>; <span class="k">then</span>
<span class="k">        </span><span class="nb">echo </span>1; <span class="k">return </span>0
    <span class="k">elif</span> <span class="o">((</span>ver2 &gt; ver1<span class="o">))</span>; <span class="k">then</span>
<span class="k">        </span><span class="nb">echo</span> -1; <span class="k">return </span>0
    <span class="k">fi</span>

<span class="k">    if</span> <span class="o">((</span>sep &lt;<span class="o">=</span> 1<span class="o">))</span>; <span class="k">then</span>
<span class="k">        </span><span class="nb">echo </span>0; <span class="k">return </span>0
    <span class="k">fi</span>

<span class="k">    </span>_vercmp_r <span class="k">$((</span>sep-1<span class="k">))</span> <span class="s2">&quot;${ver1[@]:1}&quot;</span> <span class="s2">&quot;${ver2[@]:1}&quot;</span>
<span class="o">}</span>


</pre></div></td></tr><tr><td class=docs>
<p>This function compares two versions and is meant to be called by
external callers. Please note the function assumes non-alphabetic
versions. For example, this will work:</p>
<blockquote>
vercmp_numbers 1.10 1.4</blockquote>
<p>The above will return &quot;1&quot;, as 1.10 is greater than 1.4.</p>
<blockquote>
vercmp_numbers 5.2 6.4</blockquote>
<p>The above will return &quot;-1&quot;, as 5.2 is less than 6.4.</p>
<blockquote>
vercmp_numbers 4.0 4.0</blockquote>
<p>The above will return &quot;0&quot;, as the versions are equal.</p>
<p>vercmp_numbers ver1 ver2</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>vercmp_numbers <span class="o">{</span>
    <span class="nb">typeset </span><span class="nv">v1</span><span class="o">=</span><span class="nv">$1</span> <span class="nv">v2</span><span class="o">=</span><span class="nv">$2</span> sep
    <span class="nb">typeset</span> -a ver1 ver2

    <span class="nv">IFS</span><span class="o">=</span>. <span class="nb">read</span> -ra ver1 <span class="o">&lt;&lt;&lt;</span> <span class="s2">&quot;$v1&quot;</span>
    <span class="nv">IFS</span><span class="o">=</span>. <span class="nb">read</span> -ra ver2 <span class="o">&lt;&lt;&lt;</span> <span class="s2">&quot;$v2&quot;</span>

    _vercmp_r <span class="s2">&quot;${#ver1[@]}&quot;</span> <span class="s2">&quot;${ver1[@]}&quot;</span> <span class="s2">&quot;${ver2[@]}&quot;</span>
<span class="o">}</span>


</pre></div></td></tr><tr><td class=docs>
<p>This function sets log formatting options for colorizing log
output to stdout. It is meant to be called by lib modules.
The last two parameters are optional and can be used to specify
non-default value for project and user format variables.
Defaults are respectively 'project_name' and 'user_name'</p>
<p>setup_colorized_logging something.conf SOMESECTION</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>setup_colorized_logging <span class="o">{</span>
    <span class="nb">local </span><span class="nv">conf_file</span><span class="o">=</span><span class="nv">$1</span>
    <span class="nb">local </span><span class="nv">conf_section</span><span class="o">=</span><span class="nv">$2</span>
    <span class="nb">local </span><span class="nv">project_var</span><span class="o">=</span><span class="k">${</span><span class="nv">3</span><span class="k">:-</span><span class="s2">&quot;project_name&quot;</span><span class="k">}</span>
    <span class="nb">local </span><span class="nv">user_var</span><span class="o">=</span><span class="k">${</span><span class="nv">4</span><span class="k">:-</span><span class="s2">&quot;user_name&quot;</span><span class="k">}</span>
</pre></div></td></tr><tr><td class=docs>
<p>Add color to logging output</p>
</td><td class=code><div class=highlight><pre>
    iniset <span class="nv">$conf_file</span> <span class="nv">$conf_section</span> logging_context_format_string <span class="s2">&quot;%(asctime)s.%(msecs)03d %(color)s%(levelname)s %(name)s [[01;36m%(request_id)s [00;36m%(&quot;</span><span class="nv">$user_var</span><span class="s2">&quot;)s %(&quot;</span><span class="nv">$project_var</span><span class="s2">&quot;)s%(color)s] [01;35m%(instance)s%(color)s%(message)s[00m&quot;</span>
    iniset <span class="nv">$conf_file</span> <span class="nv">$conf_section</span> logging_default_format_string <span class="s2">&quot;%(asctime)s.%(msecs)03d %(color)s%(levelname)s %(name)s [[00;36m-%(color)s] [01;35m%(instance)s%(color)s%(message)s[00m&quot;</span>
    iniset <span class="nv">$conf_file</span> <span class="nv">$conf_section</span> logging_debug_format_suffix <span class="s2">&quot;[00;33mfrom (pid=%(process)d) %(funcName)s %(pathname)s:%(lineno)d[00m&quot;</span>
    iniset <span class="nv">$conf_file</span> <span class="nv">$conf_section</span> logging_exception_prefix <span class="s2">&quot;%(color)s%(asctime)s.%(msecs)03d TRACE %(name)s [01;35m%(instance)s[00m&quot;</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>These functions are provided for basic fall-back functionality for
projects that include parts of devstack (grenade).  stack.sh will
override these with more specific versions for devstack (with fancy
spinners, etc).  We never override an existing version</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if</span> ! function_exists echo_summary; <span class="k">then</span>
<span class="k">    function </span>echo_summary <span class="o">{</span>
        <span class="nb">echo</span> <span class="nv">$@</span>
    <span class="o">}</span>
<span class="k">fi</span>
<span class="k">if</span> ! function_exists echo_nolog; <span class="k">then</span>
<span class="k">    function </span>echo_nolog <span class="o">{</span>
        <span class="nb">echo</span> <span class="nv">$@</span>
    <span class="o">}</span>
<span class="k">fi</span>


</pre></div></td></tr><tr><td class=docs>
<p>create_disk - Create backing disk</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>create_disk <span class="o">{</span>
    <span class="nb">local </span>node_number
    <span class="nb">local </span><span class="nv">disk_image</span><span class="o">=</span><span class="k">${</span><span class="nv">1</span><span class="k">}</span>
    <span class="nb">local </span><span class="nv">storage_data_dir</span><span class="o">=</span><span class="k">${</span><span class="nv">2</span><span class="k">}</span>
    <span class="nb">local </span><span class="nv">loopback_disk_size</span><span class="o">=</span><span class="k">${</span><span class="nv">3</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Create a loopback disk and format it to XFS.</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">if</span> <span class="o">[[</span> -e <span class="k">${</span><span class="nv">disk_image</span><span class="k">}</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        if </span>egrep -q <span class="k">${</span><span class="nv">storage_data_dir</span><span class="k">}</span> /proc/mounts; <span class="k">then</span>
<span class="k">            </span>sudo umount <span class="k">${</span><span class="nv">storage_data_dir</span><span class="k">}</span>/drives/sdb1
            sudo rm -f <span class="k">${</span><span class="nv">disk_image</span><span class="k">}</span>
        <span class="k">fi</span>
<span class="k">    fi</span>

<span class="k">    </span>sudo mkdir -p <span class="k">${</span><span class="nv">storage_data_dir</span><span class="k">}</span>/drives/images

    sudo truncate -s <span class="k">${</span><span class="nv">loopback_disk_size</span><span class="k">}</span> <span class="k">${</span><span class="nv">disk_image</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Make a fresh XFS filesystem. Use bigger inodes so xattr can fit in
a single inode. Keeping the default inode size (256) will result in multiple
inodes being used to store xattr. Retrieving the xattr will be slower
since we have to read multiple inodes. This statement is true for both
Swift and Ceph.</p>
</td><td class=code><div class=highlight><pre>
    sudo mkfs.xfs -f -i <span class="nv">size</span><span class="o">=</span>1024 <span class="k">${</span><span class="nv">disk_image</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Mount the disk with mount options to make it as efficient as possible</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">if</span> ! egrep -q <span class="k">${</span><span class="nv">storage_data_dir</span><span class="k">}</span> /proc/mounts; <span class="k">then</span>
<span class="k">        </span>sudo mount -t xfs -o loop,noatime,nodiratime,nobarrier,logbufs<span class="o">=</span>8  <span class="se">\</span>
            <span class="k">${</span><span class="nv">disk_image</span><span class="k">}</span> <span class="k">${</span><span class="nv">storage_data_dir</span><span class="k">}</span>
    <span class="k">fi</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Restore xtrace</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">$XTRACE</span>

</pre></div></td></tr><tr><td class=docs>
<p>Local variables:
mode: shell-script
End:</p>
</td><td class=code><div class=highlight><pre>


</td><td class=code><div class=highlight><pre>
</pre></div></td></tr><tr><td class=docs>
</pre></div></td></tr><tr><td class=docs>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
</div>
</body>
</html></td><td class='code'></td></tr>
    </tbody>
    </table>
</div>
</body>
</html>
