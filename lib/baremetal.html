<!DOCTYPE html>
<html>
<head>
    <meta http-eqiv='content-type' content='text/html;charset=utf-8'>
    <title>baremetal</title>
    <link rel=stylesheet href="http://jashkenas.github.com/docco/resources/docco.css">
</head>
<body>
<div id=container>
    <div id=background></div>
    <table cellspacing=0 cellpadding=0>
    <thead>
      <tr>
        <th class=docs><h1>baremetal</h1></th>
        <th class=code></th>
      </tr>
    </thead>
    <tbody>
        <tr><td class='docs'><?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.11: http://docutils.sourceforge.net/" />
<title></title>
<style type="text/css">

/*
:Author: David Goodger (goodger@python.org)
:Id: $Id: html4css1.css 7614 2013-02-21 15:55:51Z milde $
:Copyright: This stylesheet has been placed in the public domain.

Default cascading style sheet for the HTML output of Docutils.

See http://docutils.sf.net/docs/howto/html-stylesheets.html for how to
customize this style sheet.
*/

/* used to remove borders from tables and images */
.borderless, table.borderless td, table.borderless th {
  border: 0 }

table.borderless td, table.borderless th {
  /* Override padding for "table.docutils td" with "! important".
     The right padding separates the table cells. */
  padding: 0 0.5em 0 0 ! important }

.first {
  /* Override more specific margin styles with "! important". */
  margin-top: 0 ! important }

.last, .with-subtitle {
  margin-bottom: 0 ! important }

.hidden {
  display: none }

a.toc-backref {
  text-decoration: none ;
  color: black }

blockquote.epigraph {
  margin: 2em 5em ; }

dl.docutils dd {
  margin-bottom: 0.5em }

object[type="image/svg+xml"], object[type="application/x-shockwave-flash"] {
  overflow: hidden;
}

/* Uncomment (and remove this text!) to get bold-faced definition list terms
dl.docutils dt {
  font-weight: bold }
*/

div.abstract {
  margin: 2em 5em }

div.abstract p.topic-title {
  font-weight: bold ;
  text-align: center }

div.admonition, div.attention, div.caution, div.danger, div.error,
div.hint, div.important, div.note, div.tip, div.warning {
  margin: 2em ;
  border: medium outset ;
  padding: 1em }

div.admonition p.admonition-title, div.hint p.admonition-title,
div.important p.admonition-title, div.note p.admonition-title,
div.tip p.admonition-title {
  font-weight: bold ;
  font-family: sans-serif }

div.attention p.admonition-title, div.caution p.admonition-title,
div.danger p.admonition-title, div.error p.admonition-title,
div.warning p.admonition-title, .code .error {
  color: red ;
  font-weight: bold ;
  font-family: sans-serif }

/* Uncomment (and remove this text!) to get reduced vertical space in
   compound paragraphs.
div.compound .compound-first, div.compound .compound-middle {
  margin-bottom: 0.5em }

div.compound .compound-last, div.compound .compound-middle {
  margin-top: 0.5em }
*/

div.dedication {
  margin: 2em 5em ;
  text-align: center ;
  font-style: italic }

div.dedication p.topic-title {
  font-weight: bold ;
  font-style: normal }

div.figure {
  margin-left: 2em ;
  margin-right: 2em }

div.footer, div.header {
  clear: both;
  font-size: smaller }

div.line-block {
  display: block ;
  margin-top: 1em ;
  margin-bottom: 1em }

div.line-block div.line-block {
  margin-top: 0 ;
  margin-bottom: 0 ;
  margin-left: 1.5em }

div.sidebar {
  margin: 0 0 0.5em 1em ;
  border: medium outset ;
  padding: 1em ;
  background-color: #ffffee ;
  width: 40% ;
  float: right ;
  clear: right }

div.sidebar p.rubric {
  font-family: sans-serif ;
  font-size: medium }

div.system-messages {
  margin: 5em }

div.system-messages h1 {
  color: red }

div.system-message {
  border: medium outset ;
  padding: 1em }

div.system-message p.system-message-title {
  color: red ;
  font-weight: bold }

div.topic {
  margin: 2em }

h1.section-subtitle, h2.section-subtitle, h3.section-subtitle,
h4.section-subtitle, h5.section-subtitle, h6.section-subtitle {
  margin-top: 0.4em }

h1.title {
  text-align: center }

h2.subtitle {
  text-align: center }

hr.docutils {
  width: 75% }

img.align-left, .figure.align-left, object.align-left {
  clear: left ;
  float: left ;
  margin-right: 1em }

img.align-right, .figure.align-right, object.align-right {
  clear: right ;
  float: right ;
  margin-left: 1em }

img.align-center, .figure.align-center, object.align-center {
  display: block;
  margin-left: auto;
  margin-right: auto;
}

.align-left {
  text-align: left }

.align-center {
  clear: both ;
  text-align: center }

.align-right {
  text-align: right }

/* reset inner alignment in figures */
div.align-right {
  text-align: inherit }

/* div.align-center * { */
/*   text-align: left } */

ol.simple, ul.simple {
  margin-bottom: 1em }

ol.arabic {
  list-style: decimal }

ol.loweralpha {
  list-style: lower-alpha }

ol.upperalpha {
  list-style: upper-alpha }

ol.lowerroman {
  list-style: lower-roman }

ol.upperroman {
  list-style: upper-roman }

p.attribution {
  text-align: right ;
  margin-left: 50% }

p.caption {
  font-style: italic }

p.credits {
  font-style: italic ;
  font-size: smaller }

p.label {
  white-space: nowrap }

p.rubric {
  font-weight: bold ;
  font-size: larger ;
  color: maroon ;
  text-align: center }

p.sidebar-title {
  font-family: sans-serif ;
  font-weight: bold ;
  font-size: larger }

p.sidebar-subtitle {
  font-family: sans-serif ;
  font-weight: bold }

p.topic-title {
  font-weight: bold }

pre.address {
  margin-bottom: 0 ;
  margin-top: 0 ;
  font: inherit }

pre.literal-block, pre.doctest-block, pre.math, pre.code {
  margin-left: 2em ;
  margin-right: 2em }

pre.code .ln { color: grey; } /* line numbers */
pre.code, code { background-color: #eeeeee }
pre.code .comment, code .comment { color: #5C6576 }
pre.code .keyword, code .keyword { color: #3B0D06; font-weight: bold }
pre.code .literal.string, code .literal.string { color: #0C5404 }
pre.code .name.builtin, code .name.builtin { color: #352B84 }
pre.code .deleted, code .deleted { background-color: #DEB0A1}
pre.code .inserted, code .inserted { background-color: #A3D289}

span.classifier {
  font-family: sans-serif ;
  font-style: oblique }

span.classifier-delimiter {
  font-family: sans-serif ;
  font-weight: bold }

span.interpreted {
  font-family: sans-serif }

span.option {
  white-space: nowrap }

span.pre {
  white-space: pre }

span.problematic {
  color: red }

span.section-subtitle {
  /* font-size relative to parent (h1..h6 element) */
  font-size: 80% }

table.citation {
  border-left: solid 1px gray;
  margin-left: 1px }

table.docinfo {
  margin: 2em 4em }

table.docutils {
  margin-top: 0.5em ;
  margin-bottom: 0.5em }

table.footnote {
  border-left: solid 1px black;
  margin-left: 1px }

table.docutils td, table.docutils th,
table.docinfo td, table.docinfo th {
  padding-left: 0.5em ;
  padding-right: 0.5em ;
  vertical-align: top }

table.docutils th.field-name, table.docinfo th.docinfo-name {
  font-weight: bold ;
  text-align: left ;
  white-space: nowrap ;
  padding-left: 0 }

/* "booktabs" style (no vertical lines) */
table.docutils.booktabs {
  border: 0px;
  border-top: 2px solid;
  border-bottom: 2px solid;
  border-collapse: collapse;
}
table.docutils.booktabs * {
  border: 0px;
}
table.docutils.booktabs th {
  border-bottom: thin solid;
  text-align: left;
}

h1 tt.docutils, h2 tt.docutils, h3 tt.docutils,
h4 tt.docutils, h5 tt.docutils, h6 tt.docutils {
  font-size: 100% }

ul.auto-toc {
  list-style-type: none }

</style>
</head>
<body>
<div class="document">


<p>This file provides devstack with the environment and utilities to
control nova-compute's baremetal driver.
It sets reasonable defaults to run within a single host,
using virtual machines in place of physical hardware.
However, by changing just a few options, devstack+baremetal can in fact
control physical hardware resources on the same network, if you know
the MAC address(es) and IPMI credentials.</p>
<p>At a minimum, to enable the baremetal driver, you must set these in localrc:</p>
<blockquote>
VIRT_DRIVER=baremetal
ENABLED_SERVICES=&quot;$ENABLED_SERVICES,baremetal&quot;</blockquote>
<p>We utilize diskimage-builder to create a ramdisk, and then
baremetal driver uses that to push a disk image onto the node(s).</p>
<p>Below we define various defaults which control the behavior of the
baremetal compute service, and inform it of the hardware it will control.</p>
<p>Below that, various functions are defined, which are called by devstack
in the following order:</p>
<p>before nova-cpu starts:</p>
<blockquote>
<ul class="simple">
<li>prepare_baremetal_toolchain</li>
<li>configure_baremetal_nova_dirs</li>
</ul>
</blockquote>
<p>after nova and glance have started:</p>
<blockquote>
<ul class="simple">
<li>build_and_upload_baremetal_deploy_k_and_r $token</li>
<li>create_baremetal_flavor $BM_DEPLOY_KERNEL_ID $BM_DEPLOY_RAMDISK_ID</li>
<li>upload_baremetal_image $url $token</li>
<li>add_baremetal_node &lt;first_mac&gt; &lt;second_mac&gt;</li>
</ul>
</blockquote>
</td><td class=code><div class=highlight><pre>
<span class="c">## vim: tabstop=4 shiftwidth=4 softtabstop=4</span>

<span class="c">## Copyright (c) 2012 Hewlett-Packard Development Company, L.P.</span>
<span class="c">## All Rights Reserved.</span>
<span class="c">##</span>
<span class="c">##    Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may</span>
<span class="c">##    not use this file except in compliance with the License. You may obtain</span>
<span class="c">##    a copy of the License at</span>
<span class="c">##</span>
<span class="c">##         http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c">##</span>
<span class="c">##    Unless required by applicable law or agreed to in writing, software</span>
<span class="c">##    distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT</span>
<span class="c">##    WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the</span>
<span class="c">##    License for the specific language governing permissions and limitations</span>
<span class="c">##    under the License.</span>




</pre></div></td></tr><tr><td class=docs>
<p>Save trace setting</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">XTRACE</span><span class="o">=</span><span class="k">$(</span><span class="nb">set</span> +o | grep xtrace<span class="k">)</span>
<span class="nb">set</span> +o xtrace


</pre></div></td></tr><tr><td class=docs>
<div class="section" id="sub-driver-settings">
<h1>Sub-driver settings</h1>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>sub-driver to use for kernel deployment</p>
<ul class="simple">
<li>nova.virt.baremetal.pxe.PXE</li>
<li>nova.virt.baremetal.tilera.TILERA</li>
</ul>
</td><td class=code><div class=highlight><pre>
<span class="nv">BM_DRIVER</span><span class="o">=</span><span class="k">${</span><span class="nv">BM_DRIVER</span><span class="k">:-</span><span class="nv">nova</span><span class="p">.virt.baremetal.pxe.PXE</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>sub-driver to use for remote power management</p>
<ul class="simple">
<li>nova.virt.baremetal.fake.FakePowerManager, for manual power control</li>
<li>nova.virt.baremetal.ipmi.IPMI, for remote IPMI</li>
<li>nova.virt.baremetal.tilera_pdu.Pdu, for TilePro hardware</li>
</ul>
</td><td class=code><div class=highlight><pre>
<span class="nv">BM_POWER_MANAGER</span><span class="o">=</span><span class="k">${</span><span class="nv">BM_POWER_MANAGER</span><span class="k">:-</span><span class="nv">nova</span><span class="p">.virt.baremetal.fake.FakePowerManager</span><span class="k">}</span>


</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="these-should-be-customized-to-your-environment-and-hardware">
<h1>These should be customized to your environment and hardware</h1>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>To provide PXE, configure nova-network's dnsmasq rather than run the one
dedicated to baremetal. When enable this, make sure these conditions are
fulfilled:</p>
<ol class="arabic simple">
<li>nova-compute and nova-network runs on the same host</li>
<li>nova-network uses FlatDHCPManager</li>
</ol>
<p>NOTE: the other BM_DNSMASQ_* have no effect on the behavior if this option
is enabled.</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">BM_DNSMASQ_FROM_NOVA_NETWORK</span><span class="o">=</span><span class="sb">`</span>trueorfalse False <span class="nv">$BM_DNSMASQ_FROM_NOVA_NETWORK</span><span class="sb">`</span>

</pre></div></td></tr><tr><td class=docs>
<p>BM_DNSMASQ_IFACE should match FLAT_NETWORK_BRIDGE</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">BM_DNSMASQ_IFACE</span><span class="o">=</span><span class="k">${</span><span class="nv">BM_DNSMASQ_IFACE</span><span class="k">:-</span><span class="nv">eth0</span><span class="k">}</span>
</pre></div></td></tr><tr><td class=docs>
<p>if testing on a physical network,
BM_DNSMASQ_RANGE must be changed to suit your network</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">BM_DNSMASQ_RANGE</span><span class="o">=</span><span class="k">${</span><span class="nv">BM_DNSMASQ_RANGE</span><span class="k">:-}</span>

</pre></div></td></tr><tr><td class=docs>
<p>BM_DNSMASQ_DNS provide dns server to bootstrap clients</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">BM_DNSMASQ_DNS</span><span class="o">=</span><span class="k">${</span><span class="nv">BM_DNSMASQ_DNS</span><span class="k">:-}</span>

</pre></div></td></tr><tr><td class=docs>
<p>BM_FIRST_MAC <em>must</em> be set to the MAC address of the node you will
boot.  This is passed to dnsmasq along with the kernel/ramdisk to
deploy via PXE.</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">BM_FIRST_MAC</span><span class="o">=</span><span class="k">${</span><span class="nv">BM_FIRST_MAC</span><span class="k">:-}</span>

</pre></div></td></tr><tr><td class=docs>
<p>BM_SECOND_MAC is only important if the host has &gt;1 NIC.</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">BM_SECOND_MAC</span><span class="o">=</span><span class="k">${</span><span class="nv">BM_SECOND_MAC</span><span class="k">:-}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Hostname for the baremetal nova-compute node, if not run on this host</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">BM_HOSTNAME</span><span class="o">=</span><span class="k">${</span><span class="nv">BM_HOSTNAME</span><span class="k">:-$(</span>hostname -f<span class="k">)}</span>

</pre></div></td></tr><tr><td class=docs>
<p>BM_PM_* options are only necessary if BM_POWER_MANAGER=...IPMI</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">BM_PM_ADDR</span><span class="o">=</span><span class="k">${</span><span class="nv">BM_PM_ADDR</span><span class="k">:-</span><span class="nv">0</span><span class="p">.0.0.0</span><span class="k">}</span>
<span class="nv">BM_PM_USER</span><span class="o">=</span><span class="k">${</span><span class="nv">BM_PM_USER</span><span class="k">:-</span><span class="nv">user</span><span class="k">}</span>
<span class="nv">BM_PM_PASS</span><span class="o">=</span><span class="k">${</span><span class="nv">BM_PM_PASS</span><span class="k">:-</span><span class="nv">pass</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>BM_FLAVOR_* options are arbitrary and not necessarily related to
physical hardware capacity. These can be changed if you are testing
BaremetalHostManager with multiple nodes and different flavors.</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">BM_CPU_ARCH</span><span class="o">=</span><span class="k">${</span><span class="nv">BM_CPU_ARCH</span><span class="k">:-</span><span class="nv">x86_64</span><span class="k">}</span>
<span class="nv">BM_FLAVOR_CPU</span><span class="o">=</span><span class="k">${</span><span class="nv">BM_FLAVOR_CPU</span><span class="k">:-</span><span class="nv">1</span><span class="k">}</span>
<span class="nv">BM_FLAVOR_RAM</span><span class="o">=</span><span class="k">${</span><span class="nv">BM_FLAVOR_RAM</span><span class="k">:-</span><span class="nv">1024</span><span class="k">}</span>
<span class="nv">BM_FLAVOR_ROOT_DISK</span><span class="o">=</span><span class="k">${</span><span class="nv">BM_FLAVOR_ROOT_DISK</span><span class="k">:-</span><span class="nv">10</span><span class="k">}</span>
<span class="nv">BM_FLAVOR_EPHEMERAL_DISK</span><span class="o">=</span><span class="k">${</span><span class="nv">BM_FLAVOR_EPHEMERAL_DISK</span><span class="k">:-</span><span class="nv">0</span><span class="k">}</span>
<span class="nv">BM_FLAVOR_SWAP</span><span class="o">=</span><span class="k">${</span><span class="nv">BM_FLAVOR_SWAP</span><span class="k">:-</span><span class="nv">1</span><span class="k">}</span>
<span class="nv">BM_FLAVOR_NAME</span><span class="o">=</span><span class="k">${</span><span class="nv">BM_FLAVOR_NAME</span><span class="k">:-</span><span class="nv">bm</span><span class="p">.small</span><span class="k">}</span>
<span class="nv">BM_FLAVOR_ID</span><span class="o">=</span><span class="k">${</span><span class="nv">BM_FLAVOR_ID</span><span class="k">:-</span><span class="nv">11</span><span class="k">}</span>
<span class="nv">BM_FLAVOR_ARCH</span><span class="o">=</span><span class="k">${</span><span class="nv">BM_FLAVOR_ARCH</span><span class="k">:-</span><span class="nv">$BM_CPU_ARCH</span><span class="k">}</span>


</pre></div></td></tr><tr><td class=docs>
<p>Below this, we set some path and filenames.
Defaults are probably sufficient.</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">DIB_DIR</span><span class="o">=</span><span class="k">${</span><span class="nv">DIB_DIR</span><span class="k">:-</span><span class="nv">$DEST</span><span class="p">/diskimage-builder</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Use DIB to create deploy ramdisk and kernel.</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">BM_BUILD_DEPLOY_RAMDISK</span><span class="o">=</span><span class="sb">`</span>trueorfalse True <span class="nv">$BM_BUILD_DEPLOY_RAMDISK</span><span class="sb">`</span>
</pre></div></td></tr><tr><td class=docs>
<p>If not use DIB, these files are used as deploy ramdisk/kernel.
(The value must be a relative path from $TOP_DIR/files/)</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">BM_DEPLOY_RAMDISK</span><span class="o">=</span><span class="k">${</span><span class="nv">BM_DEPLOY_RAMDISK</span><span class="k">:-}</span>
<span class="nv">BM_DEPLOY_KERNEL</span><span class="o">=</span><span class="k">${</span><span class="nv">BM_DEPLOY_KERNEL</span><span class="k">:-}</span>

</pre></div></td></tr><tr><td class=docs>
<p>If you need to add any extra flavors to the deploy ramdisk image
eg, specific network drivers, specify them here</p>
<dl class="docutils">
<dt>NOTE(deva): this will be moved to lib/ironic in a future patch</dt>
<dd>for now, set the default to a suitable value for Ironic's needs</dd>
</dl>
</td><td class=code><div class=highlight><pre>
<span class="nv">BM_DEPLOY_FLAVOR</span><span class="o">=</span><span class="k">${</span><span class="nv">BM_DEPLOY_FLAVOR</span><span class="k">:-</span><span class="p">-a amd64 ubuntu deploy-ironic</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>set URL and version for google shell-in-a-box</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">BM_SHELL_IN_A_BOX</span><span class="o">=</span><span class="k">${</span><span class="nv">BM_SHELL_IN_A_BOX</span><span class="k">:-</span><span class="nv">http</span><span class="p">://shellinabox.googlecode.com/files/shellinabox-2.14.tar.gz</span><span class="k">}</span>


</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="functions">
<h1>Functions</h1>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Check if baremetal is properly enabled
Returns false if VIRT_DRIVER is not baremetal, or if ENABLED_SERVICES
does not contain &quot;baremetal&quot;</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>is_baremetal <span class="o">{</span>
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$ENABLED_SERVICES&quot;</span> <span class="o">=</span>~ <span class="s1">&#39;baremetal&#39;</span> <span class="o">&amp;&amp;</span> <span class="s2">&quot;$VIRT_DRIVER&quot;</span> <span class="o">=</span> <span class="s1">&#39;baremetal&#39;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        return </span>0
    <span class="k">fi</span>
<span class="k">    return </span>1
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Install diskimage-builder and shell-in-a-box
so that we can build the deployment kernel &amp; ramdisk</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>prepare_baremetal_toolchain <span class="o">{</span>
    git_clone <span class="nv">$DIB_REPO</span> <span class="nv">$DIB_DIR</span> <span class="nv">$DIB_BUILD_BRANCH</span>

    <span class="nb">local </span><span class="nv">shellinabox_basename</span><span class="o">=</span><span class="k">$(</span>basename <span class="nv">$BM_SHELL_IN_A_BOX</span><span class="k">)</span>
    <span class="k">if</span> <span class="o">[[</span> ! -e <span class="nv">$DEST</span>/<span class="nv">$shellinabox_basename</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nb">cd</span> <span class="nv">$DEST</span>
        wget <span class="nv">$BM_SHELL_IN_A_BOX</span>
    <span class="k">fi</span>
<span class="k">    if</span> <span class="o">[[</span> ! -d <span class="nv">$DEST</span>/<span class="k">${</span><span class="nv">shellinabox_basename</span><span class="p">%%.tar.gz</span><span class="k">}</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nb">cd</span> <span class="nv">$DEST</span>
        tar xzf <span class="nv">$shellinabox_basename</span>
    <span class="k">fi</span>
<span class="k">    if</span> <span class="o">[[</span> ! <span class="k">$(</span>which shellinaboxd<span class="k">)</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nb">cd</span> <span class="nv">$DEST</span>/<span class="k">${</span><span class="nv">shellinabox_basename</span><span class="p">%%.tar.gz</span><span class="k">}</span>
        ./configure
        make
        sudo make install
    <span class="k">fi</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>prepare various directories needed by baremetal hypervisor</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>configure_baremetal_nova_dirs <span class="o">{</span>
</pre></div></td></tr><tr><td class=docs>
<p>ensure /tftpboot is prepared</p>
</td><td class=code><div class=highlight><pre>
    sudo mkdir -p /tftpboot
    sudo mkdir -p /tftpboot/pxelinux.cfg

    <span class="nv">PXEBIN</span><span class="o">=</span>/usr/share/syslinux/pxelinux.0
    <span class="k">if</span> <span class="o">[</span> ! -f <span class="nv">$PXEBIN</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nv">PXEBIN</span><span class="o">=</span>/usr/lib/syslinux/pxelinux.0
        <span class="k">if</span> <span class="o">[</span> ! -f <span class="nv">$PXEBIN</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">            </span>die <span class="nv">$LINENO</span> <span class="s2">&quot;pxelinux.0 (from SYSLINUX) not found.&quot;</span>
        <span class="k">fi</span>
<span class="k">    fi</span>

<span class="k">    </span>sudo cp <span class="nv">$PXEBIN</span> /tftpboot/
    sudo chown -R <span class="nv">$STACK_USER</span>:<span class="nv">$LIBVIRT_GROUP</span> /tftpboot

</pre></div></td></tr><tr><td class=docs>
<p>ensure $NOVA_STATE_PATH/baremetal is prepared</p>
</td><td class=code><div class=highlight><pre>
    sudo mkdir -p <span class="nv">$NOVA_STATE_PATH</span>/baremetal
    sudo mkdir -p <span class="nv">$NOVA_STATE_PATH</span>/baremetal/console
    sudo mkdir -p <span class="nv">$NOVA_STATE_PATH</span>/baremetal/dnsmasq
    sudo touch <span class="nv">$NOVA_STATE_PATH</span>/baremetal/dnsmasq/dnsmasq-dhcp.host
    sudo chown -R <span class="nv">$STACK_USER</span> <span class="nv">$NOVA_STATE_PATH</span>/baremetal

</pre></div></td></tr><tr><td class=docs>
<p>ensure dnsmasq is installed but not running
because baremetal driver will reconfigure and restart this as needed</p>
</td><td class=code><div class=highlight><pre>
    is_package_installed dnsmasq <span class="o">||</span> install_package dnsmasq
    stop_service dnsmasq
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>build deploy kernel+ramdisk, then upload them to glance
this function sets BM_DEPLOY_KERNEL_ID and BM_DEPLOY_RAMDISK_ID</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>upload_baremetal_deploy <span class="o">{</span>
    <span class="nv">token</span><span class="o">=</span><span class="nv">$1</span>

    <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$BM_BUILD_DEPLOY_RAMDISK&quot;</span> <span class="o">=</span> <span class="s2">&quot;True&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nv">BM_DEPLOY_KERNEL</span><span class="o">=</span>bm-deploy.kernel
        <span class="nv">BM_DEPLOY_RAMDISK</span><span class="o">=</span>bm-deploy.initramfs
        <span class="k">if</span> <span class="o">[</span> ! -e <span class="s2">&quot;$TOP_DIR/files/$BM_DEPLOY_KERNEL&quot;</span> -o ! -e <span class="s2">&quot;$TOP_DIR/files/$BM_DEPLOY_RAMDISK&quot;</span> <span class="o">]</span>; <span class="k">then</span>
            <span class="nv">$DIB_DIR</span>/bin/ramdisk-image-create <span class="nv">$BM_DEPLOY_FLAVOR</span> <span class="se">\</span>
                -o <span class="nv">$TOP_DIR</span>/files/bm-deploy
        <span class="k">fi</span>
<span class="k">    fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>load them into glance</p>
</td><td class=code><div class=highlight><pre>
    <span class="nv">BM_DEPLOY_KERNEL_ID</span><span class="o">=</span><span class="k">$(</span>glance <span class="se">\</span>
        --os-auth-token <span class="nv">$token</span> <span class="se">\</span>
        --os-image-url http://<span class="nv">$GLANCE_HOSTPORT</span> <span class="se">\</span>
        image-create <span class="se">\</span>
        --name <span class="nv">$BM_DEPLOY_KERNEL</span> <span class="se">\</span>
        --is-public True --disk-format<span class="o">=</span>aki <span class="se">\</span>
        &lt; <span class="nv">$TOP_DIR</span>/files/<span class="nv">$BM_DEPLOY_KERNEL</span>  | grep <span class="s1">&#39; id &#39;</span> | get_field 2<span class="k">)</span>
    <span class="nv">BM_DEPLOY_RAMDISK_ID</span><span class="o">=</span><span class="k">$(</span>glance <span class="se">\</span>
        --os-auth-token <span class="nv">$token</span> <span class="se">\</span>
        --os-image-url http://<span class="nv">$GLANCE_HOSTPORT</span> <span class="se">\</span>
        image-create <span class="se">\</span>
        --name <span class="nv">$BM_DEPLOY_RAMDISK</span> <span class="se">\</span>
        --is-public True --disk-format<span class="o">=</span>ari <span class="se">\</span>
        &lt; <span class="nv">$TOP_DIR</span>/files/<span class="nv">$BM_DEPLOY_RAMDISK</span>  | grep <span class="s1">&#39; id &#39;</span> | get_field 2<span class="k">)</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>create a basic baremetal flavor, associated with deploy kernel &amp; ramdisk</p>
<p>Usage: create_baremetal_flavor &lt;aki_uuid&gt; &lt;ari_uuid&gt;</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>create_baremetal_flavor <span class="o">{</span>
    <span class="nv">aki</span><span class="o">=</span><span class="nv">$1</span>
    <span class="nv">ari</span><span class="o">=</span><span class="nv">$2</span>
    nova flavor-create <span class="nv">$BM_FLAVOR_NAME</span> <span class="nv">$BM_FLAVOR_ID</span> <span class="se">\</span>
        <span class="nv">$BM_FLAVOR_RAM</span> <span class="nv">$BM_FLAVOR_ROOT_DISK</span> <span class="nv">$BM_FLAVOR_CPU</span>
    nova flavor-key <span class="nv">$BM_FLAVOR_NAME</span> <span class="nb">set</span> <span class="se">\</span>
        <span class="s2">&quot;cpu_arch&quot;</span><span class="o">=</span><span class="s2">&quot;$BM_FLAVOR_ARCH&quot;</span> <span class="se">\</span>
        <span class="s2">&quot;baremetal:deploy_kernel_id&quot;</span><span class="o">=</span><span class="s2">&quot;$aki&quot;</span> <span class="se">\</span>
        <span class="s2">&quot;baremetal:deploy_ramdisk_id&quot;</span><span class="o">=</span><span class="s2">&quot;$ari&quot;</span>

<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Pull run-time kernel/ramdisk out of disk image and load into glance.
Note that $file is currently expected to be in qcow2 format.
Sets KERNEL_ID and RAMDISK_ID</p>
<p>Usage: extract_and_upload_k_and_r_from_image $token $file</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>extract_and_upload_k_and_r_from_image <span class="o">{</span>
    <span class="nv">token</span><span class="o">=</span><span class="nv">$1</span>
    <span class="nv">file</span><span class="o">=</span><span class="nv">$2</span>
    <span class="nv">image_name</span><span class="o">=</span><span class="k">$(</span>basename <span class="s2">&quot;$file&quot;</span> <span class="s2">&quot;.qcow2&quot;</span><span class="k">)</span>

</pre></div></td></tr><tr><td class=docs>
<p>this call returns the file names as &quot;$kernel,$ramdisk&quot;</p>
</td><td class=code><div class=highlight><pre>
    <span class="nv">out</span><span class="o">=</span><span class="k">$(</span><span class="nv">$DIB_DIR</span>/bin/disk-image-get-kernel <span class="se">\</span>
            -x -d <span class="nv">$TOP_DIR</span>/files -o bm-deploy -i <span class="nv">$file</span><span class="k">)</span>
    <span class="k">if</span> <span class="o">[</span> <span class="nv">$?</span> -ne 0 <span class="o">]</span>; <span class="k">then</span>
<span class="k">        </span>die <span class="nv">$LINENO</span> <span class="s2">&quot;Failed to get kernel and ramdisk from $file&quot;</span>
    <span class="k">fi</span>
<span class="k">    </span><span class="nv">XTRACE</span><span class="o">=</span><span class="k">$(</span><span class="nb">set</span> +o | grep xtrace<span class="k">)</span>
    <span class="nb">set</span> +o xtrace
    <span class="nv">out</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">&quot;$out&quot;</span> | tail -1<span class="k">)</span>
    <span class="nv">$XTRACE</span>
    <span class="nv">OUT_KERNEL</span><span class="o">=</span><span class="k">${</span><span class="nv">out</span><span class="p">%%,*</span><span class="k">}</span>
    <span class="nv">OUT_RAMDISK</span><span class="o">=</span><span class="k">${</span><span class="nv">out</span><span class="p">##*,</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>load them into glance</p>
</td><td class=code><div class=highlight><pre>
    <span class="nv">KERNEL_ID</span><span class="o">=</span><span class="k">$(</span>glance <span class="se">\</span>
        --os-auth-token <span class="nv">$token</span> <span class="se">\</span>
        --os-image-url http://<span class="nv">$GLANCE_HOSTPORT</span> <span class="se">\</span>
        image-create <span class="se">\</span>
        --name <span class="nv">$image_name</span>-kernel <span class="se">\</span>
        --is-public True --disk-format<span class="o">=</span>aki <span class="se">\</span>
        &lt; <span class="nv">$TOP_DIR</span>/files/<span class="nv">$OUT_KERNEL</span> | grep <span class="s1">&#39; id &#39;</span> | get_field 2<span class="k">)</span>
    <span class="nv">RAMDISK_ID</span><span class="o">=</span><span class="k">$(</span>glance <span class="se">\</span>
        --os-auth-token <span class="nv">$token</span> <span class="se">\</span>
        --os-image-url http://<span class="nv">$GLANCE_HOSTPORT</span> <span class="se">\</span>
        image-create <span class="se">\</span>
        --name <span class="nv">$image_name</span>-initrd <span class="se">\</span>
        --is-public True --disk-format<span class="o">=</span>ari <span class="se">\</span>
        &lt; <span class="nv">$TOP_DIR</span>/files/<span class="nv">$OUT_RAMDISK</span> | grep <span class="s1">&#39; id &#39;</span> | get_field 2<span class="k">)</span>
<span class="o">}</span>


</pre></div></td></tr><tr><td class=docs>
<p>Re-implementation of devstack's &quot;upload_image&quot; function</p>
<p>Takes the same parameters, but has some peculiarities which made it
easier to create a separate method, rather than complicate the logic
of the existing function.</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>upload_baremetal_image <span class="o">{</span>
    <span class="nb">local </span><span class="nv">image_url</span><span class="o">=</span><span class="nv">$1</span>
    <span class="nb">local </span><span class="nv">token</span><span class="o">=</span><span class="nv">$2</span>

</pre></div></td></tr><tr><td class=docs>
<p>Create a directory for the downloaded image tarballs.</p>
</td><td class=code><div class=highlight><pre>
    mkdir -p <span class="nv">$FILES</span>/images

</pre></div></td></tr><tr><td class=docs>
<p>Downloads the image (uec ami+aki style), then extracts it.</p>
</td><td class=code><div class=highlight><pre>
    <span class="nv">IMAGE_FNAME</span><span class="o">=</span><span class="sb">`</span>basename <span class="s2">&quot;$image_url&quot;</span><span class="sb">`</span>
    <span class="k">if</span> <span class="o">[[</span> ! -f <span class="nv">$FILES</span>/<span class="nv">$IMAGE_FNAME</span> <span class="o">||</span> <span class="se">\</span>
        <span class="s2">&quot;$(stat -c &quot;</span>%s<span class="s2">&quot; $FILES/$IMAGE_FNAME)&quot;</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span>wget -c <span class="nv">$image_url</span> -O <span class="nv">$FILES</span>/<span class="nv">$IMAGE_FNAME</span>
        <span class="k">if</span> <span class="o">[[</span> <span class="nv">$?</span> -ne 0 <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            </span><span class="nb">echo</span> <span class="s2">&quot;Not found: $image_url&quot;</span>
            <span class="k">return</span>
<span class="k">        fi</span>
<span class="k">    fi</span>

<span class="k">    </span><span class="nb">local </span><span class="nv">KERNEL</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
    <span class="nb">local </span><span class="nv">RAMDISK</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
    <span class="nb">local </span><span class="nv">DISK_FORMAT</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
    <span class="nb">local </span><span class="nv">CONTAINER_FORMAT</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
    <span class="k">case</span> <span class="s2">&quot;$IMAGE_FNAME&quot;</span> in
        *.tar.gz|*.tgz<span class="o">)</span>
</pre></div></td></tr><tr><td class=docs>
<p>Extract ami and aki files</p>
</td><td class=code><div class=highlight><pre>
            <span class="o">[</span> <span class="s2">&quot;${IMAGE_FNAME%.tar.gz}&quot;</span> !<span class="o">=</span> <span class="s2">&quot;$IMAGE_FNAME&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span>
                <span class="nv">IMAGE_NAME</span><span class="o">=</span><span class="s2">&quot;${IMAGE_FNAME%.tar.gz}&quot;</span> <span class="o">||</span>
                <span class="nv">IMAGE_NAME</span><span class="o">=</span><span class="s2">&quot;${IMAGE_FNAME%.tgz}&quot;</span>
            <span class="nv">xdir</span><span class="o">=</span><span class="s2">&quot;$FILES/images/$IMAGE_NAME&quot;</span>
            rm -Rf <span class="s2">&quot;$xdir&quot;</span>;
            mkdir <span class="s2">&quot;$xdir&quot;</span>
            tar -zxf <span class="nv">$FILES</span>/<span class="nv">$IMAGE_FNAME</span> -C <span class="s2">&quot;$xdir&quot;</span>
            <span class="nv">KERNEL</span><span class="o">=</span><span class="k">$(for </span>f in <span class="s2">&quot;$xdir/&quot;</span>*-vmlinuz* <span class="s2">&quot;$xdir/&quot;</span>aki-*/image; <span class="k">do</span>
                <span class="o">[</span> -f <span class="s2">&quot;$f&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">&quot;$f&quot;</span> <span class="o">&amp;&amp;</span> <span class="nb">break</span>; <span class="k">done</span>; <span class="nb">true</span><span class="k">)</span>
            <span class="nv">RAMDISK</span><span class="o">=</span><span class="k">$(for </span>f in <span class="s2">&quot;$xdir/&quot;</span>*-initrd* <span class="s2">&quot;$xdir/&quot;</span>ari-*/image; <span class="k">do</span>
                <span class="o">[</span> -f <span class="s2">&quot;$f&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">&quot;$f&quot;</span> <span class="o">&amp;&amp;</span> <span class="nb">break</span>; <span class="k">done</span>; <span class="nb">true</span><span class="k">)</span>
            <span class="nv">IMAGE</span><span class="o">=</span><span class="k">$(for </span>f in <span class="s2">&quot;$xdir/&quot;</span>*.img <span class="s2">&quot;$xdir/&quot;</span>ami-*/image; <span class="k">do</span>
                <span class="o">[</span> -f <span class="s2">&quot;$f&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">&quot;$f&quot;</span> <span class="o">&amp;&amp;</span> <span class="nb">break</span>; <span class="k">done</span>; <span class="nb">true</span><span class="k">)</span>
            <span class="k">if</span> <span class="o">[[</span> -z <span class="s2">&quot;$IMAGE_NAME&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">                </span><span class="nv">IMAGE_NAME</span><span class="o">=</span><span class="k">$(</span>basename <span class="s2">&quot;$IMAGE&quot;</span> <span class="s2">&quot;.img&quot;</span><span class="k">)</span>
            <span class="k">fi</span>
<span class="k">            </span><span class="nv">DISK_FORMAT</span><span class="o">=</span>ami
            <span class="nv">CONTAINER_FORMAT</span><span class="o">=</span>ami
            ;;
        *.qcow2<span class="o">)</span>
            <span class="nv">IMAGE</span><span class="o">=</span><span class="s2">&quot;$FILES/${IMAGE_FNAME}&quot;</span>
            <span class="nv">IMAGE_NAME</span><span class="o">=</span><span class="k">$(</span>basename <span class="s2">&quot;$IMAGE&quot;</span> <span class="s2">&quot;.qcow2&quot;</span><span class="k">)</span>
            <span class="nv">DISK_FORMAT</span><span class="o">=</span>qcow2
            <span class="nv">CONTAINER_FORMAT</span><span class="o">=</span>bare
            ;;
        *<span class="o">)</span> <span class="nb">echo</span> <span class="s2">&quot;Do not know what to do with $IMAGE_FNAME&quot;</span>; <span class="nb">false</span>;;
    <span class="k">esac</span>

<span class="k">    if</span> <span class="o">[</span> <span class="s2">&quot;$CONTAINER_FORMAT&quot;</span> <span class="o">=</span> <span class="s2">&quot;bare&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">        </span>extract_and_upload_k_and_r_from_image <span class="nv">$token</span> <span class="nv">$IMAGE</span>
    <span class="k">elif</span> <span class="o">[</span> <span class="s2">&quot;$CONTAINER_FORMAT&quot;</span> <span class="o">=</span> <span class="s2">&quot;ami&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nv">KERNEL_ID</span><span class="o">=</span><span class="k">$(</span>glance <span class="se">\</span>
            --os-auth-token <span class="nv">$token</span> <span class="se">\</span>
            --os-image-url http://<span class="nv">$GLANCE_HOSTPORT</span> <span class="se">\</span>
            image-create <span class="se">\</span>
            --name <span class="s2">&quot;$IMAGE_NAME-kernel&quot;</span> --is-public True <span class="se">\</span>
            --container-format aki <span class="se">\</span>
            --disk-format aki &lt; <span class="s2">&quot;$KERNEL&quot;</span> | grep <span class="s1">&#39; id &#39;</span> | get_field 2<span class="k">)</span>
        <span class="nv">RAMDISK_ID</span><span class="o">=</span><span class="k">$(</span>glance <span class="se">\</span>
            --os-auth-token <span class="nv">$token</span> <span class="se">\</span>
            --os-image-url http://<span class="nv">$GLANCE_HOSTPORT</span> <span class="se">\</span>
            image-create <span class="se">\</span>
            --name <span class="s2">&quot;$IMAGE_NAME-ramdisk&quot;</span> --is-public True <span class="se">\</span>
            --container-format ari <span class="se">\</span>
            --disk-format ari &lt; <span class="s2">&quot;$RAMDISK&quot;</span> | grep <span class="s1">&#39; id &#39;</span> | get_field 2<span class="k">)</span>
    <span class="k">else</span>
</pre></div></td></tr><tr><td class=docs>
<p>TODO(deva): add support for other image types</p>
</td><td class=code><div class=highlight><pre>
        <span class="k">return</span>
<span class="k">    fi</span>

<span class="k">    </span>glance <span class="se">\</span>
        --os-auth-token <span class="nv">$token</span> <span class="se">\</span>
        --os-image-url http://<span class="nv">$GLANCE_HOSTPORT</span> <span class="se">\</span>
        image-create <span class="se">\</span>
        --name <span class="s2">&quot;${IMAGE_NAME%.img}&quot;</span> --is-public True <span class="se">\</span>
        --container-format <span class="nv">$CONTAINER_FORMAT</span> <span class="se">\</span>
        --disk-format <span class="nv">$DISK_FORMAT</span> <span class="se">\</span>
        <span class="k">${</span><span class="nv">KERNEL_ID</span><span class="p">:+--property kernel_id=</span><span class="nv">$KERNEL_ID</span><span class="k">}</span> <span class="se">\</span>
        <span class="k">${</span><span class="nv">RAMDISK_ID</span><span class="p">:+--property ramdisk_id=</span><span class="nv">$RAMDISK_ID</span><span class="k">}</span> &lt; <span class="s2">&quot;${IMAGE}&quot;</span>

</pre></div></td></tr><tr><td class=docs>
<p>override DEFAULT_IMAGE_NAME so that tempest can find the image
that we just uploaded in glance</p>
</td><td class=code><div class=highlight><pre>
    <span class="nv">DEFAULT_IMAGE_NAME</span><span class="o">=</span><span class="s2">&quot;${IMAGE_NAME%.img}&quot;</span>
<span class="o">}</span>

<span class="k">function </span>clear_baremetal_of_all_nodes <span class="o">{</span>
    <span class="nv">list</span><span class="o">=</span><span class="k">$(</span>nova baremetal-node-list | awk -F <span class="s1">&#39;| &#39;</span> <span class="s1">&#39;NR&gt;3 {print $2}&#39;</span> <span class="k">)</span>
    <span class="k">for </span>node in <span class="nv">$list</span>; <span class="k">do</span>
<span class="k">        </span>nova baremetal-node-delete <span class="nv">$node</span>
    <span class="k">done</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Inform nova-baremetal about nodes, MACs, etc.
Defaults to using BM_FIRST_MAC and BM_SECOND_MAC if parameters not specified</p>
<p>Usage: add_baremetal_node &lt;first_mac&gt; &lt;second_mac&gt;</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>add_baremetal_node <span class="o">{</span>
    <span class="nv">mac_1</span><span class="o">=</span><span class="k">${</span><span class="nv">1</span><span class="k">:-</span><span class="nv">$BM_FIRST_MAC</span><span class="k">}</span>
    <span class="nv">mac_2</span><span class="o">=</span><span class="k">${</span><span class="nv">2</span><span class="k">:-</span><span class="nv">$BM_SECOND_MAC</span><span class="k">}</span>

    <span class="nv">id</span><span class="o">=</span><span class="k">$(</span>nova baremetal-node-create <span class="se">\</span>
        --pm_address<span class="o">=</span><span class="s2">&quot;$BM_PM_ADDR&quot;</span> <span class="se">\</span>
        --pm_user<span class="o">=</span><span class="s2">&quot;$BM_PM_USER&quot;</span> <span class="se">\</span>
        --pm_password<span class="o">=</span><span class="s2">&quot;$BM_PM_PASS&quot;</span> <span class="se">\</span>
        <span class="s2">&quot;$BM_HOSTNAME&quot;</span> <span class="se">\</span>
        <span class="s2">&quot;$BM_FLAVOR_CPU&quot;</span> <span class="se">\</span>
        <span class="s2">&quot;$BM_FLAVOR_RAM&quot;</span> <span class="se">\</span>
        <span class="s2">&quot;$BM_FLAVOR_ROOT_DISK&quot;</span> <span class="se">\</span>
        <span class="s2">&quot;$mac_1&quot;</span> <span class="se">\</span>
        | grep <span class="s1">&#39; id &#39;</span> | get_field 2 <span class="k">)</span>
    <span class="o">[</span> <span class="nv">$?</span> -eq 0 <span class="o">]</span> <span class="o">||</span> <span class="o">[</span> <span class="s2">&quot;$id&quot;</span> <span class="o">]</span> <span class="o">||</span> die <span class="nv">$LINENO</span> <span class="s2">&quot;Error adding baremetal node&quot;</span>
    <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;$mac_2&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nv">id2</span><span class="o">=</span><span class="k">$(</span>nova baremetal-interface-add <span class="s2">&quot;$id&quot;</span> <span class="s2">&quot;$mac_2&quot;</span> <span class="k">)</span>
        <span class="o">[</span> <span class="nv">$?</span> -eq 0 <span class="o">]</span> <span class="o">||</span> <span class="o">[</span> <span class="s2">&quot;$id2&quot;</span> <span class="o">]</span> <span class="o">||</span> die <span class="nv">$LINENO</span> <span class="s2">&quot;Error adding interface to barmetal node $id&quot;</span>
    <span class="k">fi</span>
<span class="o">}</span>


</pre></div></td></tr><tr><td class=docs>
<p>Restore xtrace</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">$XTRACE</span>

</pre></div></td></tr><tr><td class=docs>
<p>Tell emacs to use shell-script-mode</p>
</td><td class=code><div class=highlight><pre>
<span class="c">## Local variables:</span>
<span class="c">## mode: shell-script</span>
<span class="c">## End:</span>


</td><td class=code><div class=highlight><pre>
</pre></div></td></tr><tr><td class=docs>
</pre></div></td></tr><tr><td class=docs>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
</div>
</div>
</body>
</html></td><td class='code'></td></tr>
    </tbody>
    </table>
</div>
</body>
</html>
