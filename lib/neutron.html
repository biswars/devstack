<!DOCTYPE html>
<html>
<head>
    <meta http-eqiv='content-type' content='text/html;charset=utf-8'>
    <title>neutron</title>
    <link rel=stylesheet href="http://jashkenas.github.com/docco/resources/docco.css">
</head>
<body>
<div id=container>
    <div id=background></div>
    <table cellspacing=0 cellpadding=0>
    <thead>
      <tr>
        <th class=docs><h1>neutron</h1></th>
        <th class=code></th>
      </tr>
    </thead>
    <tbody>
        <tr><td class='docs'><?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.12: http://docutils.sourceforge.net/" />
<title></title>
<style type="text/css">

/*
:Author: David Goodger (goodger@python.org)
:Id: $Id: html4css1.css 7614 2013-02-21 15:55:51Z milde $
:Copyright: This stylesheet has been placed in the public domain.

Default cascading style sheet for the HTML output of Docutils.

See http://docutils.sf.net/docs/howto/html-stylesheets.html for how to
customize this style sheet.
*/

/* used to remove borders from tables and images */
.borderless, table.borderless td, table.borderless th {
  border: 0 }

table.borderless td, table.borderless th {
  /* Override padding for "table.docutils td" with "! important".
     The right padding separates the table cells. */
  padding: 0 0.5em 0 0 ! important }

.first {
  /* Override more specific margin styles with "! important". */
  margin-top: 0 ! important }

.last, .with-subtitle {
  margin-bottom: 0 ! important }

.hidden {
  display: none }

a.toc-backref {
  text-decoration: none ;
  color: black }

blockquote.epigraph {
  margin: 2em 5em ; }

dl.docutils dd {
  margin-bottom: 0.5em }

object[type="image/svg+xml"], object[type="application/x-shockwave-flash"] {
  overflow: hidden;
}

/* Uncomment (and remove this text!) to get bold-faced definition list terms
dl.docutils dt {
  font-weight: bold }
*/

div.abstract {
  margin: 2em 5em }

div.abstract p.topic-title {
  font-weight: bold ;
  text-align: center }

div.admonition, div.attention, div.caution, div.danger, div.error,
div.hint, div.important, div.note, div.tip, div.warning {
  margin: 2em ;
  border: medium outset ;
  padding: 1em }

div.admonition p.admonition-title, div.hint p.admonition-title,
div.important p.admonition-title, div.note p.admonition-title,
div.tip p.admonition-title {
  font-weight: bold ;
  font-family: sans-serif }

div.attention p.admonition-title, div.caution p.admonition-title,
div.danger p.admonition-title, div.error p.admonition-title,
div.warning p.admonition-title, .code .error {
  color: red ;
  font-weight: bold ;
  font-family: sans-serif }

/* Uncomment (and remove this text!) to get reduced vertical space in
   compound paragraphs.
div.compound .compound-first, div.compound .compound-middle {
  margin-bottom: 0.5em }

div.compound .compound-last, div.compound .compound-middle {
  margin-top: 0.5em }
*/

div.dedication {
  margin: 2em 5em ;
  text-align: center ;
  font-style: italic }

div.dedication p.topic-title {
  font-weight: bold ;
  font-style: normal }

div.figure {
  margin-left: 2em ;
  margin-right: 2em }

div.footer, div.header {
  clear: both;
  font-size: smaller }

div.line-block {
  display: block ;
  margin-top: 1em ;
  margin-bottom: 1em }

div.line-block div.line-block {
  margin-top: 0 ;
  margin-bottom: 0 ;
  margin-left: 1.5em }

div.sidebar {
  margin: 0 0 0.5em 1em ;
  border: medium outset ;
  padding: 1em ;
  background-color: #ffffee ;
  width: 40% ;
  float: right ;
  clear: right }

div.sidebar p.rubric {
  font-family: sans-serif ;
  font-size: medium }

div.system-messages {
  margin: 5em }

div.system-messages h1 {
  color: red }

div.system-message {
  border: medium outset ;
  padding: 1em }

div.system-message p.system-message-title {
  color: red ;
  font-weight: bold }

div.topic {
  margin: 2em }

h1.section-subtitle, h2.section-subtitle, h3.section-subtitle,
h4.section-subtitle, h5.section-subtitle, h6.section-subtitle {
  margin-top: 0.4em }

h1.title {
  text-align: center }

h2.subtitle {
  text-align: center }

hr.docutils {
  width: 75% }

img.align-left, .figure.align-left, object.align-left {
  clear: left ;
  float: left ;
  margin-right: 1em }

img.align-right, .figure.align-right, object.align-right {
  clear: right ;
  float: right ;
  margin-left: 1em }

img.align-center, .figure.align-center, object.align-center {
  display: block;
  margin-left: auto;
  margin-right: auto;
}

.align-left {
  text-align: left }

.align-center {
  clear: both ;
  text-align: center }

.align-right {
  text-align: right }

/* reset inner alignment in figures */
div.align-right {
  text-align: inherit }

/* div.align-center * { */
/*   text-align: left } */

ol.simple, ul.simple {
  margin-bottom: 1em }

ol.arabic {
  list-style: decimal }

ol.loweralpha {
  list-style: lower-alpha }

ol.upperalpha {
  list-style: upper-alpha }

ol.lowerroman {
  list-style: lower-roman }

ol.upperroman {
  list-style: upper-roman }

p.attribution {
  text-align: right ;
  margin-left: 50% }

p.caption {
  font-style: italic }

p.credits {
  font-style: italic ;
  font-size: smaller }

p.label {
  white-space: nowrap }

p.rubric {
  font-weight: bold ;
  font-size: larger ;
  color: maroon ;
  text-align: center }

p.sidebar-title {
  font-family: sans-serif ;
  font-weight: bold ;
  font-size: larger }

p.sidebar-subtitle {
  font-family: sans-serif ;
  font-weight: bold }

p.topic-title {
  font-weight: bold }

pre.address {
  margin-bottom: 0 ;
  margin-top: 0 ;
  font: inherit }

pre.literal-block, pre.doctest-block, pre.math, pre.code {
  margin-left: 2em ;
  margin-right: 2em }

pre.code .ln { color: grey; } /* line numbers */
pre.code, code { background-color: #eeeeee }
pre.code .comment, code .comment { color: #5C6576 }
pre.code .keyword, code .keyword { color: #3B0D06; font-weight: bold }
pre.code .literal.string, code .literal.string { color: #0C5404 }
pre.code .name.builtin, code .name.builtin { color: #352B84 }
pre.code .deleted, code .deleted { background-color: #DEB0A1}
pre.code .inserted, code .inserted { background-color: #A3D289}

span.classifier {
  font-family: sans-serif ;
  font-style: oblique }

span.classifier-delimiter {
  font-family: sans-serif ;
  font-weight: bold }

span.interpreted {
  font-family: sans-serif }

span.option {
  white-space: nowrap }

span.pre {
  white-space: pre }

span.problematic {
  color: red }

span.section-subtitle {
  /* font-size relative to parent (h1..h6 element) */
  font-size: 80% }

table.citation {
  border-left: solid 1px gray;
  margin-left: 1px }

table.docinfo {
  margin: 2em 4em }

table.docutils {
  margin-top: 0.5em ;
  margin-bottom: 0.5em }

table.footnote {
  border-left: solid 1px black;
  margin-left: 1px }

table.docutils td, table.docutils th,
table.docinfo td, table.docinfo th {
  padding-left: 0.5em ;
  padding-right: 0.5em ;
  vertical-align: top }

table.docutils th.field-name, table.docinfo th.docinfo-name {
  font-weight: bold ;
  text-align: left ;
  white-space: nowrap ;
  padding-left: 0 }

/* "booktabs" style (no vertical lines) */
table.docutils.booktabs {
  border: 0px;
  border-top: 2px solid;
  border-bottom: 2px solid;
  border-collapse: collapse;
}
table.docutils.booktabs * {
  border: 0px;
}
table.docutils.booktabs th {
  border-bottom: thin solid;
  text-align: left;
}

h1 tt.docutils, h2 tt.docutils, h3 tt.docutils,
h4 tt.docutils, h5 tt.docutils, h6 tt.docutils {
  font-size: 100% }

ul.auto-toc {
  list-style-type: none }

</style>
</head>
<body>
<div class="document">


<p>lib/neutron
functions - functions specific to neutron
Dependencies:
<tt class="docutils literal">functions</tt> file
<tt class="docutils literal">DEST</tt> must be defined
<tt class="docutils literal">STACK_USER</tt> must be defined</p>
</td><td class=code><div class=highlight><pre>


</pre></div></td></tr><tr><td class=docs>
<p><tt class="docutils literal">stack.sh</tt> calls the entry points in this order:</p>
<ul class="simple">
<li>install_neutron</li>
<li>install_neutronclient</li>
<li>install_neutron_agent_packages</li>
<li>install_neutron_third_party</li>
<li>configure_neutron</li>
<li>init_neutron</li>
<li>configure_neutron_third_party</li>
<li>init_neutron_third_party</li>
<li>start_neutron_third_party</li>
<li>create_neutron_cache_dir</li>
<li>create_nova_conf_neutron</li>
<li>start_neutron_service_and_check</li>
<li>create_neutron_initial_network</li>
<li>setup_neutron_debug</li>
<li>start_neutron_agents</li>
</ul>
<p><tt class="docutils literal">unstack.sh</tt> calls the entry points in this order:</p>
<ul class="simple">
<li>stop_neutron</li>
</ul>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Functions in lib/neutron are classified into the following categories:</p>
<ul class="simple">
<li>entry points (called from stack.sh or unstack.sh)</li>
<li>internal functions</li>
<li>neutron exercises</li>
<li>3rd party programs</li>
</ul>
</td><td class=code><div class=highlight><pre>


</pre></div></td></tr><tr><td class=docs>
<div class="section" id="neutron-networking">
<h1>Neutron Networking</h1>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Make sure that neutron is enabled in <tt class="docutils literal">ENABLED_SERVICES</tt>.  If you want
to run Neutron on this host, make sure that q-svc is also in
<tt class="docutils literal">ENABLED_SERVICES</tt>.</p>
<p>If you're planning to use the Neutron openvswitch plugin, set
<tt class="docutils literal">Q_PLUGIN</tt> to &quot;openvswitch&quot; and make sure the q-agt service is enabled
in <tt class="docutils literal">ENABLED_SERVICES</tt>.  If you're planning to use the Neutron
linuxbridge plugin, set <tt class="docutils literal">Q_PLUGIN</tt> to &quot;linuxbridge&quot; and make sure the
q-agt service is enabled in <tt class="docutils literal">ENABLED_SERVICES</tt>.</p>
<p>See &quot;Neutron Network Configuration&quot; below for additional variables
that must be set in localrc for connectivity across hosts with
Neutron.</p>
<p>With Neutron networking the NETWORK_MANAGER variable is ignored.</p>
<p>To enable specific configuration options for either the Open vSwitch or
LinuxBridge plugin, please see the top level README file under the
Neutron section.</p>
</td><td class=code><div class=highlight><pre>


</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="neutron-network-configuration">
<h1>Neutron Network Configuration</h1>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Gateway and subnet defaults, in case they are not customized in localrc</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">NETWORK_GATEWAY</span><span class="o">=</span><span class="k">${</span><span class="nv">NETWORK_GATEWAY</span><span class="k">:-</span><span class="nv">10</span><span class="p">.0.0.1</span><span class="k">}</span>
<span class="nv">PUBLIC_NETWORK_GATEWAY</span><span class="o">=</span><span class="k">${</span><span class="nv">PUBLIC_NETWORK_GATEWAY</span><span class="k">:-</span><span class="nv">172</span><span class="p">.24.4.1</span><span class="k">}</span>
<span class="nv">PRIVATE_SUBNET_NAME</span><span class="o">=</span><span class="k">${</span><span class="nv">PRIVATE_SUBNET_NAME</span><span class="k">:-</span><span class="s2">&quot;private-subnet&quot;</span><span class="k">}</span>
<span class="nv">PUBLIC_SUBNET_NAME</span><span class="o">=</span><span class="k">${</span><span class="nv">PUBLIC_SUBNET_NAME</span><span class="k">:-</span><span class="s2">&quot;public-subnet&quot;</span><span class="k">}</span>

<span class="k">if </span>is_ssl_enabled_service <span class="s2">&quot;neutron&quot;</span> <span class="o">||</span> is_service_enabled tls-proxy; <span class="k">then</span>
<span class="k">    </span><span class="nv">Q_PROTOCOL</span><span class="o">=</span><span class="s2">&quot;https&quot;</span>
<span class="k">fi</span>


</pre></div></td></tr><tr><td class=docs>
<p>Set up default directories</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">NEUTRON_DIR</span><span class="o">=</span><span class="nv">$DEST</span>/neutron
<span class="nv">NEUTRONCLIENT_DIR</span><span class="o">=</span><span class="nv">$DEST</span>/python-neutronclient
<span class="nv">NEUTRON_AUTH_CACHE_DIR</span><span class="o">=</span><span class="k">${</span><span class="nv">NEUTRON_AUTH_CACHE_DIR</span><span class="k">:-</span><span class="p">/var/cache/neutron</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Support entry points installation of console scripts</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if</span> <span class="o">[[</span> -d <span class="nv">$NEUTRON_DIR</span>/bin/neutron-server <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nv">NEUTRON_BIN_DIR</span><span class="o">=</span><span class="nv">$NEUTRON_DIR</span>/bin
<span class="k">else</span>
<span class="k">    </span><span class="nv">NEUTRON_BIN_DIR</span><span class="o">=</span><span class="k">$(</span>get_python_exec_prefix<span class="k">)</span>
<span class="k">fi</span>

<span class="nv">NEUTRON_CONF_DIR</span><span class="o">=</span>/etc/neutron
<span class="nv">NEUTRON_CONF</span><span class="o">=</span><span class="nv">$NEUTRON_CONF_DIR</span>/neutron.conf
<span class="nb">export </span><span class="nv">NEUTRON_TEST_CONFIG_FILE</span><span class="o">=</span><span class="k">${</span><span class="nv">NEUTRON_TEST_CONFIG_FILE</span><span class="k">:-</span><span class="s2">&quot;$NEUTRON_CONF_DIR/debug.ini&quot;</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Agent binaries.  Note, binary paths for other agents are set in per-service
scripts in lib/neutron_plugins/services/</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">AGENT_DHCP_BINARY</span><span class="o">=</span><span class="s2">&quot;$NEUTRON_BIN_DIR/neutron-dhcp-agent&quot;</span>
<span class="nv">AGENT_L3_BINARY</span><span class="o">=</span><span class="k">${</span><span class="nv">AGENT_L3_BINARY</span><span class="k">:-</span><span class="s2">&quot;$NEUTRON_BIN_DIR/neutron-l3-agent&quot;</span><span class="k">}</span>
<span class="nv">AGENT_META_BINARY</span><span class="o">=</span><span class="s2">&quot;$NEUTRON_BIN_DIR/neutron-metadata-agent&quot;</span>

</pre></div></td></tr><tr><td class=docs>
<p>Agent config files. Note, plugin-specific Q_PLUGIN_CONF_FILE is set and
loaded from per-plugin  scripts in lib/neutron_plugins/</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">Q_DHCP_CONF_FILE</span><span class="o">=</span><span class="nv">$NEUTRON_CONF_DIR</span>/dhcp_agent.ini
<span class="nv">Q_L3_CONF_FILE</span><span class="o">=</span><span class="nv">$NEUTRON_CONF_DIR</span>/l3_agent.ini
<span class="nv">Q_FWAAS_CONF_FILE</span><span class="o">=</span><span class="nv">$NEUTRON_CONF_DIR</span>/fwaas_driver.ini
<span class="nv">Q_VPN_CONF_FILE</span><span class="o">=</span><span class="nv">$NEUTRON_CONF_DIR</span>/vpn_agent.ini
<span class="nv">Q_META_CONF_FILE</span><span class="o">=</span><span class="nv">$NEUTRON_CONF_DIR</span>/metadata_agent.ini

</pre></div></td></tr><tr><td class=docs>
<p>Default name for Neutron database</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">Q_DB_NAME</span><span class="o">=</span><span class="k">${</span><span class="nv">Q_DB_NAME</span><span class="k">:-</span><span class="nv">neutron</span><span class="k">}</span>
</pre></div></td></tr><tr><td class=docs>
<p>Default Neutron Plugin</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">Q_PLUGIN</span><span class="o">=</span><span class="k">${</span><span class="nv">Q_PLUGIN</span><span class="k">:-</span><span class="nv">ml2</span><span class="k">}</span>
</pre></div></td></tr><tr><td class=docs>
<p>Default Neutron Port</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">Q_PORT</span><span class="o">=</span><span class="k">${</span><span class="nv">Q_PORT</span><span class="k">:-</span><span class="nv">9696</span><span class="k">}</span>
</pre></div></td></tr><tr><td class=docs>
<p>Default Neutron Internal Port when using TLS proxy</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">Q_PORT_INT</span><span class="o">=</span><span class="k">${</span><span class="nv">Q_PORT_INT</span><span class="k">:-</span><span class="nv">19696</span><span class="k">}</span>
</pre></div></td></tr><tr><td class=docs>
<p>Default Neutron Host</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">Q_HOST</span><span class="o">=</span><span class="k">${</span><span class="nv">Q_HOST</span><span class="k">:-</span><span class="nv">$SERVICE_HOST</span><span class="k">}</span>
</pre></div></td></tr><tr><td class=docs>
<p>Default protocol</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">Q_PROTOCOL</span><span class="o">=</span><span class="k">${</span><span class="nv">Q_PROTOCOL</span><span class="k">:-</span><span class="nv">$SERVICE_PROTOCOL</span><span class="k">}</span>
</pre></div></td></tr><tr><td class=docs>
<p>Default admin username</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">Q_ADMIN_USERNAME</span><span class="o">=</span><span class="k">${</span><span class="nv">Q_ADMIN_USERNAME</span><span class="k">:-</span><span class="nv">neutron</span><span class="k">}</span>
</pre></div></td></tr><tr><td class=docs>
<p>Default auth strategy</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">Q_AUTH_STRATEGY</span><span class="o">=</span><span class="k">${</span><span class="nv">Q_AUTH_STRATEGY</span><span class="k">:-</span><span class="nv">keystone</span><span class="k">}</span>
</pre></div></td></tr><tr><td class=docs>
<p>Use namespace or not</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">Q_USE_NAMESPACE</span><span class="o">=</span><span class="k">${</span><span class="nv">Q_USE_NAMESPACE</span><span class="k">:-</span><span class="nv">True</span><span class="k">}</span>
</pre></div></td></tr><tr><td class=docs>
<p>RHEL's support for namespaces requires using veths with ovs</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">Q_OVS_USE_VETH</span><span class="o">=</span><span class="k">${</span><span class="nv">Q_OVS_USE_VETH</span><span class="k">:-</span><span class="nv">False</span><span class="k">}</span>
<span class="nv">Q_USE_ROOTWRAP</span><span class="o">=</span><span class="k">${</span><span class="nv">Q_USE_ROOTWRAP</span><span class="k">:-</span><span class="nv">True</span><span class="k">}</span>
</pre></div></td></tr><tr><td class=docs>
<p>Meta data IP</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">Q_META_DATA_IP</span><span class="o">=</span><span class="k">${</span><span class="nv">Q_META_DATA_IP</span><span class="k">:-</span><span class="nv">$SERVICE_HOST</span><span class="k">}</span>
</pre></div></td></tr><tr><td class=docs>
<p>Allow Overlapping IP among subnets</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">Q_ALLOW_OVERLAPPING_IP</span><span class="o">=</span><span class="k">${</span><span class="nv">Q_ALLOW_OVERLAPPING_IP</span><span class="k">:-</span><span class="nv">True</span><span class="k">}</span>
</pre></div></td></tr><tr><td class=docs>
<p>Use neutron-debug command</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">Q_USE_DEBUG_COMMAND</span><span class="o">=</span><span class="k">${</span><span class="nv">Q_USE_DEBUG_COMMAND</span><span class="k">:-</span><span class="nv">False</span><span class="k">}</span>
</pre></div></td></tr><tr><td class=docs>
<p>The name of the default q-l3 router</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">Q_ROUTER_NAME</span><span class="o">=</span><span class="k">${</span><span class="nv">Q_ROUTER_NAME</span><span class="k">:-</span><span class="nv">router1</span><span class="k">}</span>
</pre></div></td></tr><tr><td class=docs>
<p>nova vif driver that all plugins should use</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">NOVA_VIF_DRIVER</span><span class="o">=</span><span class="k">${</span><span class="nv">NOVA_VIF_DRIVER</span><span class="k">:-</span><span class="s2">&quot;nova.virt.libvirt.vif.LibvirtGenericVIFDriver&quot;</span><span class="k">}</span>
<span class="nv">Q_NOTIFY_NOVA_PORT_STATUS_CHANGES</span><span class="o">=</span><span class="k">${</span><span class="nv">Q_NOTIFY_NOVA_PORT_STATUS_CHANGES</span><span class="k">:-</span><span class="nv">True</span><span class="k">}</span>
<span class="nv">Q_NOTIFY_NOVA_PORT_DATA_CHANGES</span><span class="o">=</span><span class="k">${</span><span class="nv">Q_NOTIFY_NOVA_PORT_DATA_CHANGES</span><span class="k">:-</span><span class="nv">True</span><span class="k">}</span>
<span class="nv">VIF_PLUGGING_IS_FATAL</span><span class="o">=</span><span class="k">${</span><span class="nv">VIF_PLUGGING_IS_FATAL</span><span class="k">:-</span><span class="nv">True</span><span class="k">}</span>
<span class="nv">VIF_PLUGGING_TIMEOUT</span><span class="o">=</span><span class="k">${</span><span class="nv">VIF_PLUGGING_TIMEOUT</span><span class="k">:-</span><span class="nv">300</span><span class="k">}</span>

<span class="c">## Provider Network Information</span>
<span class="nv">PROVIDER_SUBNET_NAME</span><span class="o">=</span><span class="k">${</span><span class="nv">PROVIDER_SUBNET_NAME</span><span class="k">:-</span><span class="s2">&quot;provider_net&quot;</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Use flat providernet for public network</p>
<p>If Q_USE_PROVIDERNET_FOR_PUBLIC=True, use a flat provider network
for external interface of neutron l3-agent.  In that case,
PUBLIC_PHYSICAL_NETWORK specifies provider:physical_network value
used for the network.  In case of openvswitch agent, you should
add the corresponding entry to your OVS_BRIDGE_MAPPINGS.</p>
<dl class="docutils">
<dt>eg.</dt>
<dd>Q_USE_PROVIDERNET_FOR_PUBLIC=True
PUBLIC_PHYSICAL_NETWORK=public
OVS_BRIDGE_MAPPINGS=public:br-ex</dd>
</dl>
</td><td class=code><div class=highlight><pre>
<span class="nv">Q_USE_PROVIDERNET_FOR_PUBLIC</span><span class="o">=</span><span class="k">${</span><span class="nv">Q_USE_PROVIDERNET_FOR_PUBLIC</span><span class="k">:-</span><span class="nv">False</span><span class="k">}</span>
<span class="nv">PUBLIC_PHYSICAL_NETWORK</span><span class="o">=</span><span class="k">${</span><span class="nv">PUBLIC_PHYSICAL_NETWORK</span><span class="k">:-</span><span class="nv">public</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>The next two variables are configured by plugin
e.g.  _configure_neutron_l3_agent or lib/neutron_plugins/*</p>
<p>The plugin supports L3.</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">Q_L3_ENABLED</span><span class="o">=</span><span class="k">${</span><span class="nv">Q_L3_ENABLED</span><span class="k">:-</span><span class="nv">False</span><span class="k">}</span>
</pre></div></td></tr><tr><td class=docs>
<p>L3 routers exist per tenant</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">Q_L3_ROUTER_PER_TENANT</span><span class="o">=</span><span class="k">${</span><span class="nv">Q_L3_ROUTER_PER_TENANT</span><span class="k">:-</span><span class="nv">False</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>List of config file names in addition to the main plugin config file
See _configure_neutron_common() for details about setting it up</p>
</td><td class=code><div class=highlight><pre>
<span class="nb">declare</span> -a Q_PLUGIN_EXTRA_CONF_FILES

</pre></div></td></tr><tr><td class=docs>
<p>List of (optional) config files for VPN device drivers to use with
the neutron-q-vpn agent</p>
</td><td class=code><div class=highlight><pre>
<span class="nb">declare</span> -a Q_VPN_EXTRA_CONF_FILES


<span class="nv">Q_RR_CONF_FILE</span><span class="o">=</span><span class="nv">$NEUTRON_CONF_DIR</span>/rootwrap.conf
<span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$Q_USE_ROOTWRAP&quot;</span> <span class="o">==</span> <span class="s2">&quot;False&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nv">Q_RR_COMMAND</span><span class="o">=</span><span class="s2">&quot;sudo&quot;</span>
<span class="k">else</span>
<span class="k">    </span><span class="nv">NEUTRON_ROOTWRAP</span><span class="o">=</span><span class="k">$(</span>get_rootwrap_location neutron<span class="k">)</span>
    <span class="nv">Q_RR_COMMAND</span><span class="o">=</span><span class="s2">&quot;sudo $NEUTRON_ROOTWRAP $Q_RR_CONF_FILE&quot;</span>
<span class="k">fi</span>


</pre></div></td></tr><tr><td class=docs>
<p>Distributed Virtual Router (DVR) configuration
Can be:</p>
<div class="system-message">
<p class="system-message-title">System Message: ERROR/3 (<tt class="docutils">&lt;stdin&gt;</tt>, line 195)</p>
Unexpected indentation.</div>
<blockquote>
legacy   - No DVR functionality
dvr_snat - Controller or single node DVR
dvr      - Compute node in multi-node DVR</blockquote>
</td><td class=code><div class=highlight><pre>
<span class="nv">Q_DVR_MODE</span><span class="o">=</span><span class="k">${</span><span class="nv">Q_DVR_MODE</span><span class="k">:-</span><span class="nv">legacy</span><span class="k">}</span>
<span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$Q_DVR_MODE&quot;</span> !<span class="o">=</span> <span class="s2">&quot;legacy&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nv">Q_ML2_PLUGIN_MECHANISM_DRIVERS</span><span class="o">=</span>openvswitch,linuxbridge,l2population
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="provider-network-configurations">
<h1>Provider Network Configurations</h1>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>The following variables control the Neutron openvswitch and
linuxbridge plugins' allocation of tenant networks and
availability of provider networks. If these are not configured
in <tt class="docutils literal">localrc</tt>, tenant networks will be local to the host (with no
remote connectivity), and no physical resources will be
available for the allocation of provider networks.</p>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>To disable tunnels (GRE or VXLAN) for tenant networks,
set to False in <tt class="docutils literal">local.conf</tt>.
GRE tunnels are only supported by the openvswitch.</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">ENABLE_TENANT_TUNNELS</span><span class="o">=</span><span class="k">${</span><span class="nv">ENABLE_TENANT_TUNNELS</span><span class="k">:-</span><span class="nv">True</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>If using GRE tunnels for tenant networks, specify the range of
tunnel IDs from which tenant networks are allocated. Can be
overriden in <tt class="docutils literal">localrc</tt> in necesssary.</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">TENANT_TUNNEL_RANGES</span><span class="o">=</span><span class="k">${</span><span class="nv">TENANT_TUNNEL_RANGES</span><span class="k">:-</span><span class="nv">1</span><span class="p">:</span><span class="nv">1000</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>To use VLANs for tenant networks, set to True in localrc. VLANs
are supported by the openvswitch and linuxbridge plugins, each
requiring additional configuration described below.</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">ENABLE_TENANT_VLANS</span><span class="o">=</span><span class="k">${</span><span class="nv">ENABLE_TENANT_VLANS</span><span class="k">:-</span><span class="nv">False</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>If using VLANs for tenant networks, set in <tt class="docutils literal">localrc</tt> to specify
the range of VLAN VIDs from which tenant networks are
allocated. An external network switch must be configured to
trunk these VLANs between hosts for multi-host connectivity.</p>
<p>Example: <tt class="docutils literal">TENANT_VLAN_RANGE=1000:1999</tt></p>
</td><td class=code><div class=highlight><pre>
<span class="nv">TENANT_VLAN_RANGE</span><span class="o">=</span><span class="k">${</span><span class="nv">TENANT_VLAN_RANGE</span><span class="k">:-}</span>

</pre></div></td></tr><tr><td class=docs>
<p>If using VLANs for tenant networks, or if using flat or VLAN
provider networks, set in <tt class="docutils literal">localrc</tt> to the name of the physical
network, and also configure <tt class="docutils literal">OVS_PHYSICAL_BRIDGE</tt> for the
openvswitch agent or <tt class="docutils literal">LB_PHYSICAL_INTERFACE</tt> for the linuxbridge
agent, as described below.</p>
<p>Example: <tt class="docutils literal">PHYSICAL_NETWORK=default</tt></p>
</td><td class=code><div class=highlight><pre>
<span class="nv">PHYSICAL_NETWORK</span><span class="o">=</span><span class="k">${</span><span class="nv">PHYSICAL_NETWORK</span><span class="k">:-}</span>

</pre></div></td></tr><tr><td class=docs>
<p>With the openvswitch plugin, if using VLANs for tenant networks,
or if using flat or VLAN provider networks, set in <tt class="docutils literal">localrc</tt> to
the name of the OVS bridge to use for the physical network. The
bridge will be created if it does not already exist, but a
physical interface must be manually added to the bridge as a
port for external connectivity.</p>
<p>Example: <tt class="docutils literal"><span class="pre">OVS_PHYSICAL_BRIDGE=br-eth1</span></tt></p>
</td><td class=code><div class=highlight><pre>
<span class="nv">OVS_PHYSICAL_BRIDGE</span><span class="o">=</span><span class="k">${</span><span class="nv">OVS_PHYSICAL_BRIDGE</span><span class="k">:-}</span>

</pre></div></td></tr><tr><td class=docs>
<p>With the linuxbridge plugin, if using VLANs for tenant networks,
or if using flat or VLAN provider networks, set in <tt class="docutils literal">localrc</tt> to
the name of the network interface to use for the physical
network.</p>
<p>Example: <tt class="docutils literal">LB_PHYSICAL_INTERFACE=eth1</tt></p>
</td><td class=code><div class=highlight><pre>
<span class="nv">LB_PHYSICAL_INTERFACE</span><span class="o">=</span><span class="k">${</span><span class="nv">LB_PHYSICAL_INTERFACE</span><span class="k">:-}</span>

</pre></div></td></tr><tr><td class=docs>
<p>When Neutron tunnels are enabled it is needed to specify the
IP address of the end point in the local server. This IP is set
by default to the same IP address that the HOST IP.
This variable can be used to specify a different end point IP address
Example: <tt class="docutils literal">TUNNEL_ENDPOINT_IP=1.1.1.1</tt></p>
</td><td class=code><div class=highlight><pre>
<span class="nv">TUNNEL_ENDPOINT_IP</span><span class="o">=</span><span class="k">${</span><span class="nv">TUNNEL_ENDPOINT_IP</span><span class="k">:-</span><span class="nv">$HOST_IP</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>With the openvswitch plugin, set to True in <tt class="docutils literal">localrc</tt> to enable
provider GRE tunnels when <tt class="docutils literal">ENABLE_TENANT_TUNNELS</tt> is False.</p>
<p>Example: <tt class="docutils literal">OVS_ENABLE_TUNNELING=True</tt></p>
</td><td class=code><div class=highlight><pre>
<span class="nv">OVS_ENABLE_TUNNELING</span><span class="o">=</span><span class="k">${</span><span class="nv">OVS_ENABLE_TUNNELING</span><span class="k">:-</span><span class="nv">$ENABLE_TENANT_TUNNELS</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="neutron-plugin-specific-functions">
<h1>Neutron plugin specific functions</h1>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Please refer to <tt class="docutils literal">lib/neutron_plugins/README.md</tt> for details.</p>
</td><td class=code><div class=highlight><pre>
<span class="nb">source</span> <span class="nv">$TOP_DIR</span>/lib/neutron_plugins/<span class="nv">$Q_PLUGIN</span>

</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="agent-loadbalancer-service-plugin-functions">
<h1>Agent loadbalancer service plugin functions</h1>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Hardcoding for 1 service plugin for now</p>
</td><td class=code><div class=highlight><pre>
<span class="nb">source</span> <span class="nv">$TOP_DIR</span>/lib/neutron_plugins/services/loadbalancer

</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="agent-metering-service-plugin-functions">
<h1>Agent metering service plugin functions</h1>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Hardcoding for 1 service plugin for now</p>
</td><td class=code><div class=highlight><pre>
<span class="nb">source</span> <span class="nv">$TOP_DIR</span>/lib/neutron_plugins/services/metering

</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="vpn-service-plugin-functions">
<h1>VPN service plugin functions</h1>
<p>Hardcoding for 1 service plugin for now</p>
</td><td class=code><div class=highlight><pre>
<span class="nb">source</span> <span class="nv">$TOP_DIR</span>/lib/neutron_plugins/services/vpn

</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="firewall-service-plugin-functions">
<h1>Firewall Service Plugin functions</h1>
</td><td class=code><div class=highlight><pre>
<span class="nb">source</span> <span class="nv">$TOP_DIR</span>/lib/neutron_plugins/services/firewall

</pre></div></td></tr><tr><td class=docs>
<p>Use security group or not</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if </span>has_neutron_plugin_security_group; <span class="k">then</span>
<span class="k">    </span><span class="nv">Q_USE_SECGROUP</span><span class="o">=</span><span class="k">${</span><span class="nv">Q_USE_SECGROUP</span><span class="k">:-</span><span class="nv">True</span><span class="k">}</span>
<span class="k">else</span>
<span class="k">    </span><span class="nv">Q_USE_SECGROUP</span><span class="o">=</span>False
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Tell Tempest this project is present</p>
</td><td class=code><div class=highlight><pre>
TEMPEST_SERVICES+<span class="o">=</span>,neutron


</pre></div></td></tr><tr><td class=docs>
<p>Save trace setting</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">XTRACE</span><span class="o">=</span><span class="k">$(</span><span class="nb">set</span> +o | grep xtrace<span class="k">)</span>
<span class="nb">set</span> +o xtrace


</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="functions">
<h1>Functions</h1>
</td><td class=code><div class=highlight><pre>

<span class="k">function </span>_determine_config_server <span class="o">{</span>
    <span class="nb">local </span>cfg_file
    <span class="nb">local </span><span class="nv">opts</span><span class="o">=</span><span class="s2">&quot;--config-file $NEUTRON_CONF --config-file /$Q_PLUGIN_CONF_FILE&quot;</span>
    <span class="k">for </span>cfg_file in <span class="k">${</span><span class="nv">Q_PLUGIN_EXTRA_CONF_FILES</span><span class="p">[@]</span><span class="k">}</span>; <span class="k">do</span>
<span class="k">        </span>opts+<span class="o">=</span><span class="s2">&quot; --config-file /$cfg_file&quot;</span>
    <span class="k">done</span>
<span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;$opts&quot;</span>
<span class="o">}</span>

<span class="k">function </span>_determine_config_vpn <span class="o">{</span>
    <span class="nb">local </span>cfg_file
    <span class="nb">local </span><span class="nv">opts</span><span class="o">=</span><span class="s2">&quot;--config-file $NEUTRON_CONF --config-file=$Q_L3_CONF_FILE --config-file=$Q_VPN_CONF_FILE&quot;</span>
    <span class="k">if </span>is_service_enabled q-fwaas; <span class="k">then</span>
<span class="k">        </span>opts+<span class="o">=</span><span class="s2">&quot; --config-file $Q_FWAAS_CONF_FILE&quot;</span>
    <span class="k">fi</span>
<span class="k">    for </span>cfg_file in <span class="k">${</span><span class="nv">Q_VPN_EXTRA_CONF_FILES</span><span class="p">[@]</span><span class="k">}</span>; <span class="k">do</span>
<span class="k">        </span>opts+<span class="o">=</span><span class="s2">&quot; --config-file $cfg_file&quot;</span>
    <span class="k">done</span>
<span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;$opts&quot;</span>

<span class="o">}</span>

<span class="k">function </span>_determine_config_l3 <span class="o">{</span>
    <span class="nb">local </span><span class="nv">opts</span><span class="o">=</span><span class="s2">&quot;--config-file $NEUTRON_CONF --config-file=$Q_L3_CONF_FILE&quot;</span>
    <span class="k">if </span>is_service_enabled q-fwaas; <span class="k">then</span>
<span class="k">        </span>opts+<span class="o">=</span><span class="s2">&quot; --config-file $Q_FWAAS_CONF_FILE&quot;</span>
    <span class="k">fi</span>
<span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;$opts&quot;</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>For services and agents that require it, dynamically construct a list of
--config-file arguments that are passed to the binary.</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>determine_config_files <span class="o">{</span>
    <span class="nb">local </span><span class="nv">opts</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
    <span class="k">case</span> <span class="s2">&quot;$1&quot;</span> in
        <span class="s2">&quot;neutron-server&quot;</span><span class="o">)</span> <span class="nv">opts</span><span class="o">=</span><span class="s2">&quot;$(_determine_config_server)&quot;</span> ;;
        <span class="s2">&quot;neutron-vpn-agent&quot;</span><span class="o">)</span> <span class="nv">opts</span><span class="o">=</span><span class="s2">&quot;$(_determine_config_vpn)&quot;</span> ;;
        <span class="s2">&quot;neutron-l3-agent&quot;</span><span class="o">)</span> <span class="nv">opts</span><span class="o">=</span><span class="s2">&quot;$(_determine_config_l3)&quot;</span> ;;
    <span class="k">esac</span>
<span class="k">    if</span> <span class="o">[</span> -z <span class="s2">&quot;$opts&quot;</span> <span class="o">]</span> ; <span class="k">then</span>
<span class="k">        </span>die <span class="nv">$LINENO</span> <span class="s2">&quot;Could not determine config files for $1.&quot;</span>
    <span class="k">fi</span>
<span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;$opts&quot;</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Test if any Neutron services are enabled
is_neutron_enabled</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>is_neutron_enabled <span class="o">{</span>
    <span class="o">[[</span> ,<span class="k">${</span><span class="nv">ENABLED_SERVICES</span><span class="k">}</span> <span class="o">=</span>~ ,<span class="s2">&quot;q-&quot;</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="k">return </span>0
    <span class="k">return </span>1
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>configure_neutron()
Set common config for all neutron server and agents.</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>configure_neutron <span class="o">{</span>
    _configure_neutron_common
    iniset_rpc_backend neutron <span class="nv">$NEUTRON_CONF</span> DEFAULT

</pre></div></td></tr><tr><td class=docs>
<p>goes before q-svc to init Q_SERVICE_PLUGIN_CLASSES</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">if </span>is_service_enabled q-lbaas; <span class="k">then</span>
<span class="k">        </span>_configure_neutron_lbaas
    <span class="k">fi</span>
<span class="k">    if </span>is_service_enabled q-metering; <span class="k">then</span>
<span class="k">        </span>_configure_neutron_metering
    <span class="k">fi</span>
<span class="k">    if </span>is_service_enabled q-vpn; <span class="k">then</span>
<span class="k">        </span>_configure_neutron_vpn
    <span class="k">fi</span>
<span class="k">    if </span>is_service_enabled q-fwaas; <span class="k">then</span>
<span class="k">        </span>_configure_neutron_fwaas
    <span class="k">fi</span>
<span class="k">    if </span>is_service_enabled q-agt q-svc; <span class="k">then</span>
<span class="k">        </span>_configure_neutron_service
    <span class="k">fi</span>
<span class="k">    if </span>is_service_enabled q-agt; <span class="k">then</span>
<span class="k">        </span>_configure_neutron_plugin_agent
    <span class="k">fi</span>
<span class="k">    if </span>is_service_enabled q-dhcp; <span class="k">then</span>
<span class="k">        </span>_configure_neutron_dhcp_agent
    <span class="k">fi</span>
<span class="k">    if </span>is_service_enabled q-l3; <span class="k">then</span>
<span class="k">        </span>_configure_neutron_l3_agent
    <span class="k">fi</span>
<span class="k">    if </span>is_service_enabled q-meta; <span class="k">then</span>
<span class="k">        </span>_configure_neutron_metadata_agent
    <span class="k">fi</span>

<span class="k">    if</span> <span class="o">[[</span> <span class="s2">&quot;$Q_DVR_MODE&quot;</span> !<span class="o">=</span> <span class="s2">&quot;legacy&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span>_configure_dvr
    <span class="k">fi</span>
<span class="k">    if </span>is_service_enabled ceilometer; <span class="k">then</span>
<span class="k">        </span>_configure_neutron_ceilometer_notifications
    <span class="k">fi</span>

<span class="k">    </span>_configure_neutron_debug_command
<span class="o">}</span>

<span class="k">function </span>create_nova_conf_neutron <span class="o">{</span>
    iniset <span class="nv">$NOVA_CONF</span> DEFAULT network_api_class <span class="s2">&quot;nova.network.neutronv2.api.API&quot;</span>
    iniset <span class="nv">$NOVA_CONF</span> neutron admin_username <span class="s2">&quot;$Q_ADMIN_USERNAME&quot;</span>
    iniset <span class="nv">$NOVA_CONF</span> neutron admin_password <span class="s2">&quot;$SERVICE_PASSWORD&quot;</span>
    iniset <span class="nv">$NOVA_CONF</span> neutron admin_auth_url <span class="s2">&quot;$KEYSTONE_SERVICE_PROTOCOL://$KEYSTONE_SERVICE_HOST:$KEYSTONE_AUTH_PORT/v2.0&quot;</span>
    iniset <span class="nv">$NOVA_CONF</span> neutron auth_strategy <span class="s2">&quot;$Q_AUTH_STRATEGY&quot;</span>
    iniset <span class="nv">$NOVA_CONF</span> neutron admin_tenant_name <span class="s2">&quot;$SERVICE_TENANT_NAME&quot;</span>
    iniset <span class="nv">$NOVA_CONF</span> neutron region_name <span class="s2">&quot;$REGION_NAME&quot;</span>
    iniset <span class="nv">$NOVA_CONF</span> neutron url <span class="s2">&quot;${Q_PROTOCOL}://$Q_HOST:$Q_PORT&quot;</span>

    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$Q_USE_SECGROUP&quot;</span> <span class="o">==</span> <span class="s2">&quot;True&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nv">LIBVIRT_FIREWALL_DRIVER</span><span class="o">=</span>nova.virt.firewall.NoopFirewallDriver
        iniset <span class="nv">$NOVA_CONF</span> DEFAULT firewall_driver <span class="nv">$LIBVIRT_FIREWALL_DRIVER</span>
        iniset <span class="nv">$NOVA_CONF</span> DEFAULT security_group_api neutron
    <span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>set NOVA_VIF_DRIVER and optionally set options in nova_conf</p>
</td><td class=code><div class=highlight><pre>
    neutron_plugin_create_nova_conf

    iniset <span class="nv">$NOVA_CONF</span> libvirt vif_driver <span class="s2">&quot;$NOVA_VIF_DRIVER&quot;</span>
    iniset <span class="nv">$NOVA_CONF</span> DEFAULT linuxnet_interface_driver <span class="s2">&quot;$LINUXNET_VIF_DRIVER&quot;</span>
    <span class="k">if </span>is_service_enabled q-meta; <span class="k">then</span>
<span class="k">        </span>iniset <span class="nv">$NOVA_CONF</span> neutron service_metadata_proxy <span class="s2">&quot;True&quot;</span>
    <span class="k">fi</span>

<span class="k">    </span>iniset <span class="nv">$NOVA_CONF</span> DEFAULT vif_plugging_is_fatal <span class="s2">&quot;$VIF_PLUGGING_IS_FATAL&quot;</span>
    iniset <span class="nv">$NOVA_CONF</span> DEFAULT vif_plugging_timeout <span class="s2">&quot;$VIF_PLUGGING_TIMEOUT&quot;</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>create_neutron_cache_dir() - Part of the _neutron_setup_keystone() process</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>create_neutron_cache_dir <span class="o">{</span>
</pre></div></td></tr><tr><td class=docs>
<p>Create cache dir</p>
</td><td class=code><div class=highlight><pre>
    sudo mkdir -p <span class="nv">$NEUTRON_AUTH_CACHE_DIR</span>
    sudo chown <span class="nv">$STACK_USER</span> <span class="nv">$NEUTRON_AUTH_CACHE_DIR</span>
    rm -f <span class="nv">$NEUTRON_AUTH_CACHE_DIR</span>/*
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>create_neutron_accounts() - Set up common required neutron accounts</p>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="tenant-user-roles">
<h1>Tenant               User       Roles</h1>
<p>service              neutron    admin        # if enabled</p>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Migrated from keystone_data.sh</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>create_neutron_accounts <span class="o">{</span>

    <span class="nb">local </span><span class="nv">service_tenant</span><span class="o">=</span><span class="k">$(</span>openstack project list | awk <span class="s2">&quot;/ $SERVICE_TENANT_NAME / { print \$2 }&quot;</span><span class="k">)</span>
    <span class="nb">local </span><span class="nv">service_role</span><span class="o">=</span><span class="k">$(</span>openstack role list | awk <span class="s2">&quot;/ service / { print \$2 }&quot;</span><span class="k">)</span>

    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$ENABLED_SERVICES&quot;</span> <span class="o">=</span>~ <span class="s2">&quot;q-svc&quot;</span> <span class="o">]]</span>; <span class="k">then</span>

<span class="k">        </span><span class="nb">local </span><span class="nv">neutron_user</span><span class="o">=</span><span class="k">$(</span>get_or_create_user <span class="s2">&quot;neutron&quot;</span> <span class="se">\</span>
            <span class="s2">&quot;$SERVICE_PASSWORD&quot;</span> <span class="nv">$service_tenant</span><span class="k">)</span>
        get_or_add_user_role <span class="nv">$service_role</span> <span class="nv">$neutron_user</span> <span class="nv">$service_tenant</span>

        <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$KEYSTONE_CATALOG_BACKEND&quot;</span> <span class="o">=</span> <span class="s1">&#39;sql&#39;</span> <span class="o">]]</span>; <span class="k">then</span>

<span class="k">            </span><span class="nb">local </span><span class="nv">neutron_service</span><span class="o">=</span><span class="k">$(</span>get_or_create_service <span class="s2">&quot;neutron&quot;</span> <span class="se">\</span>
                <span class="s2">&quot;network&quot;</span> <span class="s2">&quot;Neutron Service&quot;</span><span class="k">)</span>
            get_or_create_endpoint <span class="nv">$neutron_service</span> <span class="se">\</span>
                <span class="s2">&quot;$REGION_NAME&quot;</span> <span class="se">\</span>
                <span class="s2">&quot;$Q_PROTOCOL://$SERVICE_HOST:$Q_PORT/&quot;</span> <span class="se">\</span>
                <span class="s2">&quot;$Q_PROTOCOL://$SERVICE_HOST:$Q_PORT/&quot;</span> <span class="se">\</span>
                <span class="s2">&quot;$Q_PROTOCOL://$SERVICE_HOST:$Q_PORT/&quot;</span>
        <span class="k">fi</span>
<span class="k">    fi</span>
<span class="o">}</span>

<span class="k">function </span>create_neutron_initial_network <span class="o">{</span>
    <span class="nv">TENANT_ID</span><span class="o">=</span><span class="k">$(</span>openstack project list | grep <span class="s2">&quot; demo &quot;</span> | get_field 1<span class="k">)</span>
    die_if_not_set <span class="nv">$LINENO</span> TENANT_ID <span class="s2">&quot;Failure retrieving TENANT_ID for demo&quot;</span>

</pre></div></td></tr><tr><td class=docs>
<p>Create a small network
Since neutron command is executed in admin context at this point,
<tt class="docutils literal"><span class="pre">--tenant-id</span></tt> needs to be specified.</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">if </span>is_baremetal; <span class="k">then</span>
<span class="k">        if</span> <span class="o">[[</span> <span class="s2">&quot;$PUBLIC_INTERFACE&quot;</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="o">||</span> <span class="s2">&quot;$OVS_PHYSICAL_BRIDGE&quot;</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            </span>die <span class="nv">$LINENO</span> <span class="s2">&quot;Neutron settings for baremetal not set.. exiting&quot;</span>
        <span class="k">fi</span>
<span class="k">        </span>sudo ovs-vsctl add-port <span class="nv">$OVS_PHYSICAL_BRIDGE</span> <span class="nv">$PUBLIC_INTERFACE</span>
        <span class="k">for </span>IP in <span class="k">$(</span>ip addr show dev <span class="nv">$PUBLIC_INTERFACE</span> | grep <span class="s1">&#39; inet &#39;</span> | awk <span class="s1">&#39;{print $2}&#39;</span><span class="k">)</span>; <span class="k">do</span>
<span class="k">            </span>sudo ip addr del <span class="nv">$IP</span> dev <span class="nv">$PUBLIC_INTERFACE</span>
            sudo ip addr add <span class="nv">$IP</span> dev <span class="nv">$OVS_PHYSICAL_BRIDGE</span>
        <span class="k">done</span>
<span class="k">        </span><span class="nv">NET_ID</span><span class="o">=</span><span class="k">$(</span>neutron net-create <span class="nv">$PHYSICAL_NETWORK</span> --tenant-id <span class="nv">$TENANT_ID</span> --provider:network_type flat --provider:physical_network <span class="s2">&quot;$PHYSICAL_NETWORK&quot;</span> | grep <span class="s1">&#39; id &#39;</span> | get_field 2<span class="k">)</span>
        die_if_not_set <span class="nv">$LINENO</span> NET_ID <span class="s2">&quot;Failure creating NET_ID for $PHYSICAL_NETWORK $TENANT_ID&quot;</span>
        <span class="nv">SUBNET_ID</span><span class="o">=</span><span class="k">$(</span>neutron subnet-create --tenant-id <span class="nv">$TENANT_ID</span> --ip_version 4 <span class="k">${</span><span class="nv">ALLOCATION_POOL</span><span class="p">:+--allocation-pool </span><span class="nv">$ALLOCATION_POOL</span><span class="k">}</span> --gateway <span class="nv">$NETWORK_GATEWAY</span> --name <span class="nv">$PRIVATE_SUBNET_NAME</span> <span class="nv">$NET_ID</span> <span class="nv">$FIXED_RANGE</span> | grep <span class="s1">&#39; id &#39;</span> | get_field 2<span class="k">)</span>
        die_if_not_set <span class="nv">$LINENO</span> SUBNET_ID <span class="s2">&quot;Failure creating SUBNET_ID for $TENANT_ID&quot;</span>
        sudo ifconfig <span class="nv">$OVS_PHYSICAL_BRIDGE</span> up
        sudo route add default gw <span class="nv">$NETWORK_GATEWAY</span> dev <span class="nv">$OVS_PHYSICAL_BRIDGE</span>
    <span class="k">elif </span>is_provider_network; <span class="k">then</span>
<span class="k">        </span>die_if_not_set <span class="nv">$LINENO</span> PHYSICAL_NETWORK <span class="s2">&quot;You must specify the PHYSICAL_NETWORK&quot;</span>
        die_if_not_set <span class="nv">$LINENO</span> PROVIDER_NETWORK_TYPE <span class="s2">&quot;You must specifiy the PROVIDER_NETWORK_TYPE&quot;</span>
        <span class="nv">NET_ID</span><span class="o">=</span><span class="k">$(</span>neutron net-create <span class="nv">$PHYSICAL_NETWORK</span> --tenant_id <span class="nv">$TENANT_ID</span> --provider:network_type <span class="nv">$PROVIDER_NETWORK_TYPE</span> --provider:physical_network <span class="s2">&quot;$PHYSICAL_NETWORK&quot;</span> <span class="k">${</span><span class="nv">SEGMENTATION_ID</span><span class="p">:+--provider:</span><span class="nv">segmentation_id</span><span class="p"> </span><span class="nv">$SEGMENTATION_ID</span><span class="k">}</span> --shared | grep <span class="s1">&#39; id &#39;</span> | get_field 2<span class="k">)</span>
        <span class="nv">SUBNET_ID</span><span class="o">=</span><span class="k">$(</span>neutron subnet-create --tenant_id <span class="nv">$TENANT_ID</span> --ip_version 4 <span class="k">${</span><span class="nv">ALLOCATION_POOL</span><span class="p">:+--allocation-pool </span><span class="nv">$ALLOCATION_POOL</span><span class="k">}</span> --name <span class="nv">$PROVIDER_SUBNET_NAME</span> <span class="nv">$NET_ID</span> <span class="nv">$FIXED_RANGE</span> | grep <span class="s1">&#39; id &#39;</span> | get_field 2<span class="k">)</span>
        <span class="nv">SUBNET_V6_ID</span><span class="o">=</span><span class="k">$(</span>neutron subnet-create --tenant_id <span class="nv">$TENANT_ID</span> --ip_version 6 --ipv6-address-mode slaac --gateway <span class="nv">$V6_NETWORK_GATEWAY</span> --name <span class="nv">$PROVIDER_SUBNET_NAME_V6</span> <span class="nv">$NET_ID</span> <span class="nv">$FIXED_RANGE_V6</span> | grep <span class="s1">&#39;id&#39;</span> | get_field 2<span class="k">)</span>
        sudo ip link <span class="nb">set</span> <span class="nv">$OVS_PHYSICAL_BRIDGE</span> up
        sudo ip link <span class="nb">set </span>br-int up
        sudo ip link <span class="nb">set</span> <span class="nv">$PUBLIC_INTERFACE</span> up
    <span class="k">else</span>
<span class="k">        </span><span class="nv">NET_ID</span><span class="o">=</span><span class="k">$(</span>neutron net-create --tenant-id <span class="nv">$TENANT_ID</span> <span class="s2">&quot;$PRIVATE_NETWORK_NAME&quot;</span> | grep <span class="s1">&#39; id &#39;</span> | get_field 2<span class="k">)</span>
        die_if_not_set <span class="nv">$LINENO</span> NET_ID <span class="s2">&quot;Failure creating NET_ID for $PHYSICAL_NETWORK $TENANT_ID&quot;</span>
        <span class="nv">SUBNET_ID</span><span class="o">=</span><span class="k">$(</span>neutron subnet-create --tenant-id <span class="nv">$TENANT_ID</span> --ip_version 4 --gateway <span class="nv">$NETWORK_GATEWAY</span> --name <span class="nv">$PRIVATE_SUBNET_NAME</span> <span class="nv">$NET_ID</span> <span class="nv">$FIXED_RANGE</span> | grep <span class="s1">&#39; id &#39;</span> | get_field 2<span class="k">)</span>
        die_if_not_set <span class="nv">$LINENO</span> SUBNET_ID <span class="s2">&quot;Failure creating SUBNET_ID for $TENANT_ID&quot;</span>
    <span class="k">fi</span>

<span class="k">    if</span> <span class="o">[[</span> <span class="s2">&quot;$Q_L3_ENABLED&quot;</span> <span class="o">==</span> <span class="s2">&quot;True&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>Create a router, and add the private subnet as one of its interfaces</p>
</td><td class=code><div class=highlight><pre>
        <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$Q_L3_ROUTER_PER_TENANT&quot;</span> <span class="o">==</span> <span class="s2">&quot;True&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>create a tenant-owned router.</p>
</td><td class=code><div class=highlight><pre>
            <span class="nv">ROUTER_ID</span><span class="o">=</span><span class="k">$(</span>neutron router-create --tenant-id <span class="nv">$TENANT_ID</span> <span class="nv">$Q_ROUTER_NAME</span> | grep <span class="s1">&#39; id &#39;</span> | get_field 2<span class="k">)</span>
            die_if_not_set <span class="nv">$LINENO</span> ROUTER_ID <span class="s2">&quot;Failure creating ROUTER_ID for $TENANT_ID $Q_ROUTER_NAME&quot;</span>
        <span class="k">else</span>
</pre></div></td></tr><tr><td class=docs>
<p>Plugin only supports creating a single router, which should be admin owned.</p>
</td><td class=code><div class=highlight><pre>
            <span class="nv">ROUTER_ID</span><span class="o">=</span><span class="k">$(</span>neutron router-create <span class="nv">$Q_ROUTER_NAME</span> | grep <span class="s1">&#39; id &#39;</span> | get_field 2<span class="k">)</span>
            die_if_not_set <span class="nv">$LINENO</span> ROUTER_ID <span class="s2">&quot;Failure creating ROUTER_ID for $Q_ROUTER_NAME&quot;</span>
        <span class="k">fi</span>
<span class="k">        </span>neutron router-interface-add <span class="nv">$ROUTER_ID</span> <span class="nv">$SUBNET_ID</span>
</pre></div></td></tr><tr><td class=docs>
<p>Create an external network, and a subnet. Configure the external network as router gw</p>
</td><td class=code><div class=highlight><pre>
        <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$Q_USE_PROVIDERNET_FOR_PUBLIC&quot;</span> <span class="o">=</span> <span class="s2">&quot;True&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">            </span><span class="nv">EXT_NET_ID</span><span class="o">=</span><span class="k">$(</span>neutron net-create <span class="s2">&quot;$PUBLIC_NETWORK_NAME&quot;</span> -- --router:external<span class="o">=</span>True --provider:network_type<span class="o">=</span>flat --provider:physical_network<span class="o">=</span><span class="k">${</span><span class="nv">PUBLIC_PHYSICAL_NETWORK</span><span class="k">}</span> | grep <span class="s1">&#39; id &#39;</span> | get_field 2<span class="k">)</span>
        <span class="k">else</span>
<span class="k">            </span><span class="nv">EXT_NET_ID</span><span class="o">=</span><span class="k">$(</span>neutron net-create <span class="s2">&quot;$PUBLIC_NETWORK_NAME&quot;</span> -- --router:external<span class="o">=</span>True | grep <span class="s1">&#39; id &#39;</span> | get_field 2<span class="k">)</span>
        <span class="k">fi</span>
<span class="k">        </span>die_if_not_set <span class="nv">$LINENO</span> EXT_NET_ID <span class="s2">&quot;Failure creating EXT_NET_ID for $PUBLIC_NETWORK_NAME&quot;</span>
        <span class="nv">EXT_GW_IP</span><span class="o">=</span><span class="k">$(</span>neutron subnet-create --ip_version 4 <span class="k">${</span><span class="nv">Q_FLOATING_ALLOCATION_POOL</span><span class="p">:+--allocation-pool </span><span class="nv">$Q_FLOATING_ALLOCATION_POOL</span><span class="k">}</span> --gateway <span class="nv">$PUBLIC_NETWORK_GATEWAY</span> --name <span class="nv">$PUBLIC_SUBNET_NAME</span> <span class="nv">$EXT_NET_ID</span> <span class="nv">$FLOATING_RANGE</span> -- --enable_dhcp<span class="o">=</span>False | grep <span class="s1">&#39;gateway_ip&#39;</span> | get_field 2<span class="k">)</span>
        die_if_not_set <span class="nv">$LINENO</span> EXT_GW_IP <span class="s2">&quot;Failure creating EXT_GW_IP&quot;</span>
        neutron router-gateway-set <span class="nv">$ROUTER_ID</span> <span class="nv">$EXT_NET_ID</span>

        <span class="k">if </span>is_service_enabled q-l3; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>logic is specific to using the l3-agent for l3</p>
</td><td class=code><div class=highlight><pre>
            <span class="k">if </span>is_neutron_ovs_base_plugin <span class="o">&amp;&amp;</span> <span class="o">[[</span> <span class="s2">&quot;$Q_USE_NAMESPACE&quot;</span> <span class="o">=</span> <span class="s2">&quot;True&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>Disable in-band as we are going to use local port
to communicate with VMs</p>
</td><td class=code><div class=highlight><pre>
                sudo ovs-vsctl <span class="nb">set </span>Bridge <span class="nv">$PUBLIC_BRIDGE</span> other_config:disable-in-band<span class="o">=</span><span class="nb">true</span>
<span class="nb">                </span><span class="nv">CIDR_LEN</span><span class="o">=</span><span class="k">${</span><span class="nv">FLOATING_RANGE</span><span class="p">#*/</span><span class="k">}</span>
                sudo ip addr add <span class="nv">$EXT_GW_IP</span>/<span class="nv">$CIDR_LEN</span> dev <span class="nv">$PUBLIC_BRIDGE</span>
                sudo ip link <span class="nb">set</span> <span class="nv">$PUBLIC_BRIDGE</span> up
                <span class="nv">ROUTER_GW_IP</span><span class="o">=</span><span class="sb">`</span>neutron port-list -c fixed_ips -c device_owner | grep router_gateway | awk -F <span class="s1">&#39;&quot;&#39;</span> <span class="s1">&#39;{ print $8; }&#39;</span><span class="sb">`</span>
                die_if_not_set <span class="nv">$LINENO</span> ROUTER_GW_IP <span class="s2">&quot;Failure retrieving ROUTER_GW_IP&quot;</span>
                sudo route add -net <span class="nv">$FIXED_RANGE</span> gw <span class="nv">$ROUTER_GW_IP</span>
            <span class="k">fi</span>
<span class="k">            if</span> <span class="o">[[</span> <span class="s2">&quot;$Q_USE_NAMESPACE&quot;</span> <span class="o">==</span> <span class="s2">&quot;False&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>Explicitly set router id in l3 agent configuration</p>
</td><td class=code><div class=highlight><pre>
                iniset <span class="nv">$Q_L3_CONF_FILE</span> DEFAULT router_id <span class="nv">$ROUTER_ID</span>
            <span class="k">fi</span>
<span class="k">        fi</span>
<span class="k">    fi</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>init_neutron() - Initialize databases, etc.</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>init_neutron <span class="o">{</span>
    recreate_database <span class="nv">$Q_DB_NAME</span> utf8
</pre></div></td></tr><tr><td class=docs>
<p>Run Neutron db migrations</p>
</td><td class=code><div class=highlight><pre>
    <span class="nv">$NEUTRON_BIN_DIR</span>/neutron-db-manage --config-file <span class="nv">$NEUTRON_CONF</span> --config-file /<span class="nv">$Q_PLUGIN_CONF_FILE</span> upgrade head
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>install_neutron() - Collect source and prepare</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>install_neutron <span class="o">{</span>
    git_clone <span class="nv">$NEUTRON_REPO</span> <span class="nv">$NEUTRON_DIR</span> <span class="nv">$NEUTRON_BRANCH</span>
    setup_develop <span class="nv">$NEUTRON_DIR</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>install_neutronclient() - Collect source and prepare</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>install_neutronclient <span class="o">{</span>
    git_clone <span class="nv">$NEUTRONCLIENT_REPO</span> <span class="nv">$NEUTRONCLIENT_DIR</span> <span class="nv">$NEUTRONCLIENT_BRANCH</span>
    setup_develop <span class="nv">$NEUTRONCLIENT_DIR</span>
    sudo install -D -m 0644 -o <span class="nv">$STACK_USER</span> <span class="o">{</span><span class="nv">$NEUTRONCLIENT_DIR</span>/tools/,/etc/bash_completion.d/<span class="o">}</span>neutron.bash_completion
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>install_neutron_agent_packages() - Collect source and prepare</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>install_neutron_agent_packages <span class="o">{</span>
</pre></div></td></tr><tr><td class=docs>
<p>radvd doesn't come with the OS. Install it if the l3 service is enabled.</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">if </span>is_service_enabled q-l3; <span class="k">then</span>
<span class="k">        </span>install_package radvd
    <span class="k">fi</span>
</pre></div></td></tr><tr><td class=docs>
<p>install packages that are specific to plugin agent(s)</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">if </span>is_service_enabled q-agt q-dhcp q-l3; <span class="k">then</span>
<span class="k">        </span>neutron_plugin_install_agent_packages
    <span class="k">fi</span>

<span class="k">    if </span>is_service_enabled q-lbaas; <span class="k">then</span>
<span class="k">        </span>neutron_agent_lbaas_install_agent_packages
    <span class="k">fi</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Start running processes, including screen</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>start_neutron_service_and_check <span class="o">{</span>
    <span class="nb">local </span><span class="nv">cfg_file_options</span><span class="o">=</span><span class="s2">&quot;$(determine_config_files neutron-server)&quot;</span>
    <span class="nb">local </span><span class="nv">service_port</span><span class="o">=</span><span class="nv">$Q_PORT</span>
    <span class="nb">local </span><span class="nv">service_protocol</span><span class="o">=</span><span class="nv">$Q_PROTOCOL</span>
    <span class="k">if </span>is_service_enabled tls-proxy; <span class="k">then</span>
<span class="k">        </span><span class="nv">service_port</span><span class="o">=</span><span class="nv">$Q_PORT_INT</span>
        <span class="nv">service_protocol</span><span class="o">=</span><span class="s2">&quot;http&quot;</span>
    <span class="k">fi</span>
</pre></div></td></tr><tr><td class=docs>
<p>Start the Neutron service</p>
</td><td class=code><div class=highlight><pre>
    run_process q-svc <span class="s2">&quot;python $NEUTRON_BIN_DIR/neutron-server $cfg_file_options&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;Waiting for Neutron to start...&quot;</span>
    <span class="k">if </span>is_ssl_enabled_service <span class="s2">&quot;neutron&quot;</span>; <span class="k">then</span>
<span class="k">        </span><span class="nv">ssl_ca</span><span class="o">=</span><span class="s2">&quot;--ca-certificate=${SSL_BUNDLE_FILE}&quot;</span>
    <span class="k">fi</span>
<span class="k">    if</span> ! timeout <span class="nv">$SERVICE_TIMEOUT</span> sh -c <span class="s2">&quot;while ! wget ${ssl_ca} --no-proxy -q -O- $service_protocol://$Q_HOST:$service_port; do sleep 1; done&quot;</span>; <span class="k">then</span>
<span class="k">        </span>die <span class="nv">$LINENO</span> <span class="s2">&quot;Neutron did not start&quot;</span>
    <span class="k">fi</span>
</pre></div></td></tr><tr><td class=docs>
<p>Start proxy if enabled</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">if </span>is_service_enabled tls-proxy; <span class="k">then</span>
<span class="k">        </span>start_tls_proxy <span class="s1">&#39;*&#39;</span> <span class="nv">$Q_PORT</span> <span class="nv">$Q_HOST</span> <span class="nv">$Q_PORT_INT</span> &amp;
    <span class="k">fi</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Start running processes, including screen</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>start_neutron_agents <span class="o">{</span>
</pre></div></td></tr><tr><td class=docs>
<p>Start up the neutron agents if enabled</p>
</td><td class=code><div class=highlight><pre>
    run_process q-agt <span class="s2">&quot;python $AGENT_BINARY --config-file $NEUTRON_CONF --config-file /$Q_PLUGIN_CONF_FILE&quot;</span>
    run_process q-dhcp <span class="s2">&quot;python $AGENT_DHCP_BINARY --config-file $NEUTRON_CONF --config-file=$Q_DHCP_CONF_FILE&quot;</span>

    <span class="k">if </span>is_provider_network; <span class="k">then</span>
<span class="k">        </span>sudo ovs-vsctl add-port <span class="nv">$OVS_PHYSICAL_BRIDGE</span> <span class="nv">$PUBLIC_INTERFACE</span>
        sudo ip link <span class="nb">set</span> <span class="nv">$OVS_PHYSICAL_BRIDGE</span> up
        sudo ip link <span class="nb">set </span>br-int up
        sudo ip link <span class="nb">set</span> <span class="nv">$PUBLIC_INTERFACE</span> up
    <span class="k">fi</span>

<span class="k">    if </span>is_service_enabled q-vpn; <span class="k">then</span>
<span class="k">        </span>run_process q-vpn <span class="s2">&quot;$AGENT_VPN_BINARY $(determine_config_files neutron-vpn-agent)&quot;</span>
    <span class="k">else</span>
<span class="k">        </span>run_process q-l3 <span class="s2">&quot;python $AGENT_L3_BINARY $(determine_config_files neutron-l3-agent)&quot;</span>
    <span class="k">fi</span>

<span class="k">    </span>run_process q-meta <span class="s2">&quot;python $AGENT_META_BINARY --config-file $NEUTRON_CONF --config-file=$Q_META_CONF_FILE&quot;</span>

    <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$VIRT_DRIVER&quot;</span> <span class="o">=</span> <span class="s1">&#39;xenserver&#39;</span> <span class="o">]</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>For XenServer, start an agent for the domU openvswitch</p>
</td><td class=code><div class=highlight><pre>
        run_process q-domua <span class="s2">&quot;python $AGENT_BINARY --config-file $NEUTRON_CONF --config-file /$Q_PLUGIN_CONF_FILE.domU&quot;</span>
    <span class="k">fi</span>

<span class="k">    if </span>is_service_enabled q-lbaas; <span class="k">then</span>
<span class="k">        </span>run_process q-lbaas <span class="s2">&quot;python $AGENT_LBAAS_BINARY --config-file $NEUTRON_CONF --config-file=$LBAAS_AGENT_CONF_FILENAME&quot;</span>
    <span class="k">fi</span>

<span class="k">    if </span>is_service_enabled q-metering; <span class="k">then</span>
<span class="k">        </span>run_process q-metering <span class="s2">&quot;python $AGENT_METERING_BINARY --config-file $NEUTRON_CONF --config-file $METERING_AGENT_CONF_FILENAME&quot;</span>
    <span class="k">fi</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>stop_neutron() - Stop running processes (non-screen)</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>stop_neutron <span class="o">{</span>
    <span class="k">if </span>is_service_enabled q-dhcp; <span class="k">then</span>
<span class="k">        </span><span class="nv">pid</span><span class="o">=</span><span class="k">$(</span>ps aux | awk <span class="s1">&#39;/[d]nsmasq.+interface=(tap|ns-)/ { print $2 }&#39;</span><span class="k">)</span>
        <span class="o">[</span> ! -z <span class="s2">&quot;$pid&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> sudo <span class="nb">kill</span> -9 <span class="nv">$pid</span>
    <span class="k">fi</span>
<span class="k">    if </span>is_service_enabled q-meta; <span class="k">then</span>
<span class="k">        </span>sudo pkill -9 -f neutron-ns-metadata-proxy <span class="o">||</span> :
    <span class="k">fi</span>

<span class="k">    if </span>is_service_enabled q-lbaas; <span class="k">then</span>
<span class="k">        </span>neutron_lbaas_stop
    <span class="k">fi</span>
<span class="k">    if </span>is_service_enabled q-fwaas; <span class="k">then</span>
<span class="k">        </span>neutron_fwaas_stop
    <span class="k">fi</span>
<span class="k">    if </span>is_service_enabled q-vpn; <span class="k">then</span>
<span class="k">        </span>neutron_vpn_stop
    <span class="k">fi</span>
<span class="k">    if </span>is_service_enabled q-metering; <span class="k">then</span>
<span class="k">        </span>neutron_metering_stop
    <span class="k">fi</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>cleanup_neutron() - Remove residual data files, anything left over from previous
runs that a clean run would need to clean up</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>cleanup_neutron <span class="o">{</span>
    <span class="k">if </span>is_neutron_ovs_base_plugin; <span class="k">then</span>
<span class="k">        </span>neutron_ovs_base_cleanup
    <span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>delete all namespaces created by neutron</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">for </span>ns in <span class="k">$(</span>sudo ip netns list | grep -o -E <span class="s1">&#39;(qdhcp|qrouter|qlbaas|fip|snat)-[0-9a-f-]*&#39;</span><span class="k">)</span>; <span class="k">do</span>
<span class="k">        </span>sudo ip netns delete <span class="k">${</span><span class="nv">ns</span><span class="k">}</span>
    <span class="k">done</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>_configure_neutron_common()
Set common config for all neutron server and agents.
This MUST be called before other <tt class="docutils literal">_configure_neutron_*</tt> functions.</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>_configure_neutron_common <span class="o">{</span>
</pre></div></td></tr><tr><td class=docs>
<p>Put config files in <tt class="docutils literal">NEUTRON_CONF_DIR</tt> for everyone to find</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">if</span> <span class="o">[[</span> ! -d <span class="nv">$NEUTRON_CONF_DIR</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span>sudo mkdir -p <span class="nv">$NEUTRON_CONF_DIR</span>
    <span class="k">fi</span>
<span class="k">    </span>sudo chown <span class="nv">$STACK_USER</span> <span class="nv">$NEUTRON_CONF_DIR</span>

    cp <span class="nv">$NEUTRON_DIR</span>/etc/neutron.conf <span class="nv">$NEUTRON_CONF</span>

</pre></div></td></tr><tr><td class=docs>
<p>Set plugin-specific variables <tt class="docutils literal">Q_DB_NAME</tt>, <tt class="docutils literal">Q_PLUGIN_CLASS</tt>.
For main plugin config file, set <tt class="docutils literal">Q_PLUGIN_CONF_PATH</tt>, <tt class="docutils literal">Q_PLUGIN_CONF_FILENAME</tt>.
For addition plugin config files, set <tt class="docutils literal">Q_PLUGIN_EXTRA_CONF_PATH</tt>,
<tt class="docutils literal">Q_PLUGIN_EXTRA_CONF_FILES</tt>.  For example:</p>
<blockquote>
<tt class="docutils literal"><span class="pre">Q_PLUGIN_EXTRA_CONF_FILES=(file1,</span> file2)</tt></blockquote>
</td><td class=code><div class=highlight><pre>
    neutron_plugin_configure_common

    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$Q_PLUGIN_CONF_PATH&quot;</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="o">||</span> <span class="s2">&quot;$Q_PLUGIN_CONF_FILENAME&quot;</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="o">||</span> <span class="s2">&quot;$Q_PLUGIN_CLASS&quot;</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span>die <span class="nv">$LINENO</span> <span class="s2">&quot;Neutron plugin not set.. exiting&quot;</span>
    <span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>If needed, move config file from <tt class="docutils literal">$NEUTRON_DIR/etc/neutron</tt> to <tt class="docutils literal">NEUTRON_CONF_DIR</tt></p>
</td><td class=code><div class=highlight><pre>
    mkdir -p /<span class="nv">$Q_PLUGIN_CONF_PATH</span>
    <span class="nv">Q_PLUGIN_CONF_FILE</span><span class="o">=</span><span class="nv">$Q_PLUGIN_CONF_PATH</span>/<span class="nv">$Q_PLUGIN_CONF_FILENAME</span>
    cp <span class="nv">$NEUTRON_DIR</span>/<span class="nv">$Q_PLUGIN_CONF_FILE</span> /<span class="nv">$Q_PLUGIN_CONF_FILE</span>

    iniset <span class="nv">$NEUTRON_CONF</span> database connection <span class="sb">`</span>database_connection_url <span class="nv">$Q_DB_NAME</span><span class="sb">`</span>
    iniset <span class="nv">$NEUTRON_CONF</span> DEFAULT state_path <span class="nv">$DATA_DIR</span>/neutron

</pre></div></td></tr><tr><td class=docs>
<p>If addition config files are set, make sure their path name is set as well</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">if</span> <span class="o">[[</span> <span class="k">${#</span><span class="nv">Q_PLUGIN_EXTRA_CONF_FILES</span><span class="p">[@]</span><span class="k">}</span> &gt; 0 <span class="o">&amp;&amp;</span> <span class="nv">$Q_PLUGIN_EXTRA_CONF_PATH</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span>die <span class="nv">$LINENO</span> <span class="s2">&quot;Neutron additional plugin config not set.. exiting&quot;</span>
    <span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>If additional config files exist, copy them over to neutron configuration
directory</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">if</span> <span class="o">[[</span> <span class="nv">$Q_PLUGIN_EXTRA_CONF_PATH</span> !<span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nb">local </span>f
        <span class="k">for</span> <span class="o">((</span> <span class="nv">f</span><span class="o">=</span>0; <span class="nv">$f</span> &lt; <span class="k">${#</span><span class="nv">Q_PLUGIN_EXTRA_CONF_FILES</span><span class="p">[@]</span><span class="k">}</span>; f+<span class="o">=</span>1 <span class="o">))</span>; <span class="k">do</span>
<span class="k">            </span>Q_PLUGIN_EXTRA_CONF_FILES<span class="o">[</span><span class="nv">$f</span><span class="o">]=</span><span class="nv">$Q_PLUGIN_EXTRA_CONF_PATH</span>/<span class="k">${</span><span class="nv">Q_PLUGIN_EXTRA_CONF_FILES</span><span class="p">[</span><span class="nv">$f</span><span class="p">]</span><span class="k">}</span>
        <span class="k">done</span>
<span class="k">    fi</span>

<span class="k">    if</span> <span class="o">[</span> <span class="s2">&quot;$VIRT_DRIVER&quot;</span> <span class="o">=</span> <span class="s1">&#39;fake&#39;</span> <span class="o">]</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>Disable arbitrary limits</p>
</td><td class=code><div class=highlight><pre>
        iniset <span class="nv">$NEUTRON_CONF</span> quotas quota_network -1
        iniset <span class="nv">$NEUTRON_CONF</span> quotas quota_subnet -1
        iniset <span class="nv">$NEUTRON_CONF</span> quotas quota_port -1
        iniset <span class="nv">$NEUTRON_CONF</span> quotas quota_security_group -1
        iniset <span class="nv">$NEUTRON_CONF</span> quotas quota_security_group_rule -1
    <span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Format logging</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$LOG_COLOR&quot;</span> <span class="o">==</span> <span class="s2">&quot;True&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="o">[</span> <span class="s2">&quot;$SYSLOG&quot;</span> <span class="o">==</span> <span class="s2">&quot;False&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">        </span>setup_colorized_logging <span class="nv">$NEUTRON_CONF</span> DEFAULT project_id
    <span class="k">fi</span>

<span class="k">    if </span>is_service_enabled tls-proxy; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>Set the service port for a proxy to take the original</p>
</td><td class=code><div class=highlight><pre>
        iniset <span class="nv">$NEUTRON_CONF</span> DEFAULT bind_port <span class="s2">&quot;$Q_PORT_INT&quot;</span>
    <span class="k">fi</span>

<span class="k">    if </span>is_ssl_enabled_service <span class="s2">&quot;nova&quot;</span>; <span class="k">then</span>
<span class="k">        </span>iniset <span class="nv">$NEUTRON_CONF</span> DEFAULT nova_ca_certificates_file <span class="s2">&quot;$SSL_BUNDLE_FILE&quot;</span>
    <span class="k">fi</span>

<span class="k">    if </span>is_ssl_enabled_service <span class="s2">&quot;neutron&quot;</span>; <span class="k">then</span>
<span class="k">        </span>ensure_certificates NEUTRON

        iniset <span class="nv">$NEUTRON_CONF</span> DEFAULT use_ssl True
        iniset <span class="nv">$NEUTRON_CONF</span> DEFAULT ssl_cert_file <span class="s2">&quot;$NEUTRON_SSL_CERT&quot;</span>
        iniset <span class="nv">$NEUTRON_CONF</span> DEFAULT ssl_key_file <span class="s2">&quot;$NEUTRON_SSL_KEY&quot;</span>
    <span class="k">fi</span>

<span class="k">    </span>_neutron_setup_rootwrap
<span class="o">}</span>

<span class="k">function </span>_configure_neutron_debug_command <span class="o">{</span>
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$Q_USE_DEBUG_COMMAND&quot;</span> !<span class="o">=</span> <span class="s2">&quot;True&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        return</span>
<span class="k">    fi</span>

<span class="k">    </span>cp <span class="nv">$NEUTRON_DIR</span>/etc/l3_agent.ini <span class="nv">$NEUTRON_TEST_CONFIG_FILE</span>

    iniset <span class="nv">$NEUTRON_TEST_CONFIG_FILE</span> DEFAULT verbose False
    iniset <span class="nv">$NEUTRON_TEST_CONFIG_FILE</span> DEFAULT debug False
    iniset <span class="nv">$NEUTRON_TEST_CONFIG_FILE</span> DEFAULT use_namespaces <span class="nv">$Q_USE_NAMESPACE</span>
    iniset <span class="nv">$NEUTRON_TEST_CONFIG_FILE</span> agent root_helper <span class="s2">&quot;$Q_RR_COMMAND&quot;</span>

    _neutron_setup_interface_driver <span class="nv">$NEUTRON_TEST_CONFIG_FILE</span>

    neutron_plugin_configure_debug_command
<span class="o">}</span>

<span class="k">function </span>_configure_neutron_dhcp_agent <span class="o">{</span>

    cp <span class="nv">$NEUTRON_DIR</span>/etc/dhcp_agent.ini <span class="nv">$Q_DHCP_CONF_FILE</span>

    iniset <span class="nv">$Q_DHCP_CONF_FILE</span> DEFAULT verbose True
    iniset <span class="nv">$Q_DHCP_CONF_FILE</span> DEFAULT debug <span class="nv">$ENABLE_DEBUG_LOG_LEVEL</span>
    iniset <span class="nv">$Q_DHCP_CONF_FILE</span> DEFAULT use_namespaces <span class="nv">$Q_USE_NAMESPACE</span>
    iniset <span class="nv">$Q_DHCP_CONF_FILE</span> DEFAULT root_helper <span class="s2">&quot;$Q_RR_COMMAND&quot;</span>

    _neutron_setup_interface_driver <span class="nv">$Q_DHCP_CONF_FILE</span>

    neutron_plugin_configure_dhcp_agent
<span class="o">}</span>

<span class="k">function </span>_configure_neutron_l3_agent <span class="o">{</span>
    <span class="nb">local </span>cfg_file
    <span class="nv">Q_L3_ENABLED</span><span class="o">=</span>True
</pre></div></td></tr><tr><td class=docs>
<p>for l3-agent, only use per tenant router if we have namespaces</p>
</td><td class=code><div class=highlight><pre>
    <span class="nv">Q_L3_ROUTER_PER_TENANT</span><span class="o">=</span><span class="nv">$Q_USE_NAMESPACE</span>

    <span class="k">if </span>is_service_enabled q-vpn; <span class="k">then</span>
<span class="k">        </span>cp <span class="nv">$NEUTRON_DIR</span>/etc/vpn_agent.ini <span class="nv">$Q_VPN_CONF_FILE</span>
    <span class="k">fi</span>

<span class="k">    </span>cp <span class="nv">$NEUTRON_DIR</span>/etc/l3_agent.ini <span class="nv">$Q_L3_CONF_FILE</span>

    iniset <span class="nv">$Q_L3_CONF_FILE</span> DEFAULT verbose True
    iniset <span class="nv">$Q_L3_CONF_FILE</span> DEFAULT debug <span class="nv">$ENABLE_DEBUG_LOG_LEVEL</span>
    iniset <span class="nv">$Q_L3_CONF_FILE</span> DEFAULT use_namespaces <span class="nv">$Q_USE_NAMESPACE</span>
    iniset <span class="nv">$Q_L3_CONF_FILE</span> DEFAULT root_helper <span class="s2">&quot;$Q_RR_COMMAND&quot;</span>

    _neutron_setup_interface_driver <span class="nv">$Q_L3_CONF_FILE</span>

    neutron_plugin_configure_l3_agent
<span class="o">}</span>

<span class="k">function </span>_configure_neutron_metadata_agent <span class="o">{</span>
    cp <span class="nv">$NEUTRON_DIR</span>/etc/metadata_agent.ini <span class="nv">$Q_META_CONF_FILE</span>

    iniset <span class="nv">$Q_META_CONF_FILE</span> DEFAULT verbose True
    iniset <span class="nv">$Q_META_CONF_FILE</span> DEFAULT debug <span class="nv">$ENABLE_DEBUG_LOG_LEVEL</span>
    iniset <span class="nv">$Q_META_CONF_FILE</span> DEFAULT nova_metadata_ip <span class="nv">$Q_META_DATA_IP</span>
    iniset <span class="nv">$Q_META_CONF_FILE</span> DEFAULT root_helper <span class="s2">&quot;$Q_RR_COMMAND&quot;</span>

    _neutron_setup_keystone <span class="nv">$Q_META_CONF_FILE</span> DEFAULT

<span class="o">}</span>

<span class="k">function </span>_configure_neutron_ceilometer_notifications <span class="o">{</span>
    iniset <span class="nv">$NEUTRON_CONF</span> DEFAULT notification_driver messaging
<span class="o">}</span>

<span class="k">function </span>_configure_neutron_lbaas <span class="o">{</span>
    neutron_agent_lbaas_configure_common
    neutron_agent_lbaas_configure_agent
<span class="o">}</span>

<span class="k">function </span>_configure_neutron_metering <span class="o">{</span>
    neutron_agent_metering_configure_common
    neutron_agent_metering_configure_agent
<span class="o">}</span>

<span class="k">function </span>_configure_neutron_fwaas <span class="o">{</span>
    neutron_fwaas_configure_common
    neutron_fwaas_configure_driver
<span class="o">}</span>

<span class="k">function </span>_configure_neutron_vpn <span class="o">{</span>
    neutron_vpn_install_agent_packages
    neutron_vpn_configure_common
<span class="o">}</span>

<span class="k">function </span>_configure_dvr <span class="o">{</span>
    iniset <span class="nv">$NEUTRON_CONF</span> DEFAULT router_distributed True
    iniset <span class="nv">$Q_L3_CONF_FILE</span> DEFAULT agent_mode <span class="nv">$Q_DVR_MODE</span>
<span class="o">}</span>


</pre></div></td></tr><tr><td class=docs>
<p>_configure_neutron_plugin_agent() - Set config files for neutron plugin agent
It is called when q-agt is enabled.</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>_configure_neutron_plugin_agent <span class="o">{</span>
</pre></div></td></tr><tr><td class=docs>
<p>Specify the default root helper prior to agent configuration to
ensure that an agent's configuration can override the default</p>
</td><td class=code><div class=highlight><pre>
    iniset /<span class="nv">$Q_PLUGIN_CONF_FILE</span> agent root_helper <span class="s2">&quot;$Q_RR_COMMAND&quot;</span>
    iniset <span class="nv">$NEUTRON_CONF</span> DEFAULT verbose True
    iniset <span class="nv">$NEUTRON_CONF</span> DEFAULT debug <span class="nv">$ENABLE_DEBUG_LOG_LEVEL</span>

</pre></div></td></tr><tr><td class=docs>
<p>Configure agent for plugin</p>
</td><td class=code><div class=highlight><pre>
    neutron_plugin_configure_plugin_agent
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>_configure_neutron_service() - Set config files for neutron service
It is called when q-svc is enabled.</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>_configure_neutron_service <span class="o">{</span>
    <span class="nv">Q_API_PASTE_FILE</span><span class="o">=</span><span class="nv">$NEUTRON_CONF_DIR</span>/api-paste.ini
    <span class="nv">Q_POLICY_FILE</span><span class="o">=</span><span class="nv">$NEUTRON_CONF_DIR</span>/policy.json

    cp <span class="nv">$NEUTRON_DIR</span>/etc/api-paste.ini <span class="nv">$Q_API_PASTE_FILE</span>
    cp <span class="nv">$NEUTRON_DIR</span>/etc/policy.json <span class="nv">$Q_POLICY_FILE</span>

</pre></div></td></tr><tr><td class=docs>
<p>allow neutron user to administer neutron to match neutron account</p>
</td><td class=code><div class=highlight><pre>
    sed -i <span class="s1">&#39;s/&quot;context_is_admin&quot;:  &quot;role:admin&quot;/&quot;context_is_admin&quot;:  &quot;role:admin or user_name:neutron&quot;/g&#39;</span> <span class="nv">$Q_POLICY_FILE</span>

</pre></div></td></tr><tr><td class=docs>
<p>Update either configuration file with plugin</p>
</td><td class=code><div class=highlight><pre>
    iniset <span class="nv">$NEUTRON_CONF</span> DEFAULT core_plugin <span class="nv">$Q_PLUGIN_CLASS</span>

    <span class="k">if</span> <span class="o">[[</span> <span class="nv">$Q_SERVICE_PLUGIN_CLASSES</span> !<span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span>iniset <span class="nv">$NEUTRON_CONF</span> DEFAULT service_plugins <span class="nv">$Q_SERVICE_PLUGIN_CLASSES</span>
    <span class="k">fi</span>

<span class="k">    </span>iniset <span class="nv">$NEUTRON_CONF</span> DEFAULT verbose True
    iniset <span class="nv">$NEUTRON_CONF</span> DEFAULT debug <span class="nv">$ENABLE_DEBUG_LOG_LEVEL</span>
    iniset <span class="nv">$NEUTRON_CONF</span> DEFAULT policy_file <span class="nv">$Q_POLICY_FILE</span>
    iniset <span class="nv">$NEUTRON_CONF</span> DEFAULT allow_overlapping_ips <span class="nv">$Q_ALLOW_OVERLAPPING_IP</span>

    iniset <span class="nv">$NEUTRON_CONF</span> DEFAULT auth_strategy <span class="nv">$Q_AUTH_STRATEGY</span>
    _neutron_setup_keystone <span class="nv">$NEUTRON_CONF</span> keystone_authtoken

</pre></div></td></tr><tr><td class=docs>
<p>Configuration for neutron notifations to nova.</p>
</td><td class=code><div class=highlight><pre>
    iniset <span class="nv">$NEUTRON_CONF</span> DEFAULT notify_nova_on_port_status_changes <span class="nv">$Q_NOTIFY_NOVA_PORT_STATUS_CHANGES</span>
    iniset <span class="nv">$NEUTRON_CONF</span> DEFAULT notify_nova_on_port_data_changes <span class="nv">$Q_NOTIFY_NOVA_PORT_DATA_CHANGES</span>
    iniset <span class="nv">$NEUTRON_CONF</span> DEFAULT nova_url <span class="s2">&quot;$NOVA_SERVICE_PROTOCOL://$NOVA_SERVICE_HOST:$NOVA_SERVICE_PORT/v2&quot;</span>
    iniset <span class="nv">$NEUTRON_CONF</span> DEFAULT nova_admin_username nova
    iniset <span class="nv">$NEUTRON_CONF</span> DEFAULT nova_admin_password <span class="nv">$SERVICE_PASSWORD</span>
    <span class="nv">ADMIN_TENANT_ID</span><span class="o">=</span><span class="k">$(</span>openstack project list | awk <span class="s2">&quot;/ service / { print \$2 }&quot;</span><span class="k">)</span>
    iniset <span class="nv">$NEUTRON_CONF</span> DEFAULT nova_admin_tenant_id <span class="nv">$ADMIN_TENANT_ID</span>
    iniset <span class="nv">$NEUTRON_CONF</span> DEFAULT nova_admin_auth_url  <span class="s2">&quot;$KEYSTONE_SERVICE_PROTOCOL://$KEYSTONE_SERVICE_HOST:$KEYSTONE_AUTH_PORT/v2.0&quot;</span>

</pre></div></td></tr><tr><td class=docs>
<p>Configure plugin</p>
</td><td class=code><div class=highlight><pre>
    neutron_plugin_configure_service
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Utility Functions</p>
</td><td class=code><div class=highlight><pre>
<span class="c">#------------------</span>

</pre></div></td></tr><tr><td class=docs>
<p>_neutron_service_plugin_class_add() - add service plugin class</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>_neutron_service_plugin_class_add <span class="o">{</span>
    <span class="nb">local </span><span class="nv">service_plugin_class</span><span class="o">=</span><span class="nv">$1</span>
    <span class="k">if</span> <span class="o">[[</span> <span class="nv">$Q_SERVICE_PLUGIN_CLASSES</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nv">Q_SERVICE_PLUGIN_CLASSES</span><span class="o">=</span><span class="nv">$service_plugin_class</span>
    <span class="k">elif</span> <span class="o">[[</span> ! ,<span class="k">${</span><span class="nv">Q_SERVICE_PLUGIN_CLASSES</span><span class="k">}</span>, <span class="o">=</span>~ ,<span class="k">${</span><span class="nv">service_plugin_class</span><span class="k">}</span>, <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nv">Q_SERVICE_PLUGIN_CLASSES</span><span class="o">=</span><span class="s2">&quot;$Q_SERVICE_PLUGIN_CLASSES,$service_plugin_class&quot;</span>
    <span class="k">fi</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>_neutron_setup_rootwrap() - configure Neutron's rootwrap</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>_neutron_setup_rootwrap <span class="o">{</span>
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$Q_USE_ROOTWRAP&quot;</span> <span class="o">==</span> <span class="s2">&quot;False&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        return</span>
<span class="k">    fi</span>
</pre></div></td></tr><tr><td class=docs>
<p>Deploy new rootwrap filters files (owned by root).
Wipe any existing <tt class="docutils literal">rootwrap.d</tt> files first</p>
</td><td class=code><div class=highlight><pre>
    <span class="nv">Q_CONF_ROOTWRAP_D</span><span class="o">=</span><span class="nv">$NEUTRON_CONF_DIR</span>/rootwrap.d
    <span class="k">if</span> <span class="o">[[</span> -d <span class="nv">$Q_CONF_ROOTWRAP_D</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span>sudo rm -rf <span class="nv">$Q_CONF_ROOTWRAP_D</span>
    <span class="k">fi</span>
</pre></div></td></tr><tr><td class=docs>
<p>Deploy filters to <tt class="docutils literal">$NEUTRON_CONF_DIR/rootwrap.d</tt></p>
</td><td class=code><div class=highlight><pre>
    mkdir -p -m 755 <span class="nv">$Q_CONF_ROOTWRAP_D</span>
    cp -pr <span class="nv">$NEUTRON_DIR</span>/etc/neutron/rootwrap.d/* <span class="nv">$Q_CONF_ROOTWRAP_D</span>/
    sudo chown -R root:root <span class="nv">$Q_CONF_ROOTWRAP_D</span>
    sudo chmod 644 <span class="nv">$Q_CONF_ROOTWRAP_D</span>/*
</pre></div></td></tr><tr><td class=docs>
<p>Set up <tt class="docutils literal">rootwrap.conf</tt>, pointing to <tt class="docutils literal">$NEUTRON_CONF_DIR/rootwrap.d</tt>
location moved in newer versions, prefer new location</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">if </span><span class="nb">test</span> -r <span class="nv">$NEUTRON_DIR</span>/etc/neutron/rootwrap.conf; <span class="k">then</span>
<span class="k">        </span>sudo cp -p <span class="nv">$NEUTRON_DIR</span>/etc/neutron/rootwrap.conf <span class="nv">$Q_RR_CONF_FILE</span>
    <span class="k">else</span>
<span class="k">        </span>sudo cp -p <span class="nv">$NEUTRON_DIR</span>/etc/rootwrap.conf <span class="nv">$Q_RR_CONF_FILE</span>
    <span class="k">fi</span>
<span class="k">    </span>sudo sed -e <span class="s2">&quot;s:^filters_path=.*$:filters_path=$Q_CONF_ROOTWRAP_D:&quot;</span> -i <span class="nv">$Q_RR_CONF_FILE</span>
    sudo chown root:root <span class="nv">$Q_RR_CONF_FILE</span>
    sudo chmod 0644 <span class="nv">$Q_RR_CONF_FILE</span>
</pre></div></td></tr><tr><td class=docs>
<p>Specify <tt class="docutils literal">rootwrap.conf</tt> as first parameter to neutron-rootwrap</p>
</td><td class=code><div class=highlight><pre>
    <span class="nv">ROOTWRAP_SUDOER_CMD</span><span class="o">=</span><span class="s2">&quot;$NEUTRON_ROOTWRAP $Q_RR_CONF_FILE *&quot;</span>

</pre></div></td></tr><tr><td class=docs>
<p>Set up the rootwrap sudoers for neutron</p>
</td><td class=code><div class=highlight><pre>
    <span class="nv">TEMPFILE</span><span class="o">=</span><span class="sb">`</span>mktemp<span class="sb">`</span>
    <span class="nb">echo</span> <span class="s2">&quot;$STACK_USER ALL=(root) NOPASSWD: $ROOTWRAP_SUDOER_CMD&quot;</span> &gt;<span class="nv">$TEMPFILE</span>
    chmod 0440 <span class="nv">$TEMPFILE</span>
    sudo chown root:root <span class="nv">$TEMPFILE</span>
    sudo mv <span class="nv">$TEMPFILE</span> /etc/sudoers.d/neutron-rootwrap

</pre></div></td></tr><tr><td class=docs>
<p>Update the root_helper</p>
</td><td class=code><div class=highlight><pre>
    iniset <span class="nv">$NEUTRON_CONF</span> agent root_helper <span class="s2">&quot;$Q_RR_COMMAND&quot;</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Configures keystone integration for neutron service and agents</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>_neutron_setup_keystone <span class="o">{</span>
    <span class="nb">local </span><span class="nv">conf_file</span><span class="o">=</span><span class="nv">$1</span>
    <span class="nb">local </span><span class="nv">section</span><span class="o">=</span><span class="nv">$2</span>

    create_neutron_cache_dir
    configure_auth_token_middleware <span class="nv">$conf_file</span> <span class="nv">$Q_ADMIN_USERNAME</span> <span class="nv">$NEUTRON_AUTH_CACHE_DIR</span> <span class="nv">$section</span>
<span class="o">}</span>

<span class="k">function </span>_neutron_setup_interface_driver <span class="o">{</span>

</pre></div></td></tr><tr><td class=docs>
<p>ovs_use_veth needs to be set before the plugin configuration
occurs to allow plugins to override the setting.</p>
</td><td class=code><div class=highlight><pre>
    iniset <span class="nv">$1</span> DEFAULT ovs_use_veth <span class="nv">$Q_OVS_USE_VETH</span>

    neutron_plugin_setup_interface_driver <span class="nv">$1</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Functions for Neutron Exercises</p>
</td><td class=code><div class=highlight><pre>
<span class="c">#--------------------------------</span>

<span class="k">function </span>delete_probe <span class="o">{</span>
    <span class="nb">local </span><span class="nv">from_net</span><span class="o">=</span><span class="s2">&quot;$1&quot;</span>
    <span class="nv">net_id</span><span class="o">=</span><span class="sb">`</span>_get_net_id <span class="nv">$from_net</span><span class="sb">`</span>
    <span class="nv">probe_id</span><span class="o">=</span><span class="sb">`</span>neutron-debug --os-tenant-name admin --os-username admin --os-password <span class="nv">$ADMIN_PASSWORD</span> probe-list -c id -c network_id | grep <span class="nv">$net_id</span> | awk <span class="s1">&#39;{print $2}&#39;</span><span class="sb">`</span>
    neutron-debug --os-tenant-name admin --os-username admin probe-delete <span class="nv">$probe_id</span>
<span class="o">}</span>

<span class="k">function </span>setup_neutron_debug <span class="o">{</span>
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$Q_USE_DEBUG_COMMAND&quot;</span> <span class="o">==</span> <span class="s2">&quot;True&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nv">public_net_id</span><span class="o">=</span><span class="sb">`</span>_get_net_id <span class="nv">$PUBLIC_NETWORK_NAME</span><span class="sb">`</span>
        neutron-debug --os-tenant-name admin --os-username admin --os-password <span class="nv">$ADMIN_PASSWORD</span> probe-create --device-owner compute <span class="nv">$public_net_id</span>
        <span class="nv">private_net_id</span><span class="o">=</span><span class="sb">`</span>_get_net_id <span class="nv">$PRIVATE_NETWORK_NAME</span><span class="sb">`</span>
        neutron-debug --os-tenant-name admin --os-username admin --os-password <span class="nv">$ADMIN_PASSWORD</span> probe-create --device-owner compute <span class="nv">$private_net_id</span>
    <span class="k">fi</span>
<span class="o">}</span>

<span class="k">function </span>teardown_neutron_debug <span class="o">{</span>
    delete_probe <span class="nv">$PUBLIC_NETWORK_NAME</span>
    delete_probe <span class="nv">$PRIVATE_NETWORK_NAME</span>
<span class="o">}</span>

<span class="k">function </span>_get_net_id <span class="o">{</span>
    neutron --os-tenant-name admin --os-username admin --os-password <span class="nv">$ADMIN_PASSWORD</span> net-list | grep <span class="nv">$1</span> | awk <span class="s1">&#39;{print $2}&#39;</span>
<span class="o">}</span>

<span class="k">function </span>_get_probe_cmd_prefix <span class="o">{</span>
    <span class="nb">local </span><span class="nv">from_net</span><span class="o">=</span><span class="s2">&quot;$1&quot;</span>
    <span class="nv">net_id</span><span class="o">=</span><span class="sb">`</span>_get_net_id <span class="nv">$from_net</span><span class="sb">`</span>
    <span class="nv">probe_id</span><span class="o">=</span><span class="sb">`</span>neutron-debug --os-tenant-name admin --os-username admin --os-password <span class="nv">$ADMIN_PASSWORD</span> probe-list -c id -c network_id | grep <span class="nv">$net_id</span> | awk <span class="s1">&#39;{print $2}&#39;</span> | head -n 1<span class="sb">`</span>
    <span class="nb">echo</span> <span class="s2">&quot;$Q_RR_COMMAND ip netns exec qprobe-$probe_id&quot;</span>
<span class="o">}</span>

<span class="k">function </span>_ping_check_neutron <span class="o">{</span>
    <span class="nb">local </span><span class="nv">from_net</span><span class="o">=</span><span class="nv">$1</span>
    <span class="nb">local </span><span class="nv">ip</span><span class="o">=</span><span class="nv">$2</span>
    <span class="nb">local </span><span class="nv">timeout_sec</span><span class="o">=</span><span class="nv">$3</span>
    <span class="nb">local </span><span class="nv">expected</span><span class="o">=</span><span class="k">${</span><span class="nv">4</span><span class="k">:-</span><span class="s2">&quot;True&quot;</span><span class="k">}</span>
    <span class="nb">local </span><span class="nv">check_command</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
    <span class="nv">probe_cmd</span><span class="o">=</span><span class="sb">`</span>_get_probe_cmd_prefix <span class="nv">$from_net</span><span class="sb">`</span>
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$expected&quot;</span> <span class="o">=</span> <span class="s2">&quot;True&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nv">check_command</span><span class="o">=</span><span class="s2">&quot;while ! $probe_cmd ping -w 1 -c 1 $ip; do sleep 1; done&quot;</span>
    <span class="k">else</span>
<span class="k">        </span><span class="nv">check_command</span><span class="o">=</span><span class="s2">&quot;while $probe_cmd ping -w 1 -c 1 $ip; do sleep 1; done&quot;</span>
    <span class="k">fi</span>
<span class="k">    if</span> ! timeout <span class="nv">$timeout_sec</span> sh -c <span class="s2">&quot;$check_command&quot;</span>; <span class="k">then</span>
<span class="k">        if</span> <span class="o">[[</span> <span class="s2">&quot;$expected&quot;</span> <span class="o">=</span> <span class="s2">&quot;True&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            </span>die <span class="nv">$LINENO</span> <span class="s2">&quot;[Fail] Couldn&#39;t ping server&quot;</span>
        <span class="k">else</span>
<span class="k">            </span>die <span class="nv">$LINENO</span> <span class="s2">&quot;[Fail] Could ping server&quot;</span>
        <span class="k">fi</span>
<span class="k">    fi</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>ssh check</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>_ssh_check_neutron <span class="o">{</span>
    <span class="nb">local </span><span class="nv">from_net</span><span class="o">=</span><span class="nv">$1</span>
    <span class="nb">local </span><span class="nv">key_file</span><span class="o">=</span><span class="nv">$2</span>
    <span class="nb">local </span><span class="nv">ip</span><span class="o">=</span><span class="nv">$3</span>
    <span class="nb">local </span><span class="nv">user</span><span class="o">=</span><span class="nv">$4</span>
    <span class="nb">local </span><span class="nv">timeout_sec</span><span class="o">=</span><span class="nv">$5</span>
    <span class="nb">local </span><span class="nv">probe_cmd</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="nv">probe_cmd</span><span class="o">=</span><span class="sb">`</span>_get_probe_cmd_prefix <span class="nv">$from_net</span><span class="sb">`</span>
    <span class="k">if</span> ! timeout <span class="nv">$timeout_sec</span> sh -c <span class="s2">&quot;while ! $probe_cmd ssh -o StrictHostKeyChecking=no -i $key_file ${user}@$ip echo success; do sleep 1; done&quot;</span>; <span class="k">then</span>
<span class="k">        </span>die <span class="nv">$LINENO</span> <span class="s2">&quot;server didn&#39;t become ssh-able!&quot;</span>
    <span class="k">fi</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Neutron 3rd party programs</p>
</td><td class=code><div class=highlight><pre>
<span class="c">#---------------------------</span>

</pre></div></td></tr><tr><td class=docs>
<p>please refer to <tt class="docutils literal">lib/neutron_thirdparty/README.md</tt> for details</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">NEUTRON_THIRD_PARTIES</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
<span class="k">for </span>f in <span class="nv">$TOP_DIR</span>/lib/neutron_thirdparty/*; <span class="k">do</span>
<span class="k">    </span><span class="nv">third_party</span><span class="o">=</span><span class="k">$(</span>basename <span class="nv">$f</span><span class="k">)</span>
    <span class="k">if </span>is_service_enabled <span class="nv">$third_party</span>; <span class="k">then</span>
<span class="k">        </span><span class="nb">source</span> <span class="nv">$TOP_DIR</span>/lib/neutron_thirdparty/<span class="nv">$third_party</span>
        <span class="nv">NEUTRON_THIRD_PARTIES</span><span class="o">=</span><span class="s2">&quot;$NEUTRON_THIRD_PARTIES,$third_party&quot;</span>
    <span class="k">fi</span>
<span class="k">done</span>

<span class="k">function </span>_neutron_third_party_do <span class="o">{</span>
    <span class="k">for </span>third_party in <span class="k">${</span><span class="nv">NEUTRON_THIRD_PARTIES</span><span class="p">//,/ </span><span class="k">}</span>; <span class="k">do</span>
        <span class="k">${</span><span class="nv">1</span><span class="k">}</span>_<span class="k">${</span><span class="nv">third_party</span><span class="k">}</span>
    <span class="k">done</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>configure_neutron_third_party() - Set config files, create data dirs, etc</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>configure_neutron_third_party <span class="o">{</span>
    _neutron_third_party_do configure
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>init_neutron_third_party() - Initialize databases, etc.</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>init_neutron_third_party <span class="o">{</span>
    _neutron_third_party_do init
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>install_neutron_third_party() - Collect source and prepare</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>install_neutron_third_party <span class="o">{</span>
    _neutron_third_party_do install
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>start_neutron_third_party() - Start running processes, including screen</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>start_neutron_third_party <span class="o">{</span>
    _neutron_third_party_do start
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>stop_neutron_third_party - Stop running processes (non-screen)</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>stop_neutron_third_party <span class="o">{</span>
    _neutron_third_party_do stop
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>check_neutron_third_party_integration() - Check that third party integration is sane</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>check_neutron_third_party_integration <span class="o">{</span>
    _neutron_third_party_do check
<span class="o">}</span>

<span class="k">function </span>is_provider_network <span class="o">{</span>
    <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$Q_USE_PROVIDER_NETWORKING&quot;</span> <span class="o">==</span> <span class="s2">&quot;True&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="o">[</span> <span class="s2">&quot;$Q_L3_ENABLED&quot;</span> <span class="o">==</span> <span class="s2">&quot;False&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">        return </span>0
    <span class="k">fi</span>
<span class="k">    return </span>1
<span class="o">}</span>


</pre></div></td></tr><tr><td class=docs>
<p>Restore xtrace</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">$XTRACE</span>

</pre></div></td></tr><tr><td class=docs>
<p>Tell emacs to use shell-script-mode</p>
</td><td class=code><div class=highlight><pre>
<span class="c">## Local variables:</span>
<span class="c">## mode: shell-script</span>
<span class="c">## End:</span>


</td><td class=code><div class=highlight><pre>
</pre></div></td></tr><tr><td class=docs>
</pre></div></td></tr><tr><td class=docs>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
</div>
</div>
</body>
</html></td><td class='code'></td></tr>
    </tbody>
    </table>
</div>
</body>
</html>
