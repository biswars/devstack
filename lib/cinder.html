<!DOCTYPE html>
<html>
<head>
    <meta http-eqiv='content-type' content='text/html;charset=utf-8'>
    <title>cinder</title>
    <link rel=stylesheet href="http://jashkenas.github.com/docco/resources/docco.css">
</head>
<body>
<div id=container>
    <div id=background></div>
    <table cellspacing=0 cellpadding=0>
    <thead>
      <tr>
        <th class=docs><h1>cinder</h1></th>
        <th class=code></th>
      </tr>
    </thead>
    <tbody>
        <tr><td class='docs'><?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.11: http://docutils.sourceforge.net/" />
<title></title>
<style type="text/css">

/*
:Author: David Goodger (goodger@python.org)
:Id: $Id: html4css1.css 7614 2013-02-21 15:55:51Z milde $
:Copyright: This stylesheet has been placed in the public domain.

Default cascading style sheet for the HTML output of Docutils.

See http://docutils.sf.net/docs/howto/html-stylesheets.html for how to
customize this style sheet.
*/

/* used to remove borders from tables and images */
.borderless, table.borderless td, table.borderless th {
  border: 0 }

table.borderless td, table.borderless th {
  /* Override padding for "table.docutils td" with "! important".
     The right padding separates the table cells. */
  padding: 0 0.5em 0 0 ! important }

.first {
  /* Override more specific margin styles with "! important". */
  margin-top: 0 ! important }

.last, .with-subtitle {
  margin-bottom: 0 ! important }

.hidden {
  display: none }

a.toc-backref {
  text-decoration: none ;
  color: black }

blockquote.epigraph {
  margin: 2em 5em ; }

dl.docutils dd {
  margin-bottom: 0.5em }

object[type="image/svg+xml"], object[type="application/x-shockwave-flash"] {
  overflow: hidden;
}

/* Uncomment (and remove this text!) to get bold-faced definition list terms
dl.docutils dt {
  font-weight: bold }
*/

div.abstract {
  margin: 2em 5em }

div.abstract p.topic-title {
  font-weight: bold ;
  text-align: center }

div.admonition, div.attention, div.caution, div.danger, div.error,
div.hint, div.important, div.note, div.tip, div.warning {
  margin: 2em ;
  border: medium outset ;
  padding: 1em }

div.admonition p.admonition-title, div.hint p.admonition-title,
div.important p.admonition-title, div.note p.admonition-title,
div.tip p.admonition-title {
  font-weight: bold ;
  font-family: sans-serif }

div.attention p.admonition-title, div.caution p.admonition-title,
div.danger p.admonition-title, div.error p.admonition-title,
div.warning p.admonition-title, .code .error {
  color: red ;
  font-weight: bold ;
  font-family: sans-serif }

/* Uncomment (and remove this text!) to get reduced vertical space in
   compound paragraphs.
div.compound .compound-first, div.compound .compound-middle {
  margin-bottom: 0.5em }

div.compound .compound-last, div.compound .compound-middle {
  margin-top: 0.5em }
*/

div.dedication {
  margin: 2em 5em ;
  text-align: center ;
  font-style: italic }

div.dedication p.topic-title {
  font-weight: bold ;
  font-style: normal }

div.figure {
  margin-left: 2em ;
  margin-right: 2em }

div.footer, div.header {
  clear: both;
  font-size: smaller }

div.line-block {
  display: block ;
  margin-top: 1em ;
  margin-bottom: 1em }

div.line-block div.line-block {
  margin-top: 0 ;
  margin-bottom: 0 ;
  margin-left: 1.5em }

div.sidebar {
  margin: 0 0 0.5em 1em ;
  border: medium outset ;
  padding: 1em ;
  background-color: #ffffee ;
  width: 40% ;
  float: right ;
  clear: right }

div.sidebar p.rubric {
  font-family: sans-serif ;
  font-size: medium }

div.system-messages {
  margin: 5em }

div.system-messages h1 {
  color: red }

div.system-message {
  border: medium outset ;
  padding: 1em }

div.system-message p.system-message-title {
  color: red ;
  font-weight: bold }

div.topic {
  margin: 2em }

h1.section-subtitle, h2.section-subtitle, h3.section-subtitle,
h4.section-subtitle, h5.section-subtitle, h6.section-subtitle {
  margin-top: 0.4em }

h1.title {
  text-align: center }

h2.subtitle {
  text-align: center }

hr.docutils {
  width: 75% }

img.align-left, .figure.align-left, object.align-left {
  clear: left ;
  float: left ;
  margin-right: 1em }

img.align-right, .figure.align-right, object.align-right {
  clear: right ;
  float: right ;
  margin-left: 1em }

img.align-center, .figure.align-center, object.align-center {
  display: block;
  margin-left: auto;
  margin-right: auto;
}

.align-left {
  text-align: left }

.align-center {
  clear: both ;
  text-align: center }

.align-right {
  text-align: right }

/* reset inner alignment in figures */
div.align-right {
  text-align: inherit }

/* div.align-center * { */
/*   text-align: left } */

ol.simple, ul.simple {
  margin-bottom: 1em }

ol.arabic {
  list-style: decimal }

ol.loweralpha {
  list-style: lower-alpha }

ol.upperalpha {
  list-style: upper-alpha }

ol.lowerroman {
  list-style: lower-roman }

ol.upperroman {
  list-style: upper-roman }

p.attribution {
  text-align: right ;
  margin-left: 50% }

p.caption {
  font-style: italic }

p.credits {
  font-style: italic ;
  font-size: smaller }

p.label {
  white-space: nowrap }

p.rubric {
  font-weight: bold ;
  font-size: larger ;
  color: maroon ;
  text-align: center }

p.sidebar-title {
  font-family: sans-serif ;
  font-weight: bold ;
  font-size: larger }

p.sidebar-subtitle {
  font-family: sans-serif ;
  font-weight: bold }

p.topic-title {
  font-weight: bold }

pre.address {
  margin-bottom: 0 ;
  margin-top: 0 ;
  font: inherit }

pre.literal-block, pre.doctest-block, pre.math, pre.code {
  margin-left: 2em ;
  margin-right: 2em }

pre.code .ln { color: grey; } /* line numbers */
pre.code, code { background-color: #eeeeee }
pre.code .comment, code .comment { color: #5C6576 }
pre.code .keyword, code .keyword { color: #3B0D06; font-weight: bold }
pre.code .literal.string, code .literal.string { color: #0C5404 }
pre.code .name.builtin, code .name.builtin { color: #352B84 }
pre.code .deleted, code .deleted { background-color: #DEB0A1}
pre.code .inserted, code .inserted { background-color: #A3D289}

span.classifier {
  font-family: sans-serif ;
  font-style: oblique }

span.classifier-delimiter {
  font-family: sans-serif ;
  font-weight: bold }

span.interpreted {
  font-family: sans-serif }

span.option {
  white-space: nowrap }

span.pre {
  white-space: pre }

span.problematic {
  color: red }

span.section-subtitle {
  /* font-size relative to parent (h1..h6 element) */
  font-size: 80% }

table.citation {
  border-left: solid 1px gray;
  margin-left: 1px }

table.docinfo {
  margin: 2em 4em }

table.docutils {
  margin-top: 0.5em ;
  margin-bottom: 0.5em }

table.footnote {
  border-left: solid 1px black;
  margin-left: 1px }

table.docutils td, table.docutils th,
table.docinfo td, table.docinfo th {
  padding-left: 0.5em ;
  padding-right: 0.5em ;
  vertical-align: top }

table.docutils th.field-name, table.docinfo th.docinfo-name {
  font-weight: bold ;
  text-align: left ;
  white-space: nowrap ;
  padding-left: 0 }

/* "booktabs" style (no vertical lines) */
table.docutils.booktabs {
  border: 0px;
  border-top: 2px solid;
  border-bottom: 2px solid;
  border-collapse: collapse;
}
table.docutils.booktabs * {
  border: 0px;
}
table.docutils.booktabs th {
  border-bottom: thin solid;
  text-align: left;
}

h1 tt.docutils, h2 tt.docutils, h3 tt.docutils,
h4 tt.docutils, h5 tt.docutils, h6 tt.docutils {
  font-size: 100% }

ul.auto-toc {
  list-style-type: none }

</style>
</head>
<body>
<div class="document">


<p>lib/cinder
Install and start <strong>Cinder</strong> volume service
Dependencies:</p>
<ul class="simple">
<li>functions</li>
<li>DEST, DATA_DIR, STACK_USER must be defined</li>
<li>SERVICE_{TENANT_NAME|PASSWORD} must be defined</li>
<li><tt class="docutils literal">KEYSTONE_TOKEN_FORMAT</tt> must be defined</li>
</ul>
</td><td class=code><div class=highlight><pre>


</pre></div></td></tr><tr><td class=docs>
<div class="section" id="stack-sh">
<h1>stack.sh</h1>
<ul class="simple">
<li>install_cinder</li>
<li>configure_cinder</li>
<li>init_cinder</li>
<li>start_cinder</li>
<li>stop_cinder</li>
<li>cleanup_cinder</li>
</ul>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Save trace setting</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">XTRACE</span><span class="o">=</span><span class="k">$(</span><span class="nb">set</span> +o | grep xtrace<span class="k">)</span>
<span class="nb">set</span> +o xtrace


</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="defaults">
<h1>Defaults</h1>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>set up default driver</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">CINDER_DRIVER</span><span class="o">=</span><span class="k">${</span><span class="nv">CINDER_DRIVER</span><span class="k">:-</span><span class="nv">default</span><span class="k">}</span>
<span class="nv">CINDER_PLUGINS</span><span class="o">=</span><span class="nv">$TOP_DIR</span>/lib/cinder_plugins
<span class="nv">CINDER_BACKENDS</span><span class="o">=</span><span class="nv">$TOP_DIR</span>/lib/cinder_backends

</pre></div></td></tr><tr><td class=docs>
<p>grab plugin config if specified via cinder_driver</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if</span> <span class="o">[[</span> -r <span class="nv">$CINDER_PLUGINS</span>/<span class="nv">$CINDER_DRIVER</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nb">source</span> <span class="nv">$CINDER_PLUGINS</span>/<span class="nv">$CINDER_DRIVER</span>
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>set up default directories</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">CINDER_DIR</span><span class="o">=</span><span class="nv">$DEST</span>/cinder
<span class="nv">CINDERCLIENT_DIR</span><span class="o">=</span><span class="nv">$DEST</span>/python-cinderclient
<span class="nv">CINDER_STATE_PATH</span><span class="o">=</span><span class="k">${</span><span class="nv">CINDER_STATE_PATH</span><span class="p">:=</span><span class="nv">$DATA_DIR</span><span class="p">/cinder</span><span class="k">}</span>
<span class="nv">CINDER_AUTH_CACHE_DIR</span><span class="o">=</span><span class="k">${</span><span class="nv">CINDER_AUTH_CACHE_DIR</span><span class="k">:-</span><span class="p">/var/cache/cinder</span><span class="k">}</span>

<span class="nv">CINDER_CONF_DIR</span><span class="o">=</span>/etc/cinder
<span class="nv">CINDER_CONF</span><span class="o">=</span><span class="nv">$CINDER_CONF_DIR</span>/cinder.conf
<span class="nv">CINDER_API_PASTE_INI</span><span class="o">=</span><span class="nv">$CINDER_CONF_DIR</span>/api-paste.ini

</pre></div></td></tr><tr><td class=docs>
<p>Public facing bits</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">CINDER_SERVICE_HOST</span><span class="o">=</span><span class="k">${</span><span class="nv">CINDER_SERVICE_HOST</span><span class="k">:-</span><span class="nv">$SERVICE_HOST</span><span class="k">}</span>
<span class="nv">CINDER_SERVICE_PORT</span><span class="o">=</span><span class="k">${</span><span class="nv">CINDER_SERVICE_PORT</span><span class="k">:-</span><span class="nv">8776</span><span class="k">}</span>
<span class="nv">CINDER_SERVICE_PORT_INT</span><span class="o">=</span><span class="k">${</span><span class="nv">CINDER_SERVICE_PORT_INT</span><span class="k">:-</span><span class="nv">18776</span><span class="k">}</span>
<span class="nv">CINDER_SERVICE_PROTOCOL</span><span class="o">=</span><span class="k">${</span><span class="nv">CINDER_SERVICE_PROTOCOL</span><span class="k">:-</span><span class="nv">$SERVICE_PROTOCOL</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Support entry points installation of console scripts</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if</span> <span class="o">[[</span> -d <span class="nv">$CINDER_DIR</span>/bin <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nv">CINDER_BIN_DIR</span><span class="o">=</span><span class="nv">$CINDER_DIR</span>/bin
<span class="k">else</span>
<span class="k">    </span><span class="nv">CINDER_BIN_DIR</span><span class="o">=</span><span class="k">$(</span>get_python_exec_prefix<span class="k">)</span>
<span class="k">fi</span>


</pre></div></td></tr><tr><td class=docs>
<p>Maintain this here for backward-compatibility with the old configuration
DEPRECATED: Use CINDER_ENABLED_BACKENDS instead
Support for multi lvm backend configuration (default is no support)</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">CINDER_MULTI_LVM_BACKEND</span><span class="o">=</span><span class="k">$(</span>trueorfalse False <span class="nv">$CINDER_MULTI_LVM_BACKEND</span><span class="k">)</span>

</pre></div></td></tr><tr><td class=docs>
<p>Default backends
The backend format is type:name where type is one of the supported backend
types (lvm, nfs, etc) and name is the identifier used in the Cinder
configuration and for the volume type name.  Multiple backends are
comma-separated.</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if</span> <span class="o">[[</span> <span class="nv">$CINDER_MULTI_LVM_BACKEND</span> <span class="o">==</span> <span class="s2">&quot;False&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nv">CINDER_ENABLED_BACKENDS</span><span class="o">=</span><span class="k">${</span><span class="nv">CINDER_ENABLED_BACKENDS</span><span class="k">:-</span><span class="nv">lvm</span><span class="p">:</span><span class="nv">lvmdriver</span><span class="p">-1</span><span class="k">}</span>
<span class="k">else</span>
<span class="k">    </span><span class="nv">CINDER_ENABLED_BACKENDS</span><span class="o">=</span><span class="k">${</span><span class="nv">CINDER_ENABLED_BACKENDS</span><span class="k">:-</span><span class="nv">lvm</span><span class="p">:</span><span class="nv">lvmdriver</span><span class="p">-1,lvm:</span><span class="nv">lvmdriver</span><span class="p">-2</span><span class="k">}</span>
<span class="k">fi</span>


</pre></div></td></tr><tr><td class=docs>
<p>Should cinder perform secure deletion of volumes?
Defaults to true, can be set to False to avoid this bug when testing:
<a class="reference external" href="https://bugs.launchpad.net/ubuntu/+source/linux/+bug/1023755">https://bugs.launchpad.net/ubuntu/+source/linux/+bug/1023755</a></p>
</td><td class=code><div class=highlight><pre>
<span class="nv">CINDER_SECURE_DELETE</span><span class="o">=</span><span class="sb">`</span>trueorfalse True <span class="nv">$CINDER_SECURE_DELETE</span><span class="sb">`</span>

</pre></div></td></tr><tr><td class=docs>
<p>Cinder reports allocations back to the scheduler on periodic intervals
it turns out we can get an &quot;out of space&quot; issue when we run tests too
quickly just because cinder didn't realize we'd freed up resources.
Make this configurable so that devstack-gate/tempest can set it to
less than the 60 second default
<a class="reference external" href="https://bugs.launchpad.net/cinder/+bug/1180976">https://bugs.launchpad.net/cinder/+bug/1180976</a></p>
</td><td class=code><div class=highlight><pre>
<span class="nv">CINDER_PERIODIC_INTERVAL</span><span class="o">=</span><span class="k">${</span><span class="nv">CINDER_PERIODIC_INTERVAL</span><span class="k">:-</span><span class="nv">60</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Tell Tempest this project is present</p>
</td><td class=code><div class=highlight><pre>
TEMPEST_SERVICES+<span class="o">=</span>,cinder


</pre></div></td></tr><tr><td class=docs>
<p>Source the enabled backends</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if </span>is_service_enabled c-vol <span class="o">&amp;&amp;</span> <span class="o">[[</span> -n <span class="s2">&quot;$CINDER_ENABLED_BACKENDS&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    for </span>be in <span class="k">${</span><span class="nv">CINDER_ENABLED_BACKENDS</span><span class="p">//,/ </span><span class="k">}</span>; <span class="k">do</span>
<span class="k">        </span><span class="nv">BE_TYPE</span><span class="o">=</span><span class="k">${</span><span class="nv">be</span><span class="p">%%:*</span><span class="k">}</span>
        <span class="nv">BE_NAME</span><span class="o">=</span><span class="k">${</span><span class="nv">be</span><span class="p">##*:</span><span class="k">}</span>
        <span class="k">if</span> <span class="o">[[</span> -r <span class="nv">$CINDER_BACKENDS</span>/<span class="k">${</span><span class="nv">BE_TYPE</span><span class="k">}</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            </span><span class="nb">source</span> <span class="nv">$CINDER_BACKENDS</span>/<span class="k">${</span><span class="nv">BE_TYPE</span><span class="k">}</span>
        <span class="k">fi</span>
<span class="k">    done</span>
<span class="k">fi</span>


</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="functions">
<h1>Functions</h1>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Test if any Cinder services are enabled
is_cinder_enabled</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>is_cinder_enabled <span class="o">{</span>
    <span class="o">[[</span> ,<span class="k">${</span><span class="nv">ENABLED_SERVICES</span><span class="k">}</span> <span class="o">=</span>~ ,<span class="s2">&quot;c-&quot;</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="k">return </span>0
    <span class="k">return </span>1
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>cleanup_cinder() - Remove residual data files, anything left over from previous
runs that a clean run would need to clean up</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>cleanup_cinder <span class="o">{</span>
</pre></div></td></tr><tr><td class=docs>
<p>ensure the volume group is cleared up because fails might
leave dead volumes in the group</p>
</td><td class=code><div class=highlight><pre>
    <span class="nv">TARGETS</span><span class="o">=</span><span class="k">$(</span>sudo tgtadm --op show --mode target<span class="k">)</span>
    <span class="k">if</span> <span class="o">[</span> <span class="nv">$?</span> -ne 0 <span class="o">]</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>If tgt driver isn't running this won't work obviously
So check the response and restart if need be</p>
</td><td class=code><div class=highlight><pre>
        <span class="nb">echo</span> <span class="s2">&quot;tgtd seems to be in a bad state, restarting...&quot;</span>
        <span class="k">if </span>is_ubuntu; <span class="k">then</span>
<span class="k">            </span>restart_service tgt
        <span class="k">else</span>
<span class="k">            </span>restart_service tgtd
        <span class="k">fi</span>
<span class="k">        </span><span class="nv">TARGETS</span><span class="o">=</span><span class="k">$(</span>sudo tgtadm --op show --mode target<span class="k">)</span>
    <span class="k">fi</span>

<span class="k">    if</span> <span class="o">[[</span> -n <span class="s2">&quot;$TARGETS&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nv">iqn_list</span><span class="o">=(</span> <span class="k">$(</span>grep --no-filename -r iqn <span class="nv">$SCSI_PERSIST_DIR</span> | sed <span class="s1">&#39;s/&lt;target //&#39;</span> | sed <span class="s1">&#39;s/&gt;//&#39;</span><span class="k">)</span> <span class="o">)</span>
        <span class="k">for </span>i in <span class="s2">&quot;${iqn_list[@]}&quot;</span>; <span class="k">do</span>
<span class="k">            </span><span class="nb">echo </span>removing iSCSI target: <span class="nv">$i</span>
            sudo tgt-admin --delete <span class="nv">$i</span>
        <span class="k">done</span>
<span class="k">    fi</span>

<span class="k">    if </span>is_ubuntu; <span class="k">then</span>
<span class="k">        </span>stop_service tgt
    <span class="k">else</span>
<span class="k">        </span>stop_service tgtd
    <span class="k">fi</span>

<span class="k">    if </span>is_service_enabled c-vol <span class="o">&amp;&amp;</span> <span class="o">[[</span> -n <span class="s2">&quot;$CINDER_ENABLED_BACKENDS&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        for </span>be in <span class="k">${</span><span class="nv">CINDER_ENABLED_BACKENDS</span><span class="p">//,/ </span><span class="k">}</span>; <span class="k">do</span>
<span class="k">            </span><span class="nv">BE_TYPE</span><span class="o">=</span><span class="k">${</span><span class="nv">be</span><span class="p">%%:*</span><span class="k">}</span>
            <span class="nv">BE_NAME</span><span class="o">=</span><span class="k">${</span><span class="nv">be</span><span class="p">##*:</span><span class="k">}</span>
            <span class="k">if </span><span class="nb">type </span>cleanup_cinder_backend_<span class="k">${</span><span class="nv">BE_TYPE</span><span class="k">}</span> &gt;/dev/null 2&gt;&amp;1; <span class="k">then</span>
<span class="k">                </span>cleanup_cinder_backend_<span class="k">${</span><span class="nv">BE_TYPE</span><span class="k">}</span> <span class="k">${</span><span class="nv">BE_NAME</span><span class="k">}</span>
            <span class="k">fi</span>
<span class="k">        done</span>
<span class="k">    fi</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>configure_cinder_rootwrap() - configure Cinder's rootwrap</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>configure_cinder_rootwrap <span class="o">{</span>
</pre></div></td></tr><tr><td class=docs>
<p>Set the paths of certain binaries</p>
</td><td class=code><div class=highlight><pre>
    <span class="nv">CINDER_ROOTWRAP</span><span class="o">=</span><span class="k">$(</span>get_rootwrap_location cinder<span class="k">)</span>

</pre></div></td></tr><tr><td class=docs>
<p>Deploy new rootwrap filters files (owned by root).
Wipe any existing rootwrap.d files first</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">if</span> <span class="o">[[</span> -d <span class="nv">$CINDER_CONF_DIR</span>/rootwrap.d <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span>sudo rm -rf <span class="nv">$CINDER_CONF_DIR</span>/rootwrap.d
    <span class="k">fi</span>
</pre></div></td></tr><tr><td class=docs>
<p>Deploy filters to /etc/cinder/rootwrap.d</p>
</td><td class=code><div class=highlight><pre>
    sudo mkdir -m 755 <span class="nv">$CINDER_CONF_DIR</span>/rootwrap.d
    sudo cp <span class="nv">$CINDER_DIR</span>/etc/cinder/rootwrap.d/*.filters <span class="nv">$CINDER_CONF_DIR</span>/rootwrap.d
    sudo chown -R root:root <span class="nv">$CINDER_CONF_DIR</span>/rootwrap.d
    sudo chmod 644 <span class="nv">$CINDER_CONF_DIR</span>/rootwrap.d/*
</pre></div></td></tr><tr><td class=docs>
<p>Set up rootwrap.conf, pointing to /etc/cinder/rootwrap.d</p>
</td><td class=code><div class=highlight><pre>
    sudo cp <span class="nv">$CINDER_DIR</span>/etc/cinder/rootwrap.conf <span class="nv">$CINDER_CONF_DIR</span>/
    sudo sed -e <span class="s2">&quot;s:^filters_path=.*$:filters_path=$CINDER_CONF_DIR/rootwrap.d:&quot;</span> -i <span class="nv">$CINDER_CONF_DIR</span>/rootwrap.conf
    sudo chown root:root <span class="nv">$CINDER_CONF_DIR</span>/rootwrap.conf
    sudo chmod 0644 <span class="nv">$CINDER_CONF_DIR</span>/rootwrap.conf
</pre></div></td></tr><tr><td class=docs>
<p>Specify rootwrap.conf as first parameter to rootwrap</p>
</td><td class=code><div class=highlight><pre>
    <span class="nv">ROOTWRAP_CSUDOER_CMD</span><span class="o">=</span><span class="s2">&quot;$CINDER_ROOTWRAP $CINDER_CONF_DIR/rootwrap.conf *&quot;</span>

</pre></div></td></tr><tr><td class=docs>
<p>Set up the rootwrap sudoers for cinder</p>
</td><td class=code><div class=highlight><pre>
    <span class="nv">TEMPFILE</span><span class="o">=</span><span class="sb">`</span>mktemp<span class="sb">`</span>
    <span class="nb">echo</span> <span class="s2">&quot;$STACK_USER ALL=(root) NOPASSWD: $ROOTWRAP_CSUDOER_CMD&quot;</span> &gt;<span class="nv">$TEMPFILE</span>
    chmod 0440 <span class="nv">$TEMPFILE</span>
    sudo chown root:root <span class="nv">$TEMPFILE</span>
    sudo mv <span class="nv">$TEMPFILE</span> /etc/sudoers.d/cinder-rootwrap
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>configure_cinder() - Set config files, create data dirs, etc</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>configure_cinder <span class="o">{</span>
    <span class="k">if</span> <span class="o">[[</span> ! -d <span class="nv">$CINDER_CONF_DIR</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span>sudo mkdir -p <span class="nv">$CINDER_CONF_DIR</span>
    <span class="k">fi</span>
<span class="k">    </span>sudo chown <span class="nv">$STACK_USER</span> <span class="nv">$CINDER_CONF_DIR</span>

    cp -p <span class="nv">$CINDER_DIR</span>/etc/cinder/policy.json <span class="nv">$CINDER_CONF_DIR</span>

    configure_cinder_rootwrap

    cp <span class="nv">$CINDER_DIR</span>/etc/cinder/api-paste.ini <span class="nv">$CINDER_API_PASTE_INI</span>

    inicomment <span class="nv">$CINDER_API_PASTE_INI</span> filter:authtoken auth_host
    inicomment <span class="nv">$CINDER_API_PASTE_INI</span> filter:authtoken auth_port
    inicomment <span class="nv">$CINDER_API_PASTE_INI</span> filter:authtoken auth_protocol
    inicomment <span class="nv">$CINDER_API_PASTE_INI</span> filter:authtoken cafile
    inicomment <span class="nv">$CINDER_API_PASTE_INI</span> filter:authtoken admin_tenant_name
    inicomment <span class="nv">$CINDER_API_PASTE_INI</span> filter:authtoken admin_user
    inicomment <span class="nv">$CINDER_API_PASTE_INI</span> filter:authtoken admin_password
    inicomment <span class="nv">$CINDER_API_PASTE_INI</span> filter:authtoken signing_dir

    iniset <span class="nv">$CINDER_CONF</span> keystone_authtoken identity_uri <span class="nv">$KEYSTONE_AUTH_URI</span>
    iniset <span class="nv">$CINDER_CONF</span> keystone_authtoken cafile <span class="nv">$KEYSTONE_SSL_CA</span>
    iniset <span class="nv">$CINDER_CONF</span> keystone_authtoken admin_tenant_name <span class="nv">$SERVICE_TENANT_NAME</span>
    iniset <span class="nv">$CINDER_CONF</span> keystone_authtoken admin_user cinder
    iniset <span class="nv">$CINDER_CONF</span> keystone_authtoken admin_password <span class="nv">$SERVICE_PASSWORD</span>
    iniset <span class="nv">$CINDER_CONF</span> keystone_authtoken signing_dir <span class="nv">$CINDER_AUTH_CACHE_DIR</span>

    iniset <span class="nv">$CINDER_CONF</span> DEFAULT auth_strategy keystone
    iniset <span class="nv">$CINDER_CONF</span> DEFAULT debug <span class="nv">$ENABLE_DEBUG_LOG_LEVEL</span>
    iniset <span class="nv">$CINDER_CONF</span> DEFAULT verbose True

    iniset <span class="nv">$CINDER_CONF</span> DEFAULT my_ip <span class="s2">&quot;$CINDER_SERVICE_HOST&quot;</span>
    iniset <span class="nv">$CINDER_CONF</span> DEFAULT iscsi_helper tgtadm
    iniset <span class="nv">$CINDER_CONF</span> DEFAULT sql_connection <span class="sb">`</span>database_connection_url cinder<span class="sb">`</span>
    iniset <span class="nv">$CINDER_CONF</span> DEFAULT api_paste_config <span class="nv">$CINDER_API_PASTE_INI</span>
    iniset <span class="nv">$CINDER_CONF</span> DEFAULT rootwrap_config <span class="s2">&quot;$CINDER_CONF_DIR/rootwrap.conf&quot;</span>
    iniset <span class="nv">$CINDER_CONF</span> DEFAULT osapi_volume_extension cinder.api.contrib.standard_extensions
    iniset <span class="nv">$CINDER_CONF</span> DEFAULT state_path <span class="nv">$CINDER_STATE_PATH</span>
    iniset <span class="nv">$CINDER_CONF</span> DEFAULT lock_path <span class="nv">$CINDER_STATE_PATH</span>
    iniset <span class="nv">$CINDER_CONF</span> DEFAULT periodic_interval <span class="nv">$CINDER_PERIODIC_INTERVAL</span>
</pre></div></td></tr><tr><td class=docs>
<p>NOTE(thingee): Cinder V1 API is deprecated and defaults to off as of
Juno. Keep it enabled so we can continue testing while it's still
supported.</p>
</td><td class=code><div class=highlight><pre>
    iniset <span class="nv">$CINDER_CONF</span> DEFAULT enable_v1_api <span class="nb">true</span>

<span class="nb">    </span><span class="k">if </span>is_service_enabled c-vol <span class="o">&amp;&amp;</span> <span class="o">[[</span> -n <span class="s2">&quot;$CINDER_ENABLED_BACKENDS&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nv">enabled_backends</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
        <span class="nv">default_type</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
        <span class="k">for </span>be in <span class="k">${</span><span class="nv">CINDER_ENABLED_BACKENDS</span><span class="p">//,/ </span><span class="k">}</span>; <span class="k">do</span>
<span class="k">            </span><span class="nv">BE_TYPE</span><span class="o">=</span><span class="k">${</span><span class="nv">be</span><span class="p">%%:*</span><span class="k">}</span>
            <span class="nv">BE_NAME</span><span class="o">=</span><span class="k">${</span><span class="nv">be</span><span class="p">##*:</span><span class="k">}</span>
            <span class="k">if </span><span class="nb">type </span>configure_cinder_backend_<span class="k">${</span><span class="nv">BE_TYPE</span><span class="k">}</span> &gt;/dev/null 2&gt;&amp;1; <span class="k">then</span>
<span class="k">                </span>configure_cinder_backend_<span class="k">${</span><span class="nv">BE_TYPE</span><span class="k">}</span> <span class="k">${</span><span class="nv">BE_NAME</span><span class="k">}</span>
            <span class="k">fi</span>
<span class="k">            if</span> <span class="o">[[</span> -z <span class="s2">&quot;$default_type&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">                </span><span class="nv">default_type</span><span class="o">=</span><span class="nv">$BE_TYPE</span>
            <span class="k">fi</span>
<span class="k">            </span>enabled_backends+<span class="o">=</span><span class="nv">$BE_NAME</span>,
        <span class="k">done</span>
<span class="k">        </span>iniset <span class="nv">$CINDER_CONF</span> DEFAULT enabled_backends <span class="k">${</span><span class="nv">enabled_backends</span><span class="p">%,*</span><span class="k">}</span>
        <span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&quot;$default_type&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            </span>iniset <span class="nv">$CINDER_CONF</span> DEFAULT default_volume_type <span class="k">${</span><span class="nv">default_type</span><span class="k">}</span>
        <span class="k">fi</span>
<span class="k">    fi</span>

<span class="k">    if </span>is_service_enabled swift; <span class="k">then</span>
<span class="k">        </span>iniset <span class="nv">$CINDER_CONF</span> DEFAULT backup_swift_url <span class="s2">&quot;http://$SERVICE_HOST:8080/v1/AUTH_&quot;</span>
    <span class="k">fi</span>

<span class="k">    if </span>is_service_enabled ceilometer; <span class="k">then</span>
<span class="k">        </span>iniset <span class="nv">$CINDER_CONF</span> DEFAULT notification_driver <span class="s2">&quot;messaging&quot;</span>
    <span class="k">fi</span>

<span class="k">    if </span>is_service_enabled tls-proxy; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>Set the service port for a proxy to take the original</p>
</td><td class=code><div class=highlight><pre>
        iniset <span class="nv">$CINDER_CONF</span> DEFAULT osapi_volume_listen_port <span class="nv">$CINDER_SERVICE_PORT_INT</span>
    <span class="k">fi</span>

<span class="k">    if</span> <span class="o">[</span> <span class="s2">&quot;$SYSLOG&quot;</span> !<span class="o">=</span> <span class="s2">&quot;False&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">        </span>iniset <span class="nv">$CINDER_CONF</span> DEFAULT use_syslog True
    <span class="k">fi</span>

<span class="k">    </span>iniset_rpc_backend cinder <span class="nv">$CINDER_CONF</span> DEFAULT

    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$CINDER_SECURE_DELETE&quot;</span> <span class="o">==</span> <span class="s2">&quot;False&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span>iniset <span class="nv">$CINDER_CONF</span> DEFAULT secure_delete False
        iniset <span class="nv">$CINDER_CONF</span> DEFAULT volume_clear none
    <span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Format logging</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$LOG_COLOR&quot;</span> <span class="o">==</span> <span class="s2">&quot;True&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="o">[</span> <span class="s2">&quot;$SYSLOG&quot;</span> <span class="o">==</span> <span class="s2">&quot;False&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">        </span>setup_colorized_logging <span class="nv">$CINDER_CONF</span> DEFAULT <span class="s2">&quot;project_id&quot;</span> <span class="s2">&quot;user_id&quot;</span>
    <span class="k">fi</span>

<span class="k">    if</span> <span class="o">[[</span> -r <span class="nv">$CINDER_PLUGINS</span>/<span class="nv">$CINDER_DRIVER</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span>configure_cinder_driver
    <span class="k">fi</span>

<span class="k">    if</span> <span class="o">[[</span> is_fedora <span class="o">&amp;&amp;</span> <span class="nv">$DISTRO</span> <span class="o">=</span>~ <span class="o">(</span>rhel6<span class="o">)</span> <span class="o">]]</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>Cinder clones are slightly larger due to some extra
metadata.  RHEL6 will not allow auto-extending of LV's
without this, leading to clones giving hard-to-track disk
I/O errors.
see <a class="reference external" href="https://bugzilla.redhat.com/show_bug.cgi?id=975052">https://bugzilla.redhat.com/show_bug.cgi?id=975052</a></p>
</td><td class=code><div class=highlight><pre>
        sudo sed -i~ <span class="se">\</span>
            -e <span class="s1">&#39;s/snapshot_autoextend_threshold =.*/snapshot_autoextend_threshold = 80/&#39;</span> <span class="se">\</span>
            -e <span class="s1">&#39;s/snapshot_autoextend_percent =.*/snapshot_autoextend_percent = 20/&#39;</span> <span class="se">\</span>
            /etc/lvm/lvm.conf
    <span class="k">fi</span>
<span class="k">    </span>configure_API_version <span class="nv">$CINDER_CONF</span> <span class="nv">$IDENTITY_API_VERSION</span>
    iniset <span class="nv">$CINDER_CONF</span> keystone_authtoken admin_user cinder
    iniset <span class="nv">$CINDER_CONF</span> keystone_authtoken admin_tenant_name <span class="nv">$SERVICE_TENANT_NAME</span>
    iniset <span class="nv">$CINDER_CONF</span> keystone_authtoken admin_password <span class="nv">$SERVICE_PASSWORD</span>

<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>create_cinder_accounts() - Set up common required cinder accounts</p>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="tenant-user-roles">
<h1>Tenant               User       Roles</h1>
<p>service              cinder     admin        # if enabled</p>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Migrated from keystone_data.sh</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>create_cinder_accounts <span class="o">{</span>

    <span class="nv">SERVICE_TENANT</span><span class="o">=</span><span class="k">$(</span>openstack project list | awk <span class="s2">&quot;/ $SERVICE_TENANT_NAME / { print \$2 }&quot;</span><span class="k">)</span>
    <span class="nv">ADMIN_ROLE</span><span class="o">=</span><span class="k">$(</span>openstack role list | awk <span class="s2">&quot;/ admin / { print \$2 }&quot;</span><span class="k">)</span>

</pre></div></td></tr><tr><td class=docs>
<p>Cinder</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$ENABLED_SERVICES&quot;</span> <span class="o">=</span>~ <span class="s2">&quot;c-api&quot;</span> <span class="o">]]</span>; <span class="k">then</span>

<span class="k">        </span><span class="nv">CINDER_USER</span><span class="o">=</span><span class="k">$(</span>get_or_create_user <span class="s2">&quot;cinder&quot;</span> <span class="se">\</span>
            <span class="s2">&quot;$SERVICE_PASSWORD&quot;</span> <span class="nv">$SERVICE_TENANT</span><span class="k">)</span>
        get_or_add_user_role <span class="nv">$ADMIN_ROLE</span> <span class="nv">$CINDER_USER</span> <span class="nv">$SERVICE_TENANT</span>

        <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$KEYSTONE_CATALOG_BACKEND&quot;</span> <span class="o">=</span> <span class="s1">&#39;sql&#39;</span> <span class="o">]]</span>; <span class="k">then</span>

<span class="k">            </span><span class="nv">CINDER_SERVICE</span><span class="o">=</span><span class="k">$(</span>get_or_create_service <span class="s2">&quot;cinder&quot;</span> <span class="se">\</span>
                <span class="s2">&quot;volume&quot;</span> <span class="s2">&quot;Cinder Volume Service&quot;</span><span class="k">)</span>
            get_or_create_endpoint <span class="nv">$CINDER_SERVICE</span> <span class="s2">&quot;$REGION_NAME&quot;</span> <span class="se">\</span>
                <span class="s2">&quot;$CINDER_SERVICE_PROTOCOL://$CINDER_SERVICE_HOST:$CINDER_SERVICE_PORT/v1/\$(tenant_id)s&quot;</span> <span class="se">\</span>
                <span class="s2">&quot;$CINDER_SERVICE_PROTOCOL://$CINDER_SERVICE_HOST:$CINDER_SERVICE_PORT/v1/\$(tenant_id)s&quot;</span> <span class="se">\</span>
                <span class="s2">&quot;$CINDER_SERVICE_PROTOCOL://$CINDER_SERVICE_HOST:$CINDER_SERVICE_PORT/v1/\$(tenant_id)s&quot;</span>

            <span class="nv">CINDER_V2_SERVICE</span><span class="o">=</span><span class="k">$(</span>get_or_create_service <span class="s2">&quot;cinderv2&quot;</span> <span class="se">\</span>
                <span class="s2">&quot;volumev2&quot;</span> <span class="s2">&quot;Cinder Volume Service V2&quot;</span><span class="k">)</span>
            get_or_create_endpoint <span class="nv">$CINDER_V2_SERVICE</span> <span class="s2">&quot;$REGION_NAME&quot;</span> <span class="se">\</span>
                <span class="s2">&quot;$CINDER_SERVICE_PROTOCOL://$CINDER_SERVICE_HOST:$CINDER_SERVICE_PORT/v2/\$(tenant_id)s&quot;</span> <span class="se">\</span>
                <span class="s2">&quot;$CINDER_SERVICE_PROTOCOL://$CINDER_SERVICE_HOST:$CINDER_SERVICE_PORT/v2/\$(tenant_id)s&quot;</span> <span class="se">\</span>
                <span class="s2">&quot;$CINDER_SERVICE_PROTOCOL://$CINDER_SERVICE_HOST:$CINDER_SERVICE_PORT/v2/\$(tenant_id)s&quot;</span>
        <span class="k">fi</span>
<span class="k">    fi</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>create_cinder_cache_dir() - Part of the init_cinder() process</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>create_cinder_cache_dir <span class="o">{</span>
</pre></div></td></tr><tr><td class=docs>
<p>Create cache dir</p>
</td><td class=code><div class=highlight><pre>
    sudo mkdir -p <span class="nv">$CINDER_AUTH_CACHE_DIR</span>
    sudo chown <span class="nv">$STACK_USER</span> <span class="nv">$CINDER_AUTH_CACHE_DIR</span>
    rm -f <span class="nv">$CINDER_AUTH_CACHE_DIR</span>/*
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>init_cinder() - Initialize database and volume group</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>init_cinder <span class="o">{</span>
</pre></div></td></tr><tr><td class=docs>
<p>Force nova volumes off</p>
</td><td class=code><div class=highlight><pre>
    <span class="nv">NOVA_ENABLED_APIS</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$NOVA_ENABLED_APIS</span> | sed <span class="s2">&quot;s/osapi_volume,//&quot;</span><span class="k">)</span>

    <span class="k">if </span>is_service_enabled <span class="nv">$DATABASE_BACKENDS</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>(Re)create cinder database</p>
</td><td class=code><div class=highlight><pre>
        recreate_database cinder utf8

</pre></div></td></tr><tr><td class=docs>
<p>Migrate cinder database</p>
</td><td class=code><div class=highlight><pre>
        <span class="nv">$CINDER_BIN_DIR</span>/cinder-manage db sync
    <span class="k">fi</span>

<span class="k">    if </span>is_service_enabled c-vol <span class="o">&amp;&amp;</span> <span class="o">[[</span> -n <span class="s2">&quot;$CINDER_ENABLED_BACKENDS&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        for </span>be in <span class="k">${</span><span class="nv">CINDER_ENABLED_BACKENDS</span><span class="p">//,/ </span><span class="k">}</span>; <span class="k">do</span>
<span class="k">            </span><span class="nv">BE_TYPE</span><span class="o">=</span><span class="k">${</span><span class="nv">be</span><span class="p">%%:*</span><span class="k">}</span>
            <span class="nv">BE_NAME</span><span class="o">=</span><span class="k">${</span><span class="nv">be</span><span class="p">##*:</span><span class="k">}</span>
            <span class="k">if </span><span class="nb">type </span>init_cinder_backend_<span class="k">${</span><span class="nv">BE_TYPE</span><span class="k">}</span> &gt;/dev/null 2&gt;&amp;1; <span class="k">then</span>
<span class="k">                </span>init_cinder_backend_<span class="k">${</span><span class="nv">BE_TYPE</span><span class="k">}</span> <span class="k">${</span><span class="nv">BE_NAME</span><span class="k">}</span>
            <span class="k">fi</span>
<span class="k">        done</span>
<span class="k">    fi</span>

<span class="k">    </span>mkdir -p <span class="nv">$CINDER_STATE_PATH</span>/volumes
    create_cinder_cache_dir
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>install_cinder() - Collect source and prepare</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>install_cinder <span class="o">{</span>
    git_clone <span class="nv">$CINDER_REPO</span> <span class="nv">$CINDER_DIR</span> <span class="nv">$CINDER_BRANCH</span>
    setup_develop <span class="nv">$CINDER_DIR</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>install_cinderclient() - Collect source and prepare</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>install_cinderclient <span class="o">{</span>
    git_clone <span class="nv">$CINDERCLIENT_REPO</span> <span class="nv">$CINDERCLIENT_DIR</span> <span class="nv">$CINDERCLIENT_BRANCH</span>
    setup_develop <span class="nv">$CINDERCLIENT_DIR</span>
    sudo install -D -m 0644 -o <span class="nv">$STACK_USER</span> <span class="o">{</span><span class="nv">$CINDERCLIENT_DIR</span>/tools/,/etc/bash_completion.d/<span class="o">}</span>cinder.bash_completion
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>apply config.d approach for cinder volumes directory</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>_configure_tgt_for_config_d <span class="o">{</span>
    <span class="k">if</span> <span class="o">[[</span> ! -d /etc/tgt/stack.d/ <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span>sudo ln -sf <span class="nv">$CINDER_STATE_PATH</span>/volumes /etc/tgt/stack.d
        <span class="nb">echo</span> <span class="s2">&quot;include /etc/tgt/stack.d/*&quot;</span> | sudo tee -a /etc/tgt/targets.conf
    <span class="k">fi</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>start_cinder() - Start running processes, including screen</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>start_cinder <span class="o">{</span>
    <span class="k">if </span>is_service_enabled c-vol; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>Delete any old stack.conf</p>
</td><td class=code><div class=highlight><pre>
        sudo rm -f /etc/tgt/conf.d/stack.conf
        _configure_tgt_for_config_d
        <span class="k">if </span>is_ubuntu; <span class="k">then</span>
<span class="k">            </span>sudo service tgt restart
        <span class="k">elif </span>is_fedora; <span class="k">then</span>
<span class="k">            if</span> <span class="o">[[</span> <span class="nv">$DISTRO</span> <span class="o">=</span>~ <span class="o">(</span>rhel6<span class="o">)</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">                </span>sudo /sbin/service tgtd restart
            <span class="k">else</span>
</pre></div></td></tr><tr><td class=docs>
<p>bypass redirection to systemctl during restart</p>
</td><td class=code><div class=highlight><pre>
                sudo /sbin/service --skip-redirect tgtd restart
            <span class="k">fi</span>
<span class="k">        elif </span>is_suse; <span class="k">then</span>
<span class="k">            </span>restart_service tgtd
        <span class="k">else</span>
</pre></div></td></tr><tr><td class=docs>
<p>note for other distros: unstack.sh also uses the tgt/tgtd service
name, and would need to be adjusted too</p>
</td><td class=code><div class=highlight><pre>
            exit_distro_not_supported <span class="s2">&quot;restarting tgt&quot;</span>
        <span class="k">fi</span>
</pre></div></td></tr><tr><td class=docs>
<p>NOTE(gfidente): ensure tgtd is running in debug mode</p>
</td><td class=code><div class=highlight><pre>
        sudo tgtadm --mode system --op update --name debug --value on
    <span class="k">fi</span>

<span class="k">    </span>screen_it c-api <span class="s2">&quot;cd $CINDER_DIR &amp;&amp; $CINDER_BIN_DIR/cinder-api --config-file $CINDER_CONF&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;Waiting for Cinder API to start...&quot;</span>
    <span class="k">if</span> ! wait_for_service <span class="nv">$SERVICE_TIMEOUT</span> <span class="nv">$CINDER_SERVICE_PROTOCOL</span>://<span class="nv">$CINDER_SERVICE_HOST</span>:<span class="nv">$CINDER_SERVICE_PORT</span>; <span class="k">then</span>
<span class="k">        </span>die <span class="nv">$LINENO</span> <span class="s2">&quot;c-api did not start&quot;</span>
    <span class="k">fi</span>

<span class="k">    </span>screen_it c-sch <span class="s2">&quot;cd $CINDER_DIR &amp;&amp; $CINDER_BIN_DIR/cinder-scheduler --config-file $CINDER_CONF&quot;</span>
    screen_it c-bak <span class="s2">&quot;cd $CINDER_DIR &amp;&amp; $CINDER_BIN_DIR/cinder-backup --config-file $CINDER_CONF&quot;</span>
    screen_it c-vol <span class="s2">&quot;cd $CINDER_DIR &amp;&amp; $CINDER_BIN_DIR/cinder-volume --config-file $CINDER_CONF&quot;</span>

</pre></div></td></tr><tr><td class=docs>
<p>NOTE(jdg): For cinder, startup order matters.  To ensure that repor_capabilities is received
by the scheduler start the cinder-volume service last (or restart it) after the scheduler
has started.  This is a quick fix for lp bug/1189595</p>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Start proxies if enabled</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">if </span>is_service_enabled c-api <span class="o">&amp;&amp;</span> is_service_enabled tls-proxy; <span class="k">then</span>
<span class="k">        </span>start_tls_proxy <span class="s1">&#39;*&#39;</span> <span class="nv">$CINDER_SERVICE_PORT</span> <span class="nv">$CINDER_SERVICE_HOST</span> <span class="nv">$CINDER_SERVICE_PORT_INT</span> &amp;
    <span class="k">fi</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>stop_cinder() - Stop running processes</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>stop_cinder <span class="o">{</span>
</pre></div></td></tr><tr><td class=docs>
<p>Kill the cinder screen windows</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">for </span>serv in c-api c-bak c-sch c-vol; <span class="k">do</span>
<span class="k">        </span>screen_stop <span class="nv">$serv</span>
    <span class="k">done</span>

<span class="k">    if </span>is_service_enabled c-vol; <span class="k">then</span>
<span class="k">        if </span>is_ubuntu; <span class="k">then</span>
<span class="k">            </span>stop_service tgt
        <span class="k">else</span>
<span class="k">            </span>stop_service tgtd
        <span class="k">fi</span>
<span class="k">    fi</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>create_volume_types() - Create Cinder's configured volume types</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>create_volume_types <span class="o">{</span>
</pre></div></td></tr><tr><td class=docs>
<p>Create volume types</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">if </span>is_service_enabled c-api <span class="o">&amp;&amp;</span> <span class="o">[[</span> -n <span class="s2">&quot;$CINDER_ENABLED_BACKENDS&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        for </span>be in <span class="k">${</span><span class="nv">CINDER_ENABLED_BACKENDS</span><span class="p">//,/ </span><span class="k">}</span>; <span class="k">do</span>
<span class="k">            </span><span class="nv">BE_TYPE</span><span class="o">=</span><span class="k">${</span><span class="nv">be</span><span class="p">%%:*</span><span class="k">}</span>
            <span class="nv">BE_NAME</span><span class="o">=</span><span class="k">${</span><span class="nv">be</span><span class="p">##*:</span><span class="k">}</span>
            <span class="k">if </span><span class="nb">type </span>configure_cinder_backend_<span class="k">${</span><span class="nv">BE_TYPE</span><span class="k">}</span> &gt;/dev/null 2&gt;&amp;1; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>openstack volume type create --property volume_backend_name=&quot;${BE_TYPE}&quot; ${BE_NAME}</p>
</td><td class=code><div class=highlight><pre>
                cinder <span class="nb">type</span>-create <span class="k">${</span><span class="nv">BE_NAME</span><span class="k">}</span> <span class="o">&amp;&amp;</span> <span class="se">\</span>
                    cinder <span class="nb">type</span>-key <span class="k">${</span><span class="nv">BE_NAME</span><span class="k">}</span> <span class="nb">set </span><span class="nv">volume_backend_name</span><span class="o">=</span><span class="s2">&quot;${BE_NAME}&quot;</span>
            <span class="k">fi</span>
<span class="k">        done</span>
<span class="k">    fi</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Compatibility for Grenade</p>
</td><td class=code><div class=highlight><pre>

<span class="k">function </span>create_cinder_volume_group <span class="o">{</span>
</pre></div></td></tr><tr><td class=docs>
<p>During a transition period Grenade needs to have this function defined
It is effectively a no-op in the Grenade 'target' use case</p>
</td><td class=code><div class=highlight><pre>
    :
<span class="o">}</span>


</pre></div></td></tr><tr><td class=docs>
<p>Restore xtrace</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">$XTRACE</span>

</pre></div></td></tr><tr><td class=docs>
<p>Tell emacs to use shell-script-mode</p>
</td><td class=code><div class=highlight><pre>
<span class="c">## Local variables:</span>
<span class="c">## mode: shell-script</span>
<span class="c">## End:</span>


</td><td class=code><div class=highlight><pre>
</pre></div></td></tr><tr><td class=docs>
</pre></div></td></tr><tr><td class=docs>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
</div>
</div>
</body>
</html></td><td class='code'></td></tr>
    </tbody>
    </table>
</div>
</body>
</html>
