<!DOCTYPE html>
<html>
<head>
    <meta http-eqiv='content-type' content='text/html;charset=utf-8'>
    <title>stack.sh</title>
    <link rel=stylesheet href="http://jashkenas.github.com/docco/resources/docco.css">
</head>
<body>
<div id=container>
    <div id=background></div>
    <table cellspacing=0 cellpadding=0>
    <thead>
      <tr>
        <th class=docs><h1>stack.sh</h1></th>
        <th class=code></th>
      </tr>
    </thead>
    <tbody>
        <tr><td class='docs'><?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.12: http://docutils.sourceforge.net/" />
<title></title>
<style type="text/css">

/*
:Author: David Goodger (goodger@python.org)
:Id: $Id: html4css1.css 7614 2013-02-21 15:55:51Z milde $
:Copyright: This stylesheet has been placed in the public domain.

Default cascading style sheet for the HTML output of Docutils.

See http://docutils.sf.net/docs/howto/html-stylesheets.html for how to
customize this style sheet.
*/

/* used to remove borders from tables and images */
.borderless, table.borderless td, table.borderless th {
  border: 0 }

table.borderless td, table.borderless th {
  /* Override padding for "table.docutils td" with "! important".
     The right padding separates the table cells. */
  padding: 0 0.5em 0 0 ! important }

.first {
  /* Override more specific margin styles with "! important". */
  margin-top: 0 ! important }

.last, .with-subtitle {
  margin-bottom: 0 ! important }

.hidden {
  display: none }

a.toc-backref {
  text-decoration: none ;
  color: black }

blockquote.epigraph {
  margin: 2em 5em ; }

dl.docutils dd {
  margin-bottom: 0.5em }

object[type="image/svg+xml"], object[type="application/x-shockwave-flash"] {
  overflow: hidden;
}

/* Uncomment (and remove this text!) to get bold-faced definition list terms
dl.docutils dt {
  font-weight: bold }
*/

div.abstract {
  margin: 2em 5em }

div.abstract p.topic-title {
  font-weight: bold ;
  text-align: center }

div.admonition, div.attention, div.caution, div.danger, div.error,
div.hint, div.important, div.note, div.tip, div.warning {
  margin: 2em ;
  border: medium outset ;
  padding: 1em }

div.admonition p.admonition-title, div.hint p.admonition-title,
div.important p.admonition-title, div.note p.admonition-title,
div.tip p.admonition-title {
  font-weight: bold ;
  font-family: sans-serif }

div.attention p.admonition-title, div.caution p.admonition-title,
div.danger p.admonition-title, div.error p.admonition-title,
div.warning p.admonition-title, .code .error {
  color: red ;
  font-weight: bold ;
  font-family: sans-serif }

/* Uncomment (and remove this text!) to get reduced vertical space in
   compound paragraphs.
div.compound .compound-first, div.compound .compound-middle {
  margin-bottom: 0.5em }

div.compound .compound-last, div.compound .compound-middle {
  margin-top: 0.5em }
*/

div.dedication {
  margin: 2em 5em ;
  text-align: center ;
  font-style: italic }

div.dedication p.topic-title {
  font-weight: bold ;
  font-style: normal }

div.figure {
  margin-left: 2em ;
  margin-right: 2em }

div.footer, div.header {
  clear: both;
  font-size: smaller }

div.line-block {
  display: block ;
  margin-top: 1em ;
  margin-bottom: 1em }

div.line-block div.line-block {
  margin-top: 0 ;
  margin-bottom: 0 ;
  margin-left: 1.5em }

div.sidebar {
  margin: 0 0 0.5em 1em ;
  border: medium outset ;
  padding: 1em ;
  background-color: #ffffee ;
  width: 40% ;
  float: right ;
  clear: right }

div.sidebar p.rubric {
  font-family: sans-serif ;
  font-size: medium }

div.system-messages {
  margin: 5em }

div.system-messages h1 {
  color: red }

div.system-message {
  border: medium outset ;
  padding: 1em }

div.system-message p.system-message-title {
  color: red ;
  font-weight: bold }

div.topic {
  margin: 2em }

h1.section-subtitle, h2.section-subtitle, h3.section-subtitle,
h4.section-subtitle, h5.section-subtitle, h6.section-subtitle {
  margin-top: 0.4em }

h1.title {
  text-align: center }

h2.subtitle {
  text-align: center }

hr.docutils {
  width: 75% }

img.align-left, .figure.align-left, object.align-left {
  clear: left ;
  float: left ;
  margin-right: 1em }

img.align-right, .figure.align-right, object.align-right {
  clear: right ;
  float: right ;
  margin-left: 1em }

img.align-center, .figure.align-center, object.align-center {
  display: block;
  margin-left: auto;
  margin-right: auto;
}

.align-left {
  text-align: left }

.align-center {
  clear: both ;
  text-align: center }

.align-right {
  text-align: right }

/* reset inner alignment in figures */
div.align-right {
  text-align: inherit }

/* div.align-center * { */
/*   text-align: left } */

ol.simple, ul.simple {
  margin-bottom: 1em }

ol.arabic {
  list-style: decimal }

ol.loweralpha {
  list-style: lower-alpha }

ol.upperalpha {
  list-style: upper-alpha }

ol.lowerroman {
  list-style: lower-roman }

ol.upperroman {
  list-style: upper-roman }

p.attribution {
  text-align: right ;
  margin-left: 50% }

p.caption {
  font-style: italic }

p.credits {
  font-style: italic ;
  font-size: smaller }

p.label {
  white-space: nowrap }

p.rubric {
  font-weight: bold ;
  font-size: larger ;
  color: maroon ;
  text-align: center }

p.sidebar-title {
  font-family: sans-serif ;
  font-weight: bold ;
  font-size: larger }

p.sidebar-subtitle {
  font-family: sans-serif ;
  font-weight: bold }

p.topic-title {
  font-weight: bold }

pre.address {
  margin-bottom: 0 ;
  margin-top: 0 ;
  font: inherit }

pre.literal-block, pre.doctest-block, pre.math, pre.code {
  margin-left: 2em ;
  margin-right: 2em }

pre.code .ln { color: grey; } /* line numbers */
pre.code, code { background-color: #eeeeee }
pre.code .comment, code .comment { color: #5C6576 }
pre.code .keyword, code .keyword { color: #3B0D06; font-weight: bold }
pre.code .literal.string, code .literal.string { color: #0C5404 }
pre.code .name.builtin, code .name.builtin { color: #352B84 }
pre.code .deleted, code .deleted { background-color: #DEB0A1}
pre.code .inserted, code .inserted { background-color: #A3D289}

span.classifier {
  font-family: sans-serif ;
  font-style: oblique }

span.classifier-delimiter {
  font-family: sans-serif ;
  font-weight: bold }

span.interpreted {
  font-family: sans-serif }

span.option {
  white-space: nowrap }

span.pre {
  white-space: pre }

span.problematic {
  color: red }

span.section-subtitle {
  /* font-size relative to parent (h1..h6 element) */
  font-size: 80% }

table.citation {
  border-left: solid 1px gray;
  margin-left: 1px }

table.docinfo {
  margin: 2em 4em }

table.docutils {
  margin-top: 0.5em ;
  margin-bottom: 0.5em }

table.footnote {
  border-left: solid 1px black;
  margin-left: 1px }

table.docutils td, table.docutils th,
table.docinfo td, table.docinfo th {
  padding-left: 0.5em ;
  padding-right: 0.5em ;
  vertical-align: top }

table.docutils th.field-name, table.docinfo th.docinfo-name {
  font-weight: bold ;
  text-align: left ;
  white-space: nowrap ;
  padding-left: 0 }

/* "booktabs" style (no vertical lines) */
table.docutils.booktabs {
  border: 0px;
  border-top: 2px solid;
  border-bottom: 2px solid;
  border-collapse: collapse;
}
table.docutils.booktabs * {
  border: 0px;
}
table.docutils.booktabs th {
  border-bottom: thin solid;
  text-align: left;
}

h1 tt.docutils, h2 tt.docutils, h3 tt.docutils,
h4 tt.docutils, h5 tt.docutils, h6 tt.docutils {
  font-size: 100% }

ul.auto-toc {
  list-style-type: none }

</style>
</head>
<body>
<div class="document">


<p><tt class="docutils literal">stack.sh</tt> is an opinionated OpenStack developer installation.  It
installs and configures various combinations of <strong>Ceilometer</strong>, <strong>Cinder</strong>,
<strong>Glance</strong>, <strong>Heat</strong>, <strong>Horizon</strong>, <strong>Keystone</strong>, <strong>Nova</strong>, <strong>Neutron</strong>,
and <strong>Swift</strong></p>
</td><td class=code><div class=highlight><pre>
<span class="c">#!/usr/bin/env bash</span>


</pre></div></td></tr><tr><td class=docs>
<p>This script's options can be changed by setting appropriate environment
variables.  You can configure things like which git repositories to use,
services to enable, OS images to use, etc.  Default values are located in the
<tt class="docutils literal">stackrc</tt> file. If you are crafty you can run the script on multiple nodes
using shared settings for common resources (eg., mysql or rabbitmq) and build
a multi-node developer install.</p>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>To keep this script simple we assume you are running on a recent <strong>Ubuntu</strong>
(12.04 Precise or newer) or <strong>Fedora</strong> (F18 or newer) machine.  (It may work
on other platforms but support for those platforms is left to those who added
them to DevStack.)  It should work in a VM or physical server.  Additionally
we maintain a list of <tt class="docutils literal">apt</tt> and <tt class="docutils literal">rpm</tt> dependencies and other configuration
files in this repo.</p>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Learn more and get the most recent version at <a class="reference external" href="http://devstack.org">http://devstack.org</a></p>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Make sure custom grep options don't get in the way</p>
</td><td class=code><div class=highlight><pre>
<span class="nb">unset </span>GREP_OPTIONS

</pre></div></td></tr><tr><td class=docs>
<p>Sanitize language settings to avoid commands bailing out
with &quot;unsupported locale setting&quot; errors.</p>
</td><td class=code><div class=highlight><pre>
<span class="nb">unset </span>LANG
<span class="nb">unset </span>LANGUAGE
<span class="nv">LC_ALL</span><span class="o">=</span>C
<span class="nb">export </span>LC_ALL

</pre></div></td></tr><tr><td class=docs>
<p>Make sure umask is sane</p>
</td><td class=code><div class=highlight><pre>
<span class="nb">umask </span>022

</pre></div></td></tr><tr><td class=docs>
<p>Not all distros have sbin in PATH for regular users.</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">PATH</span><span class="o">=</span><span class="nv">$PATH</span>:/usr/local/sbin:/usr/sbin:/sbin

</pre></div></td></tr><tr><td class=docs>
<p>Keep track of the devstack directory</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">TOP_DIR</span><span class="o">=</span><span class="k">$(</span><span class="nb">cd</span> <span class="k">$(</span>dirname <span class="s2">&quot;$0&quot;</span><span class="k">)</span> <span class="o">&amp;&amp;</span> <span class="nb">pwd</span><span class="k">)</span>

</pre></div></td></tr><tr><td class=docs>
<div class="section" id="sanity-checks">
<h1>Sanity Checks</h1>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Clean up last environment var cache</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if</span> <span class="o">[[</span> -r <span class="nv">$TOP_DIR</span>/.stackenv <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    </span>rm <span class="nv">$TOP_DIR</span>/.stackenv
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p><tt class="docutils literal">stack.sh</tt> keeps the list of <tt class="docutils literal">apt</tt> and <tt class="docutils literal">rpm</tt> dependencies and config
templates and other useful files in the <tt class="docutils literal">files</tt> subdirectory</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">FILES</span><span class="o">=</span><span class="nv">$TOP_DIR</span>/files
<span class="k">if</span> <span class="o">[</span> ! -d <span class="nv">$FILES</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span>die <span class="nv">$LINENO</span> <span class="s2">&quot;missing devstack/files&quot;</span>
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p><tt class="docutils literal">stack.sh</tt> keeps function libraries here
Make sure <tt class="docutils literal">$TOP_DIR/lib</tt> directory is present</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if</span> <span class="o">[</span> ! -d <span class="nv">$TOP_DIR</span>/lib <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span>die <span class="nv">$LINENO</span> <span class="s2">&quot;missing devstack/lib&quot;</span>
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Check if run as root
OpenStack is designed to be run as a non-root user; Horizon will fail to run
as <strong>root</strong> since Apache will not serve content from <strong>root</strong> user).
<tt class="docutils literal">stack.sh</tt> must not be run as <strong>root</strong>.  It aborts and suggests one course of
action to create a suitable user account.</p>
</td><td class=code><div class=highlight><pre>

<span class="k">if</span> <span class="o">[[</span> <span class="nv">$EUID</span> -eq 0 <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;You are running this script as root.&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;Cut it out.&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;Really.&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;If you need an account to run DevStack, do this (as root, heh) to create a non-root account:&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;$TOP_DIR/tools/create-stack-user.sh&quot;</span>
    <span class="nb">exit </span>1
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="prepare-the-environment">
<h1>Prepare the environment</h1>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Import common functions</p>
</td><td class=code><div class=highlight><pre>
<span class="nb">source</span> <span class="nv">$TOP_DIR</span>/functions

</pre></div></td></tr><tr><td class=docs>
<p>Import config functions</p>
</td><td class=code><div class=highlight><pre>
<span class="nb">source</span> <span class="nv">$TOP_DIR</span>/lib/config

</pre></div></td></tr><tr><td class=docs>
<p>Determine what system we are running on.  This provides <tt class="docutils literal">os_VENDOR</tt>,
<tt class="docutils literal">os_RELEASE</tt>, <tt class="docutils literal">os_UPDATE</tt>, <tt class="docutils literal">os_PACKAGE</tt>, <tt class="docutils literal">os_CODENAME</tt>
and <tt class="docutils literal">DISTRO</tt></p>
</td><td class=code><div class=highlight><pre>
GetDistro

</pre></div></td></tr><tr><td class=docs>
<p>Warn users who aren't on an explicitly supported distro, but allow them to
override check and attempt installation with <tt class="docutils literal">FORCE=yes ./stack</tt></p>
</td><td class=code><div class=highlight><pre>
<span class="k">if</span> <span class="o">[[</span> ! <span class="k">${</span><span class="nv">DISTRO</span><span class="k">}</span> <span class="o">=</span>~ <span class="o">(</span>precise|trusty|7.0|wheezy|sid|testing|jessie|f19|f20|rhel6|rhel7<span class="o">)</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;WARNING: this script has not been tested on $DISTRO&quot;</span>
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$FORCE&quot;</span> !<span class="o">=</span> <span class="s2">&quot;yes&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span>die <span class="nv">$LINENO</span> <span class="s2">&quot;If you wish to run this script anyway run with FORCE=yes&quot;</span>
    <span class="k">fi</span>
<span class="k">fi</span>


</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="global-settings">
<h1>Global Settings</h1>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Check for a <tt class="docutils literal">localrc</tt> section embedded in <tt class="docutils literal">local.conf</tt> and extract if
<tt class="docutils literal">localrc</tt> does not already exist</p>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Phase: local</p>
</td><td class=code><div class=highlight><pre>
rm -f <span class="nv">$TOP_DIR</span>/.localrc.auto
<span class="k">if</span> <span class="o">[[</span> -r <span class="nv">$TOP_DIR</span>/local.conf <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nv">LRC</span><span class="o">=</span><span class="k">$(</span>get_meta_section_files <span class="nv">$TOP_DIR</span>/local.conf <span class="nb">local</span><span class="k">)</span>
    <span class="k">for </span>lfile in <span class="nv">$LRC</span>; <span class="k">do</span>
<span class="k">        if</span> <span class="o">[[</span> <span class="s2">&quot;$lfile&quot;</span> <span class="o">==</span> <span class="s2">&quot;localrc&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            if</span> <span class="o">[[</span> -r <span class="nv">$TOP_DIR</span>/localrc <span class="o">]]</span>; <span class="k">then</span>
<span class="k">                </span>warn <span class="nv">$LINENO</span> <span class="s2">&quot;localrc and local.conf:[[local]] both exist, using localrc&quot;</span>
            <span class="k">else</span>
<span class="k">                </span><span class="nb">echo</span> <span class="s2">&quot;# Generated file, do not edit&quot;</span> &gt;<span class="nv">$TOP_DIR</span>/.localrc.auto
                get_meta_section <span class="nv">$TOP_DIR</span>/local.conf <span class="nb">local</span> <span class="nv">$lfile</span> &gt;&gt;<span class="nv">$TOP_DIR</span>/.localrc.auto
            <span class="k">fi</span>
<span class="k">        fi</span>
<span class="k">    done</span>
<span class="k">fi</span>


</pre></div></td></tr><tr><td class=docs>
<p><tt class="docutils literal">stack.sh</tt> is customizable by setting environment variables.  Override a
default setting via export:</p>
<pre class="literal-block">
export DATABASE_PASSWORD=anothersecret
./stack.sh
</pre>
<p>or by setting the variable on the command line:</p>
<pre class="literal-block">
DATABASE_PASSWORD=simple ./stack.sh
</pre>
<p>Persistent variables can be placed in a <tt class="docutils literal">localrc</tt> file:</p>
<pre class="literal-block">
DATABASE_PASSWORD=anothersecret
DATABASE_USER=hellaroot
</pre>
<p>We try to have sensible defaults, so you should be able to run <tt class="docutils literal">./stack.sh</tt>
in most cases.  <tt class="docutils literal">localrc</tt> is not distributed with DevStack and will never
be overwritten by a DevStack update.</p>
<p>DevStack distributes <tt class="docutils literal">stackrc</tt> which contains locations for the OpenStack
repositories, branches to configure, and other configuration defaults.
<tt class="docutils literal">stackrc</tt> sources <tt class="docutils literal">localrc</tt> to allow you to safely override those settings.</p>
</td><td class=code><div class=highlight><pre>

<span class="k">if</span> <span class="o">[[</span> ! -r <span class="nv">$TOP_DIR</span>/stackrc <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    </span>die <span class="nv">$LINENO</span> <span class="s2">&quot;missing $TOP_DIR/stackrc - did you grab more than just stack.sh?&quot;</span>
<span class="k">fi</span>
<span class="nb">source</span> <span class="nv">$TOP_DIR</span>/stackrc

</pre></div></td></tr><tr><td class=docs>
<p>Check to see if we are already running DevStack
Note that this may fail if USE_SCREEN=False</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if </span><span class="nb">type</span> -p screen &gt; /dev/null <span class="o">&amp;&amp;</span> screen -ls | egrep -q <span class="s2">&quot;[0-9]\.$SCREEN_NAME&quot;</span>; <span class="k">then</span>
<span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;You are already running a stack.sh session.&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;To rejoin this session type &#39;screen -x stack&#39;.&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;To destroy this session, type &#39;./unstack.sh&#39;.&quot;</span>
    <span class="nb">exit </span>1
<span class="k">fi</span>


</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="local-settings">
<h1>Local Settings</h1>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Make sure the proxy config is visible to sub-processes</p>
</td><td class=code><div class=highlight><pre>
export_proxy_variables

</pre></div></td></tr><tr><td class=docs>
<p>Remove services which were negated in ENABLED_SERVICES
using the &quot;-&quot; prefix (e.g., &quot;-rabbit&quot;) instead of
calling disable_service().</p>
</td><td class=code><div class=highlight><pre>
disable_negated_services

</pre></div></td></tr><tr><td class=docs>
<p>Look for obsolete stuff</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if</span> <span class="o">[[</span> ,<span class="k">${</span><span class="nv">ENABLED_SERVICES</span><span class="k">}</span>, <span class="o">=</span>~ ,<span class="s2">&quot;swift&quot;</span>, <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;FATAL: &#39;swift&#39; is not supported as a service name&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;FATAL: Use the actual swift service names to enable them as required:&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;FATAL: s-proxy s-object s-container s-account&quot;</span>
    <span class="nb">exit </span>1
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="configure-sudo">
<h1>Configure sudo</h1>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>We're not <strong>root</strong>, make sure <tt class="docutils literal">sudo</tt> is available</p>
</td><td class=code><div class=highlight><pre>
is_package_installed sudo <span class="o">||</span> install_package sudo

</pre></div></td></tr><tr><td class=docs>
<p>UEC images <tt class="docutils literal">/etc/sudoers</tt> does not have a <tt class="docutils literal">#includedir</tt>, add one</p>
</td><td class=code><div class=highlight><pre>
sudo grep -q <span class="s2">&quot;^#includedir.*/etc/sudoers.d&quot;</span> /etc/sudoers <span class="o">||</span>
    <span class="nb">echo</span> <span class="s2">&quot;#includedir /etc/sudoers.d&quot;</span> | sudo tee -a /etc/sudoers

</pre></div></td></tr><tr><td class=docs>
<p>Set up devstack sudoers</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">TEMPFILE</span><span class="o">=</span><span class="sb">`</span>mktemp<span class="sb">`</span>
<span class="nb">echo</span> <span class="s2">&quot;$STACK_USER ALL=(root) NOPASSWD:ALL&quot;</span> &gt;<span class="nv">$TEMPFILE</span>
</pre></div></td></tr><tr><td class=docs>
<p>Some binaries might be under /sbin or /usr/sbin, so make sure sudo will
see them by forcing PATH</p>
</td><td class=code><div class=highlight><pre>
<span class="nb">echo</span> <span class="s2">&quot;Defaults:$STACK_USER secure_path=/sbin:/usr/sbin:/usr/bin:/bin:/usr/local/sbin:/usr/local/bin&quot;</span> &gt;&gt; <span class="nv">$TEMPFILE</span>
<span class="nb">echo</span> <span class="s2">&quot;Defaults:$STACK_USER !requiretty&quot;</span> &gt;&gt; <span class="nv">$TEMPFILE</span>
chmod 0440 <span class="nv">$TEMPFILE</span>
sudo chown root:root <span class="nv">$TEMPFILE</span>
sudo mv <span class="nv">$TEMPFILE</span> /etc/sudoers.d/50_stack_sh


</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="configure-distro-repositories">
<h1>Configure Distro Repositories</h1>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>For debian/ubuntu make apt attempt to retry network ops on it's own</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if </span>is_ubuntu; <span class="k">then</span>
<span class="k">    </span><span class="nb">echo</span> <span class="s1">&#39;APT::Acquire::Retries &quot;20&quot;;&#39;</span> | sudo tee /etc/apt/apt.conf.d/80retry  &gt;/dev/null
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>upstream Rackspace centos7 images have an issue where cloud-init is
installed via pip because there were not official packages when the
image was created (fix in the works).  Remove all pip packages
before we do anything else</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if</span> <span class="o">[[</span> <span class="nv">$DISTRO</span> <span class="o">=</span> <span class="s2">&quot;rhel7&quot;</span> <span class="o">&amp;&amp;</span> is_rackspace <span class="o">]]</span>; <span class="k">then</span>
    <span class="o">(</span>sudo pip freeze | xargs sudo pip uninstall -y<span class="o">)</span> <span class="o">||</span> <span class="nb">true</span>
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Some distros need to add repos beyond the defaults provided by the vendor
to pick up required packages.</p>
</td><td class=code><div class=highlight><pre>

<span class="k">if</span> <span class="o">[[</span> is_fedora <span class="o">&amp;&amp;</span> <span class="nv">$DISTRO</span> <span class="o">==</span> <span class="s2">&quot;rhel6&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>Installing Open vSwitch on RHEL requires enabling the RDO repo.</p>
</td><td class=code><div class=highlight><pre>
    <span class="nv">RHEL6_RDO_REPO_RPM</span><span class="o">=</span><span class="k">${</span><span class="nv">RHEL6_RDO_REPO_RPM</span><span class="k">:-</span><span class="s2">&quot;http://rdo.fedorapeople.org/openstack-icehouse/rdo-release-icehouse.rpm&quot;</span><span class="k">}</span>
    <span class="nv">RHEL6_RDO_REPO_ID</span><span class="o">=</span><span class="k">${</span><span class="nv">RHEL6_RDO_REPO_ID</span><span class="k">:-</span><span class="s2">&quot;openstack-icehouse&quot;</span><span class="k">}</span>
    <span class="k">if</span> ! sudo yum repolist enabled <span class="nv">$RHEL6_RDO_REPO_ID</span> | grep -q <span class="nv">$RHEL6_RDO_REPO_ID</span>; <span class="k">then</span>
<span class="k">        </span><span class="nb">echo</span> <span class="s2">&quot;RDO repo not detected; installing&quot;</span>
        yum_install <span class="nv">$RHEL6_RDO_REPO_RPM</span> <span class="o">||</span> <span class="se">\</span>
            die <span class="nv">$LINENO</span> <span class="s2">&quot;Error installing RDO repo, cannot continue&quot;</span>
    <span class="k">fi</span>
<span class="k">fi</span>

<span class="k">if</span> <span class="o">[[</span> is_fedora <span class="o">&amp;&amp;</span> <span class="o">(</span> <span class="nv">$DISTRO</span> <span class="o">==</span> <span class="s2">&quot;rhel6&quot;</span> <span class="o">||</span> <span class="nv">$DISTRO</span> <span class="o">==</span> <span class="s2">&quot;rhel7&quot;</span> <span class="o">)</span> <span class="o">]]</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>RHEL requires EPEL for many Open Stack dependencies</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">if</span> <span class="o">[[</span> <span class="nv">$DISTRO</span> <span class="o">==</span> <span class="s2">&quot;rhel7&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nv">EPEL_RPM</span><span class="o">=</span><span class="k">${</span><span class="nv">RHEL7_EPEL_RPM</span><span class="k">:-</span><span class="s2">&quot;http://dl.fedoraproject.org/pub/epel/beta/7/x86_64/epel-release-7-1.noarch.rpm&quot;</span><span class="k">}</span>
    <span class="k">elif</span> <span class="o">[[</span> <span class="nv">$DISTRO</span> <span class="o">==</span> <span class="s2">&quot;rhel6&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nv">EPEL_RPM</span><span class="o">=</span><span class="k">${</span><span class="nv">RHEL6_EPEL_RPM</span><span class="k">:-</span><span class="s2">&quot;http://dl.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm&quot;</span><span class="k">}</span>
    <span class="k">fi</span>
<span class="k">    if</span> ! sudo yum repolist enabled epel | grep -q <span class="s1">&#39;epel&#39;</span>; <span class="k">then</span>
<span class="k">        </span><span class="nb">echo</span> <span class="s2">&quot;EPEL not detected; installing&quot;</span>
        yum_install <span class="k">${</span><span class="nv">EPEL_RPM</span><span class="k">}</span> <span class="o">||</span> <span class="se">\</span>
            die <span class="nv">$LINENO</span> <span class="s2">&quot;Error installing EPEL repo, cannot continue&quot;</span>
    <span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>... and also optional to be enabled</p>
</td><td class=code><div class=highlight><pre>
    is_package_installed yum-utils <span class="o">||</span> install_package yum-utils
    <span class="k">if</span> <span class="o">[[</span> <span class="nv">$DISTRO</span> <span class="o">==</span> <span class="s2">&quot;rhel7&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nv">OPTIONAL_REPO</span><span class="o">=</span>rhel-7-server-optional-rpms
    <span class="k">elif</span> <span class="o">[[</span> <span class="nv">$DISTRO</span> <span class="o">==</span> <span class="s2">&quot;rhel6&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nv">OPTIONAL_REPO</span><span class="o">=</span>rhel-6-server-optional-rpms
    <span class="k">fi</span>
<span class="k">    </span>sudo yum-config-manager --enable <span class="k">${</span><span class="nv">OPTIONAL_REPO</span><span class="k">}</span>
<span class="k">fi</span>


</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="configure-target-directories">
<h1>Configure Target Directories</h1>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Destination path for installation <tt class="docutils literal">DEST</tt></p>
</td><td class=code><div class=highlight><pre>
<span class="nv">DEST</span><span class="o">=</span><span class="k">${</span><span class="nv">DEST</span><span class="k">:-</span><span class="p">/opt/stack</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Create the destination directory and ensure it is writable by the user
and read/executable by everybody for daemons (e.g. apache run for horizon)</p>
</td><td class=code><div class=highlight><pre>
sudo mkdir -p <span class="nv">$DEST</span>
safe_chown -R <span class="nv">$STACK_USER</span> <span class="nv">$DEST</span>
safe_chmod 0755 <span class="nv">$DEST</span>

</pre></div></td></tr><tr><td class=docs>
<p>a basic test for $DEST path permissions (fatal on error unless skipped)</p>
</td><td class=code><div class=highlight><pre>
check_path_perm_sanity <span class="k">${</span><span class="nv">DEST</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Destination path for service data</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">DATA_DIR</span><span class="o">=</span><span class="k">${</span><span class="nv">DATA_DIR</span><span class="k">:-${</span><span class="nv">DEST</span><span class="k">}</span><span class="p">/data</span><span class="k">}</span>
sudo mkdir -p <span class="nv">$DATA_DIR</span>
safe_chown -R <span class="nv">$STACK_USER</span> <span class="nv">$DATA_DIR</span>

</pre></div></td></tr><tr><td class=docs>
<p>Configure proper hostname
Certain services such as rabbitmq require that the local hostname resolves
correctly.  Make sure it exists in /etc/hosts so that is always true.</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">LOCAL_HOSTNAME</span><span class="o">=</span><span class="sb">`</span>hostname -s<span class="sb">`</span>
<span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;`grep ^127.0.0.1 /etc/hosts | grep $LOCAL_HOSTNAME`&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span>sudo sed -i <span class="s2">&quot;s/\(^127.0.0.1.*\)/\1 $LOCAL_HOSTNAME/&quot;</span> /etc/hosts
<span class="k">fi</span>


</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="configure-logging">
<h1>Configure Logging</h1>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Set up logging level</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">VERBOSE</span><span class="o">=</span><span class="k">$(</span>trueorfalse True <span class="nv">$VERBOSE</span><span class="k">)</span>

</pre></div></td></tr><tr><td class=docs>
<p>Draw a spinner so the user knows something is happening</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>spinner <span class="o">{</span>
    <span class="nb">local </span><span class="nv">delay</span><span class="o">=</span>0.75
    <span class="nb">local </span><span class="nv">spinstr</span><span class="o">=</span><span class="s1">&#39;/-\|&#39;</span>
    <span class="nb">printf</span> <span class="s2">&quot;...&quot;</span> &gt;&amp;3
    <span class="k">while</span> <span class="o">[</span> <span class="nb">true</span> <span class="o">]</span>; <span class="k">do</span>
<span class="k">        </span><span class="nb">local </span><span class="nv">temp</span><span class="o">=</span><span class="k">${</span><span class="nv">spinstr</span><span class="p">#?</span><span class="k">}</span>
        <span class="nb">printf</span> <span class="s2">&quot;[%c]&quot;</span> <span class="s2">&quot;$spinstr&quot;</span> &gt;&amp;3
        <span class="nb">local </span><span class="nv">spinstr</span><span class="o">=</span><span class="nv">$temp</span><span class="k">${</span><span class="nv">spinstr</span><span class="p">%</span><span class="s2">&quot;$temp&quot;</span><span class="k">}</span>
        sleep <span class="nv">$delay</span>
        <span class="nb">printf</span> <span class="s2">&quot;\b\b\b&quot;</span> &gt;&amp;3
    <span class="k">done</span>
<span class="o">}</span>

<span class="k">function </span>kill_spinner <span class="o">{</span>
    <span class="k">if</span> <span class="o">[</span> ! -z <span class="s2">&quot;$LAST_SPINNER_PID&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nb">kill</span> &gt;/dev/null 2&gt;&amp;1 <span class="nv">$LAST_SPINNER_PID</span>
        <span class="nb">printf</span> <span class="s2">&quot;\b\b\bdone\n&quot;</span> &gt;&amp;3
    <span class="k">fi</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Echo text to the log file, summary log file and stdout
echo_summary &quot;something to say&quot;</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>echo_summary <span class="o">{</span>
    <span class="k">if</span> <span class="o">[[</span> -t 3 <span class="o">&amp;&amp;</span> <span class="s2">&quot;$VERBOSE&quot;</span> !<span class="o">=</span> <span class="s2">&quot;True&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span>kill_spinner
        <span class="nb">echo</span> -n -e <span class="nv">$@</span> &gt;&amp;6
        spinner &amp;
        <span class="nv">LAST_SPINNER_PID</span><span class="o">=</span><span class="nv">$!</span>
    <span class="k">else</span>
<span class="k">        </span><span class="nb">echo</span> -e <span class="nv">$@</span> &gt;&amp;6
    <span class="k">fi</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Echo text only to stdout, no log files
echo_nolog &quot;something not for the logs&quot;</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>echo_nolog <span class="o">{</span>
    <span class="nb">echo</span> <span class="nv">$@</span> &gt;&amp;3
<span class="o">}</span>

<span class="k">if</span> <span class="o">[[</span> is_fedora <span class="o">&amp;&amp;</span> <span class="nv">$DISTRO</span> <span class="o">==</span> <span class="s2">&quot;rhel6&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>poor old python2.6 doesn't have argparse by default, which
outfilter.py uses</p>
</td><td class=code><div class=highlight><pre>
    is_package_installed python-argparse <span class="o">||</span> install_package python-argparse
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Set up logging for <tt class="docutils literal">stack.sh</tt>
Set <tt class="docutils literal">LOGFILE</tt> to turn on logging
Append '.xxxxxxxx' to the given name to maintain history
where 'xxxxxxxx' is a representation of the date the file was created</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">TIMESTAMP_FORMAT</span><span class="o">=</span><span class="k">${</span><span class="nv">TIMESTAMP_FORMAT</span><span class="k">:-</span><span class="s2">&quot;%F-%H%M%S&quot;</span><span class="k">}</span>
<span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&quot;$LOGFILE&quot;</span> <span class="o">||</span> -n <span class="s2">&quot;$SCREEN_LOGDIR&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nv">LOGDAYS</span><span class="o">=</span><span class="k">${</span><span class="nv">LOGDAYS</span><span class="k">:-</span><span class="nv">7</span><span class="k">}</span>
    <span class="nv">CURRENT_LOG_TIME</span><span class="o">=</span><span class="k">$(</span>date <span class="s2">&quot;+$TIMESTAMP_FORMAT&quot;</span><span class="k">)</span>
<span class="k">fi</span>

<span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&quot;$LOGFILE&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>First clean up old log files.  Use the user-specified <tt class="docutils literal">LOGFILE</tt>
as the template to search for, appending '.*' to match the date
we added on earlier runs.</p>
</td><td class=code><div class=highlight><pre>
    <span class="nv">LOGDIR</span><span class="o">=</span><span class="k">$(</span>dirname <span class="s2">&quot;$LOGFILE&quot;</span><span class="k">)</span>
    <span class="nv">LOGFILENAME</span><span class="o">=</span><span class="k">$(</span>basename <span class="s2">&quot;$LOGFILE&quot;</span><span class="k">)</span>
    mkdir -p <span class="nv">$LOGDIR</span>
    find <span class="nv">$LOGDIR</span> -maxdepth 1 -name <span class="nv">$LOGFILENAME</span>.<span class="se">\*</span> -mtime +<span class="nv">$LOGDAYS</span> -exec rm <span class="o">{}</span> <span class="se">\;</span>
    <span class="nv">LOGFILE</span><span class="o">=</span><span class="nv">$LOGFILE</span>.<span class="k">${</span><span class="nv">CURRENT_LOG_TIME</span><span class="k">}</span>
    <span class="nv">SUMFILE</span><span class="o">=</span><span class="nv">$LOGFILE</span>.<span class="k">${</span><span class="nv">CURRENT_LOG_TIME</span><span class="k">}</span>.summary

</pre></div></td></tr><tr><td class=docs>
<p>Redirect output according to config</p>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Set fd 3 to a copy of stdout. So we can set fd 1 without losing
stdout later.</p>
</td><td class=code><div class=highlight><pre>
    <span class="nb">exec </span>3&gt;&amp;1
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$VERBOSE&quot;</span> <span class="o">==</span> <span class="s2">&quot;True&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>Set fd 1 and 2 to write the log file</p>
</td><td class=code><div class=highlight><pre>
        <span class="nb">exec </span>1&gt; &gt;<span class="o">(</span> <span class="nv">$TOP_DIR</span>/tools/outfilter.py -v -o <span class="s2">&quot;${LOGFILE}&quot;</span> <span class="o">)</span> 2&gt;&amp;1
</pre></div></td></tr><tr><td class=docs>
<p>Set fd 6 to summary log file</p>
</td><td class=code><div class=highlight><pre>
        <span class="nb">exec </span>6&gt; &gt;<span class="o">(</span> <span class="nv">$TOP_DIR</span>/tools/outfilter.py -o <span class="s2">&quot;${SUMFILE}&quot;</span> <span class="o">)</span>
    <span class="k">else</span>
</pre></div></td></tr><tr><td class=docs>
<p>Set fd 1 and 2 to primary logfile</p>
</td><td class=code><div class=highlight><pre>
        <span class="nb">exec </span>1&gt; &gt;<span class="o">(</span> <span class="nv">$TOP_DIR</span>/tools/outfilter.py -o <span class="s2">&quot;${LOGFILE}&quot;</span> <span class="o">)</span> 2&gt;&amp;1
</pre></div></td></tr><tr><td class=docs>
<p>Set fd 6 to summary logfile and stdout</p>
</td><td class=code><div class=highlight><pre>
        <span class="nb">exec </span>6&gt; &gt;<span class="o">(</span> <span class="nv">$TOP_DIR</span>/tools/outfilter.py -v -o <span class="s2">&quot;${SUMFILE}&quot;</span> &gt;&amp;3 <span class="o">)</span>
    <span class="k">fi</span>

<span class="k">    </span>echo_summary <span class="s2">&quot;stack.sh log $LOGFILE&quot;</span>
</pre></div></td></tr><tr><td class=docs>
<p>Specified logfile name always links to the most recent log</p>
</td><td class=code><div class=highlight><pre>
    ln -sf <span class="nv">$LOGFILE</span> <span class="nv">$LOGDIR</span>/<span class="nv">$LOGFILENAME</span>
    ln -sf <span class="nv">$SUMFILE</span> <span class="nv">$LOGDIR</span>/<span class="nv">$LOGFILENAME</span>.summary
<span class="k">else</span>
</pre></div></td></tr><tr><td class=docs>
<p>Set up output redirection without log files
Set fd 3 to a copy of stdout. So we can set fd 1 without losing
stdout later.</p>
</td><td class=code><div class=highlight><pre>
    <span class="nb">exec </span>3&gt;&amp;1
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$VERBOSE&quot;</span> !<span class="o">=</span> <span class="s2">&quot;True&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>Throw away stdout and stderr</p>
</td><td class=code><div class=highlight><pre>
        <span class="nb">exec </span>1&gt;/dev/null 2&gt;&amp;1
    <span class="k">fi</span>
</pre></div></td></tr><tr><td class=docs>
<p>Always send summary fd to original stdout</p>
</td><td class=code><div class=highlight><pre>
    <span class="nb">exec </span>6&gt; &gt;<span class="o">(</span> <span class="nv">$TOP_DIR</span>/tools/outfilter.py -v &gt;&amp;3 <span class="o">)</span>
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Set up logging of screen windows
Set <tt class="docutils literal">SCREEN_LOGDIR</tt> to turn on logging of screen windows to the
directory specified in <tt class="docutils literal">SCREEN_LOGDIR</tt>, we will log to the the file
<tt class="docutils literal"><span class="pre">screen-$SERVICE_NAME-$TIMESTAMP.log</span></tt> in that dir and have a link
<tt class="docutils literal"><span class="pre">screen-$SERVICE_NAME.log</span></tt> to the latest log file.
Logs are kept for as long specified in <tt class="docutils literal">LOGDAYS</tt>.</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&quot;$SCREEN_LOGDIR&quot;</span> <span class="o">]]</span>; <span class="k">then</span>

</pre></div></td></tr><tr><td class=docs>
<p>We make sure the directory is created.</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">if</span> <span class="o">[[</span> -d <span class="s2">&quot;$SCREEN_LOGDIR&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>We cleanup the old logs</p>
</td><td class=code><div class=highlight><pre>
        find <span class="nv">$SCREEN_LOGDIR</span> -maxdepth 1 -name screen-<span class="se">\*</span>.log -mtime +<span class="nv">$LOGDAYS</span> -exec rm <span class="o">{}</span> <span class="se">\;</span>
    <span class="k">else</span>
<span class="k">        </span>mkdir -p <span class="nv">$SCREEN_LOGDIR</span>
    <span class="k">fi</span>
<span class="k">fi</span>


</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="configure-error-traps">
<h1>Configure Error Traps</h1>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Kill background processes on exit</p>
</td><td class=code><div class=highlight><pre>
<span class="nb">trap </span>exit_trap EXIT
<span class="k">function </span>exit_trap <span class="o">{</span>
    <span class="nb">local </span><span class="nv">r</span><span class="o">=</span><span class="nv">$?</span>
    <span class="nb">jobs</span><span class="o">=</span><span class="k">$(</span><span class="nb">jobs</span> -p<span class="k">)</span>
</pre></div></td></tr><tr><td class=docs>
<p>Only do the kill when we're logging through a process substitution,
which currently is only to verbose logfile</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">if</span> <span class="o">[[</span> -n <span class="nv">$jobs</span> <span class="o">&amp;&amp;</span> -n <span class="s2">&quot;$LOGFILE&quot;</span> <span class="o">&amp;&amp;</span> <span class="s2">&quot;$VERBOSE&quot;</span> <span class="o">==</span> <span class="s2">&quot;True&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nb">echo</span> <span class="s2">&quot;exit_trap: cleaning up child processes&quot;</span>
        <span class="nb">kill </span>2&gt;&amp;1 <span class="nv">$jobs</span>
    <span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Kill the last spinner process</p>
</td><td class=code><div class=highlight><pre>
    kill_spinner

    <span class="k">if</span> <span class="o">[[</span> <span class="nv">$r</span> -ne 0 <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nb">echo</span> <span class="s2">&quot;Error on exit&quot;</span>
        <span class="k">if</span> <span class="o">[[</span> -z <span class="nv">$LOGDIR</span> <span class="o">]]</span>; <span class="k">then</span>
            <span class="nv">$TOP_DIR</span>/tools/worlddump.py
        <span class="k">else</span>
            <span class="nv">$TOP_DIR</span>/tools/worlddump.py -d <span class="nv">$LOGDIR</span>
        <span class="k">fi</span>
<span class="k">    fi</span>

<span class="k">    </span><span class="nb">exit</span> <span class="nv">$r</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Exit on any errors so that errors don't compound</p>
</td><td class=code><div class=highlight><pre>
<span class="nb">trap </span>err_trap ERR
<span class="k">function </span>err_trap <span class="o">{</span>
    <span class="nb">local </span><span class="nv">r</span><span class="o">=</span><span class="nv">$?</span>
    <span class="nb">set</span> +o xtrace
    <span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&quot;$LOGFILE&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nb">echo</span> <span class="s2">&quot;${0##*/} failed: full log in $LOGFILE&quot;</span>
    <span class="k">else</span>
<span class="k">        </span><span class="nb">echo</span> <span class="s2">&quot;${0##*/} failed&quot;</span>
    <span class="k">fi</span>
<span class="k">    </span><span class="nb">exit</span> <span class="nv">$r</span>
<span class="o">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Begin trapping error exit codes</p>
</td><td class=code><div class=highlight><pre>
<span class="nb">set</span> -o errexit

</pre></div></td></tr><tr><td class=docs>
<p>Print the commands being run so that we can see the command that triggers
an error.  It is also useful for following along as the install occurs.</p>
</td><td class=code><div class=highlight><pre>
<span class="nb">set</span> -o xtrace


</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="common-configuration">
<h1>Common Configuration</h1>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Set <tt class="docutils literal">OFFLINE</tt> to <tt class="docutils literal">True</tt> to configure <tt class="docutils literal">stack.sh</tt> to run cleanly without
Internet access. <tt class="docutils literal">stack.sh</tt> must have been previously run with Internet
access to install prerequisites and fetch repositories.</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">OFFLINE</span><span class="o">=</span><span class="sb">`</span>trueorfalse False <span class="nv">$OFFLINE</span><span class="sb">`</span>

</pre></div></td></tr><tr><td class=docs>
<p>Set <tt class="docutils literal">ERROR_ON_CLONE</tt> to <tt class="docutils literal">True</tt> to configure <tt class="docutils literal">stack.sh</tt> to exit if
the destination git repository does not exist during the <tt class="docutils literal">git_clone</tt>
operation.</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">ERROR_ON_CLONE</span><span class="o">=</span><span class="sb">`</span>trueorfalse False <span class="nv">$ERROR_ON_CLONE</span><span class="sb">`</span>

</pre></div></td></tr><tr><td class=docs>
<p>Whether to enable the debug log level in OpenStack services</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">ENABLE_DEBUG_LOG_LEVEL</span><span class="o">=</span><span class="sb">`</span>trueorfalse True <span class="nv">$ENABLE_DEBUG_LOG_LEVEL</span><span class="sb">`</span>

</pre></div></td></tr><tr><td class=docs>
<p>Set fixed and floating range here so we can make sure not to use addresses
from either range when attempting to guess the IP to use for the host.
Note that setting FIXED_RANGE may be necessary when running DevStack
in an OpenStack cloud that uses either of these address ranges internally.</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">FLOATING_RANGE</span><span class="o">=</span><span class="k">${</span><span class="nv">FLOATING_RANGE</span><span class="k">:-</span><span class="nv">172</span><span class="p">.24.4.0/24</span><span class="k">}</span>
<span class="nv">FIXED_RANGE</span><span class="o">=</span><span class="k">${</span><span class="nv">FIXED_RANGE</span><span class="k">:-</span><span class="nv">10</span><span class="p">.0.0.0/24</span><span class="k">}</span>
<span class="nv">FIXED_NETWORK_SIZE</span><span class="o">=</span><span class="k">${</span><span class="nv">FIXED_NETWORK_SIZE</span><span class="k">:-</span><span class="nv">256</span><span class="k">}</span>

<span class="nv">HOST_IP</span><span class="o">=</span><span class="k">$(</span>get_default_host_ip <span class="nv">$FIXED_RANGE</span> <span class="nv">$FLOATING_RANGE</span> <span class="s2">&quot;$HOST_IP_IFACE&quot;</span> <span class="s2">&quot;$HOST_IP&quot;</span><span class="k">)</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$HOST_IP&quot;</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span>die <span class="nv">$LINENO</span> <span class="s2">&quot;Could not determine host ip address.  See local.conf for suggestions on setting HOST_IP.&quot;</span>
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Allow the use of an alternate hostname (such as localhost/127.0.0.1) for service endpoints.</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">SERVICE_HOST</span><span class="o">=</span><span class="k">${</span><span class="nv">SERVICE_HOST</span><span class="k">:-</span><span class="nv">$HOST_IP</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Configure services to use syslog instead of writing to individual log files</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">SYSLOG</span><span class="o">=</span><span class="sb">`</span>trueorfalse False <span class="nv">$SYSLOG</span><span class="sb">`</span>
<span class="nv">SYSLOG_HOST</span><span class="o">=</span><span class="k">${</span><span class="nv">SYSLOG_HOST</span><span class="k">:-</span><span class="nv">$HOST_IP</span><span class="k">}</span>
<span class="nv">SYSLOG_PORT</span><span class="o">=</span><span class="k">${</span><span class="nv">SYSLOG_PORT</span><span class="k">:-</span><span class="nv">516</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Use color for logging output (only available if syslog is not used)</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">LOG_COLOR</span><span class="o">=</span><span class="sb">`</span>trueorfalse True <span class="nv">$LOG_COLOR</span><span class="sb">`</span>

</pre></div></td></tr><tr><td class=docs>
<p>Reset the bundle of CA certificates</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">SSL_BUNDLE_FILE</span><span class="o">=</span><span class="s2">&quot;$DATA_DIR/ca-bundle.pem&quot;</span>
rm -f <span class="nv">$SSL_BUNDLE_FILE</span>

</pre></div></td></tr><tr><td class=docs>
<p>Import common services (database, message queue) configuration</p>
</td><td class=code><div class=highlight><pre>
<span class="nb">source</span> <span class="nv">$TOP_DIR</span>/lib/database
<span class="nb">source</span> <span class="nv">$TOP_DIR</span>/lib/rpc_backend

</pre></div></td></tr><tr><td class=docs>
<p>Make sure we only have one rpc backend enabled,
and the specified rpc backend is available on your platform.</p>
</td><td class=code><div class=highlight><pre>
check_rpc_backend

</pre></div></td></tr><tr><td class=docs>
<p>Use native SSL for servers in SSL_ENABLED_SERVICES</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">USE_SSL</span><span class="o">=</span><span class="k">$(</span>trueorfalse False <span class="nv">$USE_SSL</span><span class="k">)</span>

</pre></div></td></tr><tr><td class=docs>
<p>Service to enable with SSL if USE_SSL is True</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">SSL_ENABLED_SERVICES</span><span class="o">=</span><span class="s2">&quot;key,nova,cinder,glance,s-proxy,neutron&quot;</span>

<span class="k">if </span>is_service_enabled tls-proxy <span class="o">&amp;&amp;</span> <span class="o">[</span> <span class="s2">&quot;$USE_SSL&quot;</span> <span class="o">==</span> <span class="s2">&quot;True&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span>die <span class="nv">$LINENO</span> <span class="s2">&quot;tls-proxy and SSL are mutually exclusive&quot;</span>
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<div class="section" id="configure-projects">
<h2>Configure Projects</h2>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Import apache functions</p>
</td><td class=code><div class=highlight><pre>
<span class="nb">source</span> <span class="nv">$TOP_DIR</span>/lib/apache

</pre></div></td></tr><tr><td class=docs>
<p>Import TLS functions</p>
</td><td class=code><div class=highlight><pre>
<span class="nb">source</span> <span class="nv">$TOP_DIR</span>/lib/tls

</pre></div></td></tr><tr><td class=docs>
<p>Source project function libraries</p>
</td><td class=code><div class=highlight><pre>
<span class="nb">source</span> <span class="nv">$TOP_DIR</span>/lib/infra
<span class="nb">source</span> <span class="nv">$TOP_DIR</span>/lib/oslo
<span class="nb">source</span> <span class="nv">$TOP_DIR</span>/lib/stackforge
<span class="nb">source</span> <span class="nv">$TOP_DIR</span>/lib/horizon
<span class="nb">source</span> <span class="nv">$TOP_DIR</span>/lib/keystone
<span class="nb">source</span> <span class="nv">$TOP_DIR</span>/lib/glance
<span class="nb">source</span> <span class="nv">$TOP_DIR</span>/lib/nova
<span class="nb">source</span> <span class="nv">$TOP_DIR</span>/lib/cinder
<span class="nb">source</span> <span class="nv">$TOP_DIR</span>/lib/swift
<span class="nb">source</span> <span class="nv">$TOP_DIR</span>/lib/ceilometer
<span class="nb">source</span> <span class="nv">$TOP_DIR</span>/lib/heat
<span class="nb">source</span> <span class="nv">$TOP_DIR</span>/lib/neutron
<span class="nb">source</span> <span class="nv">$TOP_DIR</span>/lib/baremetal
<span class="nb">source</span> <span class="nv">$TOP_DIR</span>/lib/ldap
<span class="nb">source</span> <span class="nv">$TOP_DIR</span>/lib/dstat

</pre></div></td></tr><tr><td class=docs>
</div>
</div>
<div class="section" id="extras-source">
<h1>Extras Source</h1>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Phase: source</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if</span> <span class="o">[[</span> -d <span class="nv">$TOP_DIR</span>/extras.d <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    for </span>i in <span class="nv">$TOP_DIR</span>/extras.d/*.sh; <span class="k">do</span>
        <span class="o">[[</span> -r <span class="nv">$i</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nb">source</span> <span class="nv">$i</span> <span class="nb">source</span>
<span class="nb">    </span><span class="k">done</span>
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Set the destination directories for other OpenStack projects</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">OPENSTACKCLIENT_DIR</span><span class="o">=</span><span class="nv">$DEST</span>/python-openstackclient

</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="interactive-configuration">
<h1>Interactive Configuration</h1>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Do all interactive config up front before the logging spew begins</p>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Generic helper to configure passwords</p>
</td><td class=code><div class=highlight><pre>
<span class="k">function </span>read_password <span class="o">{</span>
    <span class="nv">XTRACE</span><span class="o">=</span><span class="k">$(</span><span class="nb">set</span> +o | grep xtrace<span class="k">)</span>
    <span class="nb">set</span> +o xtrace
    <span class="nv">var</span><span class="o">=</span><span class="nv">$1</span>; <span class="nv">msg</span><span class="o">=</span><span class="nv">$2</span>
    <span class="nv">pw</span><span class="o">=</span><span class="k">${</span><span class="p">!var</span><span class="k">}</span>

    <span class="k">if</span> <span class="o">[[</span> -f <span class="nv">$RC_DIR</span>/localrc <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nv">localrc</span><span class="o">=</span><span class="nv">$TOP_DIR</span>/localrc
    <span class="k">else</span>
<span class="k">        </span><span class="nv">localrc</span><span class="o">=</span><span class="nv">$TOP_DIR</span>/.localrc.auto
    <span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>If the password is not defined yet, proceed to prompt user for a password.</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">if</span> <span class="o">[</span> ! <span class="nv">$pw</span> <span class="o">]</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>If there is no localrc file, create one</p>
</td><td class=code><div class=highlight><pre>
        <span class="k">if</span> <span class="o">[</span> ! -e <span class="nv">$localrc</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">            </span>touch <span class="nv">$localrc</span>
        <span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Presumably if we got this far it can only be that our localrc is missing
the required password.  Prompt user for a password and write to localrc.</p>
</td><td class=code><div class=highlight><pre>
        <span class="nb">echo</span> <span class="s1">&#39;&#39;</span>
        <span class="nb">echo</span> <span class="s1">&#39;################################################################################&#39;</span>
        <span class="nb">echo</span> <span class="nv">$msg</span>
        <span class="nb">echo</span> <span class="s1">&#39;################################################################################&#39;</span>
        <span class="nb">echo</span> <span class="s2">&quot;This value will be written to your localrc file so you don&#39;t have to enter it &quot;</span>
        <span class="nb">echo</span> <span class="s2">&quot;again.  Use only alphanumeric characters.&quot;</span>
        <span class="nb">echo</span> <span class="s2">&quot;If you leave this blank, a random default value will be used.&quot;</span>
        <span class="nv">pw</span><span class="o">=</span><span class="s2">&quot; &quot;</span>
        <span class="k">while </span><span class="nb">true</span>; <span class="k">do</span>
<span class="k">            </span><span class="nb">echo</span> <span class="s2">&quot;Enter a password now:&quot;</span>
            <span class="nb">read</span> -e <span class="nv">$var</span>
            <span class="nv">pw</span><span class="o">=</span><span class="k">${</span><span class="p">!var</span><span class="k">}</span>
            <span class="o">[[</span> <span class="s2">&quot;$pw&quot;</span> <span class="o">=</span> <span class="s2">&quot;`echo $pw | tr -cd [:alnum:]`&quot;</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nb">break</span>
<span class="nb">            echo</span> <span class="s2">&quot;Invalid chars in password.  Try again:&quot;</span>
        <span class="k">done</span>
<span class="k">        if</span> <span class="o">[</span> ! <span class="nv">$pw</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">            </span><span class="nv">pw</span><span class="o">=</span><span class="k">$(</span>generate_hex_string 10<span class="k">)</span>
        <span class="k">fi</span>
<span class="k">        </span><span class="nb">eval</span> <span class="s2">&quot;$var=$pw&quot;</span>
        <span class="nb">echo</span> <span class="s2">&quot;$var=$pw&quot;</span> &gt;&gt; <span class="nv">$localrc</span>
    <span class="k">fi</span>
    <span class="nv">$XTRACE</span>
<span class="o">}</span>


</pre></div></td></tr><tr><td class=docs>
<p>Database Configuration</p>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>To select between database backends, add the following to <tt class="docutils literal">localrc</tt>:</p>
<blockquote>
disable_service mysql
enable_service postgresql</blockquote>
<p>The available database backends are listed in <tt class="docutils literal">DATABASE_BACKENDS</tt> after
<tt class="docutils literal">lib/database</tt> is sourced. <tt class="docutils literal">mysql</tt> is the default.</p>
</td><td class=code><div class=highlight><pre>

initialize_database_backends <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">&quot;Using $DATABASE_TYPE database backend&quot;</span> <span class="o">||</span> <span class="nb">echo</span> <span class="s2">&quot;No database enabled&quot;</span>


</pre></div></td></tr><tr><td class=docs>
<p>Queue Configuration</p>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Rabbit connection info</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if </span>is_service_enabled rabbit; <span class="k">then</span>
<span class="k">    </span><span class="nv">RABBIT_HOST</span><span class="o">=</span><span class="k">${</span><span class="nv">RABBIT_HOST</span><span class="k">:-</span><span class="nv">$SERVICE_HOST</span><span class="k">}</span>
    read_password RABBIT_PASSWORD <span class="s2">&quot;ENTER A PASSWORD TO USE FOR RABBIT.&quot;</span>
<span class="k">fi</span>


</pre></div></td></tr><tr><td class=docs>
<p>Keystone</p>
</td><td class=code><div class=highlight><pre>

<span class="k">if </span>is_service_enabled key; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>The <tt class="docutils literal">SERVICE_TOKEN</tt> is used to bootstrap the Keystone database.  It is
just a string and is not a 'real' Keystone token.</p>
</td><td class=code><div class=highlight><pre>
    read_password SERVICE_TOKEN <span class="s2">&quot;ENTER A SERVICE_TOKEN TO USE FOR THE SERVICE ADMIN TOKEN.&quot;</span>
</pre></div></td></tr><tr><td class=docs>
<p>Services authenticate to Identity with servicename/<tt class="docutils literal">SERVICE_PASSWORD</tt></p>
</td><td class=code><div class=highlight><pre>
    read_password SERVICE_PASSWORD <span class="s2">&quot;ENTER A SERVICE_PASSWORD TO USE FOR THE SERVICE AUTHENTICATION.&quot;</span>
</pre></div></td></tr><tr><td class=docs>
<p>Horizon currently truncates usernames and passwords at 20 characters</p>
</td><td class=code><div class=highlight><pre>
    read_password ADMIN_PASSWORD <span class="s2">&quot;ENTER A PASSWORD TO USE FOR HORIZON AND KEYSTONE (20 CHARS OR LESS).&quot;</span>

</pre></div></td></tr><tr><td class=docs>
<p>Keystone can now optionally install OpenLDAP by enabling the <tt class="docutils literal">ldap</tt>
service in <tt class="docutils literal">localrc</tt> (e.g. <tt class="docutils literal">enable_service ldap</tt>).
To clean out the Keystone contents in OpenLDAP set <tt class="docutils literal">KEYSTONE_CLEAR_LDAP</tt>
to <tt class="docutils literal">yes</tt> (e.g. <tt class="docutils literal">KEYSTONE_CLEAR_LDAP=yes</tt>) in <tt class="docutils literal">localrc</tt>.  To enable the
Keystone Identity Driver (<tt class="docutils literal">keystone.identity.backends.ldap.Identity</tt>)
set <tt class="docutils literal">KEYSTONE_IDENTITY_BACKEND</tt> to <tt class="docutils literal">ldap</tt> (e.g.
<tt class="docutils literal">KEYSTONE_IDENTITY_BACKEND=ldap</tt>) in <tt class="docutils literal">localrc</tt>.</p>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>only request ldap password if the service is enabled</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">if </span>is_service_enabled ldap; <span class="k">then</span>
<span class="k">        </span>read_password LDAP_PASSWORD <span class="s2">&quot;ENTER A PASSWORD TO USE FOR LDAP&quot;</span>
    <span class="k">fi</span>
<span class="k">fi</span>


</pre></div></td></tr><tr><td class=docs>
<p>Swift</p>
</td><td class=code><div class=highlight><pre>

<span class="k">if </span>is_service_enabled s-proxy; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>We only ask for Swift Hash if we have enabled swift service.
<tt class="docutils literal">SWIFT_HASH</tt> is a random unique string for a swift cluster that
can never change.</p>
</td><td class=code><div class=highlight><pre>
    read_password SWIFT_HASH <span class="s2">&quot;ENTER A RANDOM SWIFT HASH.&quot;</span>

    <span class="k">if</span> <span class="o">[[</span> -z <span class="s2">&quot;$SWIFT_TEMPURL_KEY&quot;</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="o">[[</span> <span class="s2">&quot;$SWIFT_ENABLE_TEMPURLS&quot;</span> <span class="o">==</span> <span class="s2">&quot;True&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span>read_password SWIFT_TEMPURL_KEY <span class="s2">&quot;ENTER A KEY FOR SWIFT TEMPURLS.&quot;</span>
    <span class="k">fi</span>
<span class="k">fi</span>


</pre></div></td></tr><tr><td class=docs>
<div class="section" id="install-packages">
<h2>Install Packages</h2>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>OpenStack uses a fair number of other projects.</p>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Install package requirements
Source it so the entire environment is available</p>
</td><td class=code><div class=highlight><pre>
echo_summary <span class="s2">&quot;Installing package prerequisites&quot;</span>
<span class="nb">source</span> <span class="nv">$TOP_DIR</span>/tools/install_prereqs.sh

</pre></div></td></tr><tr><td class=docs>
<p>Configure an appropriate python environment</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$OFFLINE&quot;</span> !<span class="o">=</span> <span class="s2">&quot;True&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nv">PYPI_ALTERNATIVE_URL</span><span class="o">=</span><span class="nv">$PYPI_ALTERNATIVE_URL</span> <span class="nv">$TOP_DIR</span>/tools/install_pip.sh
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Do the ugly hacks for broken packages and distros</p>
</td><td class=code><div class=highlight><pre>
<span class="nb">source</span> <span class="nv">$TOP_DIR</span>/tools/fixup_stuff.sh


</pre></div></td></tr><tr><td class=docs>
</div>
</div>
<div class="section" id="extras-pre-install">
<h1>Extras Pre-install</h1>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Phase: pre-install</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if</span> <span class="o">[[</span> -d <span class="nv">$TOP_DIR</span>/extras.d <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    for </span>i in <span class="nv">$TOP_DIR</span>/extras.d/*.sh; <span class="k">do</span>
        <span class="o">[[</span> -r <span class="nv">$i</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nb">source</span> <span class="nv">$i</span> stack pre-install
    <span class="k">done</span>
<span class="k">fi</span>


install_rpc_backend

<span class="k">if </span>is_service_enabled <span class="nv">$DATABASE_BACKENDS</span>; <span class="k">then</span>
<span class="k">    </span>install_database
<span class="k">fi</span>

<span class="k">if </span>is_service_enabled neutron; <span class="k">then</span>
<span class="k">    </span>install_neutron_agent_packages
<span class="k">fi</span>

<span class="nv">TRACK_DEPENDS</span><span class="o">=</span><span class="k">${</span><span class="nv">TRACK_DEPENDS</span><span class="k">:-</span><span class="nv">False</span><span class="k">}</span>

</pre></div></td></tr><tr><td class=docs>
<p>Install python packages into a virtualenv so that we can track them</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if</span> <span class="o">[[</span> <span class="nv">$TRACK_DEPENDS</span> <span class="o">=</span> True <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    </span>echo_summary <span class="s2">&quot;Installing Python packages into a virtualenv $DEST/.venv&quot;</span>
    pip_install -U virtualenv

    rm -rf <span class="nv">$DEST</span>/.venv
    virtualenv --system-site-packages <span class="nv">$DEST</span>/.venv
    <span class="nb">source</span> <span class="nv">$DEST</span>/.venv/bin/activate
    <span class="nv">$DEST</span>/.venv/bin/pip freeze &gt; <span class="nv">$DEST</span>/requires-pre-pip
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="check-out-and-install-source">
<h1>Check Out and Install Source</h1>
</td><td class=code><div class=highlight><pre>

echo_summary <span class="s2">&quot;Installing OpenStack project source&quot;</span>

</pre></div></td></tr><tr><td class=docs>
<p>Install required infra support libraries</p>
</td><td class=code><div class=highlight><pre>
install_infra

</pre></div></td></tr><tr><td class=docs>
<p>Install oslo libraries that have graduated</p>
</td><td class=code><div class=highlight><pre>
install_oslo

</pre></div></td></tr><tr><td class=docs>
<p>Install stackforge libraries for testing</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if </span>is_service_enabled stackforge_libs; <span class="k">then</span>
<span class="k">    </span>install_stackforge
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Install clients libraries</p>
</td><td class=code><div class=highlight><pre>
install_keystoneclient
install_glanceclient
install_cinderclient
install_novaclient
<span class="k">if </span>is_service_enabled swift glance horizon; <span class="k">then</span>
<span class="k">    </span>install_swiftclient
<span class="k">fi</span>
<span class="k">if </span>is_service_enabled neutron nova horizon; <span class="k">then</span>
<span class="k">    </span>install_neutronclient
<span class="k">fi</span>
<span class="k">if </span>is_service_enabled heat horizon; <span class="k">then</span>
<span class="k">    </span>install_heatclient
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Install middleware</p>
</td><td class=code><div class=highlight><pre>
install_keystonemiddleware

git_clone <span class="nv">$OPENSTACKCLIENT_REPO</span> <span class="nv">$OPENSTACKCLIENT_DIR</span> <span class="nv">$OPENSTACKCLIENT_BRANCH</span>
setup_develop <span class="nv">$OPENSTACKCLIENT_DIR</span>

<span class="k">if </span>is_service_enabled key; <span class="k">then</span>
<span class="k">    if</span> <span class="o">[</span> <span class="s2">&quot;$KEYSTONE_AUTH_HOST&quot;</span> <span class="o">==</span> <span class="s2">&quot;$SERVICE_HOST&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">        </span>install_keystone
        configure_keystone
    <span class="k">fi</span>
<span class="k">fi</span>

<span class="k">if </span>is_service_enabled s-proxy; <span class="k">then</span>
<span class="k">    </span>install_swift
    configure_swift

</pre></div></td></tr><tr><td class=docs>
<p>swift3 middleware to provide S3 emulation to Swift</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">if </span>is_service_enabled swift3; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>replace the nova-objectstore port by the swift port</p>
</td><td class=code><div class=highlight><pre>
        <span class="nv">S3_SERVICE_PORT</span><span class="o">=</span>8080
        git_clone <span class="nv">$SWIFT3_REPO</span> <span class="nv">$SWIFT3_DIR</span> <span class="nv">$SWIFT3_BRANCH</span>
        setup_develop <span class="nv">$SWIFT3_DIR</span>
    <span class="k">fi</span>
<span class="k">fi</span>

<span class="k">if </span>is_service_enabled g-api n-api; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>image catalog service</p>
</td><td class=code><div class=highlight><pre>
    install_glance
    configure_glance
<span class="k">fi</span>

<span class="k">if </span>is_service_enabled cinder; <span class="k">then</span>
<span class="k">    </span>install_cinder
    configure_cinder
<span class="k">fi</span>

<span class="k">if </span>is_service_enabled neutron; <span class="k">then</span>
<span class="k">    </span>install_neutron
    install_neutron_third_party
<span class="k">fi</span>

<span class="k">if </span>is_service_enabled nova; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>compute service</p>
</td><td class=code><div class=highlight><pre>
    install_nova
    cleanup_nova
    configure_nova
<span class="k">fi</span>

<span class="k">if </span>is_service_enabled horizon; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>django openstack_auth</p>
</td><td class=code><div class=highlight><pre>
    install_django_openstack_auth
</pre></div></td></tr><tr><td class=docs>
<p>dashboard</p>
</td><td class=code><div class=highlight><pre>
    install_horizon
    configure_horizon
<span class="k">fi</span>

<span class="k">if </span>is_service_enabled ceilometer; <span class="k">then</span>
<span class="k">    </span>install_ceilometerclient
    install_ceilometer
    echo_summary <span class="s2">&quot;Configuring Ceilometer&quot;</span>
    configure_ceilometer
<span class="k">fi</span>

<span class="k">if </span>is_service_enabled heat; <span class="k">then</span>
<span class="k">    </span>install_heat
    install_heat_other
    cleanup_heat
    configure_heat
<span class="k">fi</span>

<span class="k">if </span>is_service_enabled tls-proxy <span class="o">||</span> <span class="o">[</span> <span class="s2">&quot;$USE_SSL&quot;</span> <span class="o">==</span> <span class="s2">&quot;True&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span>configure_CA
    init_CA
    init_cert
</pre></div></td></tr><tr><td class=docs>
<p>Add name to /etc/hosts
don't be naive and add to existing line!</p>
</td><td class=code><div class=highlight><pre>
<span class="k">fi</span>


</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="extras-install">
<h1>Extras Install</h1>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Phase: install</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if</span> <span class="o">[[</span> -d <span class="nv">$TOP_DIR</span>/extras.d <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    for </span>i in <span class="nv">$TOP_DIR</span>/extras.d/*.sh; <span class="k">do</span>
        <span class="o">[[</span> -r <span class="nv">$i</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nb">source</span> <span class="nv">$i</span> stack install
    <span class="k">done</span>
<span class="k">fi</span>

<span class="k">if</span> <span class="o">[[</span> <span class="nv">$TRACK_DEPENDS</span> <span class="o">=</span> True <span class="o">]]</span>; <span class="k">then</span>
    <span class="nv">$DEST</span>/.venv/bin/pip freeze &gt; <span class="nv">$DEST</span>/requires-post-pip
    <span class="k">if</span> ! diff -Nru <span class="nv">$DEST</span>/requires-pre-pip <span class="nv">$DEST</span>/requires-post-pip &gt; <span class="nv">$DEST</span>/requires.diff; <span class="k">then</span>
<span class="k">        </span><span class="nb">echo</span> <span class="s2">&quot;Detect some changes for installed packages of pip, in depend tracking mode&quot;</span>
        cat <span class="nv">$DEST</span>/requires.diff
    <span class="k">fi</span>
<span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;Ran stack.sh in depend tracking mode, bailing out now&quot;</span>
    <span class="nb">exit </span>0
<span class="k">fi</span>


</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="syslog">
<h1>Syslog</h1>
</td><td class=code><div class=highlight><pre>

<span class="k">if</span> <span class="o">[[</span> <span class="nv">$SYSLOG</span> !<span class="o">=</span> <span class="s2">&quot;False&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    if</span> <span class="o">[[</span> <span class="s2">&quot;$SYSLOG_HOST&quot;</span> <span class="o">=</span> <span class="s2">&quot;$HOST_IP&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>Configure the master host to receive</p>
</td><td class=code><div class=highlight><pre>
        cat <span class="s">&lt;&lt;EOF &gt;/tmp/90-stack-m.conf</span>
<span class="s">\$ModLoad imrelp</span>
<span class="s">\$InputRELPServerRun $SYSLOG_PORT</span>
<span class="s">EOF</span>
        sudo mv /tmp/90-stack-m.conf /etc/rsyslog.d
    <span class="k">else</span>
</pre></div></td></tr><tr><td class=docs>
<p>Set rsyslog to send to remote host</p>
</td><td class=code><div class=highlight><pre>
        cat <span class="s">&lt;&lt;EOF &gt;/tmp/90-stack-s.conf</span>
<span class="s">*.*		:omrelp:$SYSLOG_HOST:$SYSLOG_PORT</span>
<span class="s">EOF</span>
        sudo mv /tmp/90-stack-s.conf /etc/rsyslog.d
    <span class="k">fi</span>

<span class="k">    </span><span class="nv">RSYSLOGCONF</span><span class="o">=</span><span class="s2">&quot;/etc/rsyslog.conf&quot;</span>
    <span class="k">if</span> <span class="o">[</span> -f <span class="nv">$RSYSLOGCONF</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">        </span>sudo cp -b <span class="nv">$RSYSLOGCONF</span> <span class="nv">$RSYSLOGCONF</span>.bak
        <span class="k">if</span> <span class="o">[[</span> <span class="k">$(</span>grep <span class="s1">&#39;$SystemLogRateLimitBurst&#39;</span> <span class="nv">$RSYSLOGCONF</span><span class="k">)</span>  <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            </span>sudo sed -i <span class="s1">&#39;s/$SystemLogRateLimitBurst\ .*/$SystemLogRateLimitBurst\ 0/&#39;</span> <span class="nv">$RSYSLOGCONF</span>
        <span class="k">else</span>
<span class="k">            </span>sudo sed -i <span class="s1">&#39;$ i $SystemLogRateLimitBurst\ 0&#39;</span> <span class="nv">$RSYSLOGCONF</span>
        <span class="k">fi</span>
<span class="k">        if</span> <span class="o">[[</span> <span class="k">$(</span>grep <span class="s1">&#39;$SystemLogRateLimitInterval&#39;</span> <span class="nv">$RSYSLOGCONF</span><span class="k">)</span>  <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            </span>sudo sed -i <span class="s1">&#39;s/$SystemLogRateLimitInterval\ .*/$SystemLogRateLimitInterval\ 0/&#39;</span> <span class="nv">$RSYSLOGCONF</span>
        <span class="k">else</span>
<span class="k">            </span>sudo sed -i <span class="s1">&#39;$ i $SystemLogRateLimitInterval\ 0&#39;</span> <span class="nv">$RSYSLOGCONF</span>
        <span class="k">fi</span>
<span class="k">    fi</span>

<span class="k">    </span>echo_summary <span class="s2">&quot;Starting rsyslog&quot;</span>
    restart_service rsyslog
<span class="k">fi</span>


</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="finalize-queue-installation">
<h1>Finalize queue installation</h1>
</td><td class=code><div class=highlight><pre>
restart_rpc_backend


</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="export-certicate-authority-bundle">
<h1>Export Certicate Authority Bundle</h1>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>If certificates were used and written to the SSL bundle file then these
should be exported so clients can validate their connections.</p>
</td><td class=code><div class=highlight><pre>

<span class="k">if</span> <span class="o">[</span> -f <span class="nv">$SSL_BUNDLE_FILE</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nb">export </span><span class="nv">OS_CACERT</span><span class="o">=</span><span class="nv">$SSL_BUNDLE_FILE</span>
<span class="k">fi</span>


</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="configure-database">
<h1>Configure database</h1>
</td><td class=code><div class=highlight><pre>

<span class="k">if </span>is_service_enabled <span class="nv">$DATABASE_BACKENDS</span>; <span class="k">then</span>
<span class="k">    </span>configure_database
<span class="k">fi</span>


</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="configure-screen">
<h1>Configure screen</h1>
</td><td class=code><div class=highlight><pre>

<span class="nv">USE_SCREEN</span><span class="o">=</span><span class="k">$(</span>trueorfalse True <span class="nv">$USE_SCREEN</span><span class="k">)</span>
<span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$USE_SCREEN&quot;</span> <span class="o">==</span> <span class="s2">&quot;True&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>Create a new named screen to run processes in</p>
</td><td class=code><div class=highlight><pre>
    screen -d -m -S <span class="nv">$SCREEN_NAME</span> -t shell -s /bin/bash
    sleep 1

</pre></div></td></tr><tr><td class=docs>
<p>Set a reasonable status bar</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;$SCREEN_HARDSTATUS&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nv">SCREEN_HARDSTATUS</span><span class="o">=</span><span class="s1">&#39;%{= .} %-Lw%{= .}%&gt; %n%f %t*%{= .}%+Lw%&lt; %-=%{g}(%{d}%H/%l%{g})&#39;</span>
    <span class="k">fi</span>
<span class="k">    </span>screen -r <span class="nv">$SCREEN_NAME</span> -X hardstatus alwayslastline <span class="s2">&quot;$SCREEN_HARDSTATUS&quot;</span>
    screen -r <span class="nv">$SCREEN_NAME</span> -X setenv PROMPT_COMMAND /bin/true
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Clear screen rc file</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">SCREENRC</span><span class="o">=</span><span class="nv">$TOP_DIR</span>/<span class="nv">$SCREEN_NAME</span>-screenrc
<span class="k">if</span> <span class="o">[[</span> -e <span class="nv">$SCREENRC</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    </span>rm -f <span class="nv">$SCREENRC</span>
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Initialize the directory for service status check</p>
</td><td class=code><div class=highlight><pre>
init_service_check

</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="dstat">
<h1>Dstat</h1>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>A better kind of sysstat, with the top process per time slice</p>
</td><td class=code><div class=highlight><pre>
start_dstat

</pre></div></td></tr><tr><td class=docs>
<div class="section" id="start-services">
<h2>Start Services</h2>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
</div>
</div>
<div class="section" id="keystone">
<h1>Keystone</h1>
</td><td class=code><div class=highlight><pre>

<span class="k">if </span>is_service_enabled key; <span class="k">then</span>
<span class="k">    </span>echo_summary <span class="s2">&quot;Starting Keystone&quot;</span>

    <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$KEYSTONE_AUTH_HOST&quot;</span> <span class="o">==</span> <span class="s2">&quot;$SERVICE_HOST&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">        </span>init_keystone
        start_keystone
    <span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Set up a temporary admin URI for Keystone</p>
</td><td class=code><div class=highlight><pre>
    <span class="nv">SERVICE_ENDPOINT</span><span class="o">=</span><span class="nv">$KEYSTONE_AUTH_URI</span>/v2.0

    <span class="k">if </span>is_service_enabled tls-proxy; <span class="k">then</span>
<span class="k">        </span><span class="nb">export </span><span class="nv">OS_CACERT</span><span class="o">=</span><span class="nv">$INT_CA_DIR</span>/ca-chain.pem
</pre></div></td></tr><tr><td class=docs>
<p>Until the client support is fixed, just use the internal endpoint</p>
</td><td class=code><div class=highlight><pre>
        <span class="nv">SERVICE_ENDPOINT</span><span class="o">=</span>http://<span class="nv">$KEYSTONE_AUTH_HOST</span>:<span class="nv">$KEYSTONE_AUTH_PORT_INT</span>/v2.0
    <span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Setup OpenStackclient token-flow auth</p>
</td><td class=code><div class=highlight><pre>
    <span class="nb">export </span><span class="nv">OS_TOKEN</span><span class="o">=</span><span class="nv">$SERVICE_TOKEN</span>
    <span class="nb">export </span><span class="nv">OS_URL</span><span class="o">=</span><span class="nv">$SERVICE_ENDPOINT</span>

    create_keystone_accounts
    create_nova_accounts
    create_glance_accounts
    create_cinder_accounts
    create_neutron_accounts

    <span class="k">if </span>is_service_enabled ceilometer; <span class="k">then</span>
<span class="k">        </span>create_ceilometer_accounts
    <span class="k">fi</span>

<span class="k">    if </span>is_service_enabled swift; <span class="k">then</span>
<span class="k">        </span>create_swift_accounts
    <span class="k">fi</span>

<span class="k">    if </span>is_service_enabled heat <span class="o">&amp;&amp;</span> <span class="o">[[</span> <span class="s2">&quot;$HEAT_STANDALONE&quot;</span> !<span class="o">=</span> <span class="s2">&quot;True&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span>create_heat_accounts
    <span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Begone token-flow auth</p>
</td><td class=code><div class=highlight><pre>
    <span class="nb">unset </span>OS_TOKEN OS_URL

</pre></div></td></tr><tr><td class=docs>
<p>Set up password-flow auth creds now that keystone is bootstrapped</p>
</td><td class=code><div class=highlight><pre>
    <span class="nb">export </span><span class="nv">OS_AUTH_URL</span><span class="o">=</span><span class="nv">$SERVICE_ENDPOINT</span>
    <span class="nb">export </span><span class="nv">OS_TENANT_NAME</span><span class="o">=</span>admin
    <span class="nb">export </span><span class="nv">OS_USERNAME</span><span class="o">=</span>admin
    <span class="nb">export </span><span class="nv">OS_PASSWORD</span><span class="o">=</span><span class="nv">$ADMIN_PASSWORD</span>
    <span class="nb">export </span><span class="nv">OS_REGION_NAME</span><span class="o">=</span><span class="nv">$REGION_NAME</span>
<span class="k">fi</span>


</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="horizon">
<h1>Horizon</h1>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Set up the django horizon application to serve via apache/wsgi</p>
</td><td class=code><div class=highlight><pre>

<span class="k">if </span>is_service_enabled horizon; <span class="k">then</span>
<span class="k">    </span>echo_summary <span class="s2">&quot;Configuring and starting Horizon&quot;</span>
    init_horizon
    start_horizon
<span class="k">fi</span>


</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="glance">
<h1>Glance</h1>
</td><td class=code><div class=highlight><pre>

<span class="k">if </span>is_service_enabled g-reg; <span class="k">then</span>
<span class="k">    </span>echo_summary <span class="s2">&quot;Configuring Glance&quot;</span>
    init_glance
<span class="k">fi</span>


</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="neutron">
<h1>Neutron</h1>
</td><td class=code><div class=highlight><pre>

<span class="k">if </span>is_service_enabled neutron; <span class="k">then</span>
<span class="k">    </span>echo_summary <span class="s2">&quot;Configuring Neutron&quot;</span>

    configure_neutron
</pre></div></td></tr><tr><td class=docs>
<p>Run init_neutron only on the node hosting the neutron API server</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">if </span>is_service_enabled <span class="nv">$DATABASE_BACKENDS</span> <span class="o">&amp;&amp;</span> is_service_enabled q-svc; <span class="k">then</span>
<span class="k">        </span>init_neutron
    <span class="k">fi</span>
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Some Neutron plugins require network controllers which are not
a part of the OpenStack project. Configure and start them.</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if </span>is_service_enabled neutron; <span class="k">then</span>
<span class="k">    </span>configure_neutron_third_party
    init_neutron_third_party
    start_neutron_third_party
<span class="k">fi</span>


</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="nova">
<h1>Nova</h1>
</td><td class=code><div class=highlight><pre>

<span class="k">if </span>is_service_enabled n-net q-dhcp; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>Delete traces of nova networks from prior runs
Do not kill any dnsmasq instance spawned by NetworkManager</p>
</td><td class=code><div class=highlight><pre>
    <span class="nv">netman_pid</span><span class="o">=</span><span class="k">$(</span>pidof NetworkManager <span class="o">||</span> <span class="nb">true</span><span class="k">)</span>
    <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;$netman_pid&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">        </span>sudo killall dnsmasq <span class="o">||</span> <span class="nb">true</span>
<span class="nb">    </span><span class="k">else</span>
<span class="k">        </span>sudo ps h -o pid,ppid -C dnsmasq | grep -v <span class="nv">$netman_pid</span> | awk <span class="s1">&#39;{print $1}&#39;</span> | sudo xargs <span class="nb">kill</span> <span class="o">||</span> <span class="nb">true</span>
<span class="nb">    </span><span class="k">fi</span>

<span class="k">    </span>clean_iptables

    <span class="k">if </span>is_service_enabled n-net; <span class="k">then</span>
<span class="k">        </span>rm -rf <span class="k">${</span><span class="nv">NOVA_STATE_PATH</span><span class="k">}</span>/networks
        sudo mkdir -p <span class="k">${</span><span class="nv">NOVA_STATE_PATH</span><span class="k">}</span>/networks
        safe_chown -R <span class="k">${</span><span class="nv">STACK_USER</span><span class="k">}</span> <span class="k">${</span><span class="nv">NOVA_STATE_PATH</span><span class="k">}</span>/networks
    <span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Force IP forwarding on, just in case</p>
</td><td class=code><div class=highlight><pre>
    sudo sysctl -w net.ipv4.ip_forward<span class="o">=</span>1
<span class="k">fi</span>


</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="storage-service">
<h1>Storage Service</h1>
</td><td class=code><div class=highlight><pre>

<span class="k">if </span>is_service_enabled s-proxy; <span class="k">then</span>
<span class="k">    </span>echo_summary <span class="s2">&quot;Configuring Swift&quot;</span>
    init_swift
<span class="k">fi</span>


</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="volume-service">
<h1>Volume Service</h1>
</td><td class=code><div class=highlight><pre>

<span class="k">if </span>is_service_enabled cinder; <span class="k">then</span>
<span class="k">    </span>echo_summary <span class="s2">&quot;Configuring Cinder&quot;</span>
    init_cinder
<span class="k">fi</span>


</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="compute-service">
<h1>Compute Service</h1>
</td><td class=code><div class=highlight><pre>

<span class="k">if </span>is_service_enabled nova; <span class="k">then</span>
<span class="k">    </span>echo_summary <span class="s2">&quot;Configuring Nova&quot;</span>
    init_nova

</pre></div></td></tr><tr><td class=docs>
<p>Additional Nova configuration that is dependent on other services</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">if </span>is_service_enabled neutron; <span class="k">then</span>
<span class="k">        </span>create_nova_conf_neutron
    <span class="k">elif </span>is_service_enabled n-net; <span class="k">then</span>
<span class="k">        </span>create_nova_conf_nova_network
    <span class="k">fi</span>

<span class="k">    </span>init_nova_cells
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Extra things to prepare nova for baremetal, before nova starts</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if </span>is_service_enabled nova <span class="o">&amp;&amp;</span> is_baremetal; <span class="k">then</span>
<span class="k">    </span>echo_summary <span class="s2">&quot;Preparing for nova baremetal&quot;</span>
    prepare_baremetal_toolchain
    configure_baremetal_nova_dirs
<span class="k">fi</span>


</pre></div></td></tr><tr><td class=docs>
<div class="section" id="extras-configuration">
<h2>Extras Configuration</h2>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Phase: post-config</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if</span> <span class="o">[[</span> -d <span class="nv">$TOP_DIR</span>/extras.d <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    for </span>i in <span class="nv">$TOP_DIR</span>/extras.d/*.sh; <span class="k">do</span>
        <span class="o">[[</span> -r <span class="nv">$i</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nb">source</span> <span class="nv">$i</span> stack post-config
    <span class="k">done</span>
<span class="k">fi</span>


</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="local-configuration">
<h2>Local Configuration</h2>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Apply configuration from local.conf if it exists for layer 2 services
Phase: post-config</p>
</td><td class=code><div class=highlight><pre>
merge_config_group <span class="nv">$TOP_DIR</span>/local.conf post-config


</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="launch-services">
<h2>Launch Services</h2>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Only run the services specified in <tt class="docutils literal">ENABLED_SERVICES</tt></p>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Launch Swift Services</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if </span>is_service_enabled s-proxy; <span class="k">then</span>
<span class="k">    </span>echo_summary <span class="s2">&quot;Starting Swift&quot;</span>
    start_swift
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Launch the Glance services</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if </span>is_service_enabled glance; <span class="k">then</span>
<span class="k">    </span>echo_summary <span class="s2">&quot;Starting Glance&quot;</span>
    start_glance
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="install-images">
<h2>Install Images</h2>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Upload an image to glance.</p>
<p>The default image is cirros, a small testing image which lets you login as <strong>root</strong>
cirros has a <tt class="docutils literal"><span class="pre">cloud-init</span></tt> analog supporting login via keypair and sending
scripts as userdata.
See <a class="reference external" href="https://help.ubuntu.com/community/CloudInit">https://help.ubuntu.com/community/CloudInit</a> for more on cloud-init</p>
<dl class="docutils">
<dt>Override <tt class="docutils literal">IMAGE_URLS</tt> with a comma-separated list of UEC images.</dt>
<dd><ul class="first last simple">
<li><strong>precise</strong>: <a class="reference external" href="http://uec-images.ubuntu.com/precise/current/precise-server-cloudimg-amd64.tar.gz">http://uec-images.ubuntu.com/precise/current/precise-server-cloudimg-amd64.tar.gz</a></li>
</ul>
</dd>
</dl>
</td><td class=code><div class=highlight><pre>

<span class="k">if </span>is_service_enabled g-reg; <span class="k">then</span>
<span class="k">    </span><span class="nv">TOKEN</span><span class="o">=</span><span class="k">$(</span>keystone token-get | grep <span class="s1">&#39; id &#39;</span> | get_field 2<span class="k">)</span>
    die_if_not_set <span class="nv">$LINENO</span> TOKEN <span class="s2">&quot;Keystone fail to get token&quot;</span>

    <span class="k">if </span>is_baremetal; <span class="k">then</span>
<span class="k">        </span>echo_summary <span class="s2">&quot;Creating and uploading baremetal images&quot;</span>

</pre></div></td></tr><tr><td class=docs>
<p>build and upload separate deploy kernel &amp; ramdisk</p>
</td><td class=code><div class=highlight><pre>
        upload_baremetal_deploy <span class="nv">$TOKEN</span>

</pre></div></td></tr><tr><td class=docs>
<p>upload images, separating out the kernel &amp; ramdisk for PXE boot</p>
</td><td class=code><div class=highlight><pre>
        <span class="k">for </span>image_url in <span class="k">${</span><span class="nv">IMAGE_URLS</span><span class="p">//,/ </span><span class="k">}</span>; <span class="k">do</span>
<span class="k">            </span>upload_baremetal_image <span class="nv">$image_url</span> <span class="nv">$TOKEN</span>
        <span class="k">done</span>
<span class="k">    else</span>
<span class="k">        </span>echo_summary <span class="s2">&quot;Uploading images&quot;</span>

</pre></div></td></tr><tr><td class=docs>
<p>Option to upload legacy ami-tty, which works with xenserver</p>
</td><td class=code><div class=highlight><pre>
        <span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&quot;$UPLOAD_LEGACY_TTY&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">            </span><span class="nv">IMAGE_URLS</span><span class="o">=</span><span class="s2">&quot;${IMAGE_URLS:+${IMAGE_URLS},}https://github.com/downloads/citrix-openstack/warehouse/tty.tgz&quot;</span>
        <span class="k">fi</span>

<span class="k">        for </span>image_url in <span class="k">${</span><span class="nv">IMAGE_URLS</span><span class="p">//,/ </span><span class="k">}</span>; <span class="k">do</span>
<span class="k">            </span>upload_image <span class="nv">$image_url</span> <span class="nv">$TOKEN</span>
        <span class="k">done</span>
<span class="k">    fi</span>
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Create an access key and secret key for nova ec2 register image</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if </span>is_service_enabled key <span class="o">&amp;&amp;</span> is_service_enabled swift3 <span class="o">&amp;&amp;</span> is_service_enabled nova; <span class="k">then</span>
<span class="k">    </span><span class="nb">eval</span> <span class="k">$(</span>openstack ec2 credentials create --user nova --project <span class="nv">$SERVICE_TENANT_NAME</span> -f shell -c access -c secret<span class="k">)</span>
    iniset <span class="nv">$NOVA_CONF</span> DEFAULT s3_access_key <span class="s2">&quot;$access&quot;</span>
    iniset <span class="nv">$NOVA_CONF</span> DEFAULT s3_secret_key <span class="s2">&quot;$secret&quot;</span>
    iniset <span class="nv">$NOVA_CONF</span> DEFAULT s3_affix_tenant <span class="s2">&quot;True&quot;</span>
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Create a randomized default value for the keymgr's fixed_key</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if </span>is_service_enabled nova; <span class="k">then</span>
<span class="k">    </span>iniset <span class="nv">$NOVA_CONF</span> keymgr fixed_key <span class="k">$(</span>generate_hex_string 32<span class="k">)</span>
<span class="k">fi</span>

<span class="k">if </span>is_service_enabled zeromq; <span class="k">then</span>
<span class="k">    </span>echo_summary <span class="s2">&quot;Starting zermomq receiver&quot;</span>
    run_process zeromq <span class="s2">&quot;$OSLO_BIN_DIR/oslo-messaging-zmq-receiver&quot;</span>
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Launch the nova-api and wait for it to answer before continuing</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if </span>is_service_enabled n-api; <span class="k">then</span>
<span class="k">    </span>echo_summary <span class="s2">&quot;Starting Nova API&quot;</span>
    start_nova_api
<span class="k">fi</span>

<span class="k">if </span>is_service_enabled q-svc; <span class="k">then</span>
<span class="k">    </span>echo_summary <span class="s2">&quot;Starting Neutron&quot;</span>
    start_neutron_service_and_check
    check_neutron_third_party_integration
<span class="k">elif </span>is_service_enabled <span class="nv">$DATABASE_BACKENDS</span> <span class="o">&amp;&amp;</span> is_service_enabled n-net; <span class="k">then</span>
<span class="k">    </span><span class="nv">NM_CONF</span><span class="o">=</span><span class="k">${</span><span class="nv">NOVA_CONF</span><span class="k">}</span>
    <span class="k">if </span>is_service_enabled n-cell; <span class="k">then</span>
<span class="k">        </span><span class="nv">NM_CONF</span><span class="o">=</span><span class="k">${</span><span class="nv">NOVA_CELLS_CONF</span><span class="k">}</span>
    <span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Create a small network</p>
</td><td class=code><div class=highlight><pre>
    <span class="nv">$NOVA_BIN_DIR</span>/nova-manage --config-file <span class="nv">$NM_CONF</span> network create <span class="s2">&quot;$PRIVATE_NETWORK_NAME&quot;</span> <span class="nv">$FIXED_RANGE</span> 1 <span class="nv">$FIXED_NETWORK_SIZE</span> <span class="nv">$NETWORK_CREATE_ARGS</span>

</pre></div></td></tr><tr><td class=docs>
<p>Create some floating ips</p>
</td><td class=code><div class=highlight><pre>
    <span class="nv">$NOVA_BIN_DIR</span>/nova-manage --config-file <span class="nv">$NM_CONF</span> floating create <span class="nv">$FLOATING_RANGE</span> --pool<span class="o">=</span><span class="nv">$PUBLIC_NETWORK_NAME</span>

</pre></div></td></tr><tr><td class=docs>
<p>Create a second pool</p>
</td><td class=code><div class=highlight><pre>
    <span class="nv">$NOVA_BIN_DIR</span>/nova-manage --config-file <span class="nv">$NM_CONF</span> floating create --ip_range<span class="o">=</span><span class="nv">$TEST_FLOATING_RANGE</span> --pool<span class="o">=</span><span class="nv">$TEST_FLOATING_POOL</span>
<span class="k">fi</span>

<span class="k">if </span>is_service_enabled neutron; <span class="k">then</span>
<span class="k">    </span>start_neutron_agents
<span class="k">fi</span>
</pre></div></td></tr><tr><td class=docs>
<p>Once neutron agents are started setup initial network elements</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if </span>is_service_enabled q-svc; <span class="k">then</span>
<span class="k">    </span>echo_summary <span class="s2">&quot;Creating initial neutron network elements&quot;</span>
    create_neutron_initial_network
    setup_neutron_debug
<span class="k">fi</span>
<span class="k">if </span>is_service_enabled nova; <span class="k">then</span>
<span class="k">    </span>echo_summary <span class="s2">&quot;Starting Nova&quot;</span>
    start_nova
<span class="k">fi</span>
<span class="k">if </span>is_service_enabled cinder; <span class="k">then</span>
<span class="k">    </span>echo_summary <span class="s2">&quot;Starting Cinder&quot;</span>
    start_cinder
    create_volume_types
<span class="k">fi</span>
<span class="k">if </span>is_service_enabled ceilometer; <span class="k">then</span>
<span class="k">    </span>echo_summary <span class="s2">&quot;Starting Ceilometer&quot;</span>
    init_ceilometer
    start_ceilometer
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Configure and launch heat engine, api and metadata</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if </span>is_service_enabled heat; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>Initialize heat</p>
</td><td class=code><div class=highlight><pre>
    echo_summary <span class="s2">&quot;Configuring Heat&quot;</span>
    init_heat
    echo_summary <span class="s2">&quot;Starting Heat&quot;</span>
    start_heat
    <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$HEAT_CREATE_TEST_IMAGE&quot;</span> <span class="o">=</span> <span class="s2">&quot;True&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">        </span>echo_summary <span class="s2">&quot;Building Heat functional test image&quot;</span>
        build_heat_functional_test_image
    <span class="k">fi</span>
<span class="k">fi</span>


</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="create-account-rc-files">
<h2>Create account rc files</h2>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Creates source able script files for easier user switching.
This step also creates certificates for tenants and users,
which is helpful in image bundle steps.</p>
</td><td class=code><div class=highlight><pre>

<span class="k">if </span>is_service_enabled nova <span class="o">&amp;&amp;</span> is_service_enabled key; <span class="k">then</span>
<span class="k">    </span><span class="nv">USERRC_PARAMS</span><span class="o">=</span><span class="s2">&quot;-PA --target-dir $TOP_DIR/accrc&quot;</span>

    <span class="k">if</span> <span class="o">[</span> -f <span class="nv">$SSL_BUNDLE_FILE</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nv">USERRC_PARAMS</span><span class="o">=</span><span class="s2">&quot;$USERRC_PARAMS --os-cacert $SSL_BUNDLE_FILE&quot;</span>
    <span class="k">fi</span>

<span class="k">    if</span> <span class="o">[[</span> <span class="s2">&quot;$HEAT_STANDALONE&quot;</span> <span class="o">=</span> <span class="s2">&quot;True&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nv">USERRC_PARAMS</span><span class="o">=</span><span class="s2">&quot;$USERRC_PARAMS --heat-url http://$HEAT_API_HOST:$HEAT_API_PORT/v1&quot;</span>
    <span class="k">fi</span>

    <span class="nv">$TOP_DIR</span>/tools/create_userrc.sh <span class="nv">$USERRC_PARAMS</span>
<span class="k">fi</span>


</pre></div></td></tr><tr><td class=docs>
<p>If we are running nova with baremetal driver, there are a few
last-mile configuration bits to attend to, which must happen
after n-api and n-sch have started.
Also, creating the baremetal flavor must happen after images
are loaded into glance, though just knowing the IDs is sufficient here</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if </span>is_service_enabled nova <span class="o">&amp;&amp;</span> is_baremetal; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>create special flavor for baremetal if we know what images to associate</p>
</td><td class=code><div class=highlight><pre>
    <span class="o">[[</span> -n <span class="s2">&quot;$BM_DEPLOY_KERNEL_ID&quot;</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="o">[[</span> -n <span class="s2">&quot;$BM_DEPLOY_RAMDISK_ID&quot;</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="se">\</span>
        create_baremetal_flavor <span class="nv">$BM_DEPLOY_KERNEL_ID</span> <span class="nv">$BM_DEPLOY_RAMDISK_ID</span>

</pre></div></td></tr><tr><td class=docs>
<p>otherwise user can manually add it later by calling nova-baremetal-manage</p>
</td><td class=code><div class=highlight><pre>
    <span class="o">[[</span> -n <span class="s2">&quot;$BM_FIRST_MAC&quot;</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> add_baremetal_node

    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$BM_DNSMASQ_FROM_NOVA_NETWORK&quot;</span> <span class="o">=</span> <span class="s2">&quot;False&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>NOTE: we do this here to ensure that our copy of dnsmasq is running</p>
</td><td class=code><div class=highlight><pre>
        sudo pkill dnsmasq <span class="o">||</span> <span class="nb">true</span>
<span class="nb">        </span>sudo dnsmasq --conf-file<span class="o">=</span> --port<span class="o">=</span>0 --enable-tftp --tftp-root<span class="o">=</span>/tftpboot <span class="se">\</span>
            --dhcp-boot<span class="o">=</span>pxelinux.0 --bind-interfaces --pid-file<span class="o">=</span>/var/run/dnsmasq.pid <span class="se">\</span>
            --interface<span class="o">=</span><span class="nv">$BM_DNSMASQ_IFACE</span> --dhcp-range<span class="o">=</span><span class="nv">$BM_DNSMASQ_RANGE</span> <span class="se">\</span>
            <span class="k">${</span><span class="nv">BM_DNSMASQ_DNS</span><span class="p">:+--dhcp-option=option:</span><span class="nv">dns</span><span class="p">-server,</span><span class="nv">$BM_DNSMASQ_DNS</span><span class="k">}</span>
    <span class="k">fi</span>
</pre></div></td></tr><tr><td class=docs>
<p>ensure callback daemon is running</p>
</td><td class=code><div class=highlight><pre>
    sudo pkill nova-baremetal-deploy-helper <span class="o">||</span> <span class="nb">true</span>
<span class="nb">    </span>run_process baremetal <span class="s2">&quot;nova-baremetal-deploy-helper&quot;</span>
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Save some values we generated for later use</p>
</td><td class=code><div class=highlight><pre>
<span class="nv">CURRENT_RUN_TIME</span><span class="o">=</span><span class="k">$(</span>date <span class="s2">&quot;+$TIMESTAMP_FORMAT&quot;</span><span class="k">)</span>
<span class="nb">echo</span> <span class="s2">&quot;# $CURRENT_RUN_TIME&quot;</span> &gt;<span class="nv">$TOP_DIR</span>/.stackenv
<span class="k">for </span>i in BASE_SQL_CONN ENABLED_SERVICES HOST_IP LOGFILE <span class="se">\</span>
    SERVICE_HOST SERVICE_PROTOCOL STACK_USER TLS_IP KEYSTONE_AUTH_PROTOCOL OS_CACERT; <span class="k">do</span>
<span class="k">    </span><span class="nb">echo</span> <span class="nv">$i</span><span class="o">=</span><span class="k">${</span><span class="p">!i</span><span class="k">}</span> &gt;&gt;<span class="nv">$TOP_DIR</span>/.stackenv
<span class="k">done</span>


</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="id1">
<h2>Local Configuration</h2>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Apply configuration from local.conf if it exists for layer 2 services
Phase: extra</p>
</td><td class=code><div class=highlight><pre>
merge_config_group <span class="nv">$TOP_DIR</span>/local.conf extra


</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="run-extras">
<h2>Run extras</h2>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Phase: extra</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if</span> <span class="o">[[</span> -d <span class="nv">$TOP_DIR</span>/extras.d <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    for </span>i in <span class="nv">$TOP_DIR</span>/extras.d/*.sh; <span class="k">do</span>
        <span class="o">[[</span> -r <span class="nv">$i</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nb">source</span> <span class="nv">$i</span> stack extra
    <span class="k">done</span>
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="id2">
<h2>Local Configuration</h2>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Apply configuration from local.conf if it exists for layer 2 services
Phase: post-extra</p>
</td><td class=code><div class=highlight><pre>
merge_config_group <span class="nv">$TOP_DIR</span>/local.conf post-extra


</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="run-local-script">
<h2>Run local script</h2>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
<p>Run <tt class="docutils literal">local.sh</tt> if it exists to perform user-managed tasks</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if</span> <span class="o">[[</span> -x <span class="nv">$TOP_DIR</span>/local.sh <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;Running user script $TOP_DIR/local.sh&quot;</span>
    <span class="nv">$TOP_DIR</span>/local.sh
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Check the status of running services</p>
</td><td class=code><div class=highlight><pre>
service_check


</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="fin">
<h2>Fin</h2>
</td><td class=code><div class=highlight><pre>

<span class="nb">set</span> +o xtrace

<span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&quot;$LOGFILE&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nb">exec </span>1&gt;&amp;3
</pre></div></td></tr><tr><td class=docs>
<p>Force all output to stdout and logs now</p>
</td><td class=code><div class=highlight><pre>
    <span class="nb">exec </span>1&gt; &gt;<span class="o">(</span> tee -a <span class="s2">&quot;${LOGFILE}&quot;</span> <span class="o">)</span> 2&gt;&amp;1
<span class="k">else</span>
</pre></div></td></tr><tr><td class=docs>
<p>Force all output to stdout now</p>
</td><td class=code><div class=highlight><pre>
    <span class="nb">exec </span>1&gt;&amp;3
<span class="k">fi</span>


</pre></div></td></tr><tr><td class=docs>
</div>
</div>
<div class="section" id="using-the-cloud">
<h1>Using the cloud</h1>
</td><td class=code><div class=highlight><pre>

<span class="nb">echo</span> <span class="s2">&quot;&quot;</span>
<span class="nb">echo</span> <span class="s2">&quot;&quot;</span>
<span class="nb">echo</span> <span class="s2">&quot;&quot;</span>

</pre></div></td></tr><tr><td class=docs>
<p>If you installed Horizon on this server you should be able
to access the site using your browser.</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if </span>is_service_enabled horizon; <span class="k">then</span>
<span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;Horizon is now available at http://$SERVICE_HOST/&quot;</span>
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>If Keystone is present you can point <tt class="docutils literal">nova</tt> cli to this server</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if </span>is_service_enabled key; <span class="k">then</span>
<span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;Keystone is serving at $KEYSTONE_SERVICE_URI/v2.0/&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;Examples on using novaclient command line is in exercise.sh&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;The default users are: admin and demo&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;The password: $ADMIN_PASSWORD&quot;</span>
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Echo <tt class="docutils literal">HOST_IP</tt> - useful for <tt class="docutils literal">build_uec.sh</tt>, which uses dhcp to give the instance an address</p>
</td><td class=code><div class=highlight><pre>
<span class="nb">echo</span> <span class="s2">&quot;This is your host ip: $HOST_IP&quot;</span>

</pre></div></td></tr><tr><td class=docs>
<p>Warn that a deprecated feature was used</p>
</td><td class=code><div class=highlight><pre>
<span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&quot;$DEPRECATED_TEXT&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">    </span>echo_summary <span class="s2">&quot;WARNING: $DEPRECATED_TEXT&quot;</span>
<span class="k">fi</span>

<span class="k">if </span>is_service_enabled neutron; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>TODO(dtroyer): Remove Q_AGENT_EXTRA_AGENT_OPTS after stable/juno branch is cut</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&quot;$Q_AGENT_EXTRA_AGENT_OPTS&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nb">echo</span> <span class="s2">&quot;&quot;</span>
        echo_summary <span class="s2">&quot;WARNING: Q_AGENT_EXTRA_AGENT_OPTS is used&quot;</span>
        <span class="nb">echo</span> <span class="s2">&quot;You are using Q_AGENT_EXTRA_AGENT_OPTS to pass configuration into $NEUTRON_CONF.&quot;</span>
        <span class="nb">echo</span> <span class="s2">&quot;Please convert that configuration in localrc to a $NEUTRON_CONF section in local.conf:&quot;</span>
        <span class="nb">echo</span> <span class="s2">&quot;Q_AGENT_EXTRA_AGENT_OPTS will be removed early in the &#39;K&#39; development cycle&quot;</span>
        <span class="nb">echo</span> <span class="s2">&quot;</span>
<span class="s2">[[post-config|/\$Q_PLUGIN_CONF_FILE]]</span>
<span class="s2">[DEFAULT]</span>
<span class="s2">&quot;</span>
        <span class="k">for </span>I in <span class="s2">&quot;${Q_AGENT_EXTRA_AGENT_OPTS[@]}&quot;</span>; <span class="k">do</span>
</pre></div></td></tr><tr><td class=docs>
<p>Replace the first '=' with ' ' for iniset syntax</p>
</td><td class=code><div class=highlight><pre>
            <span class="nb">echo</span> <span class="k">${</span><span class="nv">I</span><span class="k">}</span>
        <span class="k">done</span>
<span class="k">    fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>TODO(dtroyer): Remove Q_AGENT_EXTRA_SRV_OPTS after stable/juno branch is cut</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&quot;$Q_AGENT_EXTRA_SRV_OPTS&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nb">echo</span> <span class="s2">&quot;&quot;</span>
        echo_summary <span class="s2">&quot;WARNING: Q_AGENT_EXTRA_SRV_OPTS is used&quot;</span>
        <span class="nb">echo</span> <span class="s2">&quot;You are using Q_AGENT_EXTRA_SRV_OPTS to pass configuration into $NEUTRON_CONF.&quot;</span>
        <span class="nb">echo</span> <span class="s2">&quot;Please convert that configuration in localrc to a $NEUTRON_CONF section in local.conf:&quot;</span>
        <span class="nb">echo</span> <span class="s2">&quot;Q_AGENT_EXTRA_AGENT_OPTS will be removed early in the &#39;K&#39; development cycle&quot;</span>
        <span class="nb">echo</span> <span class="s2">&quot;</span>
<span class="s2">[[post-config|/\$Q_PLUGIN_CONF_FILE]]</span>
<span class="s2">[DEFAULT]</span>
<span class="s2">&quot;</span>
        <span class="k">for </span>I in <span class="s2">&quot;${Q_AGENT_EXTRA_SRV_OPTS[@]}&quot;</span>; <span class="k">do</span>
</pre></div></td></tr><tr><td class=docs>
<p>Replace the first '=' with ' ' for iniset syntax</p>
</td><td class=code><div class=highlight><pre>
            <span class="nb">echo</span> <span class="k">${</span><span class="nv">I</span><span class="k">}</span>
        <span class="k">done</span>
<span class="k">    fi</span>
<span class="k">fi</span>

<span class="k">if </span>is_service_enabled cinder; <span class="k">then</span>
</pre></div></td></tr><tr><td class=docs>
<p>TODO(dtroyer): Remove CINDER_MULTI_LVM_BACKEND after stable/juno branch is cut</p>
</td><td class=code><div class=highlight><pre>
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$CINDER_MULTI_LVM_BACKEND&quot;</span> <span class="o">=</span> <span class="s2">&quot;True&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">        </span><span class="nb">echo</span> <span class="s2">&quot;&quot;</span>
        echo_summary <span class="s2">&quot;WARNING: CINDER_MULTI_LVM_BACKEND is used&quot;</span>
        <span class="nb">echo</span> <span class="s2">&quot;You are using CINDER_MULTI_LVM_BACKEND to configure Cinder&#39;s multiple LVM backends&quot;</span>
        <span class="nb">echo</span> <span class="s2">&quot;Please convert that configuration in local.conf to use CINDER_ENABLED_BACKENDS.&quot;</span>
        <span class="nb">echo</span> <span class="s2">&quot;CINDER_MULTI_LVM_BACKEND will be removed early in the &#39;K&#39; development cycle&quot;</span>
        <span class="nb">echo</span> <span class="s2">&quot;</span>
<span class="s2">[[local|localrc]]</span>
<span class="s2">CINDER_ENABLED_BACKENDS=lvm:lvmdriver-1,lvm:lvmdriver-2</span>
<span class="s2">&quot;</span>
    <span class="k">fi</span>
<span class="k">fi</span>

</pre></div></td></tr><tr><td class=docs>
<p>Indicate how long this took to run (bash maintained variable <tt class="docutils literal">SECONDS</tt>)</p>
</td><td class=code><div class=highlight><pre>
echo_summary <span class="s2">&quot;stack.sh completed in $SECONDS seconds.&quot;</span>

</pre></div></td></tr><tr><td class=docs>
<p>Restore/close logging file descriptors</p>
</td><td class=code><div class=highlight><pre>
<span class="nb">exec </span>1&gt;&amp;3
<span class="nb">exec </span>2&gt;&amp;3
<span class="nb">exec </span>3&gt;&amp;-
<span class="nb">exec </span>6&gt;&amp;-


</td><td class=code><div class=highlight><pre>
</pre></div></td></tr><tr><td class=docs>
</pre></div></td></tr><tr><td class=docs>
</td><td class=code><div class=highlight><pre>

</pre></div></td></tr><tr><td class=docs>
</div>
</div>
</body>
</html></td><td class='code'></td></tr>
    </tbody>
    </table>
</div>
</body>
</html>
